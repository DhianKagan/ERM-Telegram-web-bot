{"version":3,"file":"RequestsPage-legacy-C0TpvKAp.js","sources":["../../../web/src/pages/RequestsPage.tsx"],"sourcesContent":["// Назначение файла: список заявок с таблицей DataTable\r\n// Модули: React, контексты, сервисы задач, shared\r\nimport React from \"react\";\r\nimport { useSearchParams } from \"react-router-dom\";\r\nimport TaskTable from \"../components/TaskTable\";\r\nimport useTasks from \"../context/useTasks\";\r\nimport {\r\n  useTaskIndex,\r\n  useTaskIndexMeta,\r\n} from \"../controllers/taskStateController\";\r\nimport { fetchTasks } from \"../services/tasks\";\r\nimport authFetch from \"../utils/authFetch\";\r\nimport { type Task, type User } from \"shared\";\r\nimport { useAuth } from \"../context/useAuth\";\r\n\r\ninterface RequestRow extends Task {\r\n  assigned_user_id?: number;\r\n  [key: string]: unknown;\r\n}\r\n\r\nexport default function RequestsPage() {\r\n  const [page, setPage] = React.useState(0);\r\n  const [users, setUsers] = React.useState<User[]>([]);\r\n  const [loading, setLoading] = React.useState(true);\r\n  const [params, setParams] = useSearchParams();\r\n  const [mine, setMine] = React.useState(params.get(\"mine\") === \"1\");\r\n  const { version, refresh, controller } = useTasks();\r\n  const { user, loading: authLoading } = useAuth();\r\n  const isAdmin = user?.role === \"admin\";\r\n  const isManager = user?.role === \"manager\";\r\n  const isPrivileged = isAdmin || isManager;\r\n\r\n  const scopeKey = React.useMemo(() => {\r\n    const userKey = user?.telegram_id ? String(user.telegram_id) : \"anon\";\r\n    const mineKey = mine ? \"mine\" : \"all\";\r\n    return `tasks:request:${userKey}:${mineKey}:page=${page + 1}`;\r\n  }, [mine, page, user?.telegram_id]);\r\n\r\n  const tasks = useTaskIndex(scopeKey) as RequestRow[];\r\n  const meta = useTaskIndexMeta(scopeKey);\r\n\r\n  const load = React.useCallback(() => {\r\n    if (!user?.telegram_id) {\r\n      controller.setIndex(scopeKey, [], {\r\n        kind: \"request\",\r\n        mine,\r\n        userId: undefined,\r\n        pageSize: 25,\r\n        total: 0,\r\n        sort: \"desc\",\r\n      });\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    setLoading(true);\r\n    fetchTasks(\r\n      {\r\n        page: page + 1,\r\n        limit: 25,\r\n        mine: mine ? 1 : undefined,\r\n        kind: \"request\",\r\n      },\r\n      user.telegram_id,\r\n      true,\r\n    )\r\n      .then((data) => {\r\n        const rawTasks = data.tasks as RequestRow[];\r\n        const filtered = isPrivileged\r\n          ? rawTasks\r\n          : rawTasks.filter((t) => {\r\n              const assigned =\r\n                t.assignees || (t.assigned_user_id ? [t.assigned_user_id] : []);\r\n              const uid = user.telegram_id;\r\n              return assigned.includes(uid) || t.created_by === uid;\r\n            });\r\n        controller.setIndex(scopeKey, filtered, {\r\n          kind: \"request\",\r\n          mine,\r\n          userId: user.telegram_id,\r\n          pageSize: 25,\r\n          total: data.total || filtered.length,\r\n          sort: \"desc\",\r\n        });\r\n        const list = Array.isArray(data.users)\r\n          ? (data.users as User[])\r\n          : (Object.values(data.users || {}) as User[]);\r\n        setUsers(list);\r\n      })\r\n      .finally(() => setLoading(false));\r\n    if (isPrivileged) {\r\n      authFetch(\"/api/v1/users\")\r\n        .then((r) => (r.ok ? r.json() : []))\r\n        .then((list) =>\r\n          setUsers(Array.isArray(list) ? list : Object.values(list || {})),\r\n        )\r\n        .catch(() => undefined);\r\n    }\r\n  }, [controller, isPrivileged, mine, page, scopeKey, user]);\r\n\r\n  React.useEffect(() => {\r\n    if (authLoading) return;\r\n    if (!user?.telegram_id) return;\r\n    load();\r\n  }, [authLoading, user, load, version, page, mine]);\r\n\r\n  const map = React.useMemo(() => {\r\n    const registry: Record<number, User> = {};\r\n    users.forEach((candidate) => {\r\n      registry[candidate.telegram_id] = candidate;\r\n    });\r\n    return registry;\r\n  }, [users]);\r\n\r\n  if (authLoading) {\r\n    return <div>Загрузка...</div>;\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <h2 className=\"text-2xl font-semibold text-slate-900 dark:text-slate-100\">\r\n        Панель заявок\r\n      </h2>\r\n      {loading && <div>Загрузка...</div>}\r\n      <TaskTable\r\n        tasks={tasks}\r\n        users={map}\r\n        page={page}\r\n        pageCount={Math.ceil((meta.total ?? tasks.length) / 25)}\r\n        mine={mine}\r\n        entityKind=\"request\"\r\n        onPageChange={setPage}\r\n        onMineChange={(value) => {\r\n          setMine(value);\r\n          if (value) params.set(\"mine\", \"1\");\r\n          else params.delete(\"mine\");\r\n          setParams(params);\r\n        }}\r\n        onRowClick={(id) => {\r\n          params.set(\"task\", id);\r\n          setParams(params);\r\n        }}\r\n        toolbarChildren={\r\n          <>\r\n            <button\r\n              onClick={refresh}\r\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\r\n            >\r\n              Обновить\r\n            </button>\r\n            <button\r\n              onClick={() => {\r\n                params.set(\"newRequest\", \"1\");\r\n                setParams(params);\r\n              }}\r\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\r\n            >\r\n              Новая заявка\r\n            </button>\r\n          </>\r\n        }\r\n      />\r\n    </div>\r\n  );\r\n}\r\n"],"names":["_meta$total","_React$useState2","_slicedToArray","React","useState","page","setPage","_React$useState4","users","setUsers","_React$useState6","loading","setLoading","_useSearchParams2","useSearchParams","params","setParams","_React$useState8","get","mine","setMine","_useTasks","useTasks","version","refresh","controller","_useAuth","useAuth","user","authLoading","isAdmin","role","isManager","isPrivileged","scopeKey","useMemo","userKey","telegram_id","String","mineKey","concat","tasks","useTaskIndex","meta","useTaskIndexMeta","load","useCallback","setIndex","kind","userId","pageSize","total","sort","fetchTasks","limit","then","data","rawTasks","filtered","filter","t","assigned","assignees","assigned_user_id","uid","includes","created_by","length","list","Array","isArray","Object","values","finally","authFetch","r","ok","json","catch","useEffect","map","registry","forEach","candidate","jsx","children","jsxs","className","TaskTable","pageCount","Math","ceil","entityKind","onPageChange","onMineChange","value","set","delete","onRowClick","id","toolbarChildren","Fragment","onClick"],"mappings":"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"}