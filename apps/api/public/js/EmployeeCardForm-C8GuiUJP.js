import{j as s}from"./index-DAGCYRZX.js";import{b as n,c as ae}from"./vendor-DBLHOZWC.js";import{h as te,a as re,s as j,B as G}from"./App-DjzPhsfn.js";import{C as ne}from"./ConfirmDialog-DSuP3Gyy.js";import{f as R}from"./collections-B_MhW3hf.js";import{p as le,a as oe,c as ie,u as V}from"./users-BM4xFPV8.js";import{h as ce,A as me}from"./AuthenticatedApp-DKm_nmXg.js";const de=()=>te("/api/v1/roles").then(t=>t.ok?t.json():[]),I={admin:"Администратор",manager:"Менеджер",user:"Сотрудник"},ue=[{value:"admin",label:I.admin},{value:"manager",label:I.manager},{value:"user",label:I.user}],ve=t=>{var N;return t?(N=I[t])!=null?N:t:"—"},m={telegram_id:void 0,username:"",name:"",phone:"",mobNumber:"",email:"",role:"user",access:1,roleId:"",departmentId:"",divisionId:"",positionId:""};function M(t){return{telegram_id:t.telegram_id,username:t.telegram_username||t.username||"",name:t.name||"",phone:t.phone||"",mobNumber:t.mobNumber||"",email:t.email||"",role:t.role||"user",access:t.access,roleId:t.roleId||"",departmentId:t.departmentId||"",divisionId:t.divisionId||"",positionId:t.positionId||""}}const $=t=>t==null?"":String(t);function pe({telegramId:t,className:N,mode:E,onSaved:x}){var q;const{user:w}=re(),[r,c]=n.useState({...m}),[v,d]=n.useState({...m}),[H,A]=n.useState([]),[J,U]=n.useState([]),[K,L]=n.useState([]),[Q,W]=n.useState([]),T=E!=null?E:t?"update":"create",[y,_]=n.useState(T==="update"&&!!t),[S,b]=n.useState(null),[k,C]=n.useState(!1),[X,h]=n.useState(!1),[B,f]=n.useState(null),[P,g]=n.useState(null),i=T==="create",o=ce(w==null?void 0:w.access,me);n.useEffect(()=>{R("departments","",1,100).then(e=>A(e.items)).catch(()=>A([])),R("divisions","",1,100).then(e=>U(e.items)).catch(()=>U([])),R("positions","",1,100).then(e=>L(e.items)).catch(()=>L([])),de().then(e=>W(e))},[]);const F=n.useCallback(e=>{c(a=>({...a,telegram_id:e.telegram_id,username:e.username})),d(a=>({...a,telegram_id:e.telegram_id,username:e.username}))},[]),D=n.useCallback(()=>le(),[]);n.useEffect(()=>{if(f(null),i){_(!1),b(null),c({...m}),d({...m});let e=!0;return D().then(a=>{e&&(F(a),g(null))}).catch(a=>{if(!e)return;const l=a instanceof Error?a.message:"Не удалось подготовить данные";g(l),j(l,"error")}),()=>{e=!1}}if(g(null),!t){_(!1),b(null),c({...m}),d({...m});return}_(!0),b(null),oe(t).then(e=>{if(!e){b("Пользователь не найден"),c({...m}),d({...m});return}const a=M(e);c(a),d({...a})}).catch(e=>{const a=e instanceof Error?e.message:"Ошибка загрузки";b(a||"Ошибка загрузки"),c({...m}),d({...m})}).finally(()=>_(!1))},[t,i,F,D]);const O=n.useMemo(()=>o?i?!!(r.telegram_id&&r.username):Object.keys(v).some(a=>$(r[a])!==$(v[a])):!1,[o,r,v,i]),u=(e,a)=>{f(null),c(l=>({...l,[e]:a}))},Y=e=>{const a=Q.find(l=>l.name===e);f(null),c(l=>{var p;return{...l,role:e,roleId:(a==null?void 0:a._id)||l.roleId,access:(p=a==null?void 0:a.access)!=null?p:l.access}})},Z=()=>{if(i){f(null),c({...m}),d({...m}),D().then(e=>{F(e),g(null)}).catch(e=>{const a=e instanceof Error?e.message:"Не удалось подготовить данные";g(a),j(a,"error")});return}f(null),c({...v})},ee=e=>{e.preventDefault(),o&&O&&h(!0)},se=async()=>{if(!o){h(!1);return}if(i){if(!r.telegram_id||!r.username){j("Укажите ID и username сотрудника","error"),h(!1);return}C(!0);try{const e=Number(r.telegram_id);if(!Number.isFinite(e))throw new Error("ID должен быть числом");await ie(e,r.username,r.roleId);const{telegram_id:a,...l}=r,p=await V(e,l);if(!p)throw new Error("Не удалось сохранить изменения");const z=M(p);c(z),d({...z}),x==null||x(p),f("Сотрудник создан")}catch(e){const a=e instanceof Error?e.message:"Не удалось сохранить";j(a,"error")}finally{C(!1),h(!1)}return}if(!r.telegram_id){h(!1);return}C(!0);try{const{telegram_id:e,...a}=r,l=await V(e,a);if(!l)throw new Error("Не удалось сохранить изменения");const p=M(l);c(p),d({...p}),x==null||x(l),f("Данные сотрудника сохранены")}catch(e){const a=e instanceof Error?e.message:"Не удалось сохранить";j(a,"error")}finally{C(!1),h(!1)}};return!t&&!i?s.jsx("div",{className:"text-sm text-gray-500",children:"Выберите сотрудника слева"}):s.jsxs("div",{className:ae("space-y-4",N),children:[s.jsxs("div",{className:"space-y-1",children:[s.jsx("h2",{className:"text-xl font-semibold",children:i?"Новый сотрудник":"Карточка сотрудника"}),s.jsx("p",{className:"text-sm text-gray-500",children:i?"Заполните данные и сохраните, чтобы создать запись.":"Измените данные и подтвердите сохранение."})]}),y&&s.jsx("div",{children:"Загрузка..."}),!y&&i&&P&&s.jsx("div",{className:"rounded border border-rose-200 bg-rose-50 p-3 text-sm text-rose-900",children:P}),!y&&S&&s.jsx("div",{className:"text-red-600",children:S}),!y&&!S&&s.jsxs("form",{onSubmit:ee,className:"space-y-4 rounded bg-white p-6 shadow",children:[B&&s.jsx("div",{className:"rounded border border-green-200 bg-green-50 p-3 text-sm text-green-800",children:B}),!o&&s.jsx("div",{className:"rounded border border-amber-200 bg-amber-50 p-3 text-sm text-amber-900",children:"У вас нет прав на редактирование, данные доступны только для чтения."}),s.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[s.jsxs("label",{className:"space-y-1",children:[s.jsx("span",{className:"block text-sm font-medium",children:"ID"}),s.jsx("input",{name:"telegramId",className:"h-10 w-full rounded border px-3",value:(q=r.telegram_id)!=null?q:"",onChange:e=>u("telegram_id",e.target.value?Number(e.target.value):void 0),readOnly:!i,required:!0})]}),s.jsxs("label",{className:"space-y-1",children:[s.jsx("span",{className:"block text-sm font-medium",children:"Username"}),s.jsx("input",{name:"username",className:"h-10 w-full rounded border px-3",value:r.username||"",onChange:e=>u("username",e.target.value),readOnly:!i,required:!0})]}),s.jsxs("label",{className:"space-y-1",children:[s.jsx("span",{className:"block text-sm font-medium",children:"Имя"}),s.jsx("input",{name:"name",className:"h-10 w-full rounded border px-3",value:r.name||"",onChange:e=>u("name",e.target.value),disabled:!o})]}),s.jsxs("label",{className:"space-y-1",children:[s.jsx("span",{className:"block text-sm font-medium",children:"Телефон"}),s.jsx("input",{name:"phone",className:"h-10 w-full rounded border px-3",value:r.phone||"",onChange:e=>u("phone",e.target.value),disabled:!o})]}),s.jsxs("label",{className:"space-y-1",children:[s.jsx("span",{className:"block text-sm font-medium",children:"Доп. телефон"}),s.jsx("input",{name:"mobNumber",className:"h-10 w-full rounded border px-3",value:r.mobNumber||"",onChange:e=>u("mobNumber",e.target.value),disabled:!o})]}),s.jsxs("label",{className:"space-y-1",children:[s.jsx("span",{className:"block text-sm font-medium",children:"Email"}),s.jsx("input",{name:"email",className:"h-10 w-full rounded border px-3",value:r.email||"",onChange:e=>u("email",e.target.value),disabled:!o})]}),s.jsxs("label",{className:"space-y-1",children:[s.jsx("span",{className:"block text-sm font-medium",children:"Роль"}),s.jsx("select",{className:"h-10 w-full rounded border px-3",value:r.role||"user",onChange:e=>Y(e.target.value),disabled:!o,children:ue.map(e=>s.jsx("option",{value:e.value,children:e.label},e.value))})]}),s.jsxs("label",{className:"space-y-1",children:[s.jsx("span",{className:"block text-sm font-medium",children:"Департамент"}),s.jsxs("select",{className:"h-10 w-full rounded border px-3",value:r.departmentId||"",onChange:e=>u("departmentId",e.target.value),disabled:!o,children:[s.jsx("option",{value:""}),H.map(e=>s.jsx("option",{value:e._id,children:e.name},e._id))]})]}),s.jsxs("label",{className:"space-y-1",children:[s.jsx("span",{className:"block text-sm font-medium",children:"Отдел"}),s.jsxs("select",{className:"h-10 w-full rounded border px-3",value:r.divisionId||"",onChange:e=>u("divisionId",e.target.value),disabled:!o,children:[s.jsx("option",{value:""}),J.map(e=>s.jsx("option",{value:e._id,children:e.name},e._id))]})]}),s.jsxs("label",{className:"space-y-1",children:[s.jsx("span",{className:"block text-sm font-medium",children:"Должность"}),s.jsxs("select",{className:"h-10 w-full rounded border px-3",value:r.positionId||"",onChange:e=>u("positionId",e.target.value),disabled:!o,children:[s.jsx("option",{value:""}),K.map(e=>s.jsx("option",{value:e._id,children:e.name},e._id))]})]})]}),o&&s.jsxs("div",{className:"flex gap-3",children:[s.jsx(G,{type:"submit",disabled:!O||k,children:k?"Сохранение...":"Сохранить"}),s.jsx(G,{type:"button",variant:"outline",onClick:Z,disabled:!O||k,children:"Очистить"})]})]}),s.jsx(ne,{open:X,message:i?"Создать сотрудника?":"Сохранить изменения сотрудника?",onConfirm:se,onCancel:()=>h(!1),confirmText:"Сохранить"})]})}const ye=Object.freeze(Object.defineProperty({__proto__:null,default:pe},Symbol.toStringTag,{value:"Module"}));export{pe as E,ue as R,de as a,ye as b,ve as f};
//# sourceMappingURL=EmployeeCardForm-C8GuiUJP.js.map
