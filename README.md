<!-- Назначение файла: краткое описание возможностей проекта. Основные модули: api, web. -->

# ERM Telegram Web Bot (v2.2) ![Quality checks](https://img.shields.io/badge/Codex-Quality%20Gate-blue)

Этот монорепозиторий содержит модульную систему управления ресурсами предприятия, объединяющую телеграм‑бота, REST API и веб‑дашборд.

Архитектура

Проект структурирован как рабочее пространство PNPM и состоит из нескольких пакетов:

apps/api – API на базе Node.js/Express, написанное на TypeScript. Реализует REST‑эндпоинты для задач, заявок, пользователей, ролей, журналов, справочников, журнала событий, аналитики, маршрутизации и прочего. API использует MongoDB через Mongoose и внедрение зависимостей с помощью tsyringe. Фоновые задания на базе BullMQ обрабатывают геокодирование, маршрутизацию и отправку уведомлений.

apps/bot – телеграм‑бот на Telegraf. Предоставляет интерактивные команды для создания задач и заявок, загрузки вложений, просмотра назначенных задач и получения уведомлений.

apps/web – веб‑приложение на React (Vite + Tailwind). Обеспечивает интерфейсы для задач, заявок, архива, журнала событий, файлового менеджера, справочников, аналитики и настроек. Для списков используется TanStack React Table, есть встроенные инструменты экспорта (CSV/XLSX/PDF).

packages/shared – общие типы и утилиты TypeScript, используемые API, ботом и вебом.

packages/logging и packages/monitoring – обеспечивают логирование и метрики Prometheus.

API построено модульно: каждая функциональная зона (аутентификация, задачи, заявки, пользователи, роли, логи, события, аналитика, хранилище, справочники) регистрирует свои контроллеры, DTO, сервисы и защитники. Контроль доступа реализован через маски прав (ACCESS_USER, ACCESS_MANAGER, ACCESS_ADMIN и т.д.). Безопасность включает аутентификацию JWT через cookie HttpOnly, CSRF‑токены, валидацию DTO и ограничение скорости.

Файлы хранятся на диске или в S3‑совместимом хранилище; загрузки происходят частями и сканируются ClamAV и другими антивирусами, чтобы предотвратить опасные вложения.

Функциональные возможности
Задачи и заявки

Создание, редактирование и удаление задач и заявок. Каждая запись имеет поля: статус, приоритет, тип, исполнители, сроки и вложения.

Фильтры и поиск. Фильтрация по статусу, приоритету, типу, исполнителям и диапазону дат; полнотекстовый поиск по заголовкам и описаниям. Для привилегированных пользователей можно переключать режим "Мои" / "Все".

Вложения. Загрузка файлов перетаскиванием или через диалог выбора; все вложения сканируются ClamAV и другими антивирусами.

Просмотр и экспорт. Просмотр задач/заявок в виде таблиц с пагинацией или карточек; экспорт в CSV/XLSX/PDF через встроенный тулбар.

Архив. Завершённые элементы могут быть отправлены в архив; записи из архива можно безвозвратно удалить при наличии прав TASK_DELETE.

Интеграция с ботом. Пользователи могут создавать задачи и заявки прямо в чате, прикреплять файлы и получать уведомления о назначениях.

Справочники и настройки

Раздел Справочники позволяет администраторам управлять организационными данными:

отделы, дивизионы и должности;

объекты (локации), сотрудники, автопарк и основные средства;

пользователи и шаблоны задач.

Каждый справочник поддерживает CRUD‑операции, поиск, фильтры и импорт/экспорт. Формы позволяют устанавливать связи (например, назначать сотрудника в отдел). В разделе настроек также есть вкладки Аналитика, Архив, Логи, Хранилище и Мониторинг.

Файловый менеджер

Загрузка и предпросмотр файлов. Управляйте файлами, связанными с задачами или другими объектами. Поддерживаются предпросмотры изображений, видео, PDF и текста.

Фильтры и сортировка. Поиск по имени, сортировка по размеру/дате/названию, фильтр по типу файла или статусу привязки (все/привязанные/непривязанные).

Проверка хранилища. Анализ использования диска и поиск "осиротевших" файлов через страницу диагностики.

Скачивание и удаление. Скачивайте или удаляйте файлы; изображения и видео можно просматривать прямо в модальном окне.

Журнал событий

Фиксация жизненного цикла активов. Регистрируйте обслуживание, перемещение, передачу и другие операции для основных средств и автопарка. Для каждого события хранятся номер, дата/время, тип, операция, исполнитель, объект, локации и описание.

Создание и редактирование событий. Используйте модальную форму с валидацией и динамическими полями (например, выбор объекта из справочника). Для передач требуется указать начальное и конечное местоположение.

Фильтрация и экспорт. Фильтруйте события по типу, объекту, локации и дате; экспортируйте журнал через действия в таблице.

Аналитика

Встроенные дашборды показывают статистику по планам маршрутов и задачам. Страницы /mg/analytics и /cp/analytics содержат графики и таблицы для менеджеров и администраторов.

Данные можно фильтровать по диапазону дат, объекту и исполнителю. Статистика формируется на основе задач и журнала событий.

Оптимизация маршрутов (экспериментально)

По желанию можно включить решение задачи маршрутизации (VRP) на базе OR‑Tools и GraphHopper/OSRM. При включённом ENABLE_VRP_SOLVER=true API принимает JSON‑планы маршрутов (список точек с координатами, объёмами, временными окнами и т.д.) и возвращает оптимальные маршруты.

Переменные GRAPH_HOPPER_API_KEY и GRAPH_HOPPER_BASE_URL задают внешнюю матрицу расстояний. В репозитории есть прототип на Python для тестирования маршрутов.

Очереди и наблюдаемость

Задачи геокодирования и маршрутизации выполняются асинхронно в очередях BullMQ; статистика (количество, длительность) экспортируется в Prometheus.

API записывает операции с привязкой к пользователям и обеспечивает покрытие тестами и проверку ролей. Требования: менее 1 % ошибок CSRF, полная валидация DTO и применение RBAC.

В CI используется Danger для контроля правил веток, описаний коммитов и покрытия тестами.

Быстрый старт

Необходимые компоненты: Node.js ≥ 18, PNPM или Yarn, MongoDB и Redis. Для оптимизации маршрутов нужны GraphHopper или OSRM и ENABLE_VRP_SOLVER=true.

Установка зависимостей:

pnpm install


Переменные окружения: скопируйте .env.example в .env и укажите значения. Ключевые переменные:

API_PORT=8000
MONGO_URL=mongodb://localhost:27017/erm
JWT_SECRET=ваш_секрет
CSRF_SECRET=ещё_секрет
GRAPH_HOPPER_API_KEY=    # опционально для VRP
ENABLE_VRP_SOLVER=false


Дополнительные переменные задают пути к хранилищу, ключи S3, токен бота, уровни логирования и другие сервисы.

Запуск API и веб‑интерфейса в разработке (два терминала):

# терминал 1: API + воркеры
pnpm dev:api

# терминал 2: веб‑приложение
pnpm dev:web


Запуск телеграм‑бота (опционально):

pnpm dev:bot


Сборка для продакшена:

pnpm build


Запуск в продакшене: соберите артефакты и запустите через pm2 или node apps/api/dist/main.js. Для бота используйте pnpm start:bot.

Конфигурации Docker для MongoDB, Redis и GraphHopper/OSRM находятся в docker-compose.yml. Запустить зависимости локально можно командой docker compose up -d.

Обзор API

REST‑API доступно по префиксу /api/v1. Основные эндпоинты:

POST /auth/login — аутентификация и установка JWT‑cookie.

GET /tasks, POST /tasks, PUT /tasks/:id, DELETE /tasks/:id — управление задачами (используйте kind=request для работы с заявками).

GET /users, POST /users, PUT /users/:id, DELETE /users/:id — управление пользователями.

GET /roles, PUT /roles/:id — управление ролями и правами.

GET /logs — просмотр логов приложения.

GET /files, POST /files/upload, DELETE /files/:id — загрузка и управление файлами.

GET /events — управление журналом событий для основных средств и автопарка.

POST /route-plans — построение маршрутов (при включённом VRP‑решателе).

GET /analytics — получение агрегированной аналитики.

GET /collections/:kind, POST /collections/:kind — вывод и создание элементов справочников (отделы, объекты, сотрудники и т.д.).

Большинство эндпоинтов требуют аутентификации; отправляйте JWT‑cookie и CSRF‑заголовок для запросов, изменяющих состояние. Используйте параметр mine=1, чтобы получать только свои задачи или заявки.

Вклад и качество кода

Используйте Prettier и ESLint для единообразного стиля кода.

Проверяйте типы и запускайте unit‑тесты командой pnpm test.

Не коммитите секреты; храните их только в .env.

CI с помощью Danger и GitHub Actions контролирует имена веток, качество сообщений коммитов, покрытие тестами и наличие ключей локализации.

Лицензия

Проект распространяется по лицензии MIT. Подробности см. в файле LICENSE.

Этот README отражает состояние проекта на 22 января 2026 года (по киевскому времени). Подробная техническая документация находится в docs/technical_manual.md и модулях внутри apps/api и apps/web.

«О проекте»:

Проект представляет собой модульную систему для управления задачами и маршрутами с интеграцией Telegram. Серверная часть построена на Express‑API (папка apps/api) и содержит Telegram‑бот на основе Telegraf, REST‑маршруты для работы с задачами, пользователями и ролями, а также сервисы для взаимодействия с Telegram API и базой MongoDB
Клиент — это мини‑приложение на React в папке apps/web
Статические ассеты фронтенда собираются в `apps/api/public` и обслуживаются Express, а пользовательские вложения складываются в изолированный каталог `apps/api/uploads` (значение по умолчанию для `STORAGE_DIR`).
Архитектура разделена на модули: AuthModule выполняет авторизацию через Telegram и выдаёт JWT/CSRF‑токен, TasksModule реализует CRUD задач и вычисление маршрутов, UsersModule, RolesModule и LogsModule отвечают за управление пользователями, ролями и журналирование действий соответственно
Проект переведен на TypeScript и использует DI‑контейнер tsyringe, DTO‑валидацию и декораторы RBAC; цель — перейти от монолитного JavaScript к модульной архитектуре

## Возможности

- Создание и редактирование задач.
- Прикрепление файлов с миниатюрами и метаданными.
- Drag-and-drop загрузка нескольких файлов с chunk-upload.
- Антивирусная проверка и журналирование загрузок и скачиваний, лимиты вложений по пользователю.
- Фильтрация задач по значениям через чекбоксы и поиск.
- Админ‑панель с разделом «Файлы».
- Раздел «Архив» показывает удалённые задачи в режиме только чтение (маска 6), а администратор с маской 8 может запустить полное удаление.
- Администратор наследует права менеджера (`ACCESS_ADMIN | ACCESS_MANAGER = 6`),
  удаление задач доступно только при маске `ACCESS_TASK_DELETE = 8`, которую
  выставляют вручную.
- Управление департаментами, отделами, должностями, сотрудниками и автопарком на странице «Настройки» с поиском и пагинацией.
- `/api/v1/collections` объединяет новые элементы `CollectionItem` и записи устаревших коллекций Department/Employee; такие элементы отображаются только для чтения.
- Таблицы на React Table: скрытие и перестановка колонок, экспорт CSV/XLSX/PDF, серверная пагинация.
- Поиск элементов коллекций с фильтрами и пагинацией.
- Безопасность: JWT хранится в cookie, контекст аутентификации содержит только профиль.
- Неавторизованные пользователи автоматически перенаправляются на страницу входа.

## Быстрый старт

```bash
pnpm install
./scripts/create_env_from_exports.sh
./scripts/setup_and_test.sh
pnpm run dev # запуск api и web без таймаута PNPM
./scripts/start_api_with_memdb.sh # только api с MongoDB в памяти
```

- Подробная настройка локального окружения VS Code: [docs/vscode_local_setup.md](docs/vscode_local_setup.md)

## Проверки качества

- Автоматическая конфигурация Codex хранится в `codex/config.yml` и запускается workflow `Codex Quality Gate` в GitHub Actions.
- Локально используйте `pnpm codex:check`, команда включает `pnpm format:check`, `pnpm lint`, `pnpm lint:security`, `pnpm typecheck` и `pnpm audit`.
- Любое нарушение форматирования, правил безопасности (JWT, CSRF, маски ролей) или уязвимость уровня High/ Critical в зависимостях приводит к падению проверки и блокирует слияние pull request.
- Для код-ревью используйте памятку [`CODE_REVIEW_GUIDE.md`](CODE_REVIEW_GUIDE.md), чтобы не пропустить требования и инварианты.

## Прототип маршрутизации OR-Tools

- Включите флаг `VRP_ORTOOLS_ENABLED=1` в `.env`, чтобы активировать экспериментальный вызов Python-решателя.
- Убедитесь, что в окружении доступен `python3` и установлен пакет `ortools`. Без него скрипт вернёт маршрут по порядку с предупреждением.
- Для запуска примера выполните `pnpm ts-node apps/api/src/services/vrp/runSample.ts`. На выходе будет JSON с результатом и предупреждениями.
- Подробности и сравнение подходов описаны в `docs/routing_research.md` и разделе «Экспериментальный адаптер OR-Tools» технического руководства.
- Для расчёта матриц через GraphHopper задайте `GRAPHHOPPER_MATRIX_URL` (только HTTPS), при необходимости `GRAPHHOPPER_API_KEY` и профиль `GRAPHHOPPER_PROFILE`; если переменные не заданы, адаптер использует Haversine.

## Локальный запуск API с MongoDB в памяти

```bash
./scripts/start_api_with_memdb.sh
```

Скрипт поднимает MongoDB в памяти через MongoMemoryServer и устанавливает переменную `MONGO_DATABASE_URL`, после чего запускает API.

Сгенерированные значения запишите в `.env` и не коммитьте этот файл.

## Настройки cookie

- Переменная `COOKIE_SECURE` по умолчанию считается равной `true` и включает передачу cookie только по HTTPS с атрибутами `Secure` и `SameSite=None`.
- Значение `COOKIE_SECURE=false` предназначено для локальной отладки на HTTP: флаг `Secure` отключается, а атрибут `SameSite` переключается в режим `Lax`, чтобы браузеры принимали cookie без HTTPS.
- При работе через обратный прокси и HTTPS оставляйте значение по умолчанию, чтобы сохранялись защищённые cookie и корректный обмен CSRF‑токенами.

## Антивирусная проверка файлов

- По умолчанию активирован сигнатурный сканер (`ANTIVIRUS_VENDOR=signature`). Он не требует внешних служб, использует
  встроенную сигнатуру EICAR и позволяет расширить список через `ANTIVIRUS_SIGNATURES`.
- Максимальный размер файла для проверки задаётся переменной `ANTIVIRUS_SIGNATURE_MAX_SIZE` (значение в байтах).
- Для интеграции с ClamAV укажите `ANTIVIRUS_VENDOR=clamav` и запустите демон, например через Docker:

```bash
docker run --rm -p 3310:3310 clamav/clamav:latest
```

- Затем настройте `CLAMAV_HOST`, `CLAMAV_PORT`, `CLAMAV_TIMEOUT` и `CLAMAV_CHUNK_SIZE` при необходимости.

- Все события о состоянии сканера фиксируются в `wgLogEngine`.

## Сборка и проверки

```bash
pnpm build       # сборка проекта и компиляция ensureDefaults
pnpm size        # контроль размера бандла
pnpm a11y        # проверка контрастности
pnpm approve-builds  # контроль скриптов зависимостей
pnpm security:scan   # статический анализ кода на уязвимости
./scripts/pre_pr_check.sh  # проверка сборки и запуска перед PR
./scripts/install_bot_deps.sh  # установка зависимостей; при сбоях скачивает pnpm из GitHub
pnpm pretest:e2e  # установка Firefox и Chromium, диагностика playwright doctor/--list и сборка перед e2e
```

Команда `pnpm size` проверяет файлы `apps/web/dist/*.js` (лимит 200 KB); перед запуском соберите фронтенд командой `pnpm --filter web run build:dist`.

Внутренние проверки Lighthouse CI (секрет `LHCI_GITHUB_APP_TOKEN` доступен) запускают `npx lhci autorun` и публикуют статусы через GitHub App. Для внешних вкладов из форков, где секрет недоступен, workflow выполняет `npx lhci collect && npx lhci assert` с `LHCI_UPLOAD__TARGET=filesystem`, отчёт сохраняется локально на раннере и проверка завершается успешно без публикации статусов.

## GitHub Actions и секреты

- Workflow `Docker` автоматически создаёт `.env` в CI и подставляет безопасные значения по умолчанию, если секреты не заданы в публичных ветках.
- Подстановки используют маркеры `__DUMMY_BOT_TOKEN__`, `000000000`, `__DUMMY_JWT_SECRET__` и сервисный MongoDB `mongodb://admin:admin@mongo:27017/ermdb?authSource=admin`.
- Для проверки приватных веток или staging окружений задайте реальные значения в `Repository secrets`.

## Миграции

Скрипты для обновления базы находятся в `scripts/db`. Для добавления роли
менеджера в существующую базу выполните:

```bash
pnpm ts-node scripts/db/addManagerRole.ts
```

Для синхронизации ролей пользователей выполните:

```bash
pnpm ts-node scripts/db/syncUserRoles.ts
```

## Hero-изображения

Скрипт `scripts/generate_hero_images.mjs` создаёт изображения `apps/web/public/hero/index.png`
и `logistics.png` для meta‑тегов. Скрипт запускается автоматически перед `pnpm build`.

Файл `.npmrc` перенаправляет scope `@jsr` на `https://registry.npmjs.org/`,
чтобы установка зависимостей не требовала токена.

Dockerfile копирует каталог `patches` перед установкой зависимостей для применения патчей.
Файл `nixpacks.toml` настраивает сборку на Railway через Nixpacks и выполняет установку зависимостей без режима offline.

## Docker

```bash
docker build -t erm-bot .
docker run -e BOT_TOKEN=123 erm-bot
```

Токен бота передаётся контейнеру через переменную окружения `BOT_TOKEN`.

Подробные инструкции см. в [docs/technical_manual.md](docs/technical_manual.md).
Описание масок доступа и ролей: [docs/permissions.md](docs/permissions.md).
FAQ для саппорта: [docs/support_faq.md](docs/support_faq.md).
Архив устаревших материалов: [docs/archive](docs/archive).
Восстановление проверок Codex: [docs/codex_integration.md](docs/codex_integration.md).

## Assistant / AGENTS

Инструкции для ассистента: AGENTS.md (корень) и .openai/assistant_instructions.json
