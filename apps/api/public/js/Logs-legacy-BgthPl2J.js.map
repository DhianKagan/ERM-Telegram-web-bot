{"version":3,"file":"Logs-legacy-BgthPl2J.js","sources":["../../../web/src/pages/Logs.tsx","../../../web/src/utils/parseAnsiLogEntry.ts","../../../web/src/hooks/useLogsQuery.ts","../../../web/src/components/FiltersPanel.tsx","../../../web/src/columns/logColumns.ts","../../../web/src/components/LogViewer.tsx"],"sourcesContent":["// Страница просмотра логов\r\nimport React from \"react\";\r\nimport LogViewer from \"../components/LogViewer\";\r\n\r\nexport default function Logs() {\r\n  return (\r\n    <div className=\"space-y-6 p-4\">\r\n      <LogViewer />\r\n    </div>\r\n  );\r\n}\r\n","// Назначение файла: разбор ANSI-строк логов WG Log Engine\r\n// Модули: регулярные выражения\r\n\r\nexport interface ParsedLog {\r\n  level: string;\r\n  time?: string;\r\n  method?: string;\r\n  status?: number;\r\n  endpoint?: string;\r\n  csrf?: boolean;\r\n  message: string;\r\n}\r\n\r\nconst ESC = \"\\u001b\";\r\nconst ansiRegex = new RegExp(`${ESC}\\\\[[0-9;]*m`, \"g\");\r\n\r\nexport default function parseAnsiLogEntry(line: string): ParsedLog {\r\n  const clean = line.replace(ansiRegex, \"\");\r\n  const match = clean.match(/^(\\w+)\\s+\\[(.+?)\\]\\s+(.*)$/);\r\n  const res: ParsedLog = {\r\n    level: match ? match[1].toLowerCase() : \"info\",\r\n    time: match ? match[2] : undefined,\r\n    message: match ? match[3] : clean,\r\n  };\r\n  const msg = res.message;\r\n  let m;\r\n  if ((m = msg.match(/API запрос (\\w+) (\\S+) token:([^ ]+) csrf:([^ ]+)/))) {\r\n    res.method = m[1];\r\n    res.endpoint = m[2];\r\n    res.csrf = m[4] !== \"no-csrf\";\r\n  } else if ((m = msg.match(/API запрос (\\w+) (\\S+) (\\w+) (\\w+)/))) {\r\n    res.method = m[1];\r\n    res.endpoint = m[2];\r\n    res.csrf = m[4] !== \"no-csrf\";\r\n  } else if ((m = msg.match(/API ответ (\\w+) (\\S+) (\\d+)/))) {\r\n    res.method = m[1];\r\n    res.endpoint = m[2];\r\n    res.status = Number(m[3]);\r\n  }\r\n  return res;\r\n}\r\n","// Назначение файла: загрузка и фильтрация логов\r\n// Модули: React, authFetch, parseAnsiLogEntry\r\nimport { useEffect, useState } from \"react\";\r\nimport authFetch from \"../utils/authFetch\";\r\nimport parseAnsiLogEntry, { ParsedLog } from \"../utils/parseAnsiLogEntry\";\r\n\r\nexport interface LogFilters {\r\n  level?: string;\r\n  message?: string;\r\n  from?: string;\r\n  to?: string;\r\n  method?: string;\r\n  status?: number;\r\n  endpoint?: string;\r\n  noCsrf?: boolean;\r\n}\r\n\r\nexport default function useLogsQuery(filters: LogFilters, page: number) {\r\n  const [logs, setLogs] = useState<ParsedLog[]>([]);\r\n\r\n  useEffect(() => {\r\n    const params = new URLSearchParams();\r\n    if (filters.level) params.set(\"level\", filters.level);\r\n    if (filters.message) params.set(\"message\", filters.message);\r\n    if (filters.from) params.set(\"from\", filters.from);\r\n    if (filters.to) params.set(\"to\", filters.to);\r\n    params.set(\"page\", String(page));\r\n    params.set(\"limit\", \"50\");\r\n    authFetch(`/api/v1/logs?${params.toString()}`)\r\n      .then((r) => (r.ok ? r.json() : []))\r\n      .then((data: { message: string; level: string }[]) => {\r\n        const parsed = data.map((l) =>\r\n          parseAnsiLogEntry(`${l.level} [${l.createdAt}] ${l.message}`),\r\n        );\r\n        setLogs(parsed);\r\n      });\r\n  }, [filters, page]);\r\n\r\n  return logs.filter((l) => {\r\n    if (filters.method && l.method !== filters.method) return false;\r\n    if (filters.status && l.status !== filters.status) return false;\r\n    if (filters.endpoint && !(l.endpoint || \"\").includes(filters.endpoint))\r\n      return false;\r\n    if (filters.noCsrf && l.csrf !== false) return false;\r\n    return true;\r\n  });\r\n}\r\n","// Панель фильтров логов\r\n// Модули: React\r\nimport React from \"react\";\r\nimport { LogFilters } from \"../hooks/useLogsQuery\";\r\n\r\ninterface Props {\r\n  filters: LogFilters;\r\n  onChange: (f: LogFilters) => void;\r\n}\r\n\r\nexport default function FiltersPanel({ filters, onChange }: Props) {\r\n  const noCsrfId = React.useId();\r\n  return (\r\n    <div className=\"flex flex-wrap gap-2\">\r\n      <select\r\n        className=\"rounded border p-1\"\r\n        aria-label=\"Уровень\"\r\n        name=\"level\"\r\n        value={filters.level || \"\"}\r\n        onChange={(e) => onChange({ ...filters, level: e.target.value })}\r\n      >\r\n        <option value=\"\">Все уровни</option>\r\n        <option value=\"debug\">debug</option>\r\n        <option value=\"info\">info</option>\r\n        <option value=\"warn\">warn</option>\r\n        <option value=\"error\">error</option>\r\n        <option value=\"log\">log</option>\r\n      </select>\r\n      <input\r\n        className=\"rounded border p-1\"\r\n        placeholder=\"Метод\"\r\n        aria-label=\"Метод\"\r\n        name=\"method\"\r\n        value={filters.method || \"\"}\r\n        onChange={(e) => onChange({ ...filters, method: e.target.value })}\r\n      />\r\n      <input\r\n        className=\"rounded border p-1\"\r\n        placeholder=\"Endpoint\"\r\n        aria-label=\"Endpoint\"\r\n        name=\"endpoint\"\r\n        value={filters.endpoint || \"\"}\r\n        onChange={(e) => onChange({ ...filters, endpoint: e.target.value })}\r\n      />\r\n      <input\r\n        className=\"rounded border p-1\"\r\n        placeholder=\"Статус\"\r\n        aria-label=\"Статус\"\r\n        name=\"status\"\r\n        value={filters.status || \"\"}\r\n        onChange={(e) =>\r\n          onChange({ ...filters, status: Number(e.target.value) || undefined })\r\n        }\r\n      />\r\n      <input\r\n        className=\"rounded border p-1\"\r\n        placeholder=\"Содержит текст\"\r\n        aria-label=\"Содержит текст\"\r\n        name=\"message\"\r\n        value={filters.message || \"\"}\r\n        onChange={(e) => onChange({ ...filters, message: e.target.value })}\r\n      />\r\n      <input\r\n        type=\"date\"\r\n        className=\"rounded border p-1\"\r\n        aria-label=\"От\"\r\n        name=\"from\"\r\n        value={filters.from || \"\"}\r\n        onChange={(e) => onChange({ ...filters, from: e.target.value })}\r\n      />\r\n      <input\r\n        type=\"date\"\r\n        className=\"rounded border p-1\"\r\n        aria-label=\"До\"\r\n        name=\"to\"\r\n        value={filters.to || \"\"}\r\n        onChange={(e) => onChange({ ...filters, to: e.target.value })}\r\n      />\r\n      <div className=\"flex items-center gap-1 text-sm\">\r\n        <input\r\n          id={noCsrfId}\r\n          name=\"noCsrf\"\r\n          type=\"checkbox\"\r\n          checked={filters.noCsrf || false}\r\n          onChange={(e) => onChange({ ...filters, noCsrf: e.target.checked })}\r\n        />\r\n        <label htmlFor={noCsrfId}>no-csrf</label>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","// Конфигурация колонок логов для React Table\r\n// Модули: @tanstack/react-table\r\nimport type { ColumnDef } from \"@tanstack/react-table\";\r\n\r\nexport interface LogRow {\r\n  level: string;\r\n  time: string;\r\n  method: string;\r\n  status: number;\r\n  endpoint: string;\r\n  message: string;\r\n}\r\n\r\nconst logColumns: ColumnDef<LogRow>[] = [\r\n  { header: \"Уровень\", accessorKey: \"level\" },\r\n  { header: \"Время\", accessorKey: \"time\" },\r\n  { header: \"Метод\", accessorKey: \"method\" },\r\n  { header: \"Статус\", accessorKey: \"status\" },\r\n  { header: \"Endpoint\", accessorKey: \"endpoint\" },\r\n  { header: \"Сообщение\", accessorKey: \"message\" },\r\n];\r\n\r\nexport default logColumns;\r\n","// Компонент просмотра логов на React Table\r\n// Модули: React, useLogsQuery, FiltersPanel, DataTable (лениво), logColumns\r\nimport React, { lazy, Suspense } from \"react\";\r\nimport useLogsQuery, { LogFilters } from \"../hooks/useLogsQuery\";\r\nimport FiltersPanel from \"./FiltersPanel\";\r\nconst DataTable = lazy(() => import(\"./DataTable\"));\r\nimport logColumns from \"../columns/logColumns\";\r\n\r\nexport default function LogViewer() {\r\n  const [filters, setFilters] = React.useState<LogFilters>({});\r\n  const [live, setLive] = React.useState(true);\r\n  const [page, setPage] = React.useState(0);\r\n  const logs = useLogsQuery(filters, page + 1);\r\n\r\n  React.useEffect(() => {\r\n    setPage(0);\r\n  }, [filters]);\r\n\r\n  React.useEffect(() => {\r\n    if (!live) return;\r\n    const id = setInterval(\r\n      () => setFilters((current) => ({ ...current })),\r\n      5000,\r\n    );\r\n    return () => clearInterval(id);\r\n  }, [live]);\r\n\r\n  return (\r\n    <div className=\"space-y-4 rounded-lg bg-white p-4 shadow-sm\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <h2 className=\"text-xl font-semibold\">Логи</h2>\r\n        <label\r\n          className=\"flex items-center gap-1 text-sm\"\r\n          htmlFor=\"log-live-toggle\"\r\n        >\r\n          <input\r\n            id=\"log-live-toggle\"\r\n            name=\"liveUpdates\"\r\n            type=\"checkbox\"\r\n            checked={live}\r\n            onChange={(e) => setLive(e.target.checked)}\r\n          />\r\n          Live\r\n        </label>\r\n      </div>\r\n      <FiltersPanel filters={filters} onChange={setFilters} />\r\n      <Suspense fallback={<div>Загрузка таблицы...</div>}>\r\n        <DataTable\r\n          columns={logColumns}\r\n          data={logs}\r\n          pageIndex={page}\r\n          pageSize={50}\r\n          onPageChange={setPage}\r\n        />\r\n      </Suspense>\r\n    </div>\r\n  );\r\n}\r\n"],"names":["className","children","jsx","LogViewer","ansiRegex","RegExp","concat","useLogsQuery","filters","page","_reactExports$useStat2","_slicedToArray","useState","logs","setLogs","useEffect","params","URLSearchParams","level","set","message","from","to","String","authFetch","toString","then","r","ok","json","data","parsed","map","l","line","createdAt","clean","replace","match","res","toLowerCase","time","msg","m","method","endpoint","csrf","status","Number","filter","includes","noCsrf","FiltersPanel","_ref","onChange","noCsrfId","React","useId","jsxs","name","value","e","_objectSpread","target","placeholder","type","id","checked","htmlFor","logColumns","header","accessorKey","DataTable","lazy","__vitePreload","module","import","_React$useState2","setFilters","_React$useState4","live","setLive","_React$useState6","setPage","setInterval","current","clearInterval","Suspense","fallback","columns","pageIndex","pageSize","onPageChange"],"mappings":"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"}