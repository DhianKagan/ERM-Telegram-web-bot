<!-- Назначение файла: гайд по проведению code review. Основные модули: api, web, bot, packages. -->

# Code Review Guide

## Зачем нужен этот документ

- Зафиксировать единые критерии проверки pull request в монорепозитории с pnpm.
- Обеспечить соблюдение требований из `AGENTS.md`, `docs/architecture.md`, `docs/permissions.md` и `docs/technical_manual.md`.
- Помочь ревьюерам быстрее заметить регрессии в API (NestJS), веб-клиенте (React + MapLibre), Telegram-боте и общих TS-пакетах.

## Подготовка к ревью

1. Ознакомьтесь с описанием задачи и связанной документацией.
2. Проверьте, что автор PR приложил ссылки на issue и обновил релевантные документы (`README.md`, `CHANGELOG.md`, `ROADMAP.md`, разделы в `docs/`).
3. Убедитесь, что CI-пайплайны (`Codex Quality Gate`, e2e, lint, Docker, Lighthouse) зелёные. Если проверка упала — сначала разберитесь с причиной.
4. Скачайте ветку и выполните локально как минимум `pnpm install`, `pnpm codex:check` и профильные команды из описания PR (например, `pnpm test:api`, `pnpm test:e2e`, `pnpm build`).
5. Для изменений в схемах данных запустите `scripts/db/ensureIndexes.ts` и убедитесь, что индексы создаются без ошибок.

## Общие принципы ревью

- **Фокус на требованиях.** Сверяйтесь с `AGENTS.md`, контракты берите из `docs/architecture.md` и соглашений в `packages/shared`.
- **Прозрачность.** Просите доработки, если поведение или назначение кода неочевидно, а комментариев в стиле «потом поправим» недостаточно.
- **Риск-ориентированность.** В первую очередь проверяйте участки, которые влияют на безопасность, авторизацию, маршрутизацию и работу с файлами.
- **Документирование.** Любые новые фичи должны быть описаны в документации и CHANGELOG; если автор не обновил файлы, верните PR.
- **Согласованность.** Проверяйте, что новые реализации следуют паттернам из раздела «Согласованные паттерны» в `AGENTS.md`.

## Чек-лист по слоям проекта

### Сервер (`apps/api`, NestJS)

- DTO и схемы должны быть типизированы, валидация через `class-validator` покрывает все поля.
- Контроллеры уважают контракты API (`/api/v1/...`), не возвращают лишние поля, статусы HTTP соответствуют сценарию.
- Проверяйте, что сервисы не нарушают инварианты (история задач, маски доступа, кеш OSRM, лимитер Telegram).
- Новые фоновые задачи BullMQ логируют ошибки и не блокируют event loop.
- Все изменения в маршрутах отражены в `docs/technical_manual.md` и, при необходимости, в OpenAPI/контрактных тестах.

### Клиент (`apps/web`, React + MapLibre)

- Компоненты придерживаются структуры `feature/{components,hooks,services,model,ui}` и используют React Query для данных.
- Любые изменения в работе карт проверяются на совместимость с MapLibre: корректность слоёв, источников, обновление токенов и обработку ошибок сети.
- Следите за доступностью (контраст ≥ 4.5:1, aria-атрибуты, управление с клавиатуры). При сомнениях попросите автора приложить скриншоты или результаты `pnpm a11y`.
- В Telegram WebApp не должно появляться предупреждений при отсутствии окружения Telegram; проверяйте graceful degradation.
- Проверяйте локализацию: UI-текст и сообщения должны быть на русском.

### Бот (`apps/bot`, Telegraf)

- Сцены реализуют `enter`, `leave`, `handle`, используют `SessionContext` и не хардкодят маски доступа.
- Все сетевые вызовы выполняются через `apiClient` с ретраями и логированием.
- Новые команды синхронизированы с веб-клиентом и REST API (поведение не расходится).
- Проверяйте, что `ensureDefaults` и другие скрипты инициализации не ломаются при запуске из Docker/Nixpacks.

### Общие пакеты (`packages/`)

- Любые общие типы и утилиты должны быть обратносуместимы: проверьте клиентов (`apps/web`, `apps/api`, `apps/bot`) на предмет изменений API.
- При добавлении функций следите за отсутствием циклических зависимостей и корректной публикацией типов (`index.ts`).
- Проверяйте тесты на Jest/Vitest, если они есть; при отсутствии тестов требуйте добавить.

## Проверки безопасности и производительности

- Аутентификация: JWT остаётся только в cookie, без утечек в localStorage; CSRF-токены проверяются.
- Авторизация: маски доступа вычисляются через `packages/shared/src/permissions`; не допускайте хардкода значений 2, 4, 8 и т.п.
- Загрузка файлов: убедитесь, что ограничения размера и антивирус (`ANTIVIRUS_VENDOR`) не отключены без причины.
- Телеметрия: изменения в метриках Prometheus согласуйте с SRE или отклоните.
- Производительность: новые запросы к MongoDB используют индексы; проверьте планы запросов, если есть сомнения.

## UX и копирайтинг

- Все пользовательские тексты — на русском, вежливые и конкретные.
- Контрольные состояния (loading, empty, error) реализованы и согласованы с дизайном.
- Для изменений в маршрутизации карт проверьте, что fallback без MapLibre работает корректно (например, отображает предупреждение и отключает слой).

## Что делать при несоответствиях

1. Описывайте проблему конкретно: файл, строка, ожидаемое поведение, факт.
2. Предлагайте варианты решения (команда `pnpm format`, корректировка контракта, обновление документации).
3. Если блокер связан с архитектурой, ссылайтесь на раздел `Обзор архитектуры` в `docs/architecture.md`.
4. Если требуется доработка CI, напомните про `scripts/pre_pr_check.sh` и `pnpm codex:check`.

## Критерии одобрения

- Все замечания устранены или задокументированы в issue/tech debt.
- Код и документация соответствуют договорённостям из `AGENTS.md` и связанных документов.
- Тесты и сборки (`pnpm codex:check`, целевые `pnpm test:*`, `pnpm build`, `pnpm size`, `pnpm a11y`, `pnpm approve-builds`) выполняются без ошибок.
- Изменения не нарушают инварианты безопасности, прав доступа и логирования.
- В PR есть понятное описание, чек-лист и ссылки на документацию/issue.

## Ресурсы

- `AGENTS.md` — единые правила стиля, инварианты и паттерны.
- `CODE_REVIEW_GUIDE.md` (этот файл) — шпаргалка для ревью.
- `CONTRIBUTING.md` — процесс работы с задачами и подготовка PR.
- `docs/technical_manual.md`, `docs/architecture.md`, `docs/permissions.md` — подробности API, архитектуры и прав доступа.
- `README.md` — обзор проекта и команды для локальной проверки.
