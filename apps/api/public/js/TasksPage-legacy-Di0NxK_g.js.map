{"version":3,"file":"TasksPage-legacy-Di0NxK_g.js","sources":["../../../web/src/pages/TasksPage.tsx"],"sourcesContent":["// Назначение файла: список задач с таблицей DataTable\n// Модули: React, контексты, сервисы задач, shared\nimport React from 'react';\nimport { useSearchParams } from 'react-router-dom';\nimport TaskTable from '../components/TaskTable';\nimport useTasks from '../context/useTasks';\nimport {\n  useTaskIndex,\n  useTaskIndexMeta,\n} from '../controllers/taskStateController';\nimport { fetchTasks } from '../services/tasks';\nimport authFetch from '../utils/authFetch';\nimport { type Task, type User } from 'shared';\nimport { useAuth } from '../context/useAuth';\n\ntype TaskExtra = Task & {\n  assigned_user_id?: number;\n  [key: string]: unknown;\n};\n\nexport default function TasksPage() {\n  const [page, setPage] = React.useState(0);\n  const [users, setUsers] = React.useState<User[]>([]);\n  const [loading, setLoading] = React.useState(true);\n  const [params, setParams] = useSearchParams();\n  const [mine, setMine] = React.useState(params.get('mine') === '1');\n  const { version, refresh, controller, filters, setFilterUsers } = useTasks();\n  const { user, loading: authLoading } = useAuth();\n  const isAdmin = user?.role === 'admin';\n  const isManager = user?.role === 'manager';\n  const hasPermission = user?.permissions?.includes('tasks');\n  const permissionsList = Array.isArray(user?.permissions)\n    ? user?.permissions\n    : null;\n  const hasExplicitPermissions = (permissionsList?.length ?? 0) > 0;\n  const isPrivileged = isAdmin || isManager;\n  const canView = isPrivileged || hasPermission || !hasExplicitPermissions;\n\n  const effectiveMine = isPrivileged ? mine : true;\n\n  const filterSignature = React.useMemo(() => {\n    const statusKey = [...filters.status].sort().join(',');\n    const priorityKey = [...filters.priority].sort().join(',');\n    const typeKey = [...filters.taskTypes].sort().join(',');\n    const assigneeKey = [...filters.assignees].sort((a, b) => a - b).join(',');\n    return [\n      statusKey,\n      priorityKey,\n      typeKey,\n      assigneeKey,\n      filters.from,\n      filters.to,\n    ].join('|');\n  }, [filters]);\n\n  const scopeKey = React.useMemo(() => {\n    const userKey = user?.telegram_id ? String(user.telegram_id) : 'anon';\n    const mineKey = effectiveMine ? 'mine' : 'all';\n    return `tasks:task:${userKey}:${mineKey}:page=${page + 1}:filters=${filterSignature}`;\n  }, [effectiveMine, filterSignature, page, user?.telegram_id]);\n\n  const tasks = useTaskIndex(scopeKey) as TaskExtra[];\n  const meta = useTaskIndexMeta(scopeKey);\n\n  const updateFilterUserList = React.useCallback(\n    (list: User[]) => {\n      const map = new Map<\n        number,\n        { id: number; name: string; username?: string | null }\n      >();\n      list.forEach((item) => {\n        const id = Number(item.telegram_id);\n        if (!Number.isFinite(id)) return;\n        const displayName =\n          (typeof item.name === 'string' && item.name.trim().length > 0\n            ? item.name.trim()\n            : item.username) ?? `ID ${id}`;\n        map.set(id, {\n          id,\n          name: displayName,\n          username: item.username ?? null,\n        });\n      });\n      setFilterUsers(\n        Array.from(map.values()).sort((a, b) =>\n          a.name.localeCompare(b.name, 'ru'),\n        ),\n      );\n    },\n    [setFilterUsers],\n  );\n\n  const load = React.useCallback(() => {\n    if (!user?.telegram_id) {\n      controller.setIndex(scopeKey, [], {\n        kind: 'task',\n        mine: effectiveMine,\n        userId: undefined,\n        pageSize: 25,\n        total: 0,\n        sort: 'desc',\n      });\n      setLoading(false);\n      return;\n    }\n    setLoading(true);\n    const queryParams: Record<string, unknown> = {\n      page: page + 1,\n      limit: 25,\n      mine: !isPrivileged || mine ? 1 : undefined,\n      kind: 'task',\n    };\n    if (filters.status.length) {\n      queryParams.status = filters.status.join(',');\n    }\n    if (filters.taskTypes.length) {\n      queryParams.taskType = filters.taskTypes.join(',');\n    }\n    if (filters.assignees.length) {\n      queryParams.assignees = filters.assignees.join(',');\n    }\n    fetchTasks(queryParams, user.telegram_id, true)\n      .then((data) => {\n        const rawTasks = data.tasks as TaskExtra[];\n        const filteredTasks = isPrivileged\n          ? rawTasks\n          : rawTasks.filter((t) => {\n              const assigned =\n                t.assignees || (t.assigned_user_id ? [t.assigned_user_id] : []);\n              const uid = user.telegram_id;\n              return assigned.includes(uid) || t.created_by === uid;\n            });\n        controller.setIndex(scopeKey, filteredTasks, {\n          kind: 'task',\n          mine: effectiveMine,\n          userId: user.telegram_id,\n          pageSize: 25,\n          total: data.total || filteredTasks.length,\n          sort: 'desc',\n        });\n        const list = Array.isArray(data.users)\n          ? (data.users as User[])\n          : (Object.values(data.users || {}) as User[]);\n        setUsers(list);\n        updateFilterUserList(list);\n      })\n      .finally(() => setLoading(false));\n    if (isPrivileged) {\n      authFetch('/api/v1/users')\n        .then((r) => (r.ok ? r.json() : []))\n        .then((list) => {\n          const normalized = Array.isArray(list)\n            ? (list as User[])\n            : (Object.values(list || {}) as User[]);\n          setUsers(normalized);\n          updateFilterUserList(normalized);\n        })\n        .catch(() => undefined);\n    }\n  }, [\n    controller,\n    effectiveMine,\n    isPrivileged,\n    mine,\n    page,\n    scopeKey,\n    user,\n    filters,\n    updateFilterUserList,\n  ]);\n\n  React.useEffect(() => {\n    if (authLoading) return;\n    if (isPrivileged) return;\n    if (!mine) {\n      setMine(true);\n    }\n    if (params.get('mine') !== '1') {\n      const next = new URLSearchParams(params);\n      next.set('mine', '1');\n      setParams(next, { replace: true });\n    }\n  }, [authLoading, isPrivileged, mine, params, setParams]);\n\n  React.useEffect(() => {\n    if (authLoading) return;\n    if (!canView) return;\n    if (!user?.telegram_id) return;\n    load();\n    // после загрузки профиля инициируем загрузку задач\n  }, [authLoading, user, load, version, page, mine, canView]);\n\n  const userMap = React.useMemo(() => {\n    const map: Record<number, User> = {};\n    users.forEach((u) => {\n      map[u.telegram_id] = u;\n    });\n    return map;\n  }, [users]);\n\n  if (authLoading) return <div>Загрузка...</div>;\n  if (!canView)\n    return <div className=\"p-4\">У вас нет прав для просмотра задач</div>;\n  return (\n    <div className=\"space-y-6\">\n      <h2 className=\"text-2xl font-semibold text-slate-900 dark:text-slate-100\">\n        Панель управления задачами\n      </h2>\n      {loading && <div>Загрузка...</div>}\n      <TaskTable\n        tasks={tasks}\n        users={userMap}\n        page={page}\n        pageCount={Math.ceil((meta.total ?? tasks.length) / 25)}\n        mine={isPrivileged ? mine : true}\n        onPageChange={setPage}\n        onMineChange={\n          isPrivileged\n            ? (v) => {\n                setMine(v);\n                if (v) params.set('mine', '1');\n                else params.delete('mine');\n                setParams(params);\n              }\n            : undefined\n        }\n        onRowClick={(id) => {\n          params.set('task', id);\n          setParams(params);\n        }}\n        toolbarChildren={\n          <>\n            <button\n              onClick={refresh}\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\n            >\n              Обновить\n            </button>\n            <button\n              onClick={() => {\n                params.set('newTask', '1');\n                setParams(params);\n              }}\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\n            >\n              Новая задача\n            </button>\n          </>\n        }\n      />\n    </div>\n  );\n}\n"],"names":["_user$permissions","_permissionsList$leng","_meta$total","_React$useState2","_slicedToArray","React","useState","page","setPage","_React$useState4","users","setUsers","_React$useState6","loading","setLoading","_useSearchParams2","useSearchParams","params","setParams","_React$useState8","get","mine","setMine","_useTasks","useTasks","version","refresh","controller","filters","setFilterUsers","_useAuth","useAuth","user","authLoading","isAdmin","role","isManager","hasPermission","permissions","includes","permissionsList","Array","isArray","hasExplicitPermissions","length","isPrivileged","canView","effectiveMine","filterSignature","useMemo","_toConsumableArray","status","sort","join","priority","taskTypes","assignees","a","b","from","to","scopeKey","userKey","telegram_id","String","mineKey","concat","tasks","useTaskIndex","meta","useTaskIndexMeta","updateFilterUserList","useCallback","list","map","Map","forEach","item","_ref","_item$username","id","Number","isFinite","displayName","name","trim","username","set","values","localeCompare","load","setIndex","kind","userId","pageSize","total","queryParams","limit","taskType","fetchTasks","then","data","rawTasks","filteredTasks","filter","t","assigned","assigned_user_id","uid","created_by","Object","finally","authFetch","r","ok","json","normalized","catch","useEffect","next","URLSearchParams","replace","userMap","u","jsx","children","jsxs","className","TaskTable","pageCount","Math","ceil","onPageChange","onMineChange","v","delete","onRowClick","toolbarChildren","Fragment","onClick"],"mappings":"41DAoBA,eAAoCA,EAAAC,EAAAC,EACMC,EAAAC,EAAhBC,EAAMC,SAAS,GAAC,GAAjCC,EAAAJ,EAAA,GAAMK,EAAOL,EAAA,GAC+BM,EAAAL,EAAzBC,EAAMC,SAAiB,IAAE,GAA5CI,EAAAD,EAAA,GAAOE,EAAQF,EAAA,GAC2BG,EAAAR,EAAnBC,EAAMC,UAAS,GAAI,GAA1CO,EAAAD,EAAA,GAASE,EAAUF,EAAA,GACkBG,EAAAX,EAAhBY,IAAgB,GAArCC,EAAAF,EAAA,GAAQG,EAASH,EAAA,GACyCI,EAAAf,EAAzCC,EAAMC,SAAgC,MAAvBW,EAAOG,IAAI,YAA3CC,EAAAF,EAAA,GAAMG,EAAOH,EAAA,GACpBI,EAAkEC,IAA1DC,EAAAF,EAAAE,QAASC,EAAAH,EAAAG,QAASC,IAAAA,WAAYC,EAAAL,EAAAK,QAASC,EAAAN,EAAAM,eAC/CC,EAAuCC,IAA/BC,EAAAF,EAAAE,KAAeC,EAAAH,EAATjB,QACRqB,EAAyB,WAAfF,eAAAA,EAAMG,MAChBC,EAA2B,aAAfJ,eAAAA,EAAMG,MAClBE,EAAgBL,iBAAAhC,EAAAgC,EAAMM,mBAAA,IAAAtC,OAAA,EAANA,EAAmBuC,SAAS,SAC5CC,EAAkBC,MAAMC,QAAQV,eAAAA,EAAMM,aACxCN,eAAAA,EAAMM,YACN,KACEK,GAA2C,QAA3C1C,EAA0BuC,aAAA,EAAAA,EAAiBI,cAAA,IAAA3C,EAAAA,EAAU,GAAK,EAC1D4C,EAAeX,GAAWE,EAC1BU,EAAUD,GAAgBR,IAAkBM,EAE5CI,GAAgBF,GAAexB,EAE/B2B,EAAkB3C,EAAM4C,QAAQ,WAKpC,MAAO,CAJWC,EAAItB,EAAQuB,QAAQC,OAAOC,KAAK,KAC9BH,EAAItB,EAAQ0B,UAAUF,OAAOC,KAAK,KACtCH,EAAItB,EAAQ2B,WAAWH,OAAOC,KAAK,KAC/BH,EAAItB,EAAQ4B,WAAWJ,KAAK,SAACK,EAAGC,UAAMD,EAAIC,CAAC,GAAEL,KAAK,KAMpEzB,EAAQ+B,KACR/B,EAAQgC,IACRP,KAAK,IACT,EAAG,CAACzB,IAEEiC,EAAWxD,EAAM4C,QAAQ,WAC7B,IAAMa,EAAU9B,SAAAA,EAAM+B,YAAcC,OAAOhC,EAAK+B,aAAe,OACzDE,EAAUlB,EAAgB,OAAS,MACzC,MAAA,cAAAmB,OAAqBJ,EAAO,KAAAI,OAAID,EAAO,UAAAC,OAAS3D,EAAO,EAAC,aAAA2D,OAAYlB,EACtE,EAAG,CAACD,EAAeC,EAAiBzC,EAAMyB,eAAAA,EAAM+B,cAE1CI,EAAQC,EAAaP,GACrBQ,EAAOC,EAAiBT,GAExBU,EAAuBlE,EAAMmE,YACjC,SAACC,GACC,IAAMC,MAAUC,IAIhBF,EAAKG,QAAQ,SAACC,GAAS,IAAAC,EAAAC,EACfC,EAAKC,OAAOJ,EAAKd,aACvB,GAAKkB,OAAOC,SAASF,GAArB,CACA,IAAMG,EAGK,UAFa,iBAAdN,EAAKO,MAAqBP,EAAKO,KAAKC,OAAOzC,OAAS,EACxDiC,EAAKO,KAAKC,OACVR,EAAKS,gBAAA,IAAAR,EAAAA,QAAAZ,OAAmBc,GAC9BN,EAAIa,IAAIP,EAAI,CACVA,GAAAA,EACAI,KAAMD,EACNG,iBAAAP,EAAUF,EAAKS,gBAAA,IAAAP,EAAAA,EAAY,MARH,CAU5B,GACAlD,EACEY,MAAMkB,KAAKe,EAAIc,UAAUpC,KAAK,SAACK,EAAGC,GAAA,OAChCD,EAAE2B,KAAKK,cAAc/B,EAAE0B,KAAM,KAAI,GAGvC,EACA,CAACvD,IAGG6D,EAAOrF,EAAMmE,YAAY,WAC7B,GAAKxC,UAAAA,EAAM+B,YAUT,OATApC,EAAWgE,SAAS9B,EAAU,GAAI,CAChC+B,KAAM,OACNvE,KAAM0B,EACN8C,YAAQ,EACRC,SAAU,GACVC,MAAO,EACP3C,KAAM,cAERtC,GAAW,GAGbA,GAAW,GACX,IAAMkF,EAAuC,CAC3CzF,KAAMA,EAAO,EACb0F,MAAO,GACP5E,MAAOwB,GAAgBxB,EAAO,OAAI,EAClCuE,KAAM,QAEJhE,EAAQuB,OAAOP,SACjBoD,EAAY7C,OAASvB,EAAQuB,OAAOE,KAAK,MAEvCzB,EAAQ2B,UAAUX,SACpBoD,EAAYE,SAAWtE,EAAQ2B,UAAUF,KAAK,MAE5CzB,EAAQ4B,UAAUZ,SACpBoD,EAAYxC,UAAY5B,EAAQ4B,UAAUH,KAAK,MAEjD8C,EAAWH,EAAahE,EAAK+B,aAAa,GACvCqC,KAAK,SAACC,GACL,IAAMC,EAAWD,EAAKlC,MAChBoC,EAAgB1D,EAClByD,EACAA,EAASE,OAAO,SAACC,GACf,IAAMC,EACJD,EAAEjD,YAAciD,EAAEE,iBAAmB,CAACF,EAAEE,kBAAoB,IACxDC,EAAM5E,EAAK+B,YACjB,OAAO2C,EAASnE,SAASqE,IAAQH,EAAEI,aAAeD,CACpD,GACJjF,EAAWgE,SAAS9B,EAAU0C,EAAe,CAC3CX,KAAM,OACNvE,KAAM0B,EACN8C,OAAQ7D,EAAK+B,YACb+B,SAAU,GACVC,MAAOM,EAAKN,OAASQ,EAAc3D,OACnCQ,KAAM,SAER,IAAMqB,EAAOhC,MAAMC,QAAQ2D,EAAK3F,OAC3B2F,EAAK3F,MACLoG,OAAOtB,OAAOa,EAAK3F,OAAS,CAAA,GACjCC,EAAS8D,GACTF,EAAqBE,EACvB,GACCsC,QAAQ,WAAA,OAAMjG,GAAW,EAAM,GAC9B+B,GACFmE,EAAU,iBACPZ,KAAK,SAACa,UAAOA,EAAEC,GAAKD,EAAEE,OAAS,EAAG,GAClCf,KAAK,SAAC3B,GACL,IAAM2C,EAAa3E,MAAMC,QAAQ+B,GAC5BA,EACAqC,OAAOtB,OAAOf,GAAQ,IAC3B9D,EAASyG,GACT7C,EAAqB6C,EACvB,GACCC,MAAM,aAEb,EAAG,CACD1F,EACAoB,EACAF,EACAxB,EACAd,EACAsD,EACA7B,EACAJ,EACA2C,IAGFlE,EAAMiH,UAAU,WACd,IAAIrF,IACAY,IACCxB,GACHC,GAAQ,GAEiB,MAAvBL,EAAOG,IAAI,SAAiB,CAC9B,IAAMmG,EAAO,IAAIC,gBAAgBvG,GACjCsG,EAAKhC,IAAI,OAAQ,KACjBrE,EAAUqG,EAAM,CAAEE,SAAS,GAC7B,CACF,EAAG,CAACxF,EAAaY,EAAcxB,EAAMJ,EAAQC,IAE7Cb,EAAMiH,UAAU,WACVrF,GACCa,GACAd,SAAAA,EAAM+B,aACX2B,GAEF,EAAG,CAACzD,EAAaD,EAAM0D,EAAMjE,EAASlB,EAAMc,EAAMyB,IAElD,IAAM4E,EAAUrH,EAAM4C,QAAQ,WAC5B,IAAMyB,EAA4B,CAAA,EAIlC,OAHAhE,EAAMkE,QAAQ,SAAC+C,GACbjD,EAAIiD,EAAE5D,aAAe4D,CACvB,GACOjD,CACT,EAAG,CAAChE,IAEJ,OAAIuB,EAAoB2F,EAAAA,IAAC,MAAA,CAAIC,SAAA,gBACxB/E,EAGHgF,EAAAA,KAAC,MAAA,CAAIC,UAAU,YACbF,SAAA,CAAAD,EAAAA,IAAC,KAAA,CAAGG,UAAU,4DAA4DF,SAAA,+BAGzEhH,GAAW+G,EAAAA,IAAC,MAAA,CAAIC,SAAA,gBACjBD,EAAAA,IAACI,EAAA,CACC7D,MAAAA,EACAzD,MAAOgH,EACPnH,KAAAA,EACA0H,UAAWC,KAAKC,cAAAjI,EAAMmE,EAAK0B,aAAA,IAAA7F,EAAAA,EAASiE,EAAMvB,QAAU,IACpDvB,MAAMwB,GAAexB,EACrB+G,aAAc5H,EACd6H,aACExF,EACI,SAACyF,GACChH,EAAQgH,GACJA,EAAGrH,EAAOsE,IAAI,OAAQ,KACrBtE,EAAOsH,OAAO,QACnBrH,EAAUD,EACZ,OACA,EAENuH,WAAY,SAACxD,GACX/D,EAAOsE,IAAI,OAAQP,GACnB9D,EAAUD,EACZ,EACAwH,gBACEX,EAAAA,KAAAY,WAAA,CACEb,SAAA,CAAAD,EAAAA,IAAC,SAAA,CACCe,QAASjH,EACTqG,UAAU,qEACXF,SAAA,aAGDD,EAAAA,IAAC,SAAA,CACCe,QAAS,WACP1H,EAAOsE,IAAI,UAAW,KACtBrE,EAAUD,EACZ,EACA8G,UAAU,qEACXF,SAAA,yBA1CFD,EAAAA,IAAC,MAAA,CAAIG,UAAU,MAAMF,SAAA,sCAkDhC"}