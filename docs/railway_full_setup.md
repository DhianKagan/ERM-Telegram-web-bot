<!-- Назначение файла: пошаговая инструкция по развертыванию всего проекта на Railway. -->

# Полный запуск проекта на Railway

Ниже описаны шаги по настройке сервиса на Railway так, чтобы бот, веб‑клиент и API работали вместе с сервисом **OSRM**.

## 1. Создание проекта

1. Зарегистрируйтесь на Railway и создайте новый проект.
2. Добавьте плагин **MongoDB**. После создания Railway выдаст переменную `DATABASE_URL`.

## 2. Развёртывание основного приложения

1. Нажмите **New Service → Deploy from GitHub** и выберите этот репозиторий.
2. В разделе **Variables** задайте:
   - `BOT_TOKEN` — токен от BotFather.
   - `MONGO_DATABASE_URL` — строка подключения к MongoDB. На Railway используйте значение из `DATABASE_URL` плагина MongoDB; в локальной проверке `scripts/pre_pr_check.sh` запускает MongoDB в памяти, а в CI проверка пропускается.
   - `APP_URL` — домен проекта вида `https://<имя>.up.railway.app`.
   - `ROUTING_URL` — адрес сервиса маршрутов из следующего шага (например, `https://orsm-production.up.railway.app/route`).
   - `VITE_ROUTING_URL` — тот же адрес для клиентской части.
3. Railway автоматически использует `Procfile`, который собирает клиент и запускает pm2.
4. Приложение должно слушать `process.env.PORT` на `0.0.0.0`. Railway завершает TLS на Edge и автоматически перенаправляет HTTP на HTTPS.

## 3. Добавление OSRM

1. Создайте ещё один сервис через **Deploy from GitHub** и выберите репозиторий `AgroxOD/OSRM-Odessa-Region`.
2. Railway установит зависимости и запустит приложение автоматически.
3. После запуска сервис будет доступен, например, по `https://orsm-production.up.railway.app`.
4. Укажите адрес `https://orsm-production.up.railway.app/route` в переменных `ROUTING_URL` и `VITE_ROUTING_URL` основного приложения.
5. При необходимости задайте переменную `OSRM_ALGORITHM` со значением `ch` или `mld`.

## 4. Запуск и проверка

1. Нажмите **Deploy** для обоих сервисов.
2. Откройте адрес из переменной `APP_URL` и убедитесь, что мини‑приложение загружается.
3. В Telegram отправьте `/start` боту и создайте тестовую задачу.
4. Эндпойнт `/api/v1/route` должен возвращать маршрут с использованием OSRM.

## 5. Дополнительные рекомендации

- Используйте Railway CLI для локальных тестов (`railway up`).
- При обновлении репозитория Railway автоматически перезапустит сервис.
- Для минимальной ручной настройки и автоматизации логов используйте [railway_minimal_setup.md](./railway_minimal_setup.md) и конвейер из [railway_logs.md](./railway_logs.md).

## Переменные окружения

Для корректной работы авторизации задайте:

- `NODE_ENV=production`
- `COOKIE_DOMAIN=<домен приложения>`

Подробности о переменной `COOKIE_DOMAIN` смотрите в разделе [«Защита от CSRF»](./technical_manual.md#защита-от-csrf).
