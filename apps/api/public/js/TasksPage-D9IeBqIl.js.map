{"version":3,"file":"TasksPage-D9IeBqIl.js","sources":["../../../web/src/pages/TasksPage.tsx"],"sourcesContent":["// Назначение файла: список задач с таблицей DataTable\n// Модули: React, контексты, сервисы задач, shared\nimport React from 'react';\nimport { useSearchParams } from 'react-router-dom';\nimport TaskTable from '../components/TaskTable';\nimport useTasks from '../context/useTasks';\nimport {\n  useTaskIndex,\n  useTaskIndexMeta,\n} from '../controllers/taskStateController';\nimport { fetchTasks } from '../services/tasks';\nimport authFetch from '../utils/authFetch';\nimport { type Task, type User } from 'shared';\nimport { useAuth } from '../context/useAuth';\n\ntype TaskExtra = Task & {\n  assigned_user_id?: number;\n  [key: string]: unknown;\n};\n\nexport default function TasksPage() {\n  const [page, setPage] = React.useState(0);\n  const [users, setUsers] = React.useState<User[]>([]);\n  const [loading, setLoading] = React.useState(true);\n  const [params, setParams] = useSearchParams();\n  const [mine, setMine] = React.useState(params.get('mine') === '1');\n  const { version, refresh, controller, filters, setFilterUsers } = useTasks();\n  const { user, loading: authLoading } = useAuth();\n  const isAdmin = user?.role === 'admin';\n  const isManager = user?.role === 'manager';\n  const hasPermission = user?.permissions?.includes('tasks');\n  const permissionsList = Array.isArray(user?.permissions)\n    ? user?.permissions\n    : null;\n  const hasExplicitPermissions = (permissionsList?.length ?? 0) > 0;\n  const isPrivileged = isAdmin || isManager;\n  const canView = isPrivileged || hasPermission || !hasExplicitPermissions;\n\n  const effectiveMine = isPrivileged ? mine : true;\n\n  const filterSignature = React.useMemo(() => {\n    const statusKey = [...filters.status].sort().join(',');\n    const priorityKey = [...filters.priority].sort().join(',');\n    const typeKey = [...filters.taskTypes].sort().join(',');\n    const assigneeKey = [...filters.assignees].sort((a, b) => a - b).join(',');\n    return [\n      statusKey,\n      priorityKey,\n      typeKey,\n      assigneeKey,\n      filters.from,\n      filters.to,\n    ].join('|');\n  }, [filters]);\n\n  const scopeKey = React.useMemo(() => {\n    const userKey = user?.telegram_id ? String(user.telegram_id) : 'anon';\n    const mineKey = effectiveMine ? 'mine' : 'all';\n    return `tasks:task:${userKey}:${mineKey}:page=${page + 1}:filters=${filterSignature}`;\n  }, [effectiveMine, filterSignature, page, user?.telegram_id]);\n\n  const tasks = useTaskIndex(scopeKey) as TaskExtra[];\n  const meta = useTaskIndexMeta(scopeKey);\n\n  const updateFilterUserList = React.useCallback(\n    (list: User[]) => {\n      const map = new Map<\n        number,\n        { id: number; name: string; username?: string | null }\n      >();\n      list.forEach((item) => {\n        const id = Number(item.telegram_id);\n        if (!Number.isFinite(id)) return;\n        const displayName =\n          (typeof item.name === 'string' && item.name.trim().length > 0\n            ? item.name.trim()\n            : item.username) ?? `ID ${id}`;\n        map.set(id, {\n          id,\n          name: displayName,\n          username: item.username ?? null,\n        });\n      });\n      setFilterUsers(\n        Array.from(map.values()).sort((a, b) =>\n          a.name.localeCompare(b.name, 'ru'),\n        ),\n      );\n    },\n    [setFilterUsers],\n  );\n\n  const load = React.useCallback(() => {\n    if (!user?.telegram_id) {\n      controller.setIndex(scopeKey, [], {\n        kind: 'task',\n        mine: effectiveMine,\n        userId: undefined,\n        pageSize: 25,\n        total: 0,\n        sort: 'desc',\n      });\n      setLoading(false);\n      return;\n    }\n    setLoading(true);\n    const queryParams: Record<string, unknown> = {\n      page: page + 1,\n      limit: 25,\n      mine: !isPrivileged || mine ? 1 : undefined,\n      kind: 'task',\n    };\n    if (filters.status.length) {\n      queryParams.status = filters.status.join(',');\n    }\n    if (filters.taskTypes.length) {\n      queryParams.taskType = filters.taskTypes.join(',');\n    }\n    if (filters.assignees.length) {\n      queryParams.assignees = filters.assignees.join(',');\n    }\n    fetchTasks(queryParams, user.telegram_id, true)\n      .then((data) => {\n        const rawTasks = data.tasks as TaskExtra[];\n        const filteredTasks = isPrivileged\n          ? rawTasks\n          : rawTasks.filter((t) => {\n              const assigned =\n                t.assignees || (t.assigned_user_id ? [t.assigned_user_id] : []);\n              const uid = user.telegram_id;\n              return assigned.includes(uid) || t.created_by === uid;\n            });\n        controller.setIndex(scopeKey, filteredTasks, {\n          kind: 'task',\n          mine: effectiveMine,\n          userId: user.telegram_id,\n          pageSize: 25,\n          total: data.total || filteredTasks.length,\n          sort: 'desc',\n        });\n        const list = Array.isArray(data.users)\n          ? (data.users as User[])\n          : (Object.values(data.users || {}) as User[]);\n        setUsers(list);\n        updateFilterUserList(list);\n      })\n      .finally(() => setLoading(false));\n    if (isPrivileged) {\n      authFetch('/api/v1/users')\n        .then((r) => (r.ok ? r.json() : []))\n        .then((list) => {\n          const normalized = Array.isArray(list)\n            ? (list as User[])\n            : (Object.values(list || {}) as User[]);\n          setUsers(normalized);\n          updateFilterUserList(normalized);\n        })\n        .catch(() => undefined);\n    }\n  }, [\n    controller,\n    effectiveMine,\n    isPrivileged,\n    mine,\n    page,\n    scopeKey,\n    user,\n    filters,\n    updateFilterUserList,\n  ]);\n\n  React.useEffect(() => {\n    if (authLoading) return;\n    if (isPrivileged) return;\n    if (!mine) {\n      setMine(true);\n    }\n    if (params.get('mine') !== '1') {\n      const next = new URLSearchParams(params);\n      next.set('mine', '1');\n      setParams(next, { replace: true });\n    }\n  }, [authLoading, isPrivileged, mine, params, setParams]);\n\n  React.useEffect(() => {\n    if (authLoading) return;\n    if (!canView) return;\n    if (!user?.telegram_id) return;\n    load();\n    // после загрузки профиля инициируем загрузку задач\n  }, [authLoading, user, load, version, page, mine, canView]);\n\n  const userMap = React.useMemo(() => {\n    const map: Record<number, User> = {};\n    users.forEach((u) => {\n      map[u.telegram_id] = u;\n    });\n    return map;\n  }, [users]);\n\n  if (authLoading) return <div>Загрузка...</div>;\n  if (!canView)\n    return <div className=\"p-4\">У вас нет прав для просмотра задач</div>;\n  return (\n    <div className=\"space-y-6\">\n      <h2 className=\"text-2xl font-semibold text-slate-900 dark:text-slate-100\">\n        Панель управления задачами\n      </h2>\n      {loading && <div>Загрузка...</div>}\n      <TaskTable\n        tasks={tasks}\n        users={userMap}\n        page={page}\n        pageCount={Math.ceil((meta.total ?? tasks.length) / 25)}\n        mine={isPrivileged ? mine : true}\n        onPageChange={setPage}\n        onMineChange={\n          isPrivileged\n            ? (v) => {\n                setMine(v);\n                if (v) params.set('mine', '1');\n                else params.delete('mine');\n                setParams(params);\n              }\n            : undefined\n        }\n        onRowClick={(id) => {\n          params.set('task', id);\n          setParams(params);\n        }}\n        toolbarChildren={\n          <>\n            <button\n              onClick={refresh}\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\n            >\n              Обновить\n            </button>\n            <button\n              onClick={() => {\n                params.set('newTask', '1');\n                setParams(params);\n              }}\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\n            >\n              Новая задача\n            </button>\n          </>\n        }\n      />\n    </div>\n  );\n}\n"],"names":["TasksPage","page","setPage","React","users","setUsers","loading","setLoading","params","setParams","useSearchParams","mine","setMine","version","refresh","controller","filters","setFilterUsers","useTasks","user","authLoading","useAuth","isAdmin","isManager","hasPermission","_a","permissionsList","hasExplicitPermissions","_b","isPrivileged","canView","effectiveMine","filterSignature","statusKey","priorityKey","typeKey","assigneeKey","a","b","scopeKey","userKey","mineKey","tasks","useTaskIndex","meta","useTaskIndexMeta","updateFilterUserList","list","map","item","id","displayName","load","queryParams","fetchTasks","data","rawTasks","filteredTasks","t","assigned","uid","authFetch","r","normalized","next","userMap","u","jsx","jsxs","TaskTable","_c","v","Fragment"],"mappings":"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"}