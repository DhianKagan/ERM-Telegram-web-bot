{"version":3,"file":"users-legacy-0acX7224.js","sources":["../../../web/src/services/users.ts"],"sourcesContent":["// Назначение: запросы к API пользователей\r\n// Основные модули: authFetch\r\nimport authFetch from \"../utils/authFetch\";\r\nimport type { User } from \"../types/user\";\r\nimport { normalizeUser, normalizeUsers } from \"./normalizeUser\";\r\n\r\nexport interface UserDetails extends User {\r\n  email?: string;\r\n  mobNumber?: string;\r\n  name?: string;\r\n}\r\n\r\nconst referenceFields = new Set<\r\n  \"roleId\" | \"departmentId\" | \"divisionId\" | \"positionId\"\r\n>([\"roleId\", \"departmentId\", \"divisionId\", \"positionId\"]);\r\n\r\nconst normalizeRoleId = (value?: string) => {\r\n  if (typeof value !== \"string\") return undefined;\r\n  const trimmed = value.trim();\r\n  return trimmed.length > 0 ? trimmed : undefined;\r\n};\r\n\r\nconst buildCreateUserBody = (\r\n  id?: number | string,\r\n  username?: string,\r\n  roleId?: string,\r\n) => {\r\n  const payload: Record<string, unknown> = {};\r\n  if (id !== undefined) {\r\n    payload.id = id;\r\n  }\r\n  if (typeof username === \"string\") {\r\n    const trimmed = username.trim();\r\n    if (trimmed.length > 0) {\r\n      payload.username = trimmed;\r\n    }\r\n  } else if (username !== undefined) {\r\n    payload.username = username;\r\n  }\r\n  const normalizedRoleId = normalizeRoleId(roleId);\r\n  if (normalizedRoleId) {\r\n    payload.roleId = normalizedRoleId;\r\n  }\r\n  return payload;\r\n};\r\n\r\nconst sanitizeUserUpdatePayload = (data: Partial<User>): Partial<User> => {\r\n  const payload: Partial<User> = {};\r\n  (Object.entries(data) as [keyof User, User[keyof User]][]).forEach(\r\n    ([key, value]) => {\r\n      if (value === undefined || value === null) {\r\n        return;\r\n      }\r\n      if (typeof value === \"string\") {\r\n        const trimmed = value.trim();\r\n        if (\r\n          referenceFields.has(\r\n            key as \"roleId\" | \"departmentId\" | \"divisionId\" | \"positionId\",\r\n          )\r\n        ) {\r\n          if (trimmed.length === 0) {\r\n            return;\r\n          }\r\n          payload[key] = trimmed as User[keyof User];\r\n          return;\r\n        }\r\n        payload[key] = trimmed as User[keyof User];\r\n        return;\r\n      }\r\n      payload[key] = value;\r\n    },\r\n  );\r\n  return payload;\r\n};\r\n\r\nexport const fetchUser = async (\r\n  id: number | string,\r\n): Promise<UserDetails | null> => {\r\n  const res = await authFetch(`/api/v1/users/${id}`, { noRedirect: true });\r\n  if (res.status === 404) return null;\r\n  if (!res.ok) {\r\n    const text = await res.text().catch(() => \"\");\r\n    throw new Error(text || \"Не удалось загрузить пользователя\");\r\n  }\r\n  const data = await res.json();\r\n  return normalizeUser(data) as UserDetails;\r\n};\r\n\r\nexport const fetchUsers = async (): Promise<User[]> => {\r\n  const response = await authFetch(\"/api/v1/users\");\r\n  if (response.ok) {\r\n    const data = await response.json();\r\n    return Array.isArray(data) ? (normalizeUsers(data) as User[]) : [];\r\n  }\r\n  const text = await response.text().catch(() => \"\");\r\n  throw new Error(text || \"Не удалось загрузить пользователей\");\r\n};\r\n\r\nexport const createUser = (\r\n  id?: number | string,\r\n  username?: string,\r\n  roleId?: string,\r\n) => {\r\n  const body = buildCreateUserBody(id, username, roleId);\r\n  return authFetch(\"/api/v1/users\", {\r\n    method: \"POST\",\r\n    confirmed: true,\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify(body),\r\n  }).then(async (r) => {\r\n    if (!r.ok) {\r\n      const body = await r.text().catch(() => \"\");\r\n      let message = \"Не удалось создать пользователя\";\r\n      if (body) {\r\n        try {\r\n          const data = JSON.parse(body) as {\r\n            error?: string;\r\n            message?: string;\r\n            detail?: string;\r\n          };\r\n          message = data.error || data.detail || data.message || message;\r\n        } catch {\r\n          message = body;\r\n        }\r\n      }\r\n      throw new Error(message);\r\n    }\r\n    const data = await r.json();\r\n    return normalizeUser(data);\r\n  });\r\n};\r\n\r\nexport interface GeneratedUserCredentials {\r\n  telegram_id: number;\r\n  username: string;\r\n}\r\n\r\nexport const previewUserCredentials = (\r\n  id?: number | string,\r\n  username?: string,\r\n): Promise<GeneratedUserCredentials> =>\r\n  authFetch(`/api/v1/users?preview=1`, {\r\n    method: \"POST\",\r\n    confirmed: true,\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify({ id, username }),\r\n  }).then(async (r) => {\r\n    if (!r.ok) {\r\n      const body = await r.text().catch(() => \"\");\r\n      let message = \"Не удалось получить сгенерированные данные\";\r\n      if (body) {\r\n        try {\r\n          const parsed = JSON.parse(body) as {\r\n            error?: string;\r\n            detail?: string;\r\n            message?: string;\r\n          };\r\n          message = parsed.error || parsed.detail || parsed.message || message;\r\n        } catch {\r\n          message = body;\r\n        }\r\n      }\r\n      throw new Error(message);\r\n    }\r\n    return r.json();\r\n  });\r\n\r\nexport const updateUser = (\r\n  id: number | string,\r\n  data: Partial<User>,\r\n): Promise<UserDetails | null> => {\r\n  const body = sanitizeUserUpdatePayload(data);\r\n  return authFetch(`/api/v1/users/${id}`, {\r\n    method: \"PATCH\",\r\n    confirmed: true,\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify(body),\r\n  }).then(async (r) => {\r\n    if (!r.ok) {\r\n      const body = await r.text().catch(() => \"\");\r\n      let message = \"Не удалось обновить пользователя\";\r\n      if (body) {\r\n        try {\r\n          const parsed = JSON.parse(body) as {\r\n            error?: string;\r\n            detail?: string;\r\n            message?: string;\r\n          };\r\n          message = parsed.error || parsed.detail || parsed.message || message;\r\n        } catch {\r\n          message = body;\r\n        }\r\n      }\r\n      throw new Error(message);\r\n    }\r\n    const data = await r.json();\r\n    return normalizeUser(data) as UserDetails;\r\n  });\r\n};\r\n\r\nexport const deleteUser = async (id: number | string): Promise<void> => {\r\n  const response = await authFetch(`/api/v1/users/${id}`, {\r\n    method: \"DELETE\",\r\n    confirmed: true,\r\n  });\r\n  if (response.status === 404) {\r\n    throw new Error(\"Пользователь не найден\");\r\n  }\r\n  if (!response.ok) {\r\n    const body = await response.text().catch(() => \"\");\r\n    throw new Error(body || \"Не удалось удалить пользователя\");\r\n  }\r\n};\r\n"],"names":["referenceFields","Set","exports","_ref3","_asyncToGenerator","_regenerator","m","_callee","id","res","text","data","w","_context","n","authFetch","concat","noRedirect","v","status","a","ok","catch","Error","json","normalizeUser","_x","apply","this","arguments","_callee2","response","_context2","Array","isArray","normalizeUsers","username","roleId","body","payload","trimmed","trim","length","normalizedRoleId","value","normalizeRoleId","buildCreateUserBody","method","confirmed","headers","JSON","stringify","then","_ref5","_callee3","r","body2","message","data2","_context3","parse","error","detail","_unused","_x2","_ref6","_callee4","parsed","_context4","_unused2","_x3","Object","entries","forEach","_ref","_ref2","_slicedToArray","key","has","sanitizeUserUpdatePayload","_ref7","_callee5","_context5","_unused3","_x4","_ref8","_callee6","_context6","_x5"],"mappings":"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"}