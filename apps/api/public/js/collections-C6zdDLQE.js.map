{"version":3,"file":"collections-C6zdDLQE.js","sources":["../../../web/src/services/collections.ts"],"sourcesContent":["// Назначение: запросы к API универсальных коллекций\r\n// Основные модули: authFetch, i18n\r\nimport i18n from \"../i18n\";\r\nimport authFetch from \"../utils/authFetch\";\r\n\r\nexport interface CollectionItemMeta {\r\n  invalid?: boolean;\r\n  invalidReason?: string;\r\n  invalidCode?: string;\r\n  invalidAt?: string;\r\n  syncPending?: boolean;\r\n  syncWarning?: string;\r\n  syncError?: string;\r\n  syncFailedAt?: string;\r\n  legacy?: boolean;\r\n  readonly?: boolean;\r\n  readonlyReason?: string;\r\n  source?: string;\r\n  sourceId?: string;\r\n  fleetId?: string;\r\n  departmentId?: string;\r\n  divisionId?: string;\r\n  positionId?: string;\r\n  defaultLabel?: string;\r\n  fieldType?: string;\r\n  required?: boolean;\r\n  order?: number;\r\n  virtual?: boolean;\r\n  tg_theme_url?: string;\r\n  tg_chat_id?: string;\r\n  tg_topic_id?: number;\r\n  tg_photos_url?: string;\r\n  tg_photos_chat_id?: string;\r\n  tg_photos_topic_id?: number;\r\n  [key: string]: unknown;\r\n}\r\n\r\nexport interface CollectionItem {\r\n  _id: string;\r\n  type: string;\r\n  name: string;\r\n  value: string;\r\n  meta?: CollectionItemMeta;\r\n}\r\n\r\ntype ProblemValidationError = {\r\n  msg?: string;\r\n  message?: string;\r\n  [key: string]: unknown;\r\n};\r\n\r\ntype ProblemResponse = {\r\n  error?: string;\r\n  detail?: unknown;\r\n  message?: string;\r\n  errors?: ProblemValidationError[];\r\n};\r\n\r\ntype ParseErrorOptions = {\r\n  collectionType?: string;\r\n};\r\n\r\nconst validationMessageKeys: Record<string, string> = {\r\n  \"Некорректный тип коллекции\": \"collections.errors.invalidType\",\r\n  \"Тип коллекции обязателен\": \"collections.errors.typeRequired\",\r\n  \"Некорректное название элемента\": \"collections.errors.invalidName\",\r\n  \"Название элемента обязательно\": \"collections.errors.nameRequired\",\r\n  \"Некорректное значение элемента\": \"collections.errors.invalidValue\",\r\n  \"Значение элемента обязательно\": \"collections.errors.valueRequired\",\r\n  \"Значение элемента не может быть пустым\": \"collections.errors.valueRequired\",\r\n  \"Ошибка валидации\": \"collections.errors.generalValidation\",\r\n  \"Ссылка на тему Telegram должна иметь формат https://t.me/c/<id>/<topic>\":\r\n    \"collections.errors.invalidTelegramTopicUrl\",\r\n};\r\n\r\nconst typeSpecificValidationKeys: Record<string, Record<string, string>> = {\r\n  departments: {\r\n    \"Значение элемента обязательно\":\r\n      \"collections.errors.departmentsMustHaveDivisions\",\r\n  },\r\n};\r\n\r\nconst tryParseJson = (raw: string): unknown => {\r\n  try {\r\n    return JSON.parse(raw);\r\n  } catch {\r\n    return undefined;\r\n  }\r\n};\r\n\r\nconst translateValidationMessage = (\r\n  raw: string | undefined,\r\n  options?: ParseErrorOptions,\r\n): string => {\r\n  if (!raw) return \"\";\r\n  const trimmed = raw.trim();\r\n  if (!trimmed) return \"\";\r\n  const collectionType = options?.collectionType;\r\n  const specificKey =\r\n    collectionType && typeSpecificValidationKeys[collectionType]?.[trimmed];\r\n  const key = specificKey ?? validationMessageKeys[trimmed];\r\n  if (key) return i18n.t(key);\r\n  return trimmed;\r\n};\r\n\r\nconst translateValidationErrors = (\r\n  errors: ProblemValidationError[] | undefined,\r\n  options?: ParseErrorOptions,\r\n): string[] => {\r\n  if (!errors?.length) return [];\r\n  const translated = errors\r\n    .map((error) => {\r\n      const base =\r\n        typeof error?.msg === \"string\"\r\n          ? error.msg\r\n          : typeof error?.message === \"string\"\r\n            ? error.message\r\n            : \"\";\r\n      return translateValidationMessage(base, options);\r\n    })\r\n    .filter(Boolean);\r\n  if (translated.length) return translated;\r\n  return [i18n.t(\"collections.errors.generalValidation\")];\r\n};\r\n\r\nconst extractMessagesFromPayload = (\r\n  payload: unknown,\r\n  options?: ParseErrorOptions,\r\n): string[] => {\r\n  if (!payload) return [];\r\n  if (Array.isArray(payload)) {\r\n    const asErrors = payload.filter(\r\n      (item): item is ProblemValidationError =>\r\n        Boolean(item && typeof item === \"object\" && \"msg\" in item),\r\n    );\r\n    if (asErrors.length) return translateValidationErrors(asErrors, options);\r\n    const directStrings = payload\r\n      .map((item) =>\r\n        typeof item === \"string\"\r\n          ? translateValidationMessage(item, options)\r\n          : \"\",\r\n      )\r\n      .filter(Boolean);\r\n    if (directStrings.length) return directStrings;\r\n  }\r\n  if (typeof payload === \"string\") {\r\n    const parsed = tryParseJson(payload);\r\n    if (parsed !== undefined) {\r\n      const nested = extractMessagesFromPayload(parsed, options);\r\n      if (nested.length) return nested;\r\n    }\r\n    const translated = translateValidationMessage(payload, options);\r\n    return translated ? [translated] : [];\r\n  }\r\n  return [];\r\n};\r\n\r\nexport const parseErrorMessage = (\r\n  status: number,\r\n  body: string,\r\n  options?: ParseErrorOptions,\r\n): string => {\r\n  const fallback =\r\n    status === 429\r\n      ? i18n.t(\"collections.fallback.rateLimited\")\r\n      : status === 403\r\n        ? i18n.t(\"collections.fallback.forbidden\")\r\n        : i18n.t(\"collections.fallback.loadFailed\");\r\n\r\n  if (body) {\r\n    const parsed = tryParseJson(body) as ProblemResponse | undefined;\r\n    if (parsed) {\r\n      const errorMessages = translateValidationErrors(parsed.errors, options);\r\n      if (errorMessages.length) {\r\n        return Array.from(new Set(errorMessages)).join(\". \");\r\n      }\r\n      const detailMessages = extractMessagesFromPayload(\r\n        parsed.detail,\r\n        options,\r\n      );\r\n      if (detailMessages.length) {\r\n        return Array.from(new Set(detailMessages)).join(\". \");\r\n      }\r\n      const generalMessage =\r\n        translateValidationMessage(parsed.error, options) ||\r\n        translateValidationMessage(parsed.message, options);\r\n      if (generalMessage) return generalMessage;\r\n    } else {\r\n      const translated = translateValidationMessage(body, options);\r\n      if (translated) return translated;\r\n    }\r\n  }\r\n\r\n  return fallback;\r\n};\r\n\r\nexport const fetchCollectionItems = async (\r\n  type: string,\r\n  search = \"\",\r\n  page = 1,\r\n  limit = 10,\r\n) => {\r\n  const res = await authFetch(\r\n    `/api/v1/collections?type=${type}&page=${page}&limit=${limit}${search ? `&search=${encodeURIComponent(search)}` : \"\"}`,\r\n  );\r\n  if (!res.ok) {\r\n    const body = await res.text().catch(() => \"\");\r\n    throw new Error(parseErrorMessage(res.status, body, { collectionType: type }));\r\n  }\r\n  return res.json();\r\n};\r\n\r\nconst isFiniteNumber = (value: unknown): value is number =>\r\n  typeof value === \"number\" && Number.isFinite(value);\r\n\r\nexport const fetchAllCollectionItems = async (\r\n  type: string,\r\n  search = \"\",\r\n  limit = 200,\r\n): Promise<CollectionItem[]> => {\r\n  const effectiveLimit = limit > 0 ? limit : 200;\r\n  const aggregated: CollectionItem[] = [];\r\n  let page = 1;\r\n  let expectedTotal = 0;\r\n  // ограничиваем количество итераций, чтобы избежать бесконечных циклов при ошибках пагинации\r\n  const maxIterations = 100;\r\n  while (page <= maxIterations) {\r\n    const response = (await fetchCollectionItems(\r\n      type,\r\n      search,\r\n      page,\r\n      effectiveLimit,\r\n    )) as { items?: CollectionItem[]; total?: number };\r\n    const items = Array.isArray(response.items) ? response.items : [];\r\n    if (!items.length && aggregated.length === 0 && !isFiniteNumber(response.total)) {\r\n      return [];\r\n    }\r\n    aggregated.push(...items);\r\n    if (isFiniteNumber(response.total)) {\r\n      expectedTotal = Math.max(expectedTotal, response.total);\r\n    }\r\n    if (items.length < effectiveLimit) {\r\n      break;\r\n    }\r\n    if (expectedTotal && aggregated.length >= expectedTotal) {\r\n      break;\r\n    }\r\n    page += 1;\r\n  }\r\n  if (expectedTotal && aggregated.length > expectedTotal) {\r\n    return aggregated.slice(0, expectedTotal);\r\n  }\r\n  return aggregated;\r\n};\r\n\r\nexport const createCollectionItem = (\r\n  type: string,\r\n  data: { name: string; value: string; meta?: Record<string, unknown> },\r\n) =>\r\n  authFetch(\"/api/v1/collections\", {\r\n    method: \"POST\",\r\n    confirmed: true,\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify({ type, ...data }),\r\n  }).then(async (r) => {\r\n    if (!r.ok) {\r\n      const body = await r.text().catch(() => \"\");\r\n      throw new Error(parseErrorMessage(r.status, body, { collectionType: type }));\r\n    }\r\n    return r.json();\r\n  });\r\n\r\nexport const updateCollectionItem = (\r\n  id: string,\r\n  data: { name?: string; value?: string; meta?: Record<string, unknown> },\r\n  options?: ParseErrorOptions,\r\n) =>\r\n  authFetch(`/api/v1/collections/${id}`, {\r\n    method: \"PUT\",\r\n    confirmed: true,\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify(data),\r\n  }).then(async (r) => {\r\n    if (!r.ok) {\r\n      const body = await r.text().catch(() => \"\");\r\n      throw new Error(parseErrorMessage(r.status, body, options));\r\n    }\r\n    return r.json();\r\n  });\r\n\r\nexport const removeCollectionItem = async (id: string) => {\r\n  const r = await authFetch(`/api/v1/collections/${id}`, {\r\n    method: \"DELETE\",\r\n    confirmed: true,\r\n  });\r\n  if (!r.ok) {\r\n    const body = await r.text().catch(() => \"\");\r\n    throw new Error(parseErrorMessage(r.status, body));\r\n  }\r\n  return r.json();\r\n};\r\n"],"names":["validationMessageKeys","typeSpecificValidationKeys","tryParseJson","raw","e","translateValidationMessage","options","trimmed","collectionType","specificKey","_a","key","i18n","translateValidationErrors","errors","translated","error","base","extractMessagesFromPayload","payload","asErrors","item","directStrings","parsed","nested","parseErrorMessage","status","body","fallback","errorMessages","detailMessages","generalMessage","fetchCollectionItems","type","search","page","limit","res","authFetch","isFiniteNumber","value","fetchAllCollectionItems","effectiveLimit","aggregated","expectedTotal","maxIterations","response","items","createCollectionItem","data","r","updateCollectionItem","id","removeCollectionItem"],"mappings":"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"}