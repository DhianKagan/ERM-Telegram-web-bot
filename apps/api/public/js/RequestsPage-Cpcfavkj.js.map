{"version":3,"file":"RequestsPage-Cpcfavkj.js","sources":["../../../web/src/pages/RequestsPage.tsx"],"sourcesContent":["// Назначение файла: список заявок с таблицей DataTable\n// Модули: React, контексты, сервисы задач, shared\nimport React from 'react';\nimport { useSearchParams } from 'react-router-dom';\nimport TaskTable from '../components/TaskTable';\nimport useTasks from '../context/useTasks';\nimport {\n  useTaskIndex,\n  useTaskIndexMeta,\n} from '../controllers/taskStateController';\nimport { fetchTasks } from '../services/tasks';\nimport authFetch from '../utils/authFetch';\nimport { type Task, type User } from 'shared';\nimport { useAuth } from '../context/useAuth';\n\ninterface RequestRow extends Task {\n  assigned_user_id?: number;\n  [key: string]: unknown;\n}\n\nexport default function RequestsPage() {\n  const [page, setPage] = React.useState(0);\n  const [users, setUsers] = React.useState<User[]>([]);\n  const [loading, setLoading] = React.useState(true);\n  const [params, setParams] = useSearchParams();\n  const [mine, setMine] = React.useState(params.get('mine') === '1');\n  const { version, refresh, controller } = useTasks();\n  const { user, loading: authLoading } = useAuth();\n  const isAdmin = user?.role === 'admin';\n  const isManager = user?.role === 'manager';\n  const isPrivileged = isAdmin || isManager;\n\n  const scopeKey = React.useMemo(() => {\n    const userKey = user?.telegram_id ? String(user.telegram_id) : 'anon';\n    const mineKey = mine ? 'mine' : 'all';\n    return `tasks:request:${userKey}:${mineKey}:page=${page + 1}`;\n  }, [mine, page, user?.telegram_id]);\n\n  const tasks = useTaskIndex(scopeKey) as RequestRow[];\n  const meta = useTaskIndexMeta(scopeKey);\n\n  const load = React.useCallback(() => {\n    if (!user?.telegram_id) {\n      controller.setIndex(scopeKey, [], {\n        kind: 'request',\n        mine,\n        userId: undefined,\n        pageSize: 25,\n        total: 0,\n        sort: 'desc',\n      });\n      setLoading(false);\n      return;\n    }\n    setLoading(true);\n    fetchTasks(\n      {\n        page: page + 1,\n        limit: 25,\n        mine: mine ? 1 : undefined,\n        kind: 'request',\n      },\n      user.telegram_id,\n      true,\n    )\n      .then((data) => {\n        const rawTasks = data.tasks as RequestRow[];\n        const filtered = isPrivileged\n          ? rawTasks\n          : rawTasks.filter((t) => {\n              const assigned =\n                t.assignees || (t.assigned_user_id ? [t.assigned_user_id] : []);\n              const uid = user.telegram_id;\n              return assigned.includes(uid) || t.created_by === uid;\n            });\n        controller.setIndex(scopeKey, filtered, {\n          kind: 'request',\n          mine,\n          userId: user.telegram_id,\n          pageSize: 25,\n          total: data.total || filtered.length,\n          sort: 'desc',\n        });\n        const list = Array.isArray(data.users)\n          ? (data.users as User[])\n          : (Object.values(data.users || {}) as User[]);\n        setUsers(list);\n      })\n      .finally(() => setLoading(false));\n    if (isPrivileged) {\n      authFetch('/api/v1/users')\n        .then((r) => (r.ok ? r.json() : []))\n        .then((list) =>\n          setUsers(Array.isArray(list) ? list : Object.values(list || {})),\n        )\n        .catch(() => undefined);\n    }\n  }, [controller, isPrivileged, mine, page, scopeKey, user]);\n\n  React.useEffect(() => {\n    if (authLoading) return;\n    if (!user?.telegram_id) return;\n    load();\n  }, [authLoading, user, load, version, page, mine]);\n\n  const map = React.useMemo(() => {\n    const registry: Record<number, User> = {};\n    users.forEach((candidate) => {\n      registry[candidate.telegram_id] = candidate;\n    });\n    return registry;\n  }, [users]);\n\n  if (authLoading) {\n    return <div>Загрузка...</div>;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <h2 className=\"text-2xl font-semibold text-slate-900 dark:text-slate-100\">\n        Панель заявок\n      </h2>\n      {loading && <div>Загрузка...</div>}\n      <TaskTable\n        tasks={tasks}\n        users={map}\n        page={page}\n        pageCount={Math.ceil((meta.total ?? tasks.length) / 25)}\n        mine={mine}\n        entityKind=\"request\"\n        onPageChange={setPage}\n        onMineChange={(value) => {\n          setMine(value);\n          if (value) params.set('mine', '1');\n          else params.delete('mine');\n          setParams(params);\n        }}\n        onRowClick={(id) => {\n          params.set('task', id);\n          setParams(params);\n        }}\n        toolbarChildren={\n          <>\n            <button\n              onClick={refresh}\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\n            >\n              Обновить\n            </button>\n            <button\n              onClick={() => {\n                params.set('newRequest', '1');\n                setParams(params);\n              }}\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\n            >\n              Новая заявка\n            </button>\n          </>\n        }\n      />\n    </div>\n  );\n}\n"],"names":["RequestsPage","page","setPage","React","users","setUsers","loading","setLoading","params","setParams","useSearchParams","mine","setMine","version","refresh","controller","useTasks","user","authLoading","useAuth","isAdmin","isManager","isPrivileged","scopeKey","userKey","mineKey","tasks","useTaskIndex","meta","useTaskIndexMeta","load","fetchTasks","data","rawTasks","filtered","t","assigned","uid","list","authFetch","r","map","registry","candidate","jsx","jsxs","TaskTable","_a","value","id","Fragment"],"mappings":"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"}