{"version":3,"mappings":"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","names":["ReportFilterForm","onChange","from","setFrom","React","to","setTo","submit","e","jsxs","jsx","Button","KPIOverview","count","time","ReactApexChart","__vitePreload","n","buildQuery","filters","params","query","TasksChart","series","setSeries","useState","categories","setCategories","theme","useTheme","useEffect","cancelled","authFetch","r","data","labels","normalizedData","value","numeric","normalizedLabels","label","options","Reports","kpi","setKpi","setFilters","downloading","setDownloading","normalizePeriod","source","normalized","trimmed","period","extractFilename","header","fallback","match","handleDownload","kind","prev","endpoint","res","blob","disposition","filename","url","link","error","showToast","fetchSummary","load","next"],"ignoreList":[],"sources":["../../../web/src/components/ReportFilterForm.tsx","../../../web/src/components/KPIOverview.tsx","../../../web/src/components/TasksChart.tsx","../../../web/src/pages/Reports.tsx"],"sourcesContent":["// Форма фильтрации отчётов по диапазону дат\r\nimport React from \"react\";\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\ninterface ReportFilterFormProps {\r\n  onChange?: (period: { from: string; to: string }) => void;\r\n}\r\n\r\nexport default function ReportFilterForm({ onChange }: ReportFilterFormProps) {\r\n  const [from, setFrom] = React.useState(\"\");\r\n  const [to, setTo] = React.useState(\"\");\r\n  const submit = (e) => {\r\n    e.preventDefault();\r\n    onChange && onChange({ from, to });\r\n  };\r\n  return (\r\n    <form onSubmit={submit} className=\"flex flex-wrap items-end gap-2\">\r\n      <input\r\n        type=\"date\"\r\n        id=\"report-from\"\r\n        name=\"reportFrom\"\r\n        value={from}\r\n        onChange={(e) => setFrom(e.target.value)}\r\n        className=\"focus:border-accentPrimary focus:ring-brand-200 rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-800 focus:ring focus:outline-none\"\r\n      />\r\n      <input\r\n        type=\"date\"\r\n        id=\"report-to\"\r\n        name=\"reportTo\"\r\n        value={to}\r\n        onChange={(e) => setTo(e.target.value)}\r\n        className=\"focus:border-accentPrimary focus:ring-brand-200 rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-800 focus:ring focus:outline-none\"\r\n      />\r\n      <Button type=\"submit\">\r\n        Применить\r\n      </Button>\r\n    </form>\r\n  );\r\n}\r\n","// Блок KPI с общими метриками по задачам\r\nimport React from \"react\";\r\n\r\ninterface KPIOverviewProps {\r\n  count: number;\r\n  time: number;\r\n}\r\n\r\nexport default function KPIOverview({ count, time }: KPIOverviewProps) {\r\n  return (\r\n    <div className=\"flex space-x-4\">\r\n      <div className=\"rounded border p-2\">Всего задач: {count}</div>\r\n      <div className=\"rounded border p-2\">Затрачено минут: {time}</div>\r\n    </div>\r\n  );\r\n}\r\n","// График количества задач за период\r\n// Модули: React, react-apexcharts, next-themes, authFetch\r\nimport React, { useEffect, useState } from \"react\";\r\nimport { useTheme } from \"next-themes\";\r\nimport authFetch from \"../utils/authFetch\";\r\nconst ReactApexChart = React.lazy(() => import(\"react-apexcharts\"));\r\n\r\ninterface ChartState {\r\n  series: { data: number[] }[];\r\n  categories: string[];\r\n}\r\n\r\ninterface TasksChartProps {\r\n  filters?: {\r\n    from?: string;\r\n    to?: string;\r\n  };\r\n}\r\n\r\nconst buildQuery = (filters?: TasksChartProps['filters']) => {\r\n  const params = new URLSearchParams();\r\n  if (filters?.from) params.set('from', filters.from);\r\n  if (filters?.to) params.set('to', filters.to);\r\n  const query = params.toString();\r\n  return query ? `?${query}` : \"\";\r\n};\r\n\r\nexport default function TasksChart({ filters }: TasksChartProps) {\r\n  const [series, setSeries] = useState<ChartState[\"series\"]>([{ data: [] }]);\r\n  const [categories, setCategories] = useState<ChartState[\"categories\"]>([]);\r\n  const { theme } = useTheme();\r\n\r\n  useEffect(() => {\r\n    let cancelled = false;\r\n    authFetch(`/api/v1/tasks/report/chart${buildQuery(filters)}`)\r\n      .then((r) => (r.ok ? r.json() : { data: [], labels: [] }))\r\n      .then(({ data, labels }) => {\r\n        if (cancelled) return;\r\n        const normalizedData = Array.isArray(data)\r\n          ? data.map((value) => {\r\n              const numeric = Number(value);\r\n              return Number.isFinite(numeric) ? numeric : 0;\r\n            })\r\n          : [];\r\n        const normalizedLabels = Array.isArray(labels)\r\n          ? labels.map((label) => String(label))\r\n          : [];\r\n        setSeries([{ data: normalizedData }]);\r\n        setCategories(normalizedLabels);\r\n      })\r\n      .catch(() => {\r\n        if (cancelled) return;\r\n        setSeries([{ data: [] }]);\r\n        setCategories([]);\r\n      });\r\n    return () => {\r\n      cancelled = true;\r\n    };\r\n  }, [filters?.from, filters?.to]);\r\n\r\n  const options = {\r\n    chart: {\r\n      height: 200,\r\n      type: \"line\",\r\n      fontFamily: \"Inter, sans-serif\",\r\n      toolbar: { show: false },\r\n      background: theme === \"dark\" ? \"#24303F\" : undefined,\r\n    },\r\n    colors: [\"#2563EB\"],\r\n    stroke: { width: 2, curve: \"smooth\" },\r\n    xaxis: {\r\n      categories,\r\n      labels: { style: { colors: theme === \"dark\" ? \"#DEE4EE\" : \"#6B7280\" } },\r\n    },\r\n    yaxis: {\r\n      labels: { style: { colors: theme === \"dark\" ? \"#DEE4EE\" : \"#6B7280\" } },\r\n    },\r\n  };\r\n\r\n  return (\r\n    <React.Suspense fallback={<div>Загрузка...</div>}>\r\n      <ReactApexChart\r\n        series={series}\r\n        options={options}\r\n        type=\"line\"\r\n        height={200}\r\n      />\r\n    </React.Suspense>\r\n  );\r\n}\r\n","// Страница отчётов с фильтром по датам\r\nimport React from \"react\";\r\nimport ReportFilterForm from \"../components/ReportFilterForm\";\r\nimport KPIOverview from \"../components/KPIOverview\";\r\nimport TasksChart from \"../components/TasksChart\";\r\nimport authFetch from \"../utils/authFetch\";\r\nimport { Button } from \"../components/ui/button\";\r\nimport { showToast } from \"../utils/toast\";\r\n\r\nexport default function Reports() {\r\n  const [kpi, setKpi] = React.useState({ count: 0, time: 0 });\r\n  const [filters, setFilters] = React.useState<{ from?: string; to?: string }>({});\r\n  const [downloading, setDownloading] = React.useState({\r\n    pdf: false,\r\n    xlsx: false,\r\n  });\r\n\r\n  const normalizePeriod = (source?: { from?: string; to?: string }) => {\r\n    const normalized: { from?: string; to?: string } = {};\r\n    if (source?.from) {\r\n      const trimmed = source.from.trim();\r\n      if (trimmed) normalized.from = trimmed;\r\n    }\r\n    if (source?.to) {\r\n      const trimmed = source.to.trim();\r\n      if (trimmed) normalized.to = trimmed;\r\n    }\r\n    return normalized;\r\n  };\r\n\r\n  const buildQuery = (period: { from?: string; to?: string }) => {\r\n    const params = new URLSearchParams();\r\n    if (period.from) params.set(\"from\", period.from);\r\n    if (period.to) params.set(\"to\", period.to);\r\n    const query = params.toString();\r\n    return query ? `?${query}` : \"\";\r\n  };\r\n\r\n  const extractFilename = (header: string | null, fallback: string) => {\r\n    if (!header) return fallback;\r\n    const match = header.match(/filename\\*?=(?:UTF-8'')?\"?([^\";]+)/i);\r\n    if (match && match[1]) {\r\n      try {\r\n        return decodeURIComponent(match[1]);\r\n      } catch {\r\n        return match[1];\r\n      }\r\n    }\r\n    return fallback;\r\n  };\r\n\r\n  const handleDownload = React.useCallback(\r\n    async (kind: \"pdf\" | \"xlsx\") => {\r\n      setDownloading((prev) => ({ ...prev, [kind]: true }));\r\n      try {\r\n        const query = buildQuery(filters);\r\n        const endpoint =\r\n          kind === \"pdf\"\r\n            ? `/api/v1/tasks/report.pdf${query}`\r\n            : `/api/v1/tasks/report.xlsx${query}`;\r\n        const res = await authFetch(endpoint, { noRedirect: true });\r\n        if (!res.ok) {\r\n          throw new Error(`HTTP ${res.status}`);\r\n        }\r\n        const blob = await res.blob();\r\n        const disposition = res.headers.get(\"Content-Disposition\");\r\n        const fallbackName =\r\n          kind === \"pdf\" ? \"tasks-report.pdf\" : \"tasks-report.xlsx\";\r\n        const filename = extractFilename(disposition, fallbackName);\r\n        const url = window.URL.createObjectURL(blob);\r\n        const link = document.createElement(\"a\");\r\n        link.href = url;\r\n        link.download = filename;\r\n        document.body.appendChild(link);\r\n        link.click();\r\n        link.remove();\r\n        window.URL.revokeObjectURL(url);\r\n      } catch (error) {\r\n        console.error(\"report download error\", error);\r\n        showToast(\"Не удалось скачать отчёт\", \"error\");\r\n      } finally {\r\n        setDownloading((prev) => ({ ...prev, [kind]: false }));\r\n      }\r\n    },\r\n    [filters],\r\n  );\r\n\r\n  const fetchSummary = React.useCallback((period: { from?: string; to?: string }) => {\r\n    authFetch(`/api/v1/tasks/report/summary${buildQuery(period)}`)\r\n      .then((r) => (r.ok ? r.json() : { count: 0, time: 0 }))\r\n      .then(setKpi);\r\n  }, []);\r\n\r\n  const load = (next?: { from?: string; to?: string }) => {\r\n    const normalized = normalizePeriod(next);\r\n    setFilters(normalized);\r\n    fetchSummary(normalized);\r\n  };\r\n\r\n  React.useEffect(() => {\r\n    fetchSummary({});\r\n  }, [fetchSummary]);\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"space-y-4 rounded-lg bg-white p-4 shadow-sm\">\r\n        <h2 className=\"text-xl font-semibold\">Отчёты</h2>\r\n        <ReportFilterForm onChange={load} />\r\n        <KPIOverview count={kpi.count} time={kpi.time} />\r\n        <div className=\"flex flex-wrap gap-2\">\r\n          <Button\r\n            onClick={() => handleDownload(\"pdf\")}\r\n            disabled={downloading.pdf}\r\n          >\r\n            {downloading.pdf ? \"Формируем PDF...\" : \"Скачать PDF\"}\r\n          </Button>\r\n          <Button\r\n            variant=\"outline\"\r\n            onClick={() => handleDownload(\"xlsx\")}\r\n            disabled={downloading.xlsx}\r\n          >\r\n            {downloading.xlsx ? \"Формируем Excel...\" : \"Скачать Excel\"}\r\n          </Button>\r\n        </div>\r\n      </div>\r\n      <div className=\"space-y-4 rounded-lg bg-white p-4 shadow-sm\">\r\n        <h3 className=\"text-lg font-semibold\">Динамика задач</h3>\r\n        <TasksChart filters={filters} />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"file":"js/Reports-D1Fdz2IK.js"}