{"version":3,"file":"TasksPage-CgRQdO4R.js","sources":["../../../web/src/pages/TasksPage.tsx"],"sourcesContent":["// Назначение файла: список задач с таблицей DataTable\r\n// Модули: React, контексты, сервисы задач, shared\r\nimport React from \"react\";\r\nimport { useSearchParams } from \"react-router-dom\";\r\nimport TaskTable from \"../components/TaskTable\";\r\nimport useTasks from \"../context/useTasks\";\r\nimport {\r\n  useTaskIndex,\r\n  useTaskIndexMeta,\r\n} from \"../controllers/taskStateController\";\r\nimport { fetchTasks } from \"../services/tasks\";\r\nimport authFetch from \"../utils/authFetch\";\r\nimport { type Task, type User } from \"shared\";\r\nimport { useAuth } from \"../context/useAuth\";\r\n\r\ntype TaskExtra = Task & {\r\n  assigned_user_id?: number;\r\n  [key: string]: unknown;\r\n};\r\n\r\nexport default function TasksPage() {\r\n  const [page, setPage] = React.useState(0);\r\n  const [users, setUsers] = React.useState<User[]>([]);\r\n  const [loading, setLoading] = React.useState(true);\r\n  const [params, setParams] = useSearchParams();\r\n  const [mine, setMine] = React.useState(params.get(\"mine\") === \"1\");\r\n  const { version, refresh, controller, filters, setFilterUsers } = useTasks();\r\n  const { user, loading: authLoading } = useAuth();\r\n  const isAdmin = user?.role === \"admin\";\r\n  const isManager = user?.role === \"manager\";\r\n  const hasPermission = user?.permissions?.includes(\"tasks\");\r\n  const permissionsList = Array.isArray(user?.permissions)\r\n    ? user?.permissions\r\n    : null;\r\n  const hasExplicitPermissions = (permissionsList?.length ?? 0) > 0;\r\n  const isPrivileged = isAdmin || isManager;\r\n  const canView = isPrivileged || hasPermission || !hasExplicitPermissions;\r\n\r\n  const effectiveMine = isPrivileged ? mine : true;\r\n\r\n  const filterSignature = React.useMemo(() => {\r\n    const statusKey = [...filters.status].sort().join(\",\");\r\n    const priorityKey = [...filters.priority].sort().join(\",\");\r\n    const typeKey = [...filters.taskTypes].sort().join(\",\");\r\n    const assigneeKey = [...filters.assignees].sort((a, b) => a - b).join(\",\");\r\n    return [\r\n      statusKey,\r\n      priorityKey,\r\n      typeKey,\r\n      assigneeKey,\r\n      filters.from,\r\n      filters.to,\r\n    ].join(\"|\");\r\n  }, [filters]);\r\n\r\n  const scopeKey = React.useMemo(() => {\r\n    const userKey = user?.telegram_id ? String(user.telegram_id) : \"anon\";\r\n    const mineKey = effectiveMine ? \"mine\" : \"all\";\r\n    return `tasks:task:${userKey}:${mineKey}:page=${page + 1}:filters=${filterSignature}`;\r\n  }, [effectiveMine, filterSignature, page, user?.telegram_id]);\r\n\r\n  const tasks = useTaskIndex(scopeKey) as TaskExtra[];\r\n  const meta = useTaskIndexMeta(scopeKey);\r\n\r\n  const updateFilterUserList = React.useCallback(\r\n    (list: User[]) => {\r\n      const map = new Map<number, { id: number; name: string; username?: string | null }>();\r\n      list.forEach((item) => {\r\n        const id = Number(item.telegram_id);\r\n        if (!Number.isFinite(id)) return;\r\n        const displayName =\r\n          (typeof item.name === \"string\" && item.name.trim().length > 0\r\n            ? item.name.trim()\r\n            : item.username) ?? `ID ${id}`;\r\n        map.set(id, {\r\n          id,\r\n          name: displayName,\r\n          username: item.username ?? null,\r\n        });\r\n      });\r\n      setFilterUsers(Array.from(map.values()).sort((a, b) => a.name.localeCompare(b.name, \"ru\")));\r\n    },\r\n    [setFilterUsers],\r\n  );\r\n\r\n  const load = React.useCallback(() => {\r\n    if (!user?.telegram_id) {\r\n      controller.setIndex(scopeKey, [], {\r\n        kind: \"task\",\r\n        mine: effectiveMine,\r\n        userId: undefined,\r\n        pageSize: 25,\r\n        total: 0,\r\n        sort: \"desc\",\r\n      });\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    setLoading(true);\r\n    const queryParams: Record<string, unknown> = {\r\n      page: page + 1,\r\n      limit: 25,\r\n      mine: !isPrivileged || mine ? 1 : undefined,\r\n      kind: \"task\",\r\n    };\r\n    if (filters.status.length) {\r\n      queryParams.status = filters.status.join(\",\");\r\n    }\r\n    if (filters.taskTypes.length) {\r\n      queryParams.taskType = filters.taskTypes.join(\",\");\r\n    }\r\n    if (filters.assignees.length) {\r\n      queryParams.assignees = filters.assignees.join(\",\");\r\n    }\r\n    fetchTasks(queryParams, user.telegram_id, true)\r\n      .then((data) => {\r\n        const rawTasks = data.tasks as TaskExtra[];\r\n        const filteredTasks = isPrivileged\r\n          ? rawTasks\r\n          : rawTasks.filter((t) => {\r\n              const assigned =\r\n                t.assignees || (t.assigned_user_id ? [t.assigned_user_id] : []);\r\n              const uid = user.telegram_id;\r\n              return assigned.includes(uid) || t.created_by === uid;\r\n            });\r\n        controller.setIndex(scopeKey, filteredTasks, {\r\n          kind: \"task\",\r\n          mine: effectiveMine,\r\n          userId: user.telegram_id,\r\n          pageSize: 25,\r\n          total: data.total || filteredTasks.length,\r\n          sort: \"desc\",\r\n        });\r\n        const list = Array.isArray(data.users)\r\n          ? (data.users as User[])\r\n          : (Object.values(data.users || {}) as User[]);\r\n        setUsers(list);\r\n        updateFilterUserList(list);\r\n      })\r\n      .finally(() => setLoading(false));\r\n    if (isPrivileged) {\r\n      authFetch(\"/api/v1/users\")\r\n        .then((r) => (r.ok ? r.json() : []))\r\n        .then((list) => {\r\n          const normalized = Array.isArray(list)\r\n            ? (list as User[])\r\n            : (Object.values(list || {}) as User[]);\r\n          setUsers(normalized);\r\n          updateFilterUserList(normalized);\r\n        })\r\n        .catch(() => undefined);\r\n    }\r\n  }, [\r\n    controller,\r\n    effectiveMine,\r\n    isPrivileged,\r\n    mine,\r\n    page,\r\n    scopeKey,\r\n    user,\r\n    filters,\r\n    updateFilterUserList,\r\n  ]);\r\n\r\n  React.useEffect(() => {\r\n    if (authLoading) return;\r\n    if (isPrivileged) return;\r\n    if (!mine) {\r\n      setMine(true);\r\n    }\r\n    if (params.get(\"mine\") !== \"1\") {\r\n      const next = new URLSearchParams(params);\r\n      next.set(\"mine\", \"1\");\r\n      setParams(next, { replace: true });\r\n    }\r\n  }, [authLoading, isPrivileged, mine, params, setParams]);\r\n\r\n  React.useEffect(() => {\r\n    if (authLoading) return;\r\n    if (!canView) return;\r\n    if (!user?.telegram_id) return;\r\n    load();\r\n    // после загрузки профиля инициируем загрузку задач\r\n  }, [authLoading, user, load, version, page, mine, canView]);\r\n\r\n  const userMap = React.useMemo(() => {\r\n    const map: Record<number, User> = {};\r\n    users.forEach((u) => {\r\n      map[u.telegram_id] = u;\r\n    });\r\n    return map;\r\n  }, [users]);\r\n\r\n  if (authLoading) return <div>Загрузка...</div>;\r\n  if (!canView)\r\n    return <div className=\"p-4\">У вас нет прав для просмотра задач</div>;\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <h2 className=\"text-2xl font-semibold text-slate-900 dark:text-slate-100\">\r\n        Панель управления задачами\r\n      </h2>\r\n      {loading && <div>Загрузка...</div>}\r\n      <TaskTable\r\n        tasks={tasks}\r\n        users={userMap}\r\n        page={page}\r\n        pageCount={Math.ceil((meta.total ?? tasks.length) / 25)}\r\n        mine={isPrivileged ? mine : true}\r\n        onPageChange={setPage}\r\n        onMineChange={\r\n          isPrivileged\r\n            ? (v) => {\r\n                setMine(v);\r\n                if (v) params.set(\"mine\", \"1\");\r\n                else params.delete(\"mine\");\r\n                setParams(params);\r\n              }\r\n            : undefined\r\n        }\r\n        onRowClick={(id) => {\r\n          params.set(\"task\", id);\r\n          setParams(params);\r\n        }}\r\n        toolbarChildren={\r\n          <>\r\n            <button\r\n              onClick={refresh}\r\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\r\n            >\r\n              Обновить\r\n            </button>\r\n            <button\r\n              onClick={() => {\r\n                params.set(\"newTask\", \"1\");\r\n                setParams(params);\r\n              }}\r\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\r\n            >\r\n              Новая задача\r\n            </button>\r\n          </>\r\n        }\r\n      />\r\n    </div>\r\n  );\r\n}\r\n"],"names":["TasksPage","page","setPage","React","users","setUsers","loading","setLoading","params","setParams","useSearchParams","mine","setMine","version","refresh","controller","filters","setFilterUsers","useTasks","user","authLoading","useAuth","isAdmin","isManager","hasPermission","_a","permissionsList","hasExplicitPermissions","_b","isPrivileged","canView","effectiveMine","filterSignature","statusKey","priorityKey","typeKey","assigneeKey","a","b","scopeKey","userKey","mineKey","tasks","useTaskIndex","meta","useTaskIndexMeta","updateFilterUserList","list","map","item","id","displayName","load","queryParams","fetchTasks","data","rawTasks","filteredTasks","t","assigned","uid","authFetch","r","normalized","next","userMap","u","jsx","jsxs","TaskTable","_c","v","Fragment"],"mappings":"8TAoBA,SAAwBA,IAAY,WAClC,KAAM,CAACC,EAAMC,CAAO,EAAIC,EAAM,SAAS,CAAC,EAClC,CAACC,EAAOC,CAAQ,EAAIF,EAAM,SAAiB,CAAA,CAAE,EAC7C,CAACG,EAASC,CAAU,EAAIJ,EAAM,SAAS,EAAI,EAC3C,CAACK,EAAQC,CAAS,EAAIC,EAAA,EACtB,CAACC,EAAMC,CAAO,EAAIT,EAAM,SAASK,EAAO,IAAI,MAAM,IAAM,GAAG,EAC3D,CAAE,QAAAK,EAAS,QAAAC,EAAS,WAAAC,EAAY,QAAAC,EAAS,eAAAC,CAAA,EAAmBC,EAAA,EAC5D,CAAE,KAAAC,EAAM,QAASC,CAAA,EAAgBC,EAAA,EACjCC,GAAUH,GAAA,YAAAA,EAAM,QAAS,QACzBI,GAAYJ,GAAA,YAAAA,EAAM,QAAS,UAC3BK,GAAgBC,EAAAN,GAAA,YAAAA,EAAM,cAAN,YAAAM,EAAmB,SAAS,SAC5CC,EAAkB,MAAM,QAAQP,GAAA,YAAAA,EAAM,WAAW,EACnDA,GAAA,YAAAA,EAAM,YACN,KACEQ,IAA0BC,EAAAF,GAAA,YAAAA,EAAiB,SAAjB,KAAAE,EAA2B,GAAK,EAC1DC,EAAeP,GAAWC,EAC1BO,EAAUD,GAAgBL,GAAiB,CAACG,EAE5CI,EAAgBF,EAAelB,EAAO,GAEtCqB,EAAkB7B,EAAM,QAAQ,IAAM,CAC1C,MAAM8B,EAAY,CAAC,GAAGjB,EAAQ,MAAM,EAAE,KAAA,EAAO,KAAK,GAAG,EAC/CkB,EAAc,CAAC,GAAGlB,EAAQ,QAAQ,EAAE,KAAA,EAAO,KAAK,GAAG,EACnDmB,EAAU,CAAC,GAAGnB,EAAQ,SAAS,EAAE,KAAA,EAAO,KAAK,GAAG,EAChDoB,EAAc,CAAC,GAAGpB,EAAQ,SAAS,EAAE,KAAK,CAACqB,EAAGC,IAAMD,EAAIC,CAAC,EAAE,KAAK,GAAG,EACzE,MAAO,CACLL,EACAC,EACAC,EACAC,EACApB,EAAQ,KACRA,EAAQ,EAAA,EACR,KAAK,GAAG,CACZ,EAAG,CAACA,CAAO,CAAC,EAENuB,EAAWpC,EAAM,QAAQ,IAAM,CACnC,MAAMqC,EAAUrB,GAAA,MAAAA,EAAM,YAAc,OAAOA,EAAK,WAAW,EAAI,OACzDsB,EAAUV,EAAgB,OAAS,MACzC,MAAO,cAAc,OAAAS,EAAO,KAAI,OAAAC,EAAO,UAAS,OAAAxC,EAAO,EAAC,aAAY,OAAA+B,EACtE,EAAG,CAACD,EAAeC,EAAiB/B,EAAMkB,GAAA,YAAAA,EAAM,WAAW,CAAC,EAEtDuB,EAAQC,EAAaJ,CAAQ,EAC7BK,EAAOC,EAAiBN,CAAQ,EAEhCO,EAAuB3C,EAAM,YAChC4C,GAAiB,CAChB,MAAMC,MAAU,IAChBD,EAAK,QAASE,GAAS,SACrB,MAAMC,EAAK,OAAOD,EAAK,WAAW,EAClC,GAAI,CAAC,OAAO,SAASC,CAAE,EAAG,OAC1B,MAAMC,GACH1B,EAAA,OAAOwB,EAAK,MAAS,UAAYA,EAAK,KAAK,OAAO,OAAS,EACxDA,EAAK,KAAK,KAAA,EACVA,EAAK,WAFR,KAAAxB,EAEqB,MAAM,OAAAyB,GAC9BF,EAAI,IAAIE,EAAI,CACV,GAAAA,EACA,KAAMC,EACN,UAAUvB,EAAAqB,EAAK,WAAL,KAAArB,EAAiB,IAAA,CAC5B,CACH,CAAC,EACDX,EAAe,MAAM,KAAK+B,EAAI,OAAA,CAAQ,EAAE,KAAK,CAACX,EAAGC,IAAMD,EAAE,KAAK,cAAcC,EAAE,KAAM,IAAI,CAAC,CAAC,CAC5F,EACA,CAACrB,CAAc,CAAA,EAGXmC,EAAOjD,EAAM,YAAY,IAAM,CACnC,GAAI,EAACgB,GAAA,MAAAA,EAAM,aAAa,CACtBJ,EAAW,SAASwB,EAAU,GAAI,CAChC,KAAM,OACN,KAAMR,EACN,OAAQ,OACR,SAAU,GACV,MAAO,EACP,KAAM,MAAA,CACP,EACDxB,EAAW,EAAK,EAChB,MACF,CACAA,EAAW,EAAI,EACf,MAAM8C,EAAuC,CAC3C,KAAMpD,EAAO,EACb,MAAO,GACP,KAAM,CAAC4B,GAAgBlB,EAAO,EAAI,OAClC,KAAM,MAAA,EAEJK,EAAQ,OAAO,SACjBqC,EAAY,OAASrC,EAAQ,OAAO,KAAK,GAAG,GAE1CA,EAAQ,UAAU,SACpBqC,EAAY,SAAWrC,EAAQ,UAAU,KAAK,GAAG,GAE/CA,EAAQ,UAAU,SACpBqC,EAAY,UAAYrC,EAAQ,UAAU,KAAK,GAAG,GAEpDsC,EAAWD,EAAalC,EAAK,YAAa,EAAI,EAC3C,KAAMoC,GAAS,CACd,MAAMC,EAAWD,EAAK,MAChBE,EAAgB5B,EAClB2B,EACAA,EAAS,OAAQE,GAAM,CACrB,MAAMC,EACJD,EAAE,YAAcA,EAAE,iBAAmB,CAACA,EAAE,gBAAgB,EAAI,IACxDE,EAAMzC,EAAK,YACjB,OAAOwC,EAAS,SAASC,CAAG,GAAKF,EAAE,aAAeE,CACpD,CAAC,EACL7C,EAAW,SAASwB,EAAUkB,EAAe,CAC3C,KAAM,OACN,KAAM1B,EACN,OAAQZ,EAAK,YACb,SAAU,GACV,MAAOoC,EAAK,OAASE,EAAc,OACnC,KAAM,MAAA,CACP,EACD,MAAMV,EAAO,MAAM,QAAQQ,EAAK,KAAK,EAChCA,EAAK,MACL,OAAO,OAAOA,EAAK,OAAS,CAAA,CAAE,EACnClD,EAAS0C,CAAI,EACbD,EAAqBC,CAAI,CAC3B,CAAC,EACA,QAAQ,IAAMxC,EAAW,EAAK,CAAC,EAC9BsB,GACFgC,EAAU,eAAe,EACtB,KAAMC,GAAOA,EAAE,GAAKA,EAAE,KAAA,EAAS,CAAA,CAAG,EAClC,KAAMf,GAAS,CACd,MAAMgB,EAAa,MAAM,QAAQhB,CAAI,EAChCA,EACA,OAAO,OAAOA,GAAQ,EAAE,EAC7B1C,EAAS0D,CAAU,EACnBjB,EAAqBiB,CAAU,CACjC,CAAC,EACA,MAAM,IAAA,EAAe,CAE5B,EAAG,CACDhD,EACAgB,EACAF,EACAlB,EACAV,EACAsC,EACApB,EACAH,EACA8B,CAAA,CACD,EAED3C,EAAM,UAAU,IAAM,CACpB,GAAI,CAAAiB,GACA,CAAAS,IACClB,GACHC,EAAQ,EAAI,EAEVJ,EAAO,IAAI,MAAM,IAAM,KAAK,CAC9B,MAAMwD,EAAO,IAAI,gBAAgBxD,CAAM,EACvCwD,EAAK,IAAI,OAAQ,GAAG,EACpBvD,EAAUuD,EAAM,CAAE,QAAS,EAAA,CAAM,CACnC,CACF,EAAG,CAAC5C,EAAaS,EAAclB,EAAMH,EAAQC,CAAS,CAAC,EAEvDN,EAAM,UAAU,IAAM,CAChBiB,GACCU,GACAX,GAAA,MAAAA,EAAM,aACXiC,EAAA,CAEF,EAAG,CAAChC,EAAaD,EAAMiC,EAAMvC,EAASZ,EAAMU,EAAMmB,CAAO,CAAC,EAE1D,MAAMmC,EAAU9D,EAAM,QAAQ,IAAM,CAClC,MAAM6C,EAA4B,CAAA,EAClC,OAAA5C,EAAM,QAAS8D,GAAM,CACnBlB,EAAIkB,EAAE,WAAW,EAAIA,CACvB,CAAC,EACMlB,CACT,EAAG,CAAC5C,CAAK,CAAC,EAEV,OAAIgB,EAAoB+C,EAAAA,IAAC,MAAA,CAAI,SAAA,cAAW,EACnCrC,EAGHsC,EAAAA,KAAC,MAAA,CAAI,UAAU,YACb,SAAA,CAAAD,EAAAA,IAAC,KAAA,CAAG,UAAU,4DAA4D,SAAA,6BAE1E,EACC7D,GAAW6D,EAAAA,IAAC,MAAA,CAAI,SAAA,aAAA,CAAW,EAC5BA,EAAAA,IAACE,EAAA,CACC,MAAA3B,EACA,MAAOuB,EACP,KAAAhE,EACA,UAAW,KAAK,OAAMqE,EAAA1B,EAAK,QAAL,KAAA0B,EAAc5B,EAAM,QAAU,EAAE,EACtD,KAAMb,EAAelB,EAAO,GAC5B,aAAcT,EACd,aACE2B,EACK0C,GAAM,CACL3D,EAAQ2D,CAAC,EACLA,EAAG/D,EAAO,IAAI,OAAQ,GAAG,EACxBA,EAAO,OAAO,MAAM,EACzBC,EAAUD,CAAM,CAClB,EACA,OAEN,WAAa0C,GAAO,CAClB1C,EAAO,IAAI,OAAQ0C,CAAE,EACrBzC,EAAUD,CAAM,CAClB,EACA,gBACE4D,EAAAA,KAAAI,WAAA,CACE,SAAA,CAAAL,EAAAA,IAAC,SAAA,CACC,QAASrD,EACT,UAAU,qEACX,SAAA,UAAA,CAAA,EAGDqD,EAAAA,IAAC,SAAA,CACC,QAAS,IAAM,CACb3D,EAAO,IAAI,UAAW,GAAG,EACzBC,EAAUD,CAAM,CAClB,EACA,UAAU,qEACX,SAAA,cAAA,CAAA,CAED,CAAA,CACF,CAAA,CAAA,CAEJ,EACF,EAhDO2D,EAAAA,IAAC,MAAA,CAAI,UAAU,MAAM,SAAA,qCAAkC,CAkDlE"}