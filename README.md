<!-- Назначение файла: краткое описание возможностей проекта. Основные модули: api, web. -->

# ERM Telegram Web Bot (v2.2) ![Quality checks](https://img.shields.io/badge/Codex-Quality%20Gate-blue)

Этот монорепозиторий содержит модульную систему управления ресурсами предприятия, объединяющую телеграм‑бота, REST API и веб‑дашборд.

Архитектура

Проект структурирован как рабочее пространство PNPM и состоит из нескольких пакетов:

apps/api – API на базе Node.js/Express, написанное на TypeScript. Реализует REST‑эндпоинты для задач, заявок, пользователей, ролей, журналов, справочников, журнала событий, аналитики, маршрутизации и прочего. API использует MongoDB через Mongoose и внедрение зависимостей с помощью tsyringe. Фоновые задания на базе BullMQ обрабатывают геокодирование, маршрутизацию и отправку уведомлений.

apps/bot – телеграм‑бот на Telegraf. Предоставляет интерактивные команды для создания задач и заявок, загрузки вложений, просмотра назначенных задач и получения уведомлений.

apps/web – веб‑приложение на React (Vite + Tailwind). Обеспечивает интерфейсы для задач, заявок, архива, журнала событий, файлового менеджера, справочников, аналитики и настроек. Для списков используется TanStack React Table, есть встроенные инструменты экспорта (CSV/XLSX/PDF).

packages/shared – общие типы и утилиты TypeScript, используемые API, ботом и вебом.

packages/logging и packages/monitoring – обеспечивают логирование и метрики Prometheus.

API построено модульно: каждая функциональная зона (аутентификация, задачи, заявки, пользователи, роли, логи, события, аналитика, хранилище, справочники) регистрирует свои контроллеры, DTO, сервисы и защитники. Контроль доступа реализован через маски прав (ACCESS_USER, ACCESS_MANAGER, ACCESS_ADMIN и т.д.). Безопасность включает аутентификацию JWT через cookie HttpOnly, CSRF‑токены, валидацию DTO и ограничение скорости.

Файлы хранятся на диске или в S3‑совместимом хранилище; загрузки происходят частями и сканируются ClamAV и другими антивирусами, чтобы предотвратить опасные вложения.

Функциональные возможности
Задачи и заявки

Создание, редактирование и удаление задач и заявок. Каждая запись имеет поля: статус, приоритет, тип, исполнители, сроки и вложения.

Фильтры и поиск. Фильтрация по статусу, приоритету, типу, исполнителям и диапазону дат; полнотекстовый поиск по заголовкам и описаниям. Для привилегированных пользователей можно переключать режим "Мои" / "Все".

Вложения. Загрузка файлов перетаскиванием или через диалог выбора; все вложения сканируются ClamAV и другими антивирусами.

Просмотр и экспорт. Просмотр задач/заявок в виде таблиц с пагинацией или карточек; экспорт в CSV/XLSX/PDF через встроенный тулбар.

Архив. Завершённые элементы могут быть отправлены в архив; записи из архива можно безвозвратно удалить при наличии прав TASK_DELETE.

Интеграция с ботом. Пользователи могут создавать задачи и заявки прямо в чате, прикреплять файлы и получать уведомления о назначениях.

Справочники и настройки

Раздел Справочники позволяет администраторам управлять организационными данными:

отделы, дивизионы и должности;

объекты (локации), сотрудники, автопарк и основные средства;

пользователи и шаблоны задач.

Каждый справочник поддерживает CRUD‑операции, поиск, фильтры и импорт/экспорт. Формы позволяют устанавливать связи (например, назначать сотрудника в отдел). В разделе настроек также есть вкладки Аналитика, Архив, Логи, Хранилище и Мониторинг.

Файловый менеджер

Загрузка и предпросмотр файлов. Управляйте файлами, связанными с задачами или другими объектами. Поддерживаются предпросмотры изображений, видео, PDF и текста.

Фильтры и сортировка. Поиск по имени, сортировка по размеру/дате/названию, фильтр по типу файла или статусу привязки (все/привязанные/непривязанные).

Проверка хранилища. Анализ использования диска и поиск "осиротевших" файлов через страницу диагностики.

Скачивание и удаление. Скачивайте или удаляйте файлы; изображения и видео можно просматривать прямо в модальном окне.

Журнал событий

Фиксация жизненного цикла активов. Регистрируйте обслуживание, перемещение, передачу и другие операции для основных средств и автопарка. Для каждого события хранятся номер, дата/время, тип, операция, исполнитель, объект, локации и описание.

Создание и редактирование событий. Используйте модальную форму с валидацией и динамическими полями (например, выбор объекта из справочника). Для передач требуется указать начальное и конечное местоположение.

Фильтрация и экспорт. Фильтруйте события по типу, объекту, локации и дате; экспортируйте журнал через действия в таблице.

Аналитика

Встроенные дашборды показывают статистику по планам маршрутов и задачам. Страницы /mg/analytics и /cp/analytics содержат графики и таблицы для менеджеров и администраторов.

Данные можно фильтровать по диапазону дат, объекту и исполнителю. Статистика формируется на основе задач и журнала событий.

Оптимизация маршрутов (экспериментально)

По желанию можно включить решение задачи маршрутизации (VRP) на базе OR‑Tools и GraphHopper/OSRM. При включённом ENABLE_VRP_SOLVER=true API принимает JSON‑планы маршрутов (список точек с координатами, объёмами, временными окнами и т.д.) и возвращает оптимальные маршруты.

Переменные GRAPH_HOPPER_API_KEY и GRAPH_HOPPER_BASE_URL задают внешнюю матрицу расстояний. В репозитории есть прототип на Python для тестирования маршрутов.

Очереди и наблюдаемость

Задачи геокодирования и маршрутизации выполняются асинхронно в очередях BullMQ; статистика (количество, длительность) экспортируется в Prometheus.

API записывает операции с привязкой к пользователям и обеспечивает покрытие тестами и проверку ролей. Требования: менее 1 % ошибок CSRF, полная валидация DTO и применение RBAC.

В CI используется Danger для контроля правил веток, описаний коммитов и покрытия тестами.

Быстрый старт

Необходимые компоненты: Node.js ≥ 18, PNPM или Yarn, MongoDB и Redis. Для оптимизации маршрутов нужны GraphHopper или OSRM и ENABLE_VRP_SOLVER=true.

Установка зависимостей:

pnpm install


Переменные окружения: скопируйте .env.example в .env и укажите значения. Ключевые переменные:

API_PORT=8000
MONGO_URL=mongodb://localhost:27017/erm
JWT_SECRET=ваш_секрет
CSRF_SECRET=ещё_секрет
GRAPH_HOPPER_API_KEY=    # опционально для VRP
ENABLE_VRP_SOLVER=false


Дополнительные переменные задают пути к хранилищу, ключи S3, токен бота, уровни логирования и другие сервисы.

Запуск API и веб‑интерфейса в разработке (два терминала):

# терминал 1: API + воркеры
pnpm dev:api

# терминал 2: веб‑приложение
pnpm dev:web


Запуск телеграм‑бота (опционально):

pnpm dev:bot


Сборка для продакшена:

pnpm build


Запуск в продакшене: соберите артефакты и запустите через pm2 или node apps/api/dist/main.js. Для бота используйте pnpm start:bot.

Конфигурации Docker для MongoDB, Redis и GraphHopper/OSRM находятся в docker-compose.yml. Запустить зависимости локально можно командой docker compose up -d.

Обзор API

REST‑API доступно по префиксу /api/v1. Основные эндпоинты:

POST /auth/login — аутентификация и установка JWT‑cookie.

GET /tasks, POST /tasks, PUT /tasks/:id, DELETE /tasks/:id — управление задачами (используйте kind=request для работы с заявками).

GET /users, POST /users, PUT /users/:id, DELETE /users/:id — управление пользователями.

GET /roles, PUT /roles/:id — управление ролями и правами.

GET /logs — просмотр логов приложения.

GET /files, POST /files/upload, DELETE /files/:id — загрузка и управление файлами.

GET /events — управление журналом событий для основных средств и автопарка.

POST /route-plans — построение маршрутов (при включённом VRP‑решателе).

GET /analytics — получение агрегированной аналитики.

GET /collections/:kind, POST /collections/:kind — вывод и создание элементов справочников (отделы, объекты, сотрудники и т.д.).

Большинство эндпоинтов требуют аутентификации; отправляйте JWT‑cookie и CSRF‑заголовок для запросов, изменяющих состояние. Используйте параметр mine=1, чтобы получать только свои задачи или заявки.

Вклад и качество кода

Используйте Prettier и ESLint для единообразного стиля кода.

Проверяйте типы и запускайте unit‑тесты командой pnpm test.

Не коммитите секреты; храните их только в .env.

CI с помощью Danger и GitHub Actions контролирует имена веток, качество сообщений коммитов, покрытие тестами и наличие ключей локализации.

Лицензия

Проект распространяется по лицензии MIT. Подробности см. в файле LICENSE.

Этот README отражает состояние проекта на 22 января 2026 года (по киевскому времени). Подробная техническая документация находится в docs/technical_manual.md и модулях внутри apps/api и apps/web.
