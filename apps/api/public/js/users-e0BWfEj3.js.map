{"version":3,"file":"users-e0BWfEj3.js","sources":["../../../web/src/services/users.ts"],"sourcesContent":["// Назначение: запросы к API пользователей\r\n// Основные модули: authFetch\r\nimport authFetch from \"../utils/authFetch\";\r\nimport type { User } from \"../types/user\";\r\nimport { normalizeUser, normalizeUsers } from \"./normalizeUser\";\r\n\r\nexport interface UserDetails extends User {\r\n  email?: string;\r\n  mobNumber?: string;\r\n  name?: string;\r\n}\r\n\r\nconst referenceFields = new Set<\r\n  \"roleId\" | \"departmentId\" | \"divisionId\" | \"positionId\"\r\n>([\"roleId\", \"departmentId\", \"divisionId\", \"positionId\"]);\r\n\r\nconst normalizeRoleId = (value?: string) => {\r\n  if (typeof value !== \"string\") return undefined;\r\n  const trimmed = value.trim();\r\n  return trimmed.length > 0 ? trimmed : undefined;\r\n};\r\n\r\nconst buildCreateUserBody = (\r\n  id?: number | string,\r\n  username?: string,\r\n  roleId?: string,\r\n) => {\r\n  const payload: Record<string, unknown> = {};\r\n  if (id !== undefined) {\r\n    payload.id = id;\r\n  }\r\n  if (typeof username === \"string\") {\r\n    const trimmed = username.trim();\r\n    if (trimmed.length > 0) {\r\n      payload.username = trimmed;\r\n    }\r\n  } else if (username !== undefined) {\r\n    payload.username = username;\r\n  }\r\n  const normalizedRoleId = normalizeRoleId(roleId);\r\n  if (normalizedRoleId) {\r\n    payload.roleId = normalizedRoleId;\r\n  }\r\n  return payload;\r\n};\r\n\r\nconst sanitizeUserUpdatePayload = (data: Partial<User>): Partial<User> => {\r\n  const payload: Partial<User> = {};\r\n  (Object.entries(data) as [keyof User, User[keyof User]][]).forEach(\r\n    ([key, value]) => {\r\n      if (value === undefined || value === null) {\r\n        return;\r\n      }\r\n      if (typeof value === \"string\") {\r\n        const trimmed = value.trim();\r\n        if (\r\n          referenceFields.has(\r\n            key as \"roleId\" | \"departmentId\" | \"divisionId\" | \"positionId\",\r\n          )\r\n        ) {\r\n          if (trimmed.length === 0) {\r\n            return;\r\n          }\r\n          payload[key] = trimmed as User[keyof User];\r\n          return;\r\n        }\r\n        payload[key] = trimmed as User[keyof User];\r\n        return;\r\n      }\r\n      payload[key] = value;\r\n    },\r\n  );\r\n  return payload;\r\n};\r\n\r\nexport const fetchUser = async (\r\n  id: number | string,\r\n): Promise<UserDetails | null> => {\r\n  const res = await authFetch(`/api/v1/users/${id}`, { noRedirect: true });\r\n  if (res.status === 404) return null;\r\n  if (!res.ok) {\r\n    const text = await res.text().catch(() => \"\");\r\n    throw new Error(text || \"Не удалось загрузить пользователя\");\r\n  }\r\n  const data = await res.json();\r\n  return normalizeUser(data) as UserDetails;\r\n};\r\n\r\nexport const fetchUsers = async (): Promise<User[]> => {\r\n  const response = await authFetch(\"/api/v1/users\");\r\n  if (response.ok) {\r\n    const data = await response.json();\r\n    return Array.isArray(data) ? (normalizeUsers(data) as User[]) : [];\r\n  }\r\n  const text = await response.text().catch(() => \"\");\r\n  throw new Error(text || \"Не удалось загрузить пользователей\");\r\n};\r\n\r\nexport const createUser = (\r\n  id?: number | string,\r\n  username?: string,\r\n  roleId?: string,\r\n) => {\r\n  const body = buildCreateUserBody(id, username, roleId);\r\n  return authFetch(\"/api/v1/users\", {\r\n    method: \"POST\",\r\n    confirmed: true,\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify(body),\r\n  }).then(async (r) => {\r\n    if (!r.ok) {\r\n      const body = await r.text().catch(() => \"\");\r\n      let message = \"Не удалось создать пользователя\";\r\n      if (body) {\r\n        try {\r\n          const data = JSON.parse(body) as {\r\n            error?: string;\r\n            message?: string;\r\n            detail?: string;\r\n          };\r\n          message = data.error || data.detail || data.message || message;\r\n        } catch {\r\n          message = body;\r\n        }\r\n      }\r\n      throw new Error(message);\r\n    }\r\n    const data = await r.json();\r\n    return normalizeUser(data);\r\n  });\r\n};\r\n\r\nexport interface GeneratedUserCredentials {\r\n  telegram_id: number;\r\n  username: string;\r\n}\r\n\r\nexport const previewUserCredentials = (\r\n  id?: number | string,\r\n  username?: string,\r\n): Promise<GeneratedUserCredentials> =>\r\n  authFetch(`/api/v1/users?preview=1`, {\r\n    method: \"POST\",\r\n    confirmed: true,\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify({ id, username }),\r\n  }).then(async (r) => {\r\n    if (!r.ok) {\r\n      const body = await r.text().catch(() => \"\");\r\n      let message = \"Не удалось получить сгенерированные данные\";\r\n      if (body) {\r\n        try {\r\n          const parsed = JSON.parse(body) as {\r\n            error?: string;\r\n            detail?: string;\r\n            message?: string;\r\n          };\r\n          message = parsed.error || parsed.detail || parsed.message || message;\r\n        } catch {\r\n          message = body;\r\n        }\r\n      }\r\n      throw new Error(message);\r\n    }\r\n    return r.json();\r\n  });\r\n\r\nexport const updateUser = (\r\n  id: number | string,\r\n  data: Partial<User>,\r\n): Promise<UserDetails | null> => {\r\n  const body = sanitizeUserUpdatePayload(data);\r\n  return authFetch(`/api/v1/users/${id}`, {\r\n    method: \"PATCH\",\r\n    confirmed: true,\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify(body),\r\n  }).then(async (r) => {\r\n    if (!r.ok) {\r\n      const body = await r.text().catch(() => \"\");\r\n      let message = \"Не удалось обновить пользователя\";\r\n      if (body) {\r\n        try {\r\n          const parsed = JSON.parse(body) as {\r\n            error?: string;\r\n            detail?: string;\r\n            message?: string;\r\n          };\r\n          message = parsed.error || parsed.detail || parsed.message || message;\r\n        } catch {\r\n          message = body;\r\n        }\r\n      }\r\n      throw new Error(message);\r\n    }\r\n    const data = await r.json();\r\n    return normalizeUser(data) as UserDetails;\r\n  });\r\n};\r\n\r\nexport const deleteUser = async (id: number | string): Promise<void> => {\r\n  const response = await authFetch(`/api/v1/users/${id}`, {\r\n    method: \"DELETE\",\r\n    confirmed: true,\r\n  });\r\n  if (response.status === 404) {\r\n    throw new Error(\"Пользователь не найден\");\r\n  }\r\n  if (!response.ok) {\r\n    const body = await response.text().catch(() => \"\");\r\n    throw new Error(body || \"Не удалось удалить пользователя\");\r\n  }\r\n};\r\n"],"names":["referenceFields","normalizeRoleId","value","trimmed","buildCreateUserBody","id","username","roleId","payload","normalizedRoleId","sanitizeUserUpdatePayload","data","key","fetchUser","res","authFetch","text","normalizeUser","fetchUsers","response","normalizeUsers","createUser","body","r","message","e","previewUserCredentials","parsed","updateUser","deleteUser"],"mappings":"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"}