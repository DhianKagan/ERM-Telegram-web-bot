<!-- Назначение файла: обзор архитектуры и модулей проекта (Auth, Tasks, Users, Roles, Logs). -->

# Архитектура

## Цель проекта

Перейти от монолитного JavaScript‑кода к модульной архитектуре на TypeScript,
используя Express и MongoDB. Структура вдохновлена подходами NestJS:
чёткое разделение слоёв, DTO‑валидация и декораторы для RBAC.
Конфигурации ESLint, Prettier и Babel написаны на TypeScript, `scripts/check_no_js.sh` исключает возврат к JavaScript.

## Структура каталогов

```
src/
  common/
  decorators/
  guards/
  dto/
  error-handler.ts
  logger.ts
  modules/
    auth/
    tasks/
    users/
    roles/
    logs/
  config/
  app.ts
web/
```

## Технологии и подходы

- Express + TypeScript, MongoDB через Mongoose.
- Внедрение зависимостей через `tsyringe`.
- DTO и `class-validator` для валидации входных данных.
- Декораторы `@Roles` и guard `rolesGuard` для проверки маски доступа.
- Middleware для логирования и метрик Prometheus.
- Секреты загружаются через HashiCorp Vault или AWS Secrets Manager,
  ключи обновляются планировщиком `KEY_ROTATION_CRON`.

## Модульная структура

- **AuthModule** — аутентификация через Telegram, выдача JWT и CSRF‑токена.
- **TasksModule** — CRUD задач и расчёт маршрутов.
- **UsersModule** — управление пользователями.
- **RolesModule** — описание ролей и масок доступа.
- **LogsModule** — журналирование действий.

## Файловый сервис

- Коллекция `File` хранит `taskId`, `userId`, `name`, `path`, `type`, `size` и `uploadedAt`.
- Контроллер `/api/v1/tasks/:taskId/files` управляет загрузкой и перечнем вложений, проверяя роли участников задачи.
- Скачивание и удаление выполняются через `/api/v1/files/:id`, разрешено автору задачи, загрузчику и администраторам.
- Подробная схема и миграция описаны в `docs/file_service_refactor.md`.

Модули связаны через сервисы и разделены по ответственности,
что упрощает тестирование и расширение функциональности.
Поле `access` модели пользователя хранит числовую маску для быстрой проверки прав.

## Оркестратор стека

- `StackOrchestratorService` объединяет диагностику хранилища и сводку анализа логов Railway, полученную из `LogAnalysisService`.
- Контроллер `StackOrchestratorController` экспортирует маршруты `/api/v1/system/overview` и `/api/v1/system/log-analysis/latest`, чтобы фронтенд получал актуальные данные.
- Страница хранилища отображает карточку «Анализ логов Railway» с количеством ошибок, предупреждений и автозапускаемых команд, обеспечивая прозрачный обмен информацией между контролёрами.

## Веб‑клиент: страницы задач

- Основной маршрут `/tasks` подключает компонент `TasksPage` через ленивую загрузку в `AuthenticatedApp.tsx`.
- В каталоге `apps/web/src/pages` остался компонент `Tasks.tsx`,
  повторяющий упрощённый список задач и не используемый в маршрутах.
- План вывода из эксплуатации: (1) зафиксировать отсутствие прямых импортов, (2) подготовить редирект либо расширить `TasksPage` для legacy‑сценариев, (3) удалить файл и связанный код после обновления тестов и документации.

## Этапы внедрения

1. Настроить DI‑контейнер и структуру модулей.
2. Создать DTO и middleware для валидации.
3. Реализовать декораторы и guards для RBAC.
4. Перенести авторизацию, затем Tasks, Users, Roles и Logs.
5. Подключить логирование и метрики Prometheus.
6. Покрыть код тестами.

## KPI

- Ошибки CSRF < 1 %.
- DTO‑валидация покрывает > 95 % POST/PATCH запросов.
- RBAC запрещает изменение чужих задач.
- Тестовое покрытие > 80 %.
- Логи фиксируют `userId` для каждого действия.
