# Назначение файла: автоматический деплой на Railway из ветки main и по запросу.
# Модули: GitHub Actions, pnpm, Railway CLI.
name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

env:
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
  RAILWAY_ENVIRONMENT_ID: ${{ secrets.RAILWAY_ENVIRONMENT_ID }}
  RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
  RAILWAY_SERVICE_NAME: ${{ secrets.RAILWAY_SERVICE_NAME }}
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Установка зависимостей
        run: ./scripts/install_bot_deps.sh
      - name: Сборка проекта
        run: pnpm build
      - name: Установка Railway CLI
        run: npm install -g @railway/cli
      - name: Обновление railway.json секретами
        if: env.RAILWAY_PROJECT_ID != '' && env.RAILWAY_ENVIRONMENT_ID != '' && env.RAILWAY_SERVICE_ID != ''
        run: |
          cat <<EOF > railway.json
          {
            "$schema": "https://railway.app/railway.schema.json",
            "_comment": "Назначение файла: хранение идентификаторов проекта Railway для CLI и GitHub Actions.",
            "projectId": "${RAILWAY_PROJECT_ID}",
            "environmentId": "${RAILWAY_ENVIRONMENT_ID}",
            "serviceId": "${RAILWAY_SERVICE_ID}"
          }
          EOF
      - name: Деплой на Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${RAILWAY_TOKEN:-}" ]; then
            echo "Секрет RAILWAY_TOKEN не задан." >&2
            exit 1
          fi
          SERVICE_NAME="${RAILWAY_SERVICE_NAME:-bot}"
          ARGS=("--service" "$SERVICE_NAME" "--detach")
          if [ -n "${RAILWAY_PROJECT_ID:-}" ]; then
            ARGS+=("--project" "$RAILWAY_PROJECT_ID")
          fi
          if [ -n "${RAILWAY_ENVIRONMENT_ID:-}" ]; then
            ARGS+=("--environment" "$RAILWAY_ENVIRONMENT_ID")
          fi
          railway up "${ARGS[@]}"
