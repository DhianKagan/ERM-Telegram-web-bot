{"version":3,"file":"TaskTable-legacy-CayimOH6.js","sources":["../../../web/src/components/TaskTable.tsx","../../../web/src/utils/matchTaskQuery.ts"],"sourcesContent":["// Назначение файла: таблица задач на основе DataTable\n// Основные модули: React, DataTable (лениво), taskColumns, useTasks, coerceTaskId\nimport React, { lazy, Suspense } from 'react';\nconst DataTable = lazy(() => import('./DataTable'));\nimport taskColumns, { TaskRow } from '../columns/taskColumns';\nimport type { User as AppUser } from '../types/user';\nimport useTasks from '../context/useTasks';\nimport coerceTaskId from '../utils/coerceTaskId';\nimport matchTaskQuery from '../utils/matchTaskQuery';\n\ntype EntityKind = 'task' | 'request';\n\ninterface TaskTableProps {\n  tasks: TaskRow[];\n  users?: Record<number, AppUser>;\n  page: number;\n  pageCount?: number;\n  mine?: boolean;\n  entityKind?: EntityKind;\n  onPageChange: (p: number) => void;\n  onMineChange?: (v: boolean) => void;\n  onRowClick?: (id: string) => void;\n  toolbarChildren?: React.ReactNode;\n  onDataChange?: (rows: TaskRow[]) => void;\n}\n\nexport default function TaskTable({\n  tasks,\n  users,\n  page,\n  pageCount,\n  mine = false,\n  entityKind = 'task',\n  onPageChange,\n  onMineChange,\n  onRowClick,\n  toolbarChildren,\n  onDataChange,\n}: TaskTableProps) {\n  const { query, filters } = useTasks();\n  const userMap = React.useMemo<Record<number, AppUser>>(\n    () => users ?? {},\n    [users],\n  );\n  const columns = React.useMemo(\n    () => taskColumns(userMap, entityKind),\n    [userMap, entityKind],\n  );\n\n  React.useEffect(() => {\n    onDataChange?.(tasks);\n  }, [onDataChange, tasks]);\n\n  return (\n    <Suspense fallback={<div>Загрузка таблицы...</div>}>\n      <DataTable<TaskRow>\n        columns={columns}\n        data={tasks.filter((t) => {\n          if (query && !matchTaskQuery(t, query, userMap)) return false;\n          if (filters.status.length && !filters.status.includes(t.status))\n            return false;\n          if (\n            filters.priority.length &&\n            !filters.priority.includes(t.priority as string)\n          )\n            return false;\n          if (filters.taskTypes.length) {\n            const taskType =\n              typeof (t as Record<string, unknown>).task_type === 'string'\n                ? ((t as Record<string, unknown>).task_type as string).trim()\n                : '';\n            if (!taskType || !filters.taskTypes.includes(taskType))\n              return false;\n          }\n          if (filters.assignees.length) {\n            const assigned = new Set<number>();\n            const collect = (value: unknown) => {\n              if (typeof value === 'number' && Number.isFinite(value)) {\n                assigned.add(value);\n              } else if (typeof value === 'string') {\n                const parsed = Number(value.trim());\n                if (Number.isFinite(parsed)) assigned.add(parsed);\n              }\n            };\n            if (Array.isArray((t as Record<string, unknown>).assignees)) {\n              ((t as Record<string, unknown>).assignees as unknown[]).forEach(\n                collect,\n              );\n            }\n            collect((t as Record<string, unknown>).assigned_user_id);\n            if (\n              !filters.assignees.some((assignee) =>\n                assigned.has(Number(assignee)),\n              )\n            ) {\n              return false;\n            }\n          }\n          const created = t.createdAt ? new Date(t.createdAt) : null;\n          if (filters.from && created && created < new Date(filters.from))\n            return false;\n          if (filters.to && created && created > new Date(filters.to))\n            return false;\n          return true;\n        })}\n        pageIndex={page}\n        pageSize={25}\n        pageCount={pageCount}\n        onPageChange={onPageChange}\n        onRowClick={(row) => {\n          const original = row as TaskRow & Record<string, unknown>;\n          const normalizedId =\n            coerceTaskId(original._id) || coerceTaskId(original.id);\n          if (normalizedId) {\n            onRowClick?.(normalizedId);\n          }\n        }}\n        toolbarChildren={\n          <>\n            {typeof onMineChange === 'function' && (\n              <label\n                className=\"flex items-center gap-1 text-sm\"\n                htmlFor=\"task-table-mine\"\n              >\n                <input\n                  id=\"task-table-mine\"\n                  name=\"mineTasks\"\n                  type=\"checkbox\"\n                  checked={mine}\n                  onChange={(e) => onMineChange(e.target.checked)}\n                />\n                Мои\n              </label>\n            )}\n            {toolbarChildren}\n          </>\n        }\n      />\n    </Suspense>\n  );\n}\n","// Назначение файла: сопоставление задач с текстовым запросом для глобального поиска\n// Модули: taskColumns (тип TaskRow)\nimport type { TaskRow } from '../columns/taskColumns';\n\ntype UserLike = Record<string, unknown>;\n\nconst normalizeCandidate = (value: string) => {\n  const trimmed = value.trim().toLowerCase();\n  if (!trimmed) return [] as string[];\n  const collapsed = trimmed.replace(/[\\s\\-_/]+/g, '');\n  if (collapsed && collapsed !== trimmed) {\n    return [trimmed, collapsed];\n  }\n  return [trimmed];\n};\n\nconst pushCandidate = (target: Set<string>, value: unknown) => {\n  if (typeof value === 'string') {\n    normalizeCandidate(value).forEach((candidate) => target.add(candidate));\n    return;\n  }\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    const text = String(value);\n    normalizeCandidate(text).forEach((candidate) => target.add(candidate));\n  }\n};\n\nconst collectNestedValues = (\n  value: unknown,\n  target: Set<string>,\n  depth = 0,\n) => {\n  if (depth > 2 || value === null || value === undefined) return;\n  if (Array.isArray(value)) {\n    value.forEach((item) => collectNestedValues(item, target, depth + 1));\n    return;\n  }\n  if (value instanceof Date) {\n    pushCandidate(target, value.toISOString());\n    return;\n  }\n  if (typeof value === 'object') {\n    Object.values(value as Record<string, unknown>).forEach((item) =>\n      collectNestedValues(item, target, depth + 1),\n    );\n    return;\n  }\n  pushCandidate(target, value);\n};\n\nconst addUserCandidates = (user: UserLike | undefined, target: Set<string>) => {\n  if (!user) return;\n  const fields = [\n    user.name,\n    user.username,\n    (user as Record<string, unknown>).telegram_username,\n    (user as Record<string, unknown>).telegramId,\n    (user as Record<string, unknown>).telegram_id,\n    user.phone,\n    (user as Record<string, unknown>).mobNumber,\n    user.email,\n  ];\n  fields.forEach((value) => pushCandidate(target, value));\n};\n\nconst toNumber = (value: unknown): number | undefined => {\n  if (typeof value === 'number' && Number.isFinite(value)) return value;\n  if (typeof value === 'string') {\n    const trimmed = value.trim();\n    if (!trimmed) return undefined;\n    const parsed = Number(trimmed);\n    if (Number.isFinite(parsed)) return parsed;\n  }\n  return undefined;\n};\n\nconst collectTaskSearchValues = (\n  task: TaskRow,\n  users: Record<number, UserLike>,\n): string[] => {\n  const candidates = new Set<string>();\n  const directFields: unknown[] = [\n    task.id,\n    task._id,\n    task.request_id,\n    task.task_number,\n    task.title,\n    task.task_description,\n    task.location,\n    (task as Record<string, unknown>).start_location,\n    (task as Record<string, unknown>).end_location,\n    task.project,\n    task.comment,\n    task.status,\n    task.priority,\n    task.task_type,\n    (task as Record<string, unknown>).route_distance_km,\n  ];\n  directFields.forEach((value) => pushCandidate(candidates, value));\n\n  const userIds = new Set<number>();\n  const appendUserId = (value: unknown) => {\n    const parsed = toNumber(value);\n    if (parsed !== undefined) {\n      userIds.add(parsed);\n      pushCandidate(candidates, parsed);\n    } else if (typeof value === 'string') {\n      pushCandidate(candidates, value);\n    }\n  };\n\n  appendUserId(task.created_by ?? task.creator ?? task.createdBy);\n  appendUserId(task.assigned_user_id);\n  appendUserId((task as Record<string, unknown>).controller_user_id);\n  (task.assignees || []).forEach((id) => appendUserId(id));\n  (\n    (task as Record<string, unknown>).controllers as unknown[] | undefined\n  )?.forEach((id) => appendUserId(id));\n\n  userIds.forEach((id) => addUserCandidates(users[id], candidates));\n\n  collectNestedValues((task as Record<string, unknown>).custom, candidates);\n  collectNestedValues((task as Record<string, unknown>).applicant, candidates);\n  collectNestedValues(\n    (task as Record<string, unknown>).logistics_details,\n    candidates,\n  );\n  collectNestedValues(\n    (task as Record<string, unknown>).procurement_details,\n    candidates,\n  );\n  collectNestedValues(\n    (task as Record<string, unknown>).work_details,\n    candidates,\n  );\n\n  return Array.from(candidates);\n};\n\nconst tokenize = (query: string): string[] =>\n  query.trim().toLowerCase().split(/\\s+/).filter(Boolean);\n\nexport default function matchTaskQuery(\n  task: TaskRow,\n  query: string,\n  users: Record<number, UserLike>,\n): boolean {\n  const tokens = tokenize(query);\n  if (!tokens.length) return true;\n  const haystack = collectTaskSearchValues(task, users);\n  if (!haystack.length) return false;\n  return tokens.every((token) => {\n    const variations = normalizeCandidate(token);\n    return variations.some((variant) =>\n      haystack.some((candidate) => candidate.includes(variant)),\n    );\n  });\n}\n\nexport { collectTaskSearchValues };\n"],"names":["_ref2","tasks","users","page","pageCount","_ref2$mine","mine","_ref2$entityKind","entityKind","onPageChange","onMineChange","onRowClick","toolbarChildren","onDataChange","_useTasks","useTasks","query","filters","userMap","React","useMemo","columns","taskColumns","useEffect","Suspense","fallback","jsx","children","DataTable","data","filter","t","task","tokens","tokenize","length","haystack","collectTaskSearchValues","every","token","normalizeCandidate","some","variant","candidate","includes","matchTaskQuery","status","priority","taskTypes","taskType","task_type","trim","assignees","assigned","Set","collect","value","Number","isFinite","add","parsed","Array","isArray","forEach","assigned_user_id","assignee","has","created","createdAt","Date","from","to","pageIndex","pageSize","row","original","normalizedId","coerceTaskId","_id","id","jsxs","Fragment","className","htmlFor","name","type","checked","onChange","e","target","trimmed","toLowerCase","collapsed","replace","pushCandidate","text","String","collectNestedValues","depth","item","toISOString","_typeof","Object","values","_ref","_task$created_by","_task$controllers","candidates","request_id","task_number","title","task_description","location","start_location","end_location","project","comment","route_distance_km","userIds","appendUserId","toNumber","created_by","creator","createdBy","controller_user_id","controllers","user","username","telegram_username","telegramId","telegram_id","phone","mobNumber","email","custom","applicant","logistics_details","procurement_details","work_details","split","Boolean","lazy","__vitePreload","module","import"],"mappings":"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"}