{"version":3,"file":"fleets-legacy-Cv-jsS1p.js","sources":["../../../web/src/services/fleets.ts"],"sourcesContent":["// Назначение: сервисные функции для работы с объектами автопарка\r\n// Основные модули: authFetch, shared/FleetVehicleDto\r\nimport authFetch from \"../utils/authFetch\";\r\nimport type { FleetVehicleDto } from \"shared\";\r\n\r\ntype PendingRequest = {\r\n  controller: AbortController;\r\n  promise: Promise<FleetVehicleResponse>;\r\n};\r\n\r\nconst pendingRequests = new Map<string, PendingRequest>();\r\n\r\nconst buildKey = (search: string, page: number, limit: number): string =>\r\n  `${search}::${page}::${limit}`;\r\n\r\nexport interface FleetVehiclePayload {\r\n  name: string;\r\n  registrationNumber: string;\r\n  odometerInitial: number;\r\n  odometerCurrent: number;\r\n  mileageTotal: number;\r\n  transportType: \"Легковой\" | \"Грузовой\";\r\n  fuelType: \"Бензин\" | \"Дизель\" | \"Газ\";\r\n  fuelRefilled: number;\r\n  fuelAverageConsumption: number;\r\n  fuelSpentTotal: number;\r\n  currentTasks: string[];\r\n}\r\n\r\nexport interface FleetVehicleResponse {\r\n  items: FleetVehicleDto[];\r\n  total: number;\r\n  page: number;\r\n  limit: number;\r\n}\r\n\r\nfunction parseResponse(res: Response, fallback: string) {\r\n  if (res.ok) return res.json();\r\n  return res.text().then((text) => {\r\n    throw new Error(text || fallback);\r\n  });\r\n}\r\n\r\nexport async function listFleetVehicles(\r\n  search = \"\",\r\n  page = 1,\r\n  limit = 10,\r\n): Promise<FleetVehicleResponse> {\r\n  const key = buildKey(search, page, limit);\r\n  const existing = pendingRequests.get(key);\r\n  if (existing) {\r\n    return existing.promise;\r\n  }\r\n\r\n  if (pendingRequests.size > 0) {\r\n    pendingRequests.forEach((entry, pendingKey) => {\r\n      if (pendingKey !== key) {\r\n        entry.controller.abort();\r\n        pendingRequests.delete(pendingKey);\r\n      }\r\n    });\r\n  }\r\n\r\n  const controller = new AbortController();\r\n  const params = new URLSearchParams();\r\n  params.set(\"page\", String(page));\r\n  params.set(\"limit\", String(limit));\r\n  if (search) params.set(\"search\", search);\r\n  const request = authFetch(`/api/v1/fleets?${params.toString()}`, {\r\n    signal: controller.signal,\r\n  })\r\n    .then((res) => parseResponse(res, \"Не удалось загрузить транспорт\"))\r\n    .finally(() => {\r\n      const entry = pendingRequests.get(key);\r\n      if (entry?.controller === controller) {\r\n        pendingRequests.delete(key);\r\n      }\r\n    });\r\n  pendingRequests.set(key, { controller, promise: request });\r\n  return request;\r\n}\r\n\r\nexport interface LegacyFleetVehiclesResponse {\r\n  fleet: { id: string; name: string };\r\n  vehicles: FleetVehicleDto[];\r\n}\r\n\r\nexport async function fetchFleetVehicles(\r\n  _fleetId?: string,\r\n): Promise<LegacyFleetVehiclesResponse> {\r\n  void _fleetId;\r\n  const data = await listFleetVehicles();\r\n  return {\r\n    fleet: { id: \"manual-fleet\", name: \"Автопарк\" },\r\n    vehicles: data.items,\r\n  };\r\n}\r\n\r\nexport async function createFleetVehicle(payload: FleetVehiclePayload): Promise<FleetVehicleDto> {\r\n  const res = await authFetch(\"/api/v1/fleets\", {\r\n    method: \"POST\",\r\n    confirmed: true,\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify(payload),\r\n  });\r\n  return parseResponse(res, \"Не удалось создать транспорт\");\r\n}\r\n\r\nexport async function updateFleetVehicle(\r\n  id: string,\r\n  payload: Partial<FleetVehiclePayload>,\r\n): Promise<FleetVehicleDto> {\r\n  const res = await authFetch(`/api/v1/fleets/${id}`, {\r\n    method: \"PUT\",\r\n    confirmed: true,\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify(payload),\r\n  });\r\n  return parseResponse(res, \"Не удалось обновить транспорт\");\r\n}\r\n\r\nexport async function deleteFleetVehicle(id: string): Promise<void> {\r\n  const res = await authFetch(`/api/v1/fleets/${id}`, {\r\n    method: \"DELETE\",\r\n    confirmed: true,\r\n  });\r\n  if (!res.ok) {\r\n    const text = await res.text().catch(() => \"\");\r\n    throw new Error(text || \"Не удалось удалить транспорт\");\r\n  }\r\n}\r\n"],"names":["_x2","_x3","_updateFleetVehicle","apply","this","arguments","pendingRequests","Map","buildKey","search","page","limit","concat","parseResponse","res","fallback","ok","json","text","then","Error","_callee","key","existing","controller","params","request","_args","_regenerator","w","_context","n","length","undefined","get","a","promise","size","forEach","entry","pendingKey","abort","delete","AbortController","URLSearchParams","set","String","authFetch","toString","signal","finally","_listFleetVehicles","_callee2","payload","_context2","method","confirmed","headers","body","JSON","stringify","v","_asyncToGenerator","m","_callee3","id","_context3","_callee4","_context4","catch"],"mappings":"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"}