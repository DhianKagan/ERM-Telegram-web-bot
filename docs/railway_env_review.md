<!-- Назначение файла: чек-лист проверки переменных Railway и рекомендации по их корректировке. -->

# Проверка переменных Railway

Ниже собраны выводы по представленному набору переменных окружения.

## Обязательные переменные
- `BOT_TOKEN`, `CHAT_ID`, `JWT_SECRET`, `APP_URL` заданы и соответствуют требованиям `config.ts`.
- `SESSION_SECRET` присутствует, что обязательно для сессий Express.
- `NODE_ENV=production` соответствует чек-листу деплоя на Railway.

## MongoDB
- Новое значение `MONGO_DATABASE_URL` в Railway уже включает имя базы и `authSource` (`mongodb://mongo:***@erm-mongodb.railway.internal:27017/test?authSource=admin`), поэтому проверка конфигурации проходит без ошибок.
- В окружении Codex всё ещё используется публичный прокси `shinkansen.proxy.rlwy.net`. Для стабильности и меньшей задержки приведите строку к приватному адресу `erm-mongodb.railway.internal` и при необходимости добавьте `directConnection=true`.
- Если вы захотите сменить базу данных с `test` на `ermdb`, не забудьте скорректировать имя базы в URI и выполнить миграции, чтобы структура коллекций совпадала.

## URL-адреса
- `APP_URL=https://agromarket.up.railway.app` соответствует требованиям API и мини-приложения.
- Для prod-окружения достаточно `APP_URL`: значение `COOKIE_DOMAIN` в Railway можно удалить, тогда сервер возьмёт домен из `APP_URL`. Если понадобится явный домен, используйте формат hostname или поддомен (например, `.agromarket.up.railway.app`).
- `ROUTING_URL` и `VITE_ROUTING_URL` указывают на OSRM `/route`, что соответствует требованиям клиентского и серверного кода.
- `BOT_API_URL` необязателен, но значение `https://api.telegram.org` корректно.

## Порты
- На Railway не задавайте `PORT` и `HOST_PORT` вручную: платформа назначает собственный порт и передаёт его через переменную `PORT`. Жёсткое значение `3001` мешает привязке. Удалите обе переменные из Railway, чтобы использовать порт, который выставляет платформа.
- Конфиг API теперь распознаёт `RAILWAY_TCP_PORT` и будет слушать именно его, даже если вы задали своё `PORT`. В логах появится предупреждение `Railway принудительно использует порт …`, а `HOST_PORT` будет проигнорирован. Это помогает поймать неправильную настройку ещё до появления `502 Bad Gateway`.

## Расписания и роли
- `SCHEDULE_CRON=*/1 * * * *` задействует ежеминутный запуск планировщика — проверьте, что такой частоты достаточно.
- `ADMIN_ROLE_ID` и `USER_ROLE_ID` соответствуют значениям из примера окружения; дополнительной настройки не требуется.

## Дополнительные параметры
- `LOCALE=ru`, `VITE_BOT_USERNAME`, `VITE_CHAT_ID`, `STORAGE_DIR=/storage` — значения валидны.
- `LHCI_GITHUB_APP_TOKEN` и другие токены храните в секрете Railway, чтобы ими не пользовались посторонние.

## Итог
1. Удалите переменные `PORT`, `HOST_PORT` и `COOKIE_DOMAIN` из Railway — они дублируют настройки платформы.
2. В Codex замените публичный хост `shinkansen.proxy.rlwy.net` на внутренний `erm-mongodb.railway.internal` и при необходимости добавьте `directConnection=true`.
3. При миграции на базу `ermdb` обновите имя базы в `MONGO_DATABASE_URL` во всех окружениях.
4. Остальные значения соответствуют требованиям репозитория.
