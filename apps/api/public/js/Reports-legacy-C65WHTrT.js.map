{"version":3,"file":"Reports-legacy-C65WHTrT.js","sources":["../../../web/src/components/ReportFilterForm.tsx","../../../web/src/components/KPIOverview.tsx","../../../web/src/pages/Reports.tsx","../../../web/src/components/TasksChart.tsx"],"sourcesContent":["// Форма фильтрации отчётов по диапазону дат\nimport React from 'react';\n\nimport { Button } from '@/components/ui/button';\n\ninterface ReportFilterFormProps {\n  onChange?: (period: { from: string; to: string }) => void;\n}\n\nexport default function ReportFilterForm({ onChange }: ReportFilterFormProps) {\n  const [from, setFrom] = React.useState('');\n  const [to, setTo] = React.useState('');\n  const submit = (e) => {\n    e.preventDefault();\n    onChange && onChange({ from, to });\n  };\n  return (\n    <form onSubmit={submit} className=\"flex flex-wrap items-end gap-2\">\n      <input\n        type=\"date\"\n        id=\"report-from\"\n        name=\"reportFrom\"\n        value={from}\n        onChange={(e) => setFrom(e.target.value)}\n        className=\"focus:border-accentPrimary focus:ring-brand-200 rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-800 focus:ring focus:outline-none\"\n      />\n      <input\n        type=\"date\"\n        id=\"report-to\"\n        name=\"reportTo\"\n        value={to}\n        onChange={(e) => setTo(e.target.value)}\n        className=\"focus:border-accentPrimary focus:ring-brand-200 rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-800 focus:ring focus:outline-none\"\n      />\n      <Button type=\"submit\">Применить</Button>\n    </form>\n  );\n}\n","// Блок KPI с общими метриками по задачам\nimport React from 'react';\n\ninterface KPIOverviewProps {\n  count: number;\n  time: number;\n}\n\nexport default function KPIOverview({ count, time }: KPIOverviewProps) {\n  return (\n    <div className=\"flex space-x-4\">\n      <div className=\"rounded border p-2\">Всего задач: {count}</div>\n      <div className=\"rounded border p-2\">Затрачено минут: {time}</div>\n    </div>\n  );\n}\n","// Страница отчётов с фильтром по датам\nimport React from 'react';\nimport ReportFilterForm from '../components/ReportFilterForm';\nimport KPIOverview from '../components/KPIOverview';\nimport TasksChart from '../components/TasksChart';\nimport authFetch from '../utils/authFetch';\nimport { Button } from '../components/ui/button';\nimport { showToast } from '../utils/toast';\n\nexport default function Reports() {\n  const [kpi, setKpi] = React.useState({ count: 0, time: 0 });\n  const [filters, setFilters] = React.useState<{ from?: string; to?: string }>(\n    {},\n  );\n  const [downloading, setDownloading] = React.useState({\n    pdf: false,\n    xlsx: false,\n  });\n\n  const normalizePeriod = (source?: { from?: string; to?: string }) => {\n    const normalized: { from?: string; to?: string } = {};\n    if (source?.from) {\n      const trimmed = source.from.trim();\n      if (trimmed) normalized.from = trimmed;\n    }\n    if (source?.to) {\n      const trimmed = source.to.trim();\n      if (trimmed) normalized.to = trimmed;\n    }\n    return normalized;\n  };\n\n  const buildQuery = (period: { from?: string; to?: string }) => {\n    const params = new URLSearchParams();\n    if (period.from) params.set('from', period.from);\n    if (period.to) params.set('to', period.to);\n    const query = params.toString();\n    return query ? `?${query}` : '';\n  };\n\n  const extractFilename = (header: string | null, fallback: string) => {\n    if (!header) return fallback;\n    const match = header.match(/filename\\*?=(?:UTF-8'')?\"?([^\";]+)/i);\n    if (match && match[1]) {\n      try {\n        return decodeURIComponent(match[1]);\n      } catch {\n        return match[1];\n      }\n    }\n    return fallback;\n  };\n\n  const handleDownload = React.useCallback(\n    async (kind: 'pdf' | 'xlsx') => {\n      setDownloading((prev) => ({ ...prev, [kind]: true }));\n      try {\n        const query = buildQuery(filters);\n        const endpoint =\n          kind === 'pdf'\n            ? `/api/v1/tasks/report.pdf${query}`\n            : `/api/v1/tasks/report.xlsx${query}`;\n        const res = await authFetch(endpoint, { noRedirect: true });\n        if (!res.ok) {\n          throw new Error(`HTTP ${res.status}`);\n        }\n        const blob = await res.blob();\n        const disposition = res.headers.get('Content-Disposition');\n        const fallbackName =\n          kind === 'pdf' ? 'tasks-report.pdf' : 'tasks-report.xlsx';\n        const filename = extractFilename(disposition, fallbackName);\n        const url = window.URL.createObjectURL(blob);\n        const link = document.createElement('a');\n        link.href = url;\n        link.download = filename;\n        document.body.appendChild(link);\n        link.click();\n        link.remove();\n        window.URL.revokeObjectURL(url);\n      } catch (error) {\n        console.error('report download error', error);\n        showToast('Не удалось скачать отчёт', 'error');\n      } finally {\n        setDownloading((prev) => ({ ...prev, [kind]: false }));\n      }\n    },\n    [filters],\n  );\n\n  const fetchSummary = React.useCallback(\n    (period: { from?: string; to?: string }) => {\n      authFetch(`/api/v1/tasks/report/summary${buildQuery(period)}`)\n        .then((r) => (r.ok ? r.json() : { count: 0, time: 0 }))\n        .then(setKpi);\n    },\n    [],\n  );\n\n  const load = (next?: { from?: string; to?: string }) => {\n    const normalized = normalizePeriod(next);\n    setFilters(normalized);\n    fetchSummary(normalized);\n  };\n\n  React.useEffect(() => {\n    fetchSummary({});\n  }, [fetchSummary]);\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"space-y-4 rounded-lg bg-white p-4 shadow-sm\">\n        <h2 className=\"text-xl font-semibold\">Отчёты</h2>\n        <ReportFilterForm onChange={load} />\n        <KPIOverview count={kpi.count} time={kpi.time} />\n        <div className=\"flex flex-wrap gap-2\">\n          <Button\n            onClick={() => handleDownload('pdf')}\n            disabled={downloading.pdf}\n          >\n            {downloading.pdf ? 'Формируем PDF...' : 'Скачать PDF'}\n          </Button>\n          <Button\n            variant=\"outline\"\n            onClick={() => handleDownload('xlsx')}\n            disabled={downloading.xlsx}\n          >\n            {downloading.xlsx ? 'Формируем Excel...' : 'Скачать Excel'}\n          </Button>\n        </div>\n      </div>\n      <div className=\"space-y-4 rounded-lg bg-white p-4 shadow-sm\">\n        <h3 className=\"text-lg font-semibold\">Динамика задач</h3>\n        <TasksChart filters={filters} />\n      </div>\n    </div>\n  );\n}\n","// График количества задач за период\n// Модули: React, react-apexcharts, next-themes, authFetch\nimport React, { useEffect, useState } from 'react';\nimport { useTheme } from 'next-themes';\nimport authFetch from '../utils/authFetch';\nconst ReactApexChart = React.lazy(() => import('react-apexcharts'));\n\ninterface ChartState {\n  series: { data: number[] }[];\n  categories: string[];\n}\n\ninterface TasksChartProps {\n  filters?: {\n    from?: string;\n    to?: string;\n  };\n}\n\nconst buildQuery = (filters?: TasksChartProps['filters']) => {\n  const params = new URLSearchParams();\n  if (filters?.from) params.set('from', filters.from);\n  if (filters?.to) params.set('to', filters.to);\n  const query = params.toString();\n  return query ? `?${query}` : '';\n};\n\nexport default function TasksChart({ filters }: TasksChartProps) {\n  const [series, setSeries] = useState<ChartState['series']>([{ data: [] }]);\n  const [categories, setCategories] = useState<ChartState['categories']>([]);\n  const { theme } = useTheme();\n\n  useEffect(() => {\n    let cancelled = false;\n    authFetch(`/api/v1/tasks/report/chart${buildQuery(filters)}`)\n      .then((r) => (r.ok ? r.json() : { data: [], labels: [] }))\n      .then(({ data, labels }) => {\n        if (cancelled) return;\n        const normalizedData = Array.isArray(data)\n          ? data.map((value) => {\n              const numeric = Number(value);\n              return Number.isFinite(numeric) ? numeric : 0;\n            })\n          : [];\n        const normalizedLabels = Array.isArray(labels)\n          ? labels.map((label) => String(label))\n          : [];\n        setSeries([{ data: normalizedData }]);\n        setCategories(normalizedLabels);\n      })\n      .catch(() => {\n        if (cancelled) return;\n        setSeries([{ data: [] }]);\n        setCategories([]);\n      });\n    return () => {\n      cancelled = true;\n    };\n  }, [filters?.from, filters?.to]);\n\n  const options = {\n    chart: {\n      height: 200,\n      type: 'line',\n      fontFamily: 'Inter, sans-serif',\n      toolbar: { show: false },\n      background: theme === 'dark' ? '#24303F' : undefined,\n    },\n    colors: ['#2563EB'],\n    stroke: { width: 2, curve: 'smooth' },\n    xaxis: {\n      categories,\n      labels: { style: { colors: theme === 'dark' ? '#DEE4EE' : '#6B7280' } },\n    },\n    yaxis: {\n      labels: { style: { colors: theme === 'dark' ? '#DEE4EE' : '#6B7280' } },\n    },\n  };\n\n  return (\n    <React.Suspense fallback={<div>Загрузка...</div>}>\n      <ReactApexChart\n        series={series}\n        options={options}\n        type=\"line\"\n        height={200}\n      />\n    </React.Suspense>\n  );\n}\n"],"names":["ReportFilterForm","_ref","onChange","_React$useState2","_slicedToArray","React","useState","from","setFrom","_React$useState4","to","setTo","jsxs","onSubmit","e","preventDefault","className","children","jsx","type","id","name","value","target","Button","KPIOverview","_ref2","count","time","_React$useState6","kpi","setKpi","_React$useState8","filters","setFilters","_React$useState0","pdf","xlsx","downloading","setDownloading","buildQuery","period","params","URLSearchParams","set","query","toString","concat","extractFilename","header","fallback","match","decodeURIComponent","_unused","handleDownload","useCallback","_ref5","_regenerator","m","_callee","kind","endpoint","res","blob","disposition","filename","url","link","_t","w","_context","p","n","prev","authFetch","noRedirect","ok","Error","status","v","headers","get","window","URL","createObjectURL","document","createElement","href","download","body","appendChild","click","remove","revokeObjectURL","console","error","showToast","f","a","_x","apply","this","arguments","fetchSummary","then","r","json","useEffect","next","normalized","source","trimmed","trim","normalizePeriod","onClick","disabled","variant","TasksChart","ReactApexChart","lazy","__vitePreload","module","_ref3","_reactExports$useStat2","data","series","setSeries","_reactExports$useStat4","categories","setCategories","theme","useTheme","cancelled","labels","_ref4","normalizedData","Array","isArray","map","numeric","Number","isFinite","normalizedLabels","label","String","catch","options","chart","height","fontFamily","toolbar","show","background","colors","stroke","width","curve","xaxis","style","yaxis","Suspense"],"mappings":"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"}