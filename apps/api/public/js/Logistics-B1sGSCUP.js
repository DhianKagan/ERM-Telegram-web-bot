import{j as e}from"./index-DgL4A3Hy.js";import{R as d}from"./vendor-bFQg9Mu4.js";import{h as L,a as P,B as D}from"./App-C5qf9m0C.js";import{B as z}from"./Breadcrumbs-K53BHuST.js";import{u as B}from"./useToast-CyXuzwzd.js";import{h as S,A as F,a as M}from"./AuthenticatedApp-m87IzzAI.js";function U(){return e.jsxs("div",{className:"border-stroke bg-gray animate-pulse rounded border p-4",children:[e.jsx("div",{className:"bg-gray-2 mb-4 h-6 w-1/3 rounded"}),e.jsx("div",{className:"bg-gray-2 mb-2 h-4 w-full rounded"}),e.jsx("div",{className:"bg-gray-2 mb-2 h-4 w-full rounded"}),e.jsx("div",{className:"bg-gray-2 h-4 w-2/3 rounded"})]})}const _=s=>Array.isArray(s)?s.map(t=>{var a;return{...t,tasks:Array.isArray(t.tasks)?t.tasks:[],stops:Array.isArray(t.stops)?t.stops:[],metrics:(a=t.metrics)!=null?a:{}}}):[],I=s=>{var l,i,m;const t=_(s.routes),a=Array.isArray(s.tasks)?s.tasks:[],o=t.reduce((u,c)=>{var x,f;return u+((f=(x=c.stops)==null?void 0:x.length)!=null?f:0)},0),n=(i=(l=s.metrics)==null?void 0:l.totalTasks)!=null?i:a.length||t.reduce((u,c)=>u+c.tasks.length,0);return{...s,routes:t,tasks:a,metrics:(m=s.metrics)!=null?m:{totalDistanceKm:null,totalRoutes:t.length,totalTasks:n,totalStops:o,totalEtaMinutes:null,totalLoad:null}}};async function $(s,t,a){const o=new URLSearchParams;s&&o.set("status",s),t&&o.set("limit",String(t)),a&&o.set("page",String(a));const n=await L("/api/v1/route-plans?".concat(o.toString()));if(!n.ok)throw new Error("Не удалось загрузить маршрутные планы");const l=await n.json(),i=Array.isArray(l.items)?l.items.map(I):[],m=typeof l.total=="number"?l.total:i.length;return{items:i,total:m}}const g={draft:"Новый",approved:"В работе",completed:"Выполнен",cancelled:"Отменен"},O={draft:"bg-blue-100 text-blue-800",approved:"bg-amber-100 text-amber-800",completed:"bg-emerald-100 text-emerald-800",cancelled:"bg-rose-100 text-rose-800"},G=[{value:"all",label:"Все"},{value:"draft",label:g.draft},{value:"approved",label:g.approved},{value:"completed",label:g.completed},{value:"cancelled",label:g.cancelled}],K=s=>{if(!s)return"—";try{return new Intl.DateTimeFormat("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(new Date(s))}catch(t){return s}},V=s=>{const t=new Set;return s.forEach(a=>{a.tasks.forEach(o=>{var l;const n=((l=o.title)==null?void 0:l.trim())||o.taskId;n&&t.add(n)})}),Array.from(t)},Y=s=>{const t=new Set;return s.forEach(a=>{a.driverName&&t.add(a.driverName)}),t.size>0?Array.from(t).join(", "):"Не назначен"},q=s=>{const t=new Set;return s.forEach(a=>{a.vehicleName&&t.add(a.vehicleName)}),t.size>0?Array.from(t).join(", "):"Не назначено"},w=s=>s==="draft"||s==="approved"||s==="completed"?s:"cancelled";function ee(){const[s,t]=d.useState([]),[a,o]=d.useState(!0),[n,l]=d.useState(null),[i,m]=d.useState("all"),{addToast:u}=B(),{user:c}=P(),x=d.useCallback(async()=>{o(!0),l(null);try{const r=await $();t(Array.isArray(r.items)?r.items:[])}catch(r){const h=r instanceof Error?r.message:"Не удалось загрузить маршрутные планы";l(h),u(h)}finally{o(!1)}},[u]);d.useEffect(()=>{x()},[x]);const f=d.useMemo(()=>i==="all"?s:s.filter(r=>w(r.status)===i),[s,i]),p=typeof(c==null?void 0:c.access)=="number"?c.access:0,k=(c==null?void 0:c.role)==="admin"||S(p,F),E=S(p,M);return e.jsxs("div",{className:"space-y-6",children:[e.jsx(z,{items:[{label:"Логистика",href:"/logistics"},{label:"Маршрутные планы"}]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Маршрутные планы"}),e.jsx("p",{className:"max-w-2xl text-sm text-muted-foreground",children:"Просматривайте планы доставки без привязки к карте: задачи, назначенные водители и транспорт, статус и детали плана."})]}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-end",children:[e.jsxs("label",{className:"flex flex-col text-sm font-medium text-foreground",htmlFor:"logistics-status-filter",children:["Статус",e.jsx("select",{id:"logistics-status-filter",className:"mt-1 min-w-[160px] rounded-md border border-border bg-background px-3 py-2 text-sm focus:border-accentPrimary focus:outline-none",value:i,onChange:r=>m(r.target.value),children:G.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]}),e.jsx(D,{onClick:()=>void x(),disabled:a,variant:"outline",className:"sm:self-end",children:a?"Обновляем…":"Обновить"})]})]}),!k&&!E&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Управление маршрутными планами доступно администраторам и менеджерам. Остальные пользователи могут просматривать список."}),n&&e.jsx("div",{className:"rounded-lg border border-destructive bg-destructive/10 p-3 text-sm text-destructive",role:"alert",children:n}),a?e.jsx(U,{}):f.length===0?e.jsx("div",{className:"rounded-lg border border-border bg-card p-4 text-sm text-muted-foreground",children:"Маршрутные планы отсутствуют."}):e.jsx("div",{className:"grid gap-3 md:grid-cols-2 xl:grid-cols-3",children:f.map(r=>{var v,y,N;const h=w(r.status),b=V((v=r.routes)!=null?v:[]),T=Y((y=r.routes)!=null?y:[]),C=q((N=r.routes)!=null?N:[]),j=g[h],R=O[h];return e.jsxs("article",{className:"flex h-full flex-col gap-3 rounded-lg border border-border bg-card p-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Создан: ",K(r.createdAt)]}),e.jsx("h3",{className:"text-lg font-semibold leading-6",children:r.title})]}),e.jsx("span",{className:"rounded-full px-3 py-1 text-xs font-semibold leading-5 ".concat(R),"aria-label":"Статус: ".concat(j),children:j})]}),r.notes&&e.jsx("p",{className:"text-sm text-foreground","aria-label":"Описание плана",children:r.notes}),e.jsxs("div",{className:"space-y-1 text-sm text-foreground",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Водитель: "}),T]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Авто: "}),C]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:"Задачи"}),b.length>0?e.jsx("ul",{className:"list-disc space-y-1 pl-5 text-sm text-foreground",children:b.map(A=>e.jsx("li",{children:A},A))}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Задачи не назначены"})]})]},r.id)})})]})}export{ee as default};
//# sourceMappingURL=Logistics-B1sGSCUP.js.map
