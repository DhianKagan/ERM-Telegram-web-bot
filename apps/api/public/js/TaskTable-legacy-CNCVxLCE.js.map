{"version":3,"file":"TaskTable-legacy-CNCVxLCE.js","sources":["../../../web/src/components/TaskTable.tsx","../../../web/src/utils/matchTaskQuery.ts"],"sourcesContent":["// Назначение файла: таблица задач на основе DataTable\r\n// Основные модули: React, DataTable (лениво), taskColumns, useTasks, coerceTaskId\r\nimport React, { lazy, Suspense } from \"react\";\r\nconst DataTable = lazy(() => import(\"./DataTable\"));\r\nimport taskColumns, { TaskRow } from \"../columns/taskColumns\";\r\nimport useTasks from \"../context/useTasks\";\r\nimport coerceTaskId from \"../utils/coerceTaskId\";\r\nimport matchTaskQuery from \"../utils/matchTaskQuery\";\r\n\r\ntype EntityKind = \"task\" | \"request\";\r\n\r\ninterface TaskTableProps {\r\n  tasks: TaskRow[];\r\n  users?: Record<number, any>;\r\n  page: number;\r\n  pageCount?: number;\r\n  mine?: boolean;\r\n  entityKind?: EntityKind;\r\n  onPageChange: (p: number) => void;\r\n  onMineChange?: (v: boolean) => void;\r\n  onRowClick?: (id: string) => void;\r\n  toolbarChildren?: React.ReactNode;\r\n  onDataChange?: (rows: TaskRow[]) => void;\r\n}\r\n\r\nexport default function TaskTable({\r\n  tasks,\r\n  users = {},\r\n  page,\r\n  pageCount,\r\n  mine = false,\r\n  entityKind = \"task\",\r\n  onPageChange,\r\n  onMineChange,\r\n  onRowClick,\r\n  toolbarChildren,\r\n  onDataChange,\r\n}: TaskTableProps) {\r\n  const { query, filters } = useTasks();\r\n  const columns = React.useMemo(\r\n    () => taskColumns(users, entityKind),\r\n    [users, entityKind],\r\n  );\r\n\r\n  React.useEffect(() => {\r\n    onDataChange?.(tasks);\r\n  }, [onDataChange, tasks]);\r\n\r\n  return (\r\n    <Suspense fallback={<div>Загрузка таблицы...</div>}>\r\n      <DataTable<TaskRow>\r\n        columns={columns}\r\n        data={tasks.filter((t) => {\r\n          if (query && !matchTaskQuery(t, query, users)) return false;\r\n          if (filters.status.length && !filters.status.includes(t.status))\r\n            return false;\r\n          if (\r\n            filters.priority.length &&\r\n            !filters.priority.includes(t.priority as string)\r\n          )\r\n            return false;\r\n          if (filters.taskTypes.length) {\r\n            const taskType =\r\n              typeof (t as Record<string, unknown>).task_type === \"string\"\r\n                ? ((t as Record<string, unknown>).task_type as string).trim()\r\n                : \"\";\r\n            if (!taskType || !filters.taskTypes.includes(taskType)) return false;\r\n          }\r\n          if (filters.assignees.length) {\r\n            const assigned = new Set<number>();\r\n            const collect = (value: unknown) => {\r\n              if (typeof value === \"number\" && Number.isFinite(value)) {\r\n                assigned.add(value);\r\n              } else if (typeof value === \"string\") {\r\n                const parsed = Number(value.trim());\r\n                if (Number.isFinite(parsed)) assigned.add(parsed);\r\n              }\r\n            };\r\n            if (Array.isArray((t as Record<string, unknown>).assignees)) {\r\n              ((t as Record<string, unknown>).assignees as unknown[]).forEach(collect);\r\n            }\r\n            collect((t as Record<string, unknown>).assigned_user_id);\r\n            if (\r\n              !filters.assignees.some((assignee) => assigned.has(Number(assignee)))\r\n            ) {\r\n              return false;\r\n            }\r\n          }\r\n          const created = t.createdAt ? new Date(t.createdAt) : null;\r\n          if (filters.from && created && created < new Date(filters.from))\r\n            return false;\r\n          if (filters.to && created && created > new Date(filters.to))\r\n            return false;\r\n          return true;\r\n        })}\r\n        pageIndex={page}\r\n        pageSize={25}\r\n        pageCount={pageCount}\r\n        onPageChange={onPageChange}\r\n        onRowClick={(row) => {\r\n          const original = row as TaskRow & Record<string, unknown>;\r\n          const normalizedId =\r\n            coerceTaskId(original._id) || coerceTaskId(original.id);\r\n          if (normalizedId) {\r\n            onRowClick?.(normalizedId);\r\n          }\r\n        }}\r\n        toolbarChildren={\r\n          <>\r\n            {typeof onMineChange === \"function\" && (\r\n              <label\r\n                className=\"flex items-center gap-1 text-sm\"\r\n                htmlFor=\"task-table-mine\"\r\n              >\r\n                <input\r\n                  id=\"task-table-mine\"\r\n                  name=\"mineTasks\"\r\n                  type=\"checkbox\"\r\n                  checked={mine}\r\n                  onChange={(e) => onMineChange(e.target.checked)}\r\n                />\r\n                Мои\r\n              </label>\r\n            )}\r\n            {toolbarChildren}\r\n          </>\r\n        }\r\n      />\r\n    </Suspense>\r\n  );\r\n}\r\n","// Назначение файла: сопоставление задач с текстовым запросом для глобального поиска\r\n// Модули: taskColumns (тип TaskRow)\r\nimport type { TaskRow } from \"../columns/taskColumns\";\r\n\r\ntype UserLike = Record<string, unknown>;\r\n\r\nconst normalizeCandidate = (value: string) => {\r\n  const trimmed = value.trim().toLowerCase();\r\n  if (!trimmed) return [] as string[];\r\n  const collapsed = trimmed.replace(/[\\s\\-_/]+/g, \"\");\r\n  if (collapsed && collapsed !== trimmed) {\r\n    return [trimmed, collapsed];\r\n  }\r\n  return [trimmed];\r\n};\r\n\r\nconst pushCandidate = (target: Set<string>, value: unknown) => {\r\n  if (typeof value === \"string\") {\r\n    normalizeCandidate(value).forEach((candidate) => target.add(candidate));\r\n    return;\r\n  }\r\n  if (typeof value === \"number\" && Number.isFinite(value)) {\r\n    const text = String(value);\r\n    normalizeCandidate(text).forEach((candidate) => target.add(candidate));\r\n  }\r\n};\r\n\r\nconst collectNestedValues = (\r\n  value: unknown,\r\n  target: Set<string>,\r\n  depth = 0,\r\n) => {\r\n  if (depth > 2 || value === null || value === undefined) return;\r\n  if (Array.isArray(value)) {\r\n    value.forEach((item) => collectNestedValues(item, target, depth + 1));\r\n    return;\r\n  }\r\n  if (value instanceof Date) {\r\n    pushCandidate(target, value.toISOString());\r\n    return;\r\n  }\r\n  if (typeof value === \"object\") {\r\n    Object.values(value as Record<string, unknown>).forEach((item) =>\r\n      collectNestedValues(item, target, depth + 1),\r\n    );\r\n    return;\r\n  }\r\n  pushCandidate(target, value);\r\n};\r\n\r\nconst addUserCandidates = (user: UserLike | undefined, target: Set<string>) => {\r\n  if (!user) return;\r\n  const fields = [\r\n    user.name,\r\n    user.username,\r\n    (user as Record<string, unknown>).telegram_username,\r\n    (user as Record<string, unknown>).telegramId,\r\n    (user as Record<string, unknown>).telegram_id,\r\n    user.phone,\r\n    (user as Record<string, unknown>).mobNumber,\r\n    user.email,\r\n  ];\r\n  fields.forEach((value) => pushCandidate(target, value));\r\n};\r\n\r\nconst toNumber = (value: unknown): number | undefined => {\r\n  if (typeof value === \"number\" && Number.isFinite(value)) return value;\r\n  if (typeof value === \"string\") {\r\n    const trimmed = value.trim();\r\n    if (!trimmed) return undefined;\r\n    const parsed = Number(trimmed);\r\n    if (Number.isFinite(parsed)) return parsed;\r\n  }\r\n  return undefined;\r\n};\r\n\r\nconst collectTaskSearchValues = (\r\n  task: TaskRow,\r\n  users: Record<number, UserLike>,\r\n): string[] => {\r\n  const candidates = new Set<string>();\r\n  const directFields: unknown[] = [\r\n    task.id,\r\n    task._id,\r\n    task.request_id,\r\n    task.task_number,\r\n    task.title,\r\n    task.task_description,\r\n    task.location,\r\n    (task as Record<string, unknown>).start_location,\r\n    (task as Record<string, unknown>).end_location,\r\n    task.project,\r\n    task.comment,\r\n    task.status,\r\n    task.priority,\r\n    task.task_type,\r\n    (task as Record<string, unknown>).route_distance_km,\r\n  ];\r\n  directFields.forEach((value) => pushCandidate(candidates, value));\r\n\r\n  const userIds = new Set<number>();\r\n  const appendUserId = (value: unknown) => {\r\n    const parsed = toNumber(value);\r\n    if (parsed !== undefined) {\r\n      userIds.add(parsed);\r\n      pushCandidate(candidates, parsed);\r\n    } else if (typeof value === \"string\") {\r\n      pushCandidate(candidates, value);\r\n    }\r\n  };\r\n\r\n  appendUserId(task.created_by ?? task.creator ?? task.createdBy);\r\n  appendUserId(task.assigned_user_id);\r\n  appendUserId((task as Record<string, unknown>).controller_user_id);\r\n  (task.assignees || []).forEach((id) => appendUserId(id));\r\n  ((task as Record<string, unknown>).controllers as unknown[] | undefined)?.forEach(\r\n    (id) => appendUserId(id),\r\n  );\r\n\r\n  userIds.forEach((id) => addUserCandidates(users[id], candidates));\r\n\r\n  collectNestedValues((task as Record<string, unknown>).custom, candidates);\r\n  collectNestedValues((task as Record<string, unknown>).applicant, candidates);\r\n  collectNestedValues(\r\n    (task as Record<string, unknown>).logistics_details,\r\n    candidates,\r\n  );\r\n  collectNestedValues(\r\n    (task as Record<string, unknown>).procurement_details,\r\n    candidates,\r\n  );\r\n  collectNestedValues(\r\n    (task as Record<string, unknown>).work_details,\r\n    candidates,\r\n  );\r\n\r\n  return Array.from(candidates);\r\n};\r\n\r\nconst tokenize = (query: string): string[] =>\r\n  query\r\n    .trim()\r\n    .toLowerCase()\r\n    .split(/\\s+/)\r\n    .filter(Boolean);\r\n\r\nexport default function matchTaskQuery(\r\n  task: TaskRow,\r\n  query: string,\r\n  users: Record<number, UserLike>,\r\n): boolean {\r\n  const tokens = tokenize(query);\r\n  if (!tokens.length) return true;\r\n  const haystack = collectTaskSearchValues(task, users);\r\n  if (!haystack.length) return false;\r\n  return tokens.every((token) => {\r\n    const variations = normalizeCandidate(token);\r\n    return variations.some((variant) =>\r\n      haystack.some((candidate) => candidate.includes(variant)),\r\n    );\r\n  });\r\n}\r\n\r\nexport { collectTaskSearchValues };\r\n"],"names":["_ref2","tasks","_ref2$users","users","page","pageCount","_ref2$mine","mine","_ref2$entityKind","entityKind","onPageChange","onMineChange","onRowClick","toolbarChildren","onDataChange","_useTasks","useTasks","query","filters","columns","React","useMemo","taskColumns","useEffect","Suspense","fallback","jsx","children","DataTable","data","filter","t","task","tokens","tokenize","length","haystack","collectTaskSearchValues","every","token","normalizeCandidate","some","variant","candidate","includes","matchTaskQuery","status","priority","taskTypes","taskType","task_type","trim","assignees","assigned","Set","collect","value","Number","isFinite","add","parsed","Array","isArray","forEach","assigned_user_id","assignee","has","created","createdAt","Date","from","to","pageIndex","pageSize","row","original","normalizedId","coerceTaskId","_id","id","jsxs","Fragment","className","htmlFor","name","type","checked","onChange","e","target","trimmed","toLowerCase","collapsed","replace","pushCandidate","text","String","collectNestedValues","depth","item","toISOString","_typeof","Object","values","_ref","_task$created_by","_task$controllers","candidates","request_id","task_number","title","task_description","location","start_location","end_location","project","comment","route_distance_km","userIds","appendUserId","toNumber","created_by","creator","createdBy","controller_user_id","controllers","user","username","telegram_username","telegramId","telegram_id","phone","mobNumber","email","custom","applicant","logistics_details","procurement_details","work_details","split","Boolean","lazy","__vitePreload","module","import"],"mappings":"umBAyBA,SAAwBA,GAYL,IAXjBC,EAAAD,EAAAC,MAAAC,EAAAF,EACAG,MAAAA,aAAQ,CAAA,EAACD,EACTE,EAAAJ,EAAAI,KACAC,EAAAL,EAAAK,UAAAC,EAAAN,EACAO,KAAAA,OAAA,IAAAD,GAAOA,EAAAE,EAAAR,EACPS,WAAAA,OAAA,IAAAD,EAAa,OAAAA,EACbE,EAAAV,EAAAU,aACAC,EAAAX,EAAAW,aACAC,EAAAZ,EAAAY,WACAC,EAAAb,EAAAa,gBACAC,EAAAd,EAAAc,aAEAC,EAA2BC,IAAnBC,EAAAF,EAAAE,MAAOC,EAAAH,EAAAG,QACTC,EAAUC,EAAMC,QACpB,WAAA,OAAMC,EAAYnB,EAAOM,EAAU,EACnC,CAACN,EAAOM,IAOV,OAJAW,EAAMG,UAAU,WACdT,SAAAA,EAAeb,EACjB,EAAG,CAACa,EAAcb,UAGfuB,EAAAA,SAAA,CAASC,SAAUC,EAAAA,IAAC,MAAA,CAAIC,iCACvBA,SAAAD,EAAAA,IAACE,EAAA,CACCT,QAAAA,EACAU,KAAM5B,EAAM6B,OAAO,SAACC,GAClB,GAAId,IC6Fd,SACEe,EACAf,EACAd,GAEA,IAAM8B,EAASC,EAASjB,GACxB,IAAKgB,EAAOE,OAAQ,OAAO,EAC3B,IAAMC,EAAWC,EAAwBL,EAAM7B,GAC/C,QAAKiC,EAASD,QACPF,EAAOK,MAAM,SAACC,GAEnB,OADmBC,EAAmBD,GACpBE,KAAK,SAACC,UACtBN,EAASK,KAAK,SAACE,GAAA,OAAcA,EAAUC,SAASF,EAAQ,EAAA,EAE5D,EACF,CD5GwBG,CAAed,EAAGd,EAAOd,GAAQ,OAAO,EACtD,GAAIe,EAAQ4B,OAAOX,SAAWjB,EAAQ4B,OAAOF,SAASb,EAAEe,QACtD,OAAO,EACT,GACE5B,EAAQ6B,SAASZ,SAChBjB,EAAQ6B,SAASH,SAASb,EAAEgB,UAE7B,OAAO,EACT,GAAI7B,EAAQ8B,UAAUb,OAAQ,CAC5B,IAAMc,EACgD,iBAA5ClB,EAA8BmB,UAChCnB,EAA8BmB,UAAqBC,OACrD,GACN,IAAKF,IAAa/B,EAAQ8B,UAAUJ,SAASK,GAAW,OAAO,CACjE,CACA,GAAI/B,EAAQkC,UAAUjB,OAAQ,CAC5B,IAAMkB,MAAeC,IACfC,EAAU,SAACC,GACf,GAAqB,iBAAVA,GAAsBC,OAAOC,SAASF,GAC/CH,EAASM,IAAIH,QACf,GAA4B,iBAAVA,EAAoB,CACpC,IAAMI,EAASH,OAAOD,EAAML,QACxBM,OAAOC,SAASE,IAASP,EAASM,IAAIC,EAC5C,CACF,EAKA,GAJIC,MAAMC,QAAS/B,EAA8BqB,YAC7CrB,EAA8BqB,UAAwBW,QAAQR,GAElEA,EAASxB,EAA8BiC,mBAEpC9C,EAAQkC,UAAUX,KAAK,SAACwB,GAAA,OAAaZ,EAASa,IAAIT,OAAOQ,GAAU,GAEpE,OAAO,CAEX,CACA,IAAME,EAAUpC,EAAEqC,UAAY,IAAIC,KAAKtC,EAAEqC,WAAa,KACtD,QAAIlD,EAAQoD,MAAQH,GAAWA,EAAU,IAAIE,KAAKnD,EAAQoD,UAEtDpD,EAAQqD,IAAMJ,GAAWA,EAAU,IAAIE,KAAKnD,EAAQqD,IAG1D,GACAC,UAAWpE,EACXqE,SAAU,GACVpE,UAAAA,EACAK,aAAAA,EACAE,WAAY,SAAC8D,GACX,IAAMC,EAAWD,EACXE,EACJC,EAAaF,EAASG,MAAQD,EAAaF,EAASI,IAClDH,IACFhE,SAAAA,EAAagE,GAEjB,EACA/D,gBACEmE,EAAAA,KAAAC,WAAA,CACGtD,SAAA,CAAwB,mBAAjBhB,GACNqE,EAAAA,KAAC,QAAA,CACCE,UAAU,kCACVC,QAAQ,kBAERxD,SAAA,CAAAD,EAAAA,IAAC,QAAA,CACCqD,GAAG,kBACHK,KAAK,YACLC,KAAK,WACLC,QAAS/E,EACTgF,SAAU,SAACC,UAAM7E,EAAa6E,EAAEC,OAAOH,QAAO,IAC9C,SAILzE,QAMb,GC5HA,IAAM2B,EAAqB,SAACgB,GAC1B,IAAMkC,EAAUlC,EAAML,OAAOwC,cAC7B,IAAKD,EAAS,MAAO,GACrB,IAAME,EAAYF,EAAQG,QAAQ,aAAc,IAChD,OAAID,GAAaA,IAAcF,EACtB,CAACA,EAASE,GAEZ,CAACF,EACV,EAEMI,EAAgB,SAACL,EAAqBjC,GAC1C,GAAqB,iBAAVA,GAIX,GAAqB,iBAAVA,GAAsBC,OAAOC,SAASF,GAAQ,CACvD,IAAMuC,EAAOC,OAAOxC,GACpBhB,EAAmBuD,GAAMhC,QAAQ,SAACpB,UAAc8C,EAAO9B,IAAIhB,EAAU,EACvE,OANEH,EAAmBgB,GAAOO,QAAQ,SAACpB,UAAc8C,EAAO9B,IAAIhB,EAAU,EAO1E,EAEMsD,EAAsB,SAC1BzC,EACAiC,OACAS,yDAAQ,EAEJA,EAAQ,GAARA,MAAa1C,IACbK,MAAMC,QAAQN,GAChBA,EAAMO,QAAQ,SAACoC,GAAA,OAASF,EAAoBE,EAAMV,EAAQS,EAAQ,EAAE,GAGlE1C,aAAiBa,KACnByB,EAAcL,EAAQjC,EAAM4C,eAGT,WAAjBC,EAAO7C,GAMXsC,EAAcL,EAAQjC,GALpB8C,OAAOC,OAAO/C,GAAkCO,QAAQ,SAACoC,GAAA,OACvDF,EAAoBE,EAAMV,EAAQS,EAAQ,KAKhD,EA4BM7D,EAA0B,SAC9BL,EACA7B,OACaqG,EAAAC,EAAAC,EACPC,MAAiBrD,IACS,CAC9BtB,EAAK+C,GACL/C,EAAK8C,IACL9C,EAAK4E,WACL5E,EAAK6E,YACL7E,EAAK8E,MACL9E,EAAK+E,iBACL/E,EAAKgF,SACJhF,EAAiCiF,eACjCjF,EAAiCkF,aAClClF,EAAKmF,QACLnF,EAAKoF,QACLpF,EAAKc,OACLd,EAAKe,SACLf,EAAKkB,UACJlB,EAAiCqF,mBAEvBtD,QAAQ,SAACP,GAAA,OAAUsC,EAAca,EAAYnD,EAAM,GAEhE,IAAM8D,MAAchE,IACdiE,EAAe,SAAC/D,GACpB,IAAMI,EArCO,SAACJ,GAChB,GAAqB,iBAAVA,GAAsBC,OAAOC,SAASF,GAAQ,OAAOA,EAChE,GAAqB,iBAAVA,EAAoB,CAC7B,IAAMkC,EAAUlC,EAAML,OACtB,IAAKuC,EAAS,OACd,IAAM9B,EAASH,OAAOiC,GACtB,GAAIjC,OAAOC,SAASE,GAAS,OAAOA,CACtC,CAEF,CA4BmB4D,CAAShE,QACT,IAAXI,GACF0D,EAAQ3D,IAAIC,GACZkC,EAAca,EAAY/C,IACA,iBAAVJ,GAChBsC,EAAca,EAAYnD,EAE9B,EA2BA,OAzBA+D,EAAqC,QAArCf,EAAkB,QAAlBC,EAAazE,EAAKyF,kBAAA,IAAAhB,EAAAA,EAAczE,EAAK0F,mBAAAlB,EAAAA,EAAWxE,EAAK2F,WACrDJ,EAAavF,EAAKgC,kBAClBuD,EAAcvF,EAAiC4F,qBAC9C5F,EAAKoB,WAAa,IAAIW,QAAQ,SAACgB,GAAA,OAAOwC,EAAaxC,EAAG,GACpB,QAAjC2B,EAAA1E,EAAiC6F,uBAAAnB,GAAjCA,EAAwE3C,QACxE,SAACgB,UAAOwC,EAAaxC,EAAE,GAGzBuC,EAAQvD,QAAQ,SAACgB,GAAA,OArEQ+C,EAqEiB3H,EAAM4E,GArEKU,EAqEAkB,OApEhDmB,GACU,CACbA,EAAK1C,KACL0C,EAAKC,SACJD,EAAiCE,kBACjCF,EAAiCG,WACjCH,EAAiCI,YAClCJ,EAAKK,MACJL,EAAiCM,UAClCN,EAAKO,OAEAtE,QAAQ,SAACP,GAAA,OAAUsC,EAAcL,EAAQjC,EAAM,IAZ9B,IAACsE,EAA4BrC,CAqEW,GAEhEQ,EAAqBjE,EAAiCsG,OAAQ3B,GAC9DV,EAAqBjE,EAAiCuG,UAAW5B,GACjEV,EACGjE,EAAiCwG,kBAClC7B,GAEFV,EACGjE,EAAiCyG,oBAClC9B,GAEFV,EACGjE,EAAiC0G,aAClC/B,GAGK9C,MAAMS,KAAKqC,EACpB,EAEMzE,EAAW,SAACjB,GAAA,OAChBA,EACGkC,OACAwC,cACAgD,MAAM,OACN7G,OAAO8G,QAAO,ED7InB,IAAMhH,EAAYiH,EAAAA,KAAK,WAAA,OAAAC,EAAA,WAAA,OAAMC,EAAAC,OAAO,iCAAa,OAAA,EAAC"}