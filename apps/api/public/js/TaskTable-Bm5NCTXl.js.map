{"version":3,"mappings":";sOAMA,MAAMA,EAAsBC,GAAkB,CAC5C,MAAMC,EAAUD,EAAM,OAAO,cAC7B,GAAI,CAACC,EAAS,MAAO,GACrB,MAAMC,EAAYD,EAAQ,QAAQ,aAAc,EAAE,EAClD,OAAIC,GAAaA,IAAcD,EACtB,CAACA,EAASC,CAAS,EAErB,CAACD,CAAO,CACjB,EAEME,EAAgB,CAACC,EAAqBJ,IAAmB,CAC7D,GAAI,OAAOA,GAAU,SAAU,CAC7BD,EAAmBC,CAAK,EAAE,QAASK,GAAcD,EAAO,IAAIC,CAAS,CAAC,EACtE,MACF,CACA,GAAI,OAAOL,GAAU,UAAY,OAAO,SAASA,CAAK,EAAG,CACvD,MAAMM,EAAO,OAAON,CAAK,EACzBD,EAAmBO,CAAI,EAAE,QAASD,GAAcD,EAAO,IAAIC,CAAS,CAAC,CACvE,CACF,EAEME,EAAsB,CAC1BP,EACAI,EACAI,EAAQ,IACL,CACH,GAAI,EAAAA,EAAQ,GAAKR,IAAU,MAAQA,IAAU,QAC7C,IAAI,MAAM,QAAQA,CAAK,EAAG,CACxBA,EAAM,QAASS,GAASF,EAAoBE,EAAML,EAAQI,EAAQ,CAAC,CAAC,EACpE,MACF,CACA,GAAIR,aAAiB,KAAM,CACzBG,EAAcC,EAAQJ,EAAM,aAAa,EACzC,MACF,CACA,GAAI,OAAOA,GAAU,SAAU,CAC7B,OAAO,OAAOA,CAAgC,EAAE,QAASS,GACvDF,EAAoBE,EAAML,EAAQI,EAAQ,CAAC,GAE7C,MACF,CACAL,EAAcC,EAAQJ,CAAK,EAC7B,EAEMU,EAAoB,CAACC,EAA4BP,IAAwB,CAC7E,GAAI,CAACO,EAAM,OACI,CACbA,EAAK,KACLA,EAAK,SACJA,EAAiC,kBACjCA,EAAiC,WACjCA,EAAiC,YAClCA,EAAK,MACJA,EAAiC,UAClCA,EAAK,OAEA,QAASX,GAAUG,EAAcC,EAAQJ,CAAK,CAAC,CACxD,EAEMY,EAAYZ,GAAuC,CACvD,GAAI,OAAOA,GAAU,UAAY,OAAO,SAASA,CAAK,EAAG,OAAOA,EAChE,GAAI,OAAOA,GAAU,SAAU,CAC7B,MAAMC,EAAUD,EAAM,OACtB,GAAI,CAACC,EAAS,OACd,MAAMY,EAAS,OAAOZ,CAAO,EAC7B,GAAI,OAAO,SAASY,CAAM,EAAG,OAAOA,CACtC,CAEF,EAEMC,EAA0B,CAC9BC,EACAC,IACa,WACb,MAAMC,MAAiB,IACS,CAC9BF,EAAK,GACLA,EAAK,IACLA,EAAK,WACLA,EAAK,YACLA,EAAK,MACLA,EAAK,iBACLA,EAAK,SACJA,EAAiC,eACjCA,EAAiC,aAClCA,EAAK,QACLA,EAAK,QACLA,EAAK,OACLA,EAAK,SACLA,EAAK,UACJA,EAAiC,mBAEvB,QAASf,GAAUG,EAAcc,EAAYjB,CAAK,CAAC,EAEhE,MAAMkB,MAAc,IACdC,EAAgBnB,GAAmB,CACvC,MAAMa,EAASD,EAASZ,CAAK,EACzBa,IAAW,QACbK,EAAQ,IAAIL,CAAM,EAClBV,EAAcc,EAAYJ,CAAM,GACvB,OAAOb,GAAU,UAC1BG,EAAcc,EAAYjB,CAAK,CAEnC,EAEA,OAAAmB,GAAaC,GAAAC,EAAAN,EAAK,aAAL,KAAAM,EAAmBN,EAAK,UAAxB,KAAAK,EAAmCL,EAAK,SAAS,EAC9DI,EAAaJ,EAAK,gBAAgB,EAClCI,EAAcJ,EAAiC,kBAAkB,GAChEA,EAAK,WAAa,IAAI,QAASO,GAAOH,EAAaG,CAAE,CAAC,GAEpDC,EAAAR,EAAiC,cAAjC,MAAAQ,EACA,QAASD,GAAOH,EAAaG,CAAE,GAElCJ,EAAQ,QAASI,GAAOZ,EAAkBM,EAAMM,CAAE,EAAGL,CAAU,CAAC,EAEhEV,EAAqBQ,EAAiC,OAAQE,CAAU,EACxEV,EAAqBQ,EAAiC,UAAWE,CAAU,EAC3EV,EACGQ,EAAiC,kBAClCE,CAAA,EAEFV,EACGQ,EAAiC,oBAClCE,CAAA,EAEFV,EACGQ,EAAiC,aAClCE,CAAA,EAGK,MAAM,KAAKA,CAAU,CAC9B,EAEMO,EAAYC,GAChBA,EAAM,OAAO,cAAc,MAAM,KAAK,EAAE,OAAO,OAAO,EAExD,SAAwBC,EACtBX,EACAU,EACAT,EACS,CACT,MAAMW,EAASH,EAASC,CAAK,EAC7B,GAAI,CAACE,EAAO,OAAQ,MAAO,GAC3B,MAAMC,EAAWd,EAAwBC,EAAMC,CAAK,EACpD,OAAKY,EAAS,OACPD,EAAO,MAAOE,GACA9B,EAAmB8B,CAAK,EACzB,KAAMC,GACtBF,EAAS,KAAMvB,GAAcA,EAAU,SAASyB,CAAO,CAAC,EAE3D,EAN4B,EAO/B,CC1JA,MAAMC,EAAYC,OAAK,IAAAC,EAAA,IAAM,OAAO,yBAAa,mCAAC,EAuBlD,SAAwBC,EAAU,CAChC,MAAAC,EACA,MAAAnB,EACA,KAAAoB,EACA,UAAAC,EACA,KAAAC,EAAO,GACP,WAAAC,EAAa,OACb,aAAAC,EACA,aAAAC,EACA,WAAAC,EACA,gBAAAC,EACA,aAAAC,CACF,EAAmB,CACjB,KAAM,CAAE,MAAAnB,EAAO,QAAAoB,CAAA,EAAYC,EAAA,EACrBC,EAAUC,EAAM,QACpB,IAAMhC,GAAA,KAAAA,EAAS,GACf,CAACA,CAAK,GAEFiC,EAAUD,EAAM,QACpB,IAAME,EAAYH,EAASR,CAAU,EACrC,CAACQ,EAASR,CAAU,GAGtB,OAAAS,EAAM,UAAU,IAAM,CACpBJ,GAAA,MAAAA,EAAeT,EACjB,EAAG,CAACS,EAAcT,CAAK,CAAC,QAGrBgB,WAAA,CAAS,SAAUC,MAAC,OAAI,+BAAmB,EAC1C,SAAAA,MAACrB,EAAA,CACC,QAAAkB,EACA,KAAMd,EAAM,OAAQkB,GAAM,CAIxB,GAHI5B,GAAS,CAACC,EAAe2B,EAAG5B,EAAOsB,CAAO,GAC1CF,EAAQ,OAAO,QAAU,CAACA,EAAQ,OAAO,SAASQ,EAAE,MAAM,GAG5DR,EAAQ,SAAS,QACjB,CAACA,EAAQ,SAAS,SAASQ,EAAE,QAAkB,EAE/C,MAAO,GACT,GAAIR,EAAQ,UAAU,OAAQ,CAC5B,MAAMS,EACJ,OAAQD,EAA8B,WAAc,SAC9CA,EAA8B,UAAqB,OACrD,GACN,GAAI,CAACC,GAAY,CAACT,EAAQ,UAAU,SAASS,CAAQ,EACnD,MAAO,EACX,CACA,GAAIT,EAAQ,UAAU,OAAQ,CAC5B,MAAMU,MAAe,IACfC,EAAWxD,GAAmB,CAClC,GAAI,OAAOA,GAAU,UAAY,OAAO,SAASA,CAAK,EACpDuD,EAAS,IAAIvD,CAAK,UACT,OAAOA,GAAU,SAAU,CACpC,MAAMa,EAAS,OAAOb,EAAM,MAAM,EAC9B,OAAO,SAASa,CAAM,GAAG0C,EAAS,IAAI1C,CAAM,CAClD,CACF,EAOA,GANI,MAAM,QAASwC,EAA8B,SAAS,GACtDA,EAA8B,UAAwB,QACtDG,CAAA,EAGJA,EAASH,EAA8B,gBAAgB,EAErD,CAACR,EAAQ,UAAU,KAAMY,GACvBF,EAAS,IAAI,OAAOE,CAAQ,CAAC,GAG/B,MAAO,EAEX,CACA,MAAMC,EAAUL,EAAE,UAAY,IAAI,KAAKA,EAAE,SAAS,EAAI,KAGtD,MAFI,EAAAR,EAAQ,MAAQa,GAAWA,EAAU,IAAI,KAAKb,EAAQ,IAAI,GAE1DA,EAAQ,IAAMa,GAAWA,EAAU,IAAI,KAAKb,EAAQ,EAAE,EAG5D,CAAC,EACD,UAAWT,EACX,SAAU,GACV,UAAAC,EACA,aAAAG,EACA,WAAamB,GAAQ,CACnB,MAAMC,EAAWD,EACXE,EACJC,EAAaF,EAAS,GAAG,GAAKE,EAAaF,EAAS,EAAE,EACpDC,IACFnB,GAAA,MAAAA,EAAamB,GAEjB,EACA,gBACEE,OAAAC,WAAA,CACG,iBAAOvB,GAAiB,YACvBsB,OAAC,SACC,UAAU,kCACV,QAAQ,kBAER,UAAAX,MAAC,SACC,GAAG,kBACH,KAAK,YACL,KAAK,WACL,QAASd,EACT,SAAW2B,GAAMxB,EAAawB,EAAE,OAAO,OAAO,IAC9C,SAILtB,CAAA,EACH,IAGN,CAEJ","names":["normalizeCandidate","value","trimmed","collapsed","pushCandidate","target","candidate","text","collectNestedValues","depth","item","addUserCandidates","user","toNumber","parsed","collectTaskSearchValues","task","users","candidates","userIds","appendUserId","_b","_a","id","_c","tokenize","query","matchTaskQuery","tokens","haystack","token","variant","DataTable","lazy","__vitePreload","TaskTable","tasks","page","pageCount","mine","entityKind","onPageChange","onMineChange","onRowClick","toolbarChildren","onDataChange","filters","useTasks","userMap","React","columns","taskColumns","Suspense","jsx","t","taskType","assigned","collect","assignee","created","row","original","normalizedId","coerceTaskId","jsxs","Fragment","e"],"ignoreList":[],"sources":["../../../web/src/utils/matchTaskQuery.ts","../../../web/src/components/TaskTable.tsx"],"sourcesContent":["// Назначение файла: сопоставление задач с текстовым запросом для глобального поиска\n// Модули: taskColumns (тип TaskRow)\nimport type { TaskRow } from '../columns/taskColumns';\n\ntype UserLike = Record<string, unknown>;\n\nconst normalizeCandidate = (value: string) => {\n  const trimmed = value.trim().toLowerCase();\n  if (!trimmed) return [] as string[];\n  const collapsed = trimmed.replace(/[\\s\\-_/]+/g, '');\n  if (collapsed && collapsed !== trimmed) {\n    return [trimmed, collapsed];\n  }\n  return [trimmed];\n};\n\nconst pushCandidate = (target: Set<string>, value: unknown) => {\n  if (typeof value === 'string') {\n    normalizeCandidate(value).forEach((candidate) => target.add(candidate));\n    return;\n  }\n  if (typeof value === 'number' && Number.isFinite(value)) {\n    const text = String(value);\n    normalizeCandidate(text).forEach((candidate) => target.add(candidate));\n  }\n};\n\nconst collectNestedValues = (\n  value: unknown,\n  target: Set<string>,\n  depth = 0,\n) => {\n  if (depth > 2 || value === null || value === undefined) return;\n  if (Array.isArray(value)) {\n    value.forEach((item) => collectNestedValues(item, target, depth + 1));\n    return;\n  }\n  if (value instanceof Date) {\n    pushCandidate(target, value.toISOString());\n    return;\n  }\n  if (typeof value === 'object') {\n    Object.values(value as Record<string, unknown>).forEach((item) =>\n      collectNestedValues(item, target, depth + 1),\n    );\n    return;\n  }\n  pushCandidate(target, value);\n};\n\nconst addUserCandidates = (user: UserLike | undefined, target: Set<string>) => {\n  if (!user) return;\n  const fields = [\n    user.name,\n    user.username,\n    (user as Record<string, unknown>).telegram_username,\n    (user as Record<string, unknown>).telegramId,\n    (user as Record<string, unknown>).telegram_id,\n    user.phone,\n    (user as Record<string, unknown>).mobNumber,\n    user.email,\n  ];\n  fields.forEach((value) => pushCandidate(target, value));\n};\n\nconst toNumber = (value: unknown): number | undefined => {\n  if (typeof value === 'number' && Number.isFinite(value)) return value;\n  if (typeof value === 'string') {\n    const trimmed = value.trim();\n    if (!trimmed) return undefined;\n    const parsed = Number(trimmed);\n    if (Number.isFinite(parsed)) return parsed;\n  }\n  return undefined;\n};\n\nconst collectTaskSearchValues = (\n  task: TaskRow,\n  users: Record<number, UserLike>,\n): string[] => {\n  const candidates = new Set<string>();\n  const directFields: unknown[] = [\n    task.id,\n    task._id,\n    task.request_id,\n    task.task_number,\n    task.title,\n    task.task_description,\n    task.location,\n    (task as Record<string, unknown>).start_location,\n    (task as Record<string, unknown>).end_location,\n    task.project,\n    task.comment,\n    task.status,\n    task.priority,\n    task.task_type,\n    (task as Record<string, unknown>).route_distance_km,\n  ];\n  directFields.forEach((value) => pushCandidate(candidates, value));\n\n  const userIds = new Set<number>();\n  const appendUserId = (value: unknown) => {\n    const parsed = toNumber(value);\n    if (parsed !== undefined) {\n      userIds.add(parsed);\n      pushCandidate(candidates, parsed);\n    } else if (typeof value === 'string') {\n      pushCandidate(candidates, value);\n    }\n  };\n\n  appendUserId(task.created_by ?? task.creator ?? task.createdBy);\n  appendUserId(task.assigned_user_id);\n  appendUserId((task as Record<string, unknown>).controller_user_id);\n  (task.assignees || []).forEach((id) => appendUserId(id));\n  (\n    (task as Record<string, unknown>).controllers as unknown[] | undefined\n  )?.forEach((id) => appendUserId(id));\n\n  userIds.forEach((id) => addUserCandidates(users[id], candidates));\n\n  collectNestedValues((task as Record<string, unknown>).custom, candidates);\n  collectNestedValues((task as Record<string, unknown>).applicant, candidates);\n  collectNestedValues(\n    (task as Record<string, unknown>).logistics_details,\n    candidates,\n  );\n  collectNestedValues(\n    (task as Record<string, unknown>).procurement_details,\n    candidates,\n  );\n  collectNestedValues(\n    (task as Record<string, unknown>).work_details,\n    candidates,\n  );\n\n  return Array.from(candidates);\n};\n\nconst tokenize = (query: string): string[] =>\n  query.trim().toLowerCase().split(/\\s+/).filter(Boolean);\n\nexport default function matchTaskQuery(\n  task: TaskRow,\n  query: string,\n  users: Record<number, UserLike>,\n): boolean {\n  const tokens = tokenize(query);\n  if (!tokens.length) return true;\n  const haystack = collectTaskSearchValues(task, users);\n  if (!haystack.length) return false;\n  return tokens.every((token) => {\n    const variations = normalizeCandidate(token);\n    return variations.some((variant) =>\n      haystack.some((candidate) => candidate.includes(variant)),\n    );\n  });\n}\n\nexport { collectTaskSearchValues };\n","// Назначение файла: таблица задач на основе DataTable\n// Основные модули: React, DataTable (лениво), taskColumns, useTasks, coerceTaskId\nimport React, { lazy, Suspense } from 'react';\nconst DataTable = lazy(() => import('./DataTable'));\nimport taskColumns, { TaskRow } from '../columns/taskColumns';\nimport type { User as AppUser } from '../types/user';\nimport useTasks from '../context/useTasks';\nimport coerceTaskId from '../utils/coerceTaskId';\nimport matchTaskQuery from '../utils/matchTaskQuery';\n\ntype EntityKind = 'task' | 'request';\n\ninterface TaskTableProps {\n  tasks: TaskRow[];\n  users?: Record<number, AppUser>;\n  page: number;\n  pageCount?: number;\n  mine?: boolean;\n  entityKind?: EntityKind;\n  onPageChange: (p: number) => void;\n  onMineChange?: (v: boolean) => void;\n  onRowClick?: (id: string) => void;\n  toolbarChildren?: React.ReactNode;\n  onDataChange?: (rows: TaskRow[]) => void;\n}\n\nexport default function TaskTable({\n  tasks,\n  users,\n  page,\n  pageCount,\n  mine = false,\n  entityKind = 'task',\n  onPageChange,\n  onMineChange,\n  onRowClick,\n  toolbarChildren,\n  onDataChange,\n}: TaskTableProps) {\n  const { query, filters } = useTasks();\n  const userMap = React.useMemo<Record<number, AppUser>>(\n    () => users ?? {},\n    [users],\n  );\n  const columns = React.useMemo(\n    () => taskColumns(userMap, entityKind),\n    [userMap, entityKind],\n  );\n\n  React.useEffect(() => {\n    onDataChange?.(tasks);\n  }, [onDataChange, tasks]);\n\n  return (\n    <Suspense fallback={<div>Загрузка таблицы...</div>}>\n      <DataTable<TaskRow>\n        columns={columns}\n        data={tasks.filter((t) => {\n          if (query && !matchTaskQuery(t, query, userMap)) return false;\n          if (filters.status.length && !filters.status.includes(t.status))\n            return false;\n          if (\n            filters.priority.length &&\n            !filters.priority.includes(t.priority as string)\n          )\n            return false;\n          if (filters.taskTypes.length) {\n            const taskType =\n              typeof (t as Record<string, unknown>).task_type === 'string'\n                ? ((t as Record<string, unknown>).task_type as string).trim()\n                : '';\n            if (!taskType || !filters.taskTypes.includes(taskType))\n              return false;\n          }\n          if (filters.assignees.length) {\n            const assigned = new Set<number>();\n            const collect = (value: unknown) => {\n              if (typeof value === 'number' && Number.isFinite(value)) {\n                assigned.add(value);\n              } else if (typeof value === 'string') {\n                const parsed = Number(value.trim());\n                if (Number.isFinite(parsed)) assigned.add(parsed);\n              }\n            };\n            if (Array.isArray((t as Record<string, unknown>).assignees)) {\n              ((t as Record<string, unknown>).assignees as unknown[]).forEach(\n                collect,\n              );\n            }\n            collect((t as Record<string, unknown>).assigned_user_id);\n            if (\n              !filters.assignees.some((assignee) =>\n                assigned.has(Number(assignee)),\n              )\n            ) {\n              return false;\n            }\n          }\n          const created = t.createdAt ? new Date(t.createdAt) : null;\n          if (filters.from && created && created < new Date(filters.from))\n            return false;\n          if (filters.to && created && created > new Date(filters.to))\n            return false;\n          return true;\n        })}\n        pageIndex={page}\n        pageSize={25}\n        pageCount={pageCount}\n        onPageChange={onPageChange}\n        onRowClick={(row) => {\n          const original = row as TaskRow & Record<string, unknown>;\n          const normalizedId =\n            coerceTaskId(original._id) || coerceTaskId(original.id);\n          if (normalizedId) {\n            onRowClick?.(normalizedId);\n          }\n        }}\n        toolbarChildren={\n          <>\n            {typeof onMineChange === 'function' && (\n              <label\n                className=\"flex items-center gap-1 text-sm\"\n                htmlFor=\"task-table-mine\"\n              >\n                <input\n                  id=\"task-table-mine\"\n                  name=\"mineTasks\"\n                  type=\"checkbox\"\n                  checked={mine}\n                  onChange={(e) => onMineChange(e.target.checked)}\n                />\n                Мои\n              </label>\n            )}\n            {toolbarChildren}\n          </>\n        }\n      />\n    </Suspense>\n  );\n}\n"],"file":"TaskTable-Bm5NCTXl.js"}