# Назначение файла: базовый workflow для запуска проверок lint/typecheck/test/semgrep.
# Модули: установка зависимостей pnpm и запуск одноимённых скриптов.
name: CI

on:
  push:
    branches: [main, work, staging]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  lint:
    name: lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - name: Включение corepack
        run: corepack enable
      - name: Установка зависимостей
        run: pnpm install --frozen-lockfile
      - name: Запуск линтера
        run: pnpm lint

  typecheck:
    name: typecheck
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - name: Включение corepack
        run: corepack enable
      - name: Установка зависимостей
        run: pnpm install --frozen-lockfile
      - name: Проверка типов
        run: pnpm typecheck

  test:
    name: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - name: Включение corepack
        run: corepack enable
      - name: Установка зависимостей
        run: pnpm install --frozen-lockfile
      - name: Проверка скриптов зависимостей
        run: pnpm approve-builds
      - name: Запуск тестов
        env:
          CI: true
        run: pnpm test

  semgrep:
    name: semgrep
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - name: Включение corepack
        run: corepack enable
      - name: Установка зависимостей
        run: pnpm install --frozen-lockfile
      - name: Запуск Semgrep
        env:
          CI: true
        run: pnpm semgrep
