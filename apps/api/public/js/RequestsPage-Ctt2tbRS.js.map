{"version":3,"file":"RequestsPage-Ctt2tbRS.js","sources":["../../../web/src/pages/RequestsPage.tsx"],"sourcesContent":["// Назначение файла: список заявок с таблицей DataTable\r\n// Модули: React, контексты, сервисы задач, shared\r\nimport React from \"react\";\r\nimport { useSearchParams } from \"react-router-dom\";\r\nimport TaskTable from \"../components/TaskTable\";\r\nimport useTasks from \"../context/useTasks\";\r\nimport {\r\n  useTaskIndex,\r\n  useTaskIndexMeta,\r\n} from \"../controllers/taskStateController\";\r\nimport { fetchTasks } from \"../services/tasks\";\r\nimport authFetch from \"../utils/authFetch\";\r\nimport { type Task, type User } from \"shared\";\r\nimport { useAuth } from \"../context/useAuth\";\r\n\r\ninterface RequestRow extends Task {\r\n  assigned_user_id?: number;\r\n  [key: string]: unknown;\r\n}\r\n\r\nexport default function RequestsPage() {\r\n  const [page, setPage] = React.useState(0);\r\n  const [users, setUsers] = React.useState<User[]>([]);\r\n  const [loading, setLoading] = React.useState(true);\r\n  const [params, setParams] = useSearchParams();\r\n  const [mine, setMine] = React.useState(params.get(\"mine\") === \"1\");\r\n  const { version, refresh, controller } = useTasks();\r\n  const { user, loading: authLoading } = useAuth();\r\n  const isAdmin = user?.role === \"admin\";\r\n  const isManager = user?.role === \"manager\";\r\n  const isPrivileged = isAdmin || isManager;\r\n\r\n  const scopeKey = React.useMemo(() => {\r\n    const userKey = user?.telegram_id ? String(user.telegram_id) : \"anon\";\r\n    const mineKey = mine ? \"mine\" : \"all\";\r\n    return `tasks:request:${userKey}:${mineKey}:page=${page + 1}`;\r\n  }, [mine, page, user?.telegram_id]);\r\n\r\n  const tasks = useTaskIndex(scopeKey) as RequestRow[];\r\n  const meta = useTaskIndexMeta(scopeKey);\r\n\r\n  const load = React.useCallback(() => {\r\n    if (!user?.telegram_id) {\r\n      controller.setIndex(scopeKey, [], {\r\n        kind: \"request\",\r\n        mine,\r\n        userId: undefined,\r\n        pageSize: 25,\r\n        total: 0,\r\n        sort: \"desc\",\r\n      });\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    setLoading(true);\r\n    fetchTasks(\r\n      {\r\n        page: page + 1,\r\n        limit: 25,\r\n        mine: mine ? 1 : undefined,\r\n        kind: \"request\",\r\n      },\r\n      user.telegram_id,\r\n      true,\r\n    )\r\n      .then((data) => {\r\n        const rawTasks = data.tasks as RequestRow[];\r\n        const filtered = isPrivileged\r\n          ? rawTasks\r\n          : rawTasks.filter((t) => {\r\n              const assigned =\r\n                t.assignees || (t.assigned_user_id ? [t.assigned_user_id] : []);\r\n              const uid = user.telegram_id;\r\n              return assigned.includes(uid) || t.created_by === uid;\r\n            });\r\n        controller.setIndex(scopeKey, filtered, {\r\n          kind: \"request\",\r\n          mine,\r\n          userId: user.telegram_id,\r\n          pageSize: 25,\r\n          total: data.total || filtered.length,\r\n          sort: \"desc\",\r\n        });\r\n        const list = Array.isArray(data.users)\r\n          ? (data.users as User[])\r\n          : (Object.values(data.users || {}) as User[]);\r\n        setUsers(list);\r\n      })\r\n      .finally(() => setLoading(false));\r\n    if (isPrivileged) {\r\n      authFetch(\"/api/v1/users\")\r\n        .then((r) => (r.ok ? r.json() : []))\r\n        .then((list) =>\r\n          setUsers(Array.isArray(list) ? list : Object.values(list || {})),\r\n        )\r\n        .catch(() => undefined);\r\n    }\r\n  }, [controller, isPrivileged, mine, page, scopeKey, user]);\r\n\r\n  React.useEffect(() => {\r\n    if (authLoading) return;\r\n    if (!user?.telegram_id) return;\r\n    load();\r\n  }, [authLoading, user, load, version, page, mine]);\r\n\r\n  const map = React.useMemo(() => {\r\n    const registry: Record<number, User> = {};\r\n    users.forEach((candidate) => {\r\n      registry[candidate.telegram_id] = candidate;\r\n    });\r\n    return registry;\r\n  }, [users]);\r\n\r\n  if (authLoading) {\r\n    return <div>Загрузка...</div>;\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <h2 className=\"text-2xl font-semibold text-slate-900 dark:text-slate-100\">\r\n        Панель заявок\r\n      </h2>\r\n      {loading && <div>Загрузка...</div>}\r\n      <TaskTable\r\n        tasks={tasks}\r\n        users={map}\r\n        page={page}\r\n        pageCount={Math.ceil((meta.total ?? tasks.length) / 25)}\r\n        mine={mine}\r\n        entityKind=\"request\"\r\n        onPageChange={setPage}\r\n        onMineChange={(value) => {\r\n          setMine(value);\r\n          if (value) params.set(\"mine\", \"1\");\r\n          else params.delete(\"mine\");\r\n          setParams(params);\r\n        }}\r\n        onRowClick={(id) => {\r\n          params.set(\"task\", id);\r\n          setParams(params);\r\n        }}\r\n        toolbarChildren={\r\n          <>\r\n            <button\r\n              onClick={refresh}\r\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\r\n            >\r\n              Обновить\r\n            </button>\r\n            <button\r\n              onClick={() => {\r\n                params.set(\"newRequest\", \"1\");\r\n                setParams(params);\r\n              }}\r\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\r\n            >\r\n              Новая заявка\r\n            </button>\r\n          </>\r\n        }\r\n      />\r\n    </div>\r\n  );\r\n}\r\n"],"names":["RequestsPage","page","setPage","React","users","setUsers","loading","setLoading","params","setParams","useSearchParams","mine","setMine","version","refresh","controller","useTasks","user","authLoading","useAuth","isAdmin","isManager","isPrivileged","scopeKey","userKey","mineKey","tasks","useTaskIndex","meta","useTaskIndexMeta","load","fetchTasks","data","rawTasks","filtered","t","assigned","uid","list","authFetch","r","map","registry","candidate","jsx","jsxs","TaskTable","_a","value","id","Fragment"],"mappings":"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"}