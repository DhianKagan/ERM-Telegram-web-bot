{"version":3,"file":"TasksPage-legacy-DXYfjwe1.js","sources":["../../../web/src/pages/TasksPage.tsx"],"sourcesContent":["// Назначение файла: список задач с таблицей DataTable\r\n// Модули: React, контексты, сервисы задач, shared\r\nimport React from \"react\";\r\nimport { useSearchParams } from \"react-router-dom\";\r\nimport TaskTable from \"../components/TaskTable\";\r\nimport useTasks from \"../context/useTasks\";\r\nimport {\r\n  useTaskIndex,\r\n  useTaskIndexMeta,\r\n} from \"../controllers/taskStateController\";\r\nimport { fetchTasks } from \"../services/tasks\";\r\nimport authFetch from \"../utils/authFetch\";\r\nimport { type Task, type User } from \"shared\";\r\nimport { useAuth } from \"../context/useAuth\";\r\n\r\ntype TaskExtra = Task & {\r\n  assigned_user_id?: number;\r\n  [key: string]: unknown;\r\n};\r\n\r\nexport default function TasksPage() {\r\n  const [page, setPage] = React.useState(0);\r\n  const [users, setUsers] = React.useState<User[]>([]);\r\n  const [loading, setLoading] = React.useState(true);\r\n  const [params, setParams] = useSearchParams();\r\n  const [mine, setMine] = React.useState(params.get(\"mine\") === \"1\");\r\n  const { version, refresh, controller, filters, setFilterUsers } = useTasks();\r\n  const { user, loading: authLoading } = useAuth();\r\n  const isAdmin = user?.role === \"admin\";\r\n  const isManager = user?.role === \"manager\";\r\n  const hasPermission = user?.permissions?.includes(\"tasks\");\r\n  const permissionsList = Array.isArray(user?.permissions)\r\n    ? user?.permissions\r\n    : null;\r\n  const hasExplicitPermissions = (permissionsList?.length ?? 0) > 0;\r\n  const isPrivileged = isAdmin || isManager;\r\n  const canView = isPrivileged || hasPermission || !hasExplicitPermissions;\r\n\r\n  const effectiveMine = isPrivileged ? mine : true;\r\n\r\n  const filterSignature = React.useMemo(() => {\r\n    const statusKey = [...filters.status].sort().join(\",\");\r\n    const priorityKey = [...filters.priority].sort().join(\",\");\r\n    const typeKey = [...filters.taskTypes].sort().join(\",\");\r\n    const assigneeKey = [...filters.assignees].sort((a, b) => a - b).join(\",\");\r\n    return [\r\n      statusKey,\r\n      priorityKey,\r\n      typeKey,\r\n      assigneeKey,\r\n      filters.from,\r\n      filters.to,\r\n    ].join(\"|\");\r\n  }, [filters]);\r\n\r\n  const scopeKey = React.useMemo(() => {\r\n    const userKey = user?.telegram_id ? String(user.telegram_id) : \"anon\";\r\n    const mineKey = effectiveMine ? \"mine\" : \"all\";\r\n    return `tasks:task:${userKey}:${mineKey}:page=${page + 1}:filters=${filterSignature}`;\r\n  }, [effectiveMine, filterSignature, page, user?.telegram_id]);\r\n\r\n  const tasks = useTaskIndex(scopeKey) as TaskExtra[];\r\n  const meta = useTaskIndexMeta(scopeKey);\r\n\r\n  const updateFilterUserList = React.useCallback(\r\n    (list: User[]) => {\r\n      const map = new Map<number, { id: number; name: string; username?: string | null }>();\r\n      list.forEach((item) => {\r\n        const id = Number(item.telegram_id);\r\n        if (!Number.isFinite(id)) return;\r\n        const displayName =\r\n          (typeof item.name === \"string\" && item.name.trim().length > 0\r\n            ? item.name.trim()\r\n            : item.username) ?? `ID ${id}`;\r\n        map.set(id, {\r\n          id,\r\n          name: displayName,\r\n          username: item.username ?? null,\r\n        });\r\n      });\r\n      setFilterUsers(Array.from(map.values()).sort((a, b) => a.name.localeCompare(b.name, \"ru\")));\r\n    },\r\n    [setFilterUsers],\r\n  );\r\n\r\n  const load = React.useCallback(() => {\r\n    if (!user?.telegram_id) {\r\n      controller.setIndex(scopeKey, [], {\r\n        kind: \"task\",\r\n        mine: effectiveMine,\r\n        userId: undefined,\r\n        pageSize: 25,\r\n        total: 0,\r\n        sort: \"desc\",\r\n      });\r\n      setLoading(false);\r\n      return;\r\n    }\r\n    setLoading(true);\r\n    const queryParams: Record<string, unknown> = {\r\n      page: page + 1,\r\n      limit: 25,\r\n      mine: !isPrivileged || mine ? 1 : undefined,\r\n      kind: \"task\",\r\n    };\r\n    if (filters.status.length) {\r\n      queryParams.status = filters.status.join(\",\");\r\n    }\r\n    if (filters.taskTypes.length) {\r\n      queryParams.taskType = filters.taskTypes.join(\",\");\r\n    }\r\n    if (filters.assignees.length) {\r\n      queryParams.assignees = filters.assignees.join(\",\");\r\n    }\r\n    fetchTasks(queryParams, user.telegram_id, true)\r\n      .then((data) => {\r\n        const rawTasks = data.tasks as TaskExtra[];\r\n        const filteredTasks = isPrivileged\r\n          ? rawTasks\r\n          : rawTasks.filter((t) => {\r\n              const assigned =\r\n                t.assignees || (t.assigned_user_id ? [t.assigned_user_id] : []);\r\n              const uid = user.telegram_id;\r\n              return assigned.includes(uid) || t.created_by === uid;\r\n            });\r\n        controller.setIndex(scopeKey, filteredTasks, {\r\n          kind: \"task\",\r\n          mine: effectiveMine,\r\n          userId: user.telegram_id,\r\n          pageSize: 25,\r\n          total: data.total || filteredTasks.length,\r\n          sort: \"desc\",\r\n        });\r\n        const list = Array.isArray(data.users)\r\n          ? (data.users as User[])\r\n          : (Object.values(data.users || {}) as User[]);\r\n        setUsers(list);\r\n        updateFilterUserList(list);\r\n      })\r\n      .finally(() => setLoading(false));\r\n    if (isPrivileged) {\r\n      authFetch(\"/api/v1/users\")\r\n        .then((r) => (r.ok ? r.json() : []))\r\n        .then((list) => {\r\n          const normalized = Array.isArray(list)\r\n            ? (list as User[])\r\n            : (Object.values(list || {}) as User[]);\r\n          setUsers(normalized);\r\n          updateFilterUserList(normalized);\r\n        })\r\n        .catch(() => undefined);\r\n    }\r\n  }, [\r\n    controller,\r\n    effectiveMine,\r\n    isPrivileged,\r\n    mine,\r\n    page,\r\n    scopeKey,\r\n    user,\r\n    filters,\r\n    updateFilterUserList,\r\n  ]);\r\n\r\n  React.useEffect(() => {\r\n    if (authLoading) return;\r\n    if (isPrivileged) return;\r\n    if (!mine) {\r\n      setMine(true);\r\n    }\r\n    if (params.get(\"mine\") !== \"1\") {\r\n      const next = new URLSearchParams(params);\r\n      next.set(\"mine\", \"1\");\r\n      setParams(next, { replace: true });\r\n    }\r\n  }, [authLoading, isPrivileged, mine, params, setParams]);\r\n\r\n  React.useEffect(() => {\r\n    if (authLoading) return;\r\n    if (!canView) return;\r\n    if (!user?.telegram_id) return;\r\n    load();\r\n    // после загрузки профиля инициируем загрузку задач\r\n  }, [authLoading, user, load, version, page, mine, canView]);\r\n\r\n  const userMap = React.useMemo(() => {\r\n    const map: Record<number, User> = {};\r\n    users.forEach((u) => {\r\n      map[u.telegram_id] = u;\r\n    });\r\n    return map;\r\n  }, [users]);\r\n\r\n  if (authLoading) return <div>Загрузка...</div>;\r\n  if (!canView)\r\n    return <div className=\"p-4\">У вас нет прав для просмотра задач</div>;\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <h2 className=\"text-2xl font-semibold text-slate-900 dark:text-slate-100\">\r\n        Панель управления задачами\r\n      </h2>\r\n      {loading && <div>Загрузка...</div>}\r\n      <TaskTable\r\n        tasks={tasks}\r\n        users={userMap}\r\n        page={page}\r\n        pageCount={Math.ceil((meta.total ?? tasks.length) / 25)}\r\n        mine={isPrivileged ? mine : true}\r\n        onPageChange={setPage}\r\n        onMineChange={\r\n          isPrivileged\r\n            ? (v) => {\r\n                setMine(v);\r\n                if (v) params.set(\"mine\", \"1\");\r\n                else params.delete(\"mine\");\r\n                setParams(params);\r\n              }\r\n            : undefined\r\n        }\r\n        onRowClick={(id) => {\r\n          params.set(\"task\", id);\r\n          setParams(params);\r\n        }}\r\n        toolbarChildren={\r\n          <>\r\n            <button\r\n              onClick={refresh}\r\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\r\n            >\r\n              Обновить\r\n            </button>\r\n            <button\r\n              onClick={() => {\r\n                params.set(\"newTask\", \"1\");\r\n                setParams(params);\r\n              }}\r\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\r\n            >\r\n              Новая задача\r\n            </button>\r\n          </>\r\n        }\r\n      />\r\n    </div>\r\n  );\r\n}\r\n"],"names":["_user$permissions","_permissionsList$leng","_meta$total","_React$useState2","_slicedToArray","React","useState","page","setPage","_React$useState4","users","setUsers","_React$useState6","loading","setLoading","_useSearchParams2","useSearchParams","params","setParams","_React$useState8","get","mine","setMine","_useTasks","useTasks","version","refresh","controller","filters","setFilterUsers","_useAuth","useAuth","user","authLoading","isAdmin","role","isManager","hasPermission","permissions","includes","permissionsList","Array","isArray","hasExplicitPermissions","length","isPrivileged","canView","effectiveMine","filterSignature","useMemo","_toConsumableArray","status","sort","join","priority","taskTypes","assignees","a","b","from","to","scopeKey","userKey","telegram_id","String","mineKey","concat","tasks","useTaskIndex","meta","useTaskIndexMeta","updateFilterUserList","useCallback","list","map","Map","forEach","item","_ref","_item$username","id","Number","isFinite","displayName","name","trim","username","set","values","localeCompare","load","setIndex","kind","userId","pageSize","total","queryParams","limit","taskType","fetchTasks","then","data","rawTasks","filteredTasks","filter","t","assigned","assigned_user_id","uid","created_by","Object","finally","authFetch","r","ok","json","normalized","catch","useEffect","next","URLSearchParams","replace","userMap","u","jsx","children","jsxs","className","TaskTable","pageCount","Math","ceil","onPageChange","onMineChange","v","delete","onRowClick","toolbarChildren","Fragment","onClick"],"mappings":"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"}