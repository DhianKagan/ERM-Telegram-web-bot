{"version":3,"file":"map-sKDTM6ec.js","sources":["../../../web/src/utils/haversine.ts","../../../web/src/utils/mapLibrary.ts","../../../web/src/config/map.ts"],"sourcesContent":["// Назначение файла: расчёт геодезического расстояния между двумя координатами\r\n// Основные модули: отсутствуют\r\nimport type { LatLng } from \"./extractCoords\";\r\n\r\nconst EARTH_RADIUS_KM = 6371;\r\n\r\nexport default function haversine(a: LatLng, b: LatLng): number {\r\n  const toRadians = (value: number) => (value * Math.PI) / 180;\r\n  const dLat = toRadians(b.lat - a.lat);\r\n  const dLon = toRadians(b.lng - a.lng);\r\n  const lat1 = toRadians(a.lat);\r\n  const lat2 = toRadians(b.lat);\r\n  const sinLat = Math.sin(dLat / 2);\r\n  const sinLon = Math.sin(dLon / 2);\r\n  const h = sinLat * sinLat + Math.cos(lat1) * Math.cos(lat2) * sinLon * sinLon;\r\n  const c = 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));\r\n  return EARTH_RADIUS_KM * c;\r\n}\r\n","// Назначение: единая точка подключения MapLibre и поддержки протокола PMTiles\r\n// Основные модули: maplibre-gl, pmtiles\r\n\r\nimport maplibregl, {\r\n  type GeoJSONSource,\r\n  type LngLatBoundsLike,\r\n  type Map as MapInstance,\r\n  type MapLayerMouseEvent,\r\n  type MapMouseEvent,\r\n  type Marker as MapMarker,\r\n} from \"maplibre-gl\";\r\nimport { Protocol } from \"pmtiles\";\r\nimport \"maplibre-gl/dist/maplibre-gl.css\";\r\n\r\nlet pmtilesProtocolRegistered = false;\r\n\r\nconst registerPmtilesProtocol = () => {\r\n  if (pmtilesProtocolRegistered) {\r\n    return;\r\n  }\r\n  try {\r\n    const protocol = new Protocol();\r\n    maplibregl.addProtocol(\"pmtiles\", (request) => protocol.tile(request));\r\n    pmtilesProtocolRegistered = true;\r\n  } catch (error) {\r\n    console.error(\"Не удалось зарегистрировать протокол PMTiles\", error);\r\n  }\r\n};\r\n\r\nif (typeof window !== \"undefined\") {\r\n  registerPmtilesProtocol();\r\n}\r\n\r\nexport default maplibregl;\r\nexport { registerPmtilesProtocol };\r\nexport type {\r\n  GeoJSONSource,\r\n  LngLatBoundsLike,\r\n  MapInstance,\r\n  MapLayerMouseEvent,\r\n  MapMouseEvent,\r\n  MapMarker,\r\n};\r\n","// Назначение файла: общие настройки карт для веб-клиента на базе MapLibre\r\n// Основные модули: maplibre-gl\r\n\r\nimport type { StyleSpecification } from \"maplibre-gl\";\r\n\r\ndeclare const __ERM_MAP_STYLE_MODE__: string | undefined;\r\n\r\ntype MapStyleMode = \"pmtiles\" | \"raster\";\r\n\r\ntype EnvLookup = (key: string) => string | undefined;\r\n\r\nconst fromProcess: EnvLookup = (key) => {\r\n  if (typeof process === \"undefined\" || !process.env) {\r\n    return undefined;\r\n  }\r\n  const raw = process.env[key];\r\n  return raw && raw.trim() ? raw.trim() : undefined;\r\n};\r\n\r\nconst fromDefine: EnvLookup = (_key) => {\r\n  if (typeof __ERM_MAP_STYLE_MODE__ === \"string\") {\r\n    return __ERM_MAP_STYLE_MODE__;\r\n  }\r\n  return undefined;\r\n};\r\n\r\nconst sanitizeStyleMode = (value: string | undefined): MapStyleMode | undefined => {\r\n  if (!value) {\r\n    return undefined;\r\n  }\r\n  const normalized = value.trim().toLowerCase();\r\n  if ([\"pmtiles\", \"vector\", \"tiles\"].includes(normalized)) {\r\n    return \"pmtiles\";\r\n  }\r\n  if ([\"raster\", \"osm\", \"fallback\"].includes(normalized)) {\r\n    return \"raster\";\r\n  }\r\n  return undefined;\r\n};\r\n\r\nconst resolveStyleMode = (): MapStyleMode => {\r\n  const explicit =\r\n    sanitizeStyleMode(fromProcess(\"VITE_MAP_STYLE_MODE\")) ??\r\n    sanitizeStyleMode(fromDefine(\"VITE_MAP_STYLE_MODE\"));\r\n  if (explicit) {\r\n    return explicit;\r\n  }\r\n  const envHint = fromProcess(\"VITE_USE_PMTILES\");\r\n  if (envHint && envHint.trim()) {\r\n    return envHint === \"0\" || envHint.toLowerCase() === \"false\"\r\n      ? \"raster\"\r\n      : \"pmtiles\";\r\n  }\r\n  const nodeEnv = fromProcess(\"NODE_ENV\");\r\n  const isProduction = nodeEnv === \"production\" || nodeEnv === \"production-build\";\r\n  return isProduction ? \"pmtiles\" : \"raster\";\r\n};\r\n\r\nconst LOCAL_GLYPHS_TEMPLATE = \"/tiles/fonts/{fontstack}/{range}.pbf\";\r\nconst REMOTE_GLYPHS_TEMPLATE =\r\n  \"https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf\";\r\n\r\nconst sanitizeGlyphTemplate = (value: string | undefined): string | undefined => {\r\n  if (!value) {\r\n    return undefined;\r\n  }\r\n  const trimmed = value.trim();\r\n  if (!trimmed.includes(\"{fontstack}\") || !trimmed.includes(\"{range}\")) {\r\n    return undefined;\r\n  }\r\n  return trimmed;\r\n};\r\n\r\nconst resolveGlyphsTemplate = (styleMode: MapStyleMode): string => {\r\n  const envTemplate =\r\n    sanitizeGlyphTemplate(fromProcess(\"VITE_MAP_GLYPHS_URL\")) ??\r\n    sanitizeGlyphTemplate(fromProcess(\"VITE_MAP_GLYPHS_PATH\"));\r\n  if (envTemplate) {\r\n    return envTemplate;\r\n  }\r\n  if (styleMode === \"pmtiles\") {\r\n    return REMOTE_GLYPHS_TEMPLATE;\r\n  }\r\n  return LOCAL_GLYPHS_TEMPLATE;\r\n};\r\n\r\nexport const MAP_STYLE_MODE: MapStyleMode = resolveStyleMode();\r\n\r\nexport const MAP_ATTRIBUTION = \"© OpenStreetMap contributors, ODbL\";\r\nexport const MAP_VECTOR_SOURCE_ID = \"openmaptiles\";\r\nexport const MAP_ADDRESSES_SOURCE_ID = \"addresses\";\r\nexport const MAP_BASEMAP_PMTILES_URL = \"pmtiles://tiles/basemap.pmtiles\";\r\nexport const MAP_ADDRESSES_PMTILES_URL = \"pmtiles://tiles/addresses.pmtiles\";\r\nexport const MAP_GLYPHS_PATH = resolveGlyphsTemplate(MAP_STYLE_MODE);\r\n\r\nconst DEV_RASTER_STYLE: StyleSpecification = {\r\n  version: 8,\r\n  sources: {\r\n    osmRaster: {\r\n      type: \"raster\",\r\n      tiles: [\"https://tile.openstreetmap.org/{z}/{x}/{y}.png\"],\r\n      tileSize: 256,\r\n      attribution: MAP_ATTRIBUTION,\r\n    },\r\n  },\r\n  layers: [\r\n    {\r\n      id: \"osm-raster\",\r\n      type: \"raster\",\r\n      source: \"osmRaster\",\r\n    },\r\n  ],\r\n};\r\n\r\nconst labelFont = [\"Noto Sans Regular\", \"Open Sans Regular\", \"Arial Unicode MS Regular\"];\r\nconst labelHalo = {\r\n  \"text-color\": \"#1f2937\",\r\n  \"text-halo-color\": \"#f8fafc\",\r\n  \"text-halo-width\": 1.2,\r\n};\r\n\r\nconst createPmtilesStyle = (): StyleSpecification => ({\r\n  version: 8,\r\n  glyphs: MAP_GLYPHS_PATH,\r\n  sources: {\r\n    [MAP_VECTOR_SOURCE_ID]: {\r\n      type: \"vector\",\r\n      url: MAP_BASEMAP_PMTILES_URL,\r\n    },\r\n  },\r\n  layers: [\r\n    {\r\n      id: \"background\",\r\n      type: \"background\",\r\n      paint: {\r\n        \"background-color\": \"#f8fafc\",\r\n      },\r\n    },\r\n    {\r\n      id: \"water-fill\",\r\n      type: \"fill\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"water\",\r\n      paint: {\r\n        \"fill-color\": \"#bfdbfe\",\r\n      },\r\n    },\r\n    {\r\n      id: \"landcover\",\r\n      type: \"fill\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"landcover\",\r\n      paint: {\r\n        \"fill-color\": \"#e2e8f0\",\r\n        \"fill-opacity\": 0.4,\r\n      },\r\n    },\r\n    {\r\n      id: \"landuse\",\r\n      type: \"fill\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"landuse\",\r\n      paint: {\r\n        \"fill-color\": \"#f1f5f9\",\r\n        \"fill-opacity\": 0.35,\r\n      },\r\n    },\r\n    {\r\n      id: \"building\",\r\n      type: \"fill\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"building\",\r\n      paint: {\r\n        \"fill-color\": \"#cbd5f5\",\r\n        \"fill-outline-color\": \"#94a3b8\",\r\n      },\r\n    },\r\n    {\r\n      id: \"road\",\r\n      type: \"line\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"transportation\",\r\n      paint: {\r\n        \"line-color\": \"#94a3b8\",\r\n        \"line-width\": [\r\n          \"interpolate\",\r\n          [\"linear\"],\r\n          [\"zoom\"],\r\n          5,\r\n          0.2,\r\n          12,\r\n          1.2,\r\n          16,\r\n          2.6,\r\n        ],\r\n      },\r\n    },\r\n    {\r\n      id: \"road-major\",\r\n      type: \"line\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"transportation\",\r\n      filter: [\"==\", [\"get\", \"class\"], \"trunk\"],\r\n      paint: {\r\n        \"line-color\": \"#64748b\",\r\n        \"line-width\": [\r\n          \"interpolate\",\r\n          [\"linear\"],\r\n          [\"zoom\"],\r\n          6,\r\n          0.6,\r\n          12,\r\n          2.4,\r\n          16,\r\n          4,\r\n        ],\r\n      },\r\n    },\r\n    {\r\n      id: \"street-label\",\r\n      type: \"symbol\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"transportation_name\",\r\n      layout: {\r\n        \"text-field\": [\r\n          \"coalesce\",\r\n          [\"get\", \"name:uk\"],\r\n          [\"get\", \"name:ru\"],\r\n          [\"get\", \"name\"],\r\n        ],\r\n        \"text-font\": labelFont,\r\n        \"text-size\": [\r\n          \"interpolate\",\r\n          [\"linear\"],\r\n          [\"zoom\"],\r\n          13,\r\n          10,\r\n          18,\r\n          15,\r\n        ],\r\n        \"symbol-placement\": \"line\",\r\n      },\r\n      paint: labelHalo,\r\n    },\r\n    {\r\n      id: \"settlement-major-label\",\r\n      type: \"symbol\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"place\",\r\n      filter: [\r\n        \"any\",\r\n        [\"==\", [\"get\", \"class\"], \"city\"],\r\n        [\"==\", [\"get\", \"class\"], \"town\"],\r\n      ],\r\n      layout: {\r\n        \"text-field\": [\r\n          \"coalesce\",\r\n          [\"get\", \"name:uk\"],\r\n          [\"get\", \"name:ru\"],\r\n          [\"get\", \"name\"],\r\n        ],\r\n        \"text-font\": labelFont,\r\n        \"text-size\": [\r\n          \"interpolate\",\r\n          [\"linear\"],\r\n          [\"zoom\"],\r\n          6,\r\n          11,\r\n          14,\r\n          20,\r\n        ],\r\n      },\r\n      paint: labelHalo,\r\n    },\r\n  ],\r\n});\r\n\r\nexport const MAP_STYLE: StyleSpecification =\r\n  MAP_STYLE_MODE === \"pmtiles\" ? createPmtilesStyle() : DEV_RASTER_STYLE;\r\n\r\nexport const MAP_DEFAULT_CENTER: [number, number] = [48.3794, 31.1656];\r\nexport const MAP_DEFAULT_ZOOM = 6;\r\nexport const MAP_MAX_BOUNDS: [[number, number], [number, number]] = [\r\n  [22.1372, 44.3865],\r\n  [40.2286, 52.3796],\r\n];\r\n\r\nexport const MAP_ANIMATION_SPEED_KMH = 45;\r\n"],"names":["EARTH_RADIUS_KM","haversine","a","b","toRadians","value","dLat","dLon","lat1","lat2","sinLat","sinLon","h","c","pmtilesProtocolRegistered","registerPmtilesProtocol","protocol","Protocol","maplibregl","request","error","fromProcess","key","define_process_env_default","raw","fromDefine","_key","sanitizeStyleMode","normalized","resolveStyleMode","explicit","_a","envHint","nodeEnv","LOCAL_GLYPHS_TEMPLATE","REMOTE_GLYPHS_TEMPLATE","sanitizeGlyphTemplate","trimmed","resolveGlyphsTemplate","styleMode","envTemplate","MAP_STYLE_MODE","MAP_ATTRIBUTION","MAP_VECTOR_SOURCE_ID","MAP_BASEMAP_PMTILES_URL","MAP_ADDRESSES_PMTILES_URL","MAP_GLYPHS_PATH","DEV_RASTER_STYLE","labelFont","labelHalo","createPmtilesStyle","MAP_STYLE","MAP_DEFAULT_CENTER","MAP_DEFAULT_ZOOM","MAP_MAX_BOUNDS","MAP_ANIMATION_SPEED_KMH"],"mappings":"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"}