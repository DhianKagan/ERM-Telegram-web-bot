{"version":3,"file":"users-Dvp7_OPk.js","sources":["../../../web/src/services/users.ts"],"sourcesContent":["// Назначение: запросы к API пользователей\n// Основные модули: authFetch\nimport authFetch from '../utils/authFetch';\nimport type { User } from '../types/user';\nimport { normalizeUser, normalizeUsers } from './normalizeUser';\n\nexport interface UserDetails extends User {\n  email?: string;\n  mobNumber?: string;\n  name?: string;\n}\n\nconst referenceFields = new Set<\n  'roleId' | 'departmentId' | 'divisionId' | 'positionId'\n>(['roleId', 'departmentId', 'divisionId', 'positionId']);\n\nconst normalizeRoleId = (value?: string) => {\n  if (typeof value !== 'string') return undefined;\n  const trimmed = value.trim();\n  return trimmed.length > 0 ? trimmed : undefined;\n};\n\nconst buildCreateUserBody = (\n  id?: number | string,\n  username?: string,\n  roleId?: string,\n) => {\n  const payload: Record<string, unknown> = {};\n  if (id !== undefined) {\n    payload.id = id;\n  }\n  if (typeof username === 'string') {\n    const trimmed = username.trim();\n    if (trimmed.length > 0) {\n      payload.username = trimmed;\n    }\n  } else if (username !== undefined) {\n    payload.username = username;\n  }\n  const normalizedRoleId = normalizeRoleId(roleId);\n  if (normalizedRoleId) {\n    payload.roleId = normalizedRoleId;\n  }\n  return payload;\n};\n\nconst sanitizeUserUpdatePayload = (data: Partial<User>): Partial<User> => {\n  const payload: Partial<User> = {};\n  (Object.entries(data) as [keyof User, User[keyof User]][]).forEach(\n    ([key, value]) => {\n      if (value === undefined || value === null) {\n        return;\n      }\n      if (typeof value === 'string') {\n        const trimmed = value.trim();\n        if (\n          referenceFields.has(\n            key as 'roleId' | 'departmentId' | 'divisionId' | 'positionId',\n          )\n        ) {\n          if (trimmed.length === 0) {\n            return;\n          }\n          payload[key] = trimmed as User[keyof User];\n          return;\n        }\n        payload[key] = trimmed as User[keyof User];\n        return;\n      }\n      payload[key] = value;\n    },\n  );\n  return payload;\n};\n\nexport const fetchUser = async (\n  id: number | string,\n): Promise<UserDetails | null> => {\n  const res = await authFetch(`/api/v1/users/${id}`, { noRedirect: true });\n  if (res.status === 404) return null;\n  if (!res.ok) {\n    const text = await res.text().catch(() => '');\n    throw new Error(text || 'Не удалось загрузить пользователя');\n  }\n  const data = await res.json();\n  return normalizeUser(data) as UserDetails;\n};\n\nexport const fetchUsers = async (): Promise<User[]> => {\n  const response = await authFetch('/api/v1/users');\n  if (response.ok) {\n    const data = await response.json();\n    return Array.isArray(data) ? (normalizeUsers(data) as User[]) : [];\n  }\n  const text = await response.text().catch(() => '');\n  throw new Error(text || 'Не удалось загрузить пользователей');\n};\n\nexport const createUser = (\n  id?: number | string,\n  username?: string,\n  roleId?: string,\n) => {\n  const body = buildCreateUserBody(id, username, roleId);\n  return authFetch('/api/v1/users', {\n    method: 'POST',\n    confirmed: true,\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify(body),\n  }).then(async (r) => {\n    if (!r.ok) {\n      const body = await r.text().catch(() => '');\n      let message = 'Не удалось создать пользователя';\n      if (body) {\n        try {\n          const data = JSON.parse(body) as {\n            error?: string;\n            message?: string;\n            detail?: string;\n          };\n          message = data.error || data.detail || data.message || message;\n        } catch {\n          message = body;\n        }\n      }\n      throw new Error(message);\n    }\n    const data = await r.json();\n    return normalizeUser(data);\n  });\n};\n\nexport interface GeneratedUserCredentials {\n  telegram_id: number;\n  username: string;\n}\n\nexport const previewUserCredentials = (\n  id?: number | string,\n  username?: string,\n): Promise<GeneratedUserCredentials> =>\n  authFetch(`/api/v1/users?preview=1`, {\n    method: 'POST',\n    confirmed: true,\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ id, username }),\n  }).then(async (r) => {\n    if (!r.ok) {\n      const body = await r.text().catch(() => '');\n      let message = 'Не удалось получить сгенерированные данные';\n      if (body) {\n        try {\n          const parsed = JSON.parse(body) as {\n            error?: string;\n            detail?: string;\n            message?: string;\n          };\n          message = parsed.error || parsed.detail || parsed.message || message;\n        } catch {\n          message = body;\n        }\n      }\n      throw new Error(message);\n    }\n    return r.json();\n  });\n\nexport const updateUser = (\n  id: number | string,\n  data: Partial<User>,\n): Promise<UserDetails | null> => {\n  const body = sanitizeUserUpdatePayload(data);\n  return authFetch(`/api/v1/users/${id}`, {\n    method: 'PATCH',\n    confirmed: true,\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify(body),\n  }).then(async (r) => {\n    if (!r.ok) {\n      const body = await r.text().catch(() => '');\n      let message = 'Не удалось обновить пользователя';\n      if (body) {\n        try {\n          const parsed = JSON.parse(body) as {\n            error?: string;\n            detail?: string;\n            message?: string;\n          };\n          message = parsed.error || parsed.detail || parsed.message || message;\n        } catch {\n          message = body;\n        }\n      }\n      throw new Error(message);\n    }\n    const data = await r.json();\n    return normalizeUser(data) as UserDetails;\n  });\n};\n\nexport const deleteUser = async (id: number | string): Promise<void> => {\n  const response = await authFetch(`/api/v1/users/${id}`, {\n    method: 'DELETE',\n    confirmed: true,\n  });\n  if (response.status === 404) {\n    throw new Error('Пользователь не найден');\n  }\n  if (!response.ok) {\n    const body = await response.text().catch(() => '');\n    throw new Error(body || 'Не удалось удалить пользователя');\n  }\n};\n"],"names":["referenceFields","normalizeRoleId","value","trimmed","buildCreateUserBody","id","username","roleId","payload","normalizedRoleId","sanitizeUserUpdatePayload","data","key","fetchUser","res","authFetch","text","normalizeUser","fetchUsers","response","normalizeUsers","createUser","body","r","message","e","previewUserCredentials","parsed","updateUser","deleteUser"],"mappings":"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"}