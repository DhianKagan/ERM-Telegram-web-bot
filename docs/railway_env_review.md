<!-- Назначение файла: чек-лист проверки переменных Railway и рекомендации по их корректировке. -->

# Проверка переменных Railway

Ниже собраны выводы по представленному набору переменных окружения.

## Обязательные переменные
- `BOT_TOKEN`, `CHAT_ID`, `JWT_SECRET`, `APP_URL` заданы и соответствуют требованиям `config.ts`.
- `SESSION_SECRET` присутствует, что обязательно для сессий Express.
- `NODE_ENV=production` соответствует чек-листу деплоя на Railway.

## MongoDB
- Текущее значение `MONGO_DATABASE_URL` (`mongodb://mongo:***@shinkansen.proxy.rlwy.net:43551`) не содержит имени базы и параметра `authSource`. Конфиг API теперь валидирует обе части и остановит запуск без них, поэтому используйте строку формата `mongodb://<user>:<pass>@<host>:<port>/<db>?authSource=<база_аутентификации>`, как в `.env.example`, чтобы исключить ошибки авторизации при рестарте Railway. Если вы не можете добавить сегменты напрямую (например, при копировании публичной ссылки Railway), задайте `MONGO_DATABASE_NAME` и `MONGO_AUTH_SOURCE` — приложение дополнит строку автоматически.
- Проверка конфигурации также распространяется на публичный прокси Railway (`*.proxy.rlwy.net`) и пользовательский домен `*.railway.app`: без `authSource=admin` приложение не запустится, чтобы предотвратить ошибку `Authentication failed`.
- Если логин и пароль вынесены в отдельные секреты Railway, задайте `MONGO_USERNAME` и `MONGO_PASSWORD` — они будут автоматически подставлены в `MONGO_DATABASE_URL`. Дополнительно можно указать `MONGO_DATABASE_NAME` и `MONGO_AUTH_SOURCE`, чтобы публичный прокси Railway был доступен для тестовых сред без ручного редактирования URI.
- Если база размещена в проекте Railway, включите Private Networking и вместо публичного прокси укажите внутренний DNS `erm-mongodb.railway.internal`. В стандартной конфигурации образа Railway с переменными `MONGO_INITDB_ROOT_USERNAME=mongo` и `MONGO_INITDB_ROOT_PASSWORD=…` корневой пользователь создаётся в базе `admin`, поэтому рекомендуемая строка подключения выглядит так: `mongodb://mongo:<пароль>@erm-mongodb.railway.internal:27017/ermdb?authSource=admin&directConnection=true`. Меняйте `authSource` только если вы вручную создали пользователя в другой базе. Внутренний адрес резолвится в IPv6 и доступен только из сервисов того же проекта, что исключает внешние задержки и лимиты по трафику.

## URL-адреса
- `APP_URL=https://agromarket.up.railway.app` и `COOKIE_DOMAIN=agromarket.up.railway.app` согласованы. Если потребуется доступ по поддоменам, задайте `COOKIE_DOMAIN=.agromarket.up.railway.app`.
- `ROUTING_URL` и `VITE_ROUTING_URL` указывают на OSRM `/route`, что соответствует требованиям клиентского и серверного кода.
- `BOT_API_URL` необязателен, но значение `https://api.telegram.org` корректно.

## Порты
- На Railway не задавайте `PORT` и `HOST_PORT` вручную: платформа назначает собственный порт и передаёт его через переменную `PORT`. Жёсткое значение `3001` мешает привязке. Удалите обе переменные из Railway, чтобы использовать порт, который выставляет платформа.
- Конфиг API теперь распознаёт `RAILWAY_TCP_PORT` и будет слушать именно его, даже если вы задали своё `PORT`. В логах появится предупреждение `Railway принудительно использует порт …`, а `HOST_PORT` будет проигнорирован. Это помогает поймать неправильную настройку ещё до появления `502 Bad Gateway`.

## Расписания и роли
- `SCHEDULE_CRON=*/1 * * * *` задействует ежеминутный запуск планировщика — проверьте, что такой частоты достаточно.
- `ADMIN_ROLE_ID` и `USER_ROLE_ID` соответствуют значениям из примера окружения; дополнительной настройки не требуется.

## Дополнительные параметры
- `LOCALE=ru`, `VITE_BOT_USERNAME`, `VITE_CHAT_ID`, `STORAGE_DIR=/storage` — значения валидны.
- `LHCI_GITHUB_APP_TOKEN` и другие токены храните в секрете Railway, чтобы ими не пользовались посторонние.

## Итог
1. Удалите переменные `PORT` и `HOST_PORT` из Railway.
2. Приведите `MONGO_DATABASE_URL` к виду `mongodb://<user>:<pass>@<host>:<port>/<db>?authSource=admin`.
3. Остальные значения соответствуют требованиям репозитория.
