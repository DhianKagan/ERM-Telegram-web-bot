{"version":3,"file":"RequestsPage-legacy-g_V1kZgV.js","sources":["../../../web/src/pages/RequestsPage.tsx"],"sourcesContent":["// Назначение файла: список заявок с таблицей DataTable\n// Модули: React, контексты, сервисы задач, shared\nimport React from 'react';\nimport { useSearchParams } from 'react-router-dom';\nimport TaskTable from '../components/TaskTable';\nimport useTasks from '../context/useTasks';\nimport {\n  useTaskIndex,\n  useTaskIndexMeta,\n} from '../controllers/taskStateController';\nimport { fetchTasks } from '../services/tasks';\nimport authFetch from '../utils/authFetch';\nimport { type Task, type User } from 'shared';\nimport { useAuth } from '../context/useAuth';\n\ninterface RequestRow extends Task {\n  assigned_user_id?: number;\n  [key: string]: unknown;\n}\n\nexport default function RequestsPage() {\n  const [page, setPage] = React.useState(0);\n  const [users, setUsers] = React.useState<User[]>([]);\n  const [loading, setLoading] = React.useState(true);\n  const [params, setParams] = useSearchParams();\n  const [mine, setMine] = React.useState(params.get('mine') === '1');\n  const { version, refresh, controller } = useTasks();\n  const { user, loading: authLoading } = useAuth();\n  const isAdmin = user?.role === 'admin';\n  const isManager = user?.role === 'manager';\n  const isPrivileged = isAdmin || isManager;\n\n  const scopeKey = React.useMemo(() => {\n    const userKey = user?.telegram_id ? String(user.telegram_id) : 'anon';\n    const mineKey = mine ? 'mine' : 'all';\n    return `tasks:request:${userKey}:${mineKey}:page=${page + 1}`;\n  }, [mine, page, user?.telegram_id]);\n\n  const tasks = useTaskIndex(scopeKey) as RequestRow[];\n  const meta = useTaskIndexMeta(scopeKey);\n\n  const load = React.useCallback(() => {\n    if (!user?.telegram_id) {\n      controller.setIndex(scopeKey, [], {\n        kind: 'request',\n        mine,\n        userId: undefined,\n        pageSize: 25,\n        total: 0,\n        sort: 'desc',\n      });\n      setLoading(false);\n      return;\n    }\n    setLoading(true);\n    fetchTasks(\n      {\n        page: page + 1,\n        limit: 25,\n        mine: mine ? 1 : undefined,\n        kind: 'request',\n      },\n      user.telegram_id,\n      true,\n    )\n      .then((data) => {\n        const rawTasks = data.tasks as RequestRow[];\n        const filtered = isPrivileged\n          ? rawTasks\n          : rawTasks.filter((t) => {\n              const assigned =\n                t.assignees || (t.assigned_user_id ? [t.assigned_user_id] : []);\n              const uid = user.telegram_id;\n              return assigned.includes(uid) || t.created_by === uid;\n            });\n        controller.setIndex(scopeKey, filtered, {\n          kind: 'request',\n          mine,\n          userId: user.telegram_id,\n          pageSize: 25,\n          total: data.total || filtered.length,\n          sort: 'desc',\n        });\n        const list = Array.isArray(data.users)\n          ? (data.users as User[])\n          : (Object.values(data.users || {}) as User[]);\n        setUsers(list);\n      })\n      .finally(() => setLoading(false));\n    if (isPrivileged) {\n      authFetch('/api/v1/users')\n        .then((r) => (r.ok ? r.json() : []))\n        .then((list) =>\n          setUsers(Array.isArray(list) ? list : Object.values(list || {})),\n        )\n        .catch(() => undefined);\n    }\n  }, [controller, isPrivileged, mine, page, scopeKey, user]);\n\n  React.useEffect(() => {\n    if (authLoading) return;\n    if (!user?.telegram_id) return;\n    load();\n  }, [authLoading, user, load, version, page, mine]);\n\n  const map = React.useMemo(() => {\n    const registry: Record<number, User> = {};\n    users.forEach((candidate) => {\n      registry[candidate.telegram_id] = candidate;\n    });\n    return registry;\n  }, [users]);\n\n  if (authLoading) {\n    return <div>Загрузка...</div>;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <h2 className=\"text-2xl font-semibold text-slate-900 dark:text-slate-100\">\n        Панель заявок\n      </h2>\n      {loading && <div>Загрузка...</div>}\n      <TaskTable\n        tasks={tasks}\n        users={map}\n        page={page}\n        pageCount={Math.ceil((meta.total ?? tasks.length) / 25)}\n        mine={mine}\n        entityKind=\"request\"\n        onPageChange={setPage}\n        onMineChange={(value) => {\n          setMine(value);\n          if (value) params.set('mine', '1');\n          else params.delete('mine');\n          setParams(params);\n        }}\n        onRowClick={(id) => {\n          params.set('task', id);\n          setParams(params);\n        }}\n        toolbarChildren={\n          <>\n            <button\n              onClick={refresh}\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\n            >\n              Обновить\n            </button>\n            <button\n              onClick={() => {\n                params.set('newRequest', '1');\n                setParams(params);\n              }}\n              className=\"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700\"\n            >\n              Новая заявка\n            </button>\n          </>\n        }\n      />\n    </div>\n  );\n}\n"],"names":["_meta$total","_React$useState2","_slicedToArray","React","useState","page","setPage","_React$useState4","users","setUsers","_React$useState6","loading","setLoading","_useSearchParams2","useSearchParams","params","setParams","_React$useState8","get","mine","setMine","_useTasks","useTasks","version","refresh","controller","_useAuth","useAuth","user","authLoading","isAdmin","role","isManager","isPrivileged","scopeKey","useMemo","userKey","telegram_id","String","mineKey","concat","tasks","useTaskIndex","meta","useTaskIndexMeta","load","useCallback","setIndex","kind","userId","pageSize","total","sort","fetchTasks","limit","then","data","rawTasks","filtered","filter","t","assigned","assignees","assigned_user_id","uid","includes","created_by","length","list","Array","isArray","Object","values","finally","authFetch","r","ok","json","catch","useEffect","map","registry","forEach","candidate","jsx","children","jsxs","className","TaskTable","pageCount","Math","ceil","entityKind","onPageChange","onMineChange","value","set","delete","onRowClick","id","toolbarChildren","Fragment","onClick"],"mappings":"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"}