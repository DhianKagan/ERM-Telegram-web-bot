{"version":3,"mappings":"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","names":["normalizeCandidate","value","trimmed","collapsed","pushCandidate","target","candidate","text","collectNestedValues","depth","item","addUserCandidates","user","toNumber","parsed","collectTaskSearchValues","task","users","candidates","userIds","appendUserId","_b","_a","id","_c","tokenize","query","matchTaskQuery","tokens","haystack","token","variant","DataTable","lazy","__vitePreload","TaskTable","tasks","page","pageCount","mine","entityKind","onPageChange","onMineChange","onRowClick","toolbarChildren","onDataChange","filters","useTasks","columns","React","taskColumns","Suspense","jsx","t","taskType","assigned","collect","assignee","created","row","original","normalizedId","coerceTaskId","jsxs","Fragment","e"],"ignoreList":[],"sources":["../../../web/src/utils/matchTaskQuery.ts","../../../web/src/components/TaskTable.tsx"],"sourcesContent":["// Назначение файла: сопоставление задач с текстовым запросом для глобального поиска\r\n// Модули: taskColumns (тип TaskRow)\r\nimport type { TaskRow } from \"../columns/taskColumns\";\r\n\r\ntype UserLike = Record<string, unknown>;\r\n\r\nconst normalizeCandidate = (value: string) => {\r\n  const trimmed = value.trim().toLowerCase();\r\n  if (!trimmed) return [] as string[];\r\n  const collapsed = trimmed.replace(/[\\s\\-_/]+/g, \"\");\r\n  if (collapsed && collapsed !== trimmed) {\r\n    return [trimmed, collapsed];\r\n  }\r\n  return [trimmed];\r\n};\r\n\r\nconst pushCandidate = (target: Set<string>, value: unknown) => {\r\n  if (typeof value === \"string\") {\r\n    normalizeCandidate(value).forEach((candidate) => target.add(candidate));\r\n    return;\r\n  }\r\n  if (typeof value === \"number\" && Number.isFinite(value)) {\r\n    const text = String(value);\r\n    normalizeCandidate(text).forEach((candidate) => target.add(candidate));\r\n  }\r\n};\r\n\r\nconst collectNestedValues = (\r\n  value: unknown,\r\n  target: Set<string>,\r\n  depth = 0,\r\n) => {\r\n  if (depth > 2 || value === null || value === undefined) return;\r\n  if (Array.isArray(value)) {\r\n    value.forEach((item) => collectNestedValues(item, target, depth + 1));\r\n    return;\r\n  }\r\n  if (value instanceof Date) {\r\n    pushCandidate(target, value.toISOString());\r\n    return;\r\n  }\r\n  if (typeof value === \"object\") {\r\n    Object.values(value as Record<string, unknown>).forEach((item) =>\r\n      collectNestedValues(item, target, depth + 1),\r\n    );\r\n    return;\r\n  }\r\n  pushCandidate(target, value);\r\n};\r\n\r\nconst addUserCandidates = (user: UserLike | undefined, target: Set<string>) => {\r\n  if (!user) return;\r\n  const fields = [\r\n    user.name,\r\n    user.username,\r\n    (user as Record<string, unknown>).telegram_username,\r\n    (user as Record<string, unknown>).telegramId,\r\n    (user as Record<string, unknown>).telegram_id,\r\n    user.phone,\r\n    (user as Record<string, unknown>).mobNumber,\r\n    user.email,\r\n  ];\r\n  fields.forEach((value) => pushCandidate(target, value));\r\n};\r\n\r\nconst toNumber = (value: unknown): number | undefined => {\r\n  if (typeof value === \"number\" && Number.isFinite(value)) return value;\r\n  if (typeof value === \"string\") {\r\n    const trimmed = value.trim();\r\n    if (!trimmed) return undefined;\r\n    const parsed = Number(trimmed);\r\n    if (Number.isFinite(parsed)) return parsed;\r\n  }\r\n  return undefined;\r\n};\r\n\r\nconst collectTaskSearchValues = (\r\n  task: TaskRow,\r\n  users: Record<number, UserLike>,\r\n): string[] => {\r\n  const candidates = new Set<string>();\r\n  const directFields: unknown[] = [\r\n    task.id,\r\n    task._id,\r\n    task.request_id,\r\n    task.task_number,\r\n    task.title,\r\n    task.task_description,\r\n    task.location,\r\n    (task as Record<string, unknown>).start_location,\r\n    (task as Record<string, unknown>).end_location,\r\n    task.project,\r\n    task.comment,\r\n    task.status,\r\n    task.priority,\r\n    task.task_type,\r\n    (task as Record<string, unknown>).route_distance_km,\r\n  ];\r\n  directFields.forEach((value) => pushCandidate(candidates, value));\r\n\r\n  const userIds = new Set<number>();\r\n  const appendUserId = (value: unknown) => {\r\n    const parsed = toNumber(value);\r\n    if (parsed !== undefined) {\r\n      userIds.add(parsed);\r\n      pushCandidate(candidates, parsed);\r\n    } else if (typeof value === \"string\") {\r\n      pushCandidate(candidates, value);\r\n    }\r\n  };\r\n\r\n  appendUserId(task.created_by ?? task.creator ?? task.createdBy);\r\n  appendUserId(task.assigned_user_id);\r\n  appendUserId((task as Record<string, unknown>).controller_user_id);\r\n  (task.assignees || []).forEach((id) => appendUserId(id));\r\n  ((task as Record<string, unknown>).controllers as unknown[] | undefined)?.forEach(\r\n    (id) => appendUserId(id),\r\n  );\r\n\r\n  userIds.forEach((id) => addUserCandidates(users[id], candidates));\r\n\r\n  collectNestedValues((task as Record<string, unknown>).custom, candidates);\r\n  collectNestedValues((task as Record<string, unknown>).applicant, candidates);\r\n  collectNestedValues(\r\n    (task as Record<string, unknown>).logistics_details,\r\n    candidates,\r\n  );\r\n  collectNestedValues(\r\n    (task as Record<string, unknown>).procurement_details,\r\n    candidates,\r\n  );\r\n  collectNestedValues(\r\n    (task as Record<string, unknown>).work_details,\r\n    candidates,\r\n  );\r\n\r\n  return Array.from(candidates);\r\n};\r\n\r\nconst tokenize = (query: string): string[] =>\r\n  query\r\n    .trim()\r\n    .toLowerCase()\r\n    .split(/\\s+/)\r\n    .filter(Boolean);\r\n\r\nexport default function matchTaskQuery(\r\n  task: TaskRow,\r\n  query: string,\r\n  users: Record<number, UserLike>,\r\n): boolean {\r\n  const tokens = tokenize(query);\r\n  if (!tokens.length) return true;\r\n  const haystack = collectTaskSearchValues(task, users);\r\n  if (!haystack.length) return false;\r\n  return tokens.every((token) => {\r\n    const variations = normalizeCandidate(token);\r\n    return variations.some((variant) =>\r\n      haystack.some((candidate) => candidate.includes(variant)),\r\n    );\r\n  });\r\n}\r\n\r\nexport { collectTaskSearchValues };\r\n","// Назначение файла: таблица задач на основе DataTable\r\n// Основные модули: React, DataTable (лениво), taskColumns, useTasks, coerceTaskId\r\nimport React, { lazy, Suspense } from \"react\";\r\nconst DataTable = lazy(() => import(\"./DataTable\"));\r\nimport taskColumns, { TaskRow } from \"../columns/taskColumns\";\r\nimport useTasks from \"../context/useTasks\";\r\nimport coerceTaskId from \"../utils/coerceTaskId\";\r\nimport matchTaskQuery from \"../utils/matchTaskQuery\";\r\n\r\ntype EntityKind = \"task\" | \"request\";\r\n\r\ninterface TaskTableProps {\r\n  tasks: TaskRow[];\r\n  users?: Record<number, any>;\r\n  page: number;\r\n  pageCount?: number;\r\n  mine?: boolean;\r\n  entityKind?: EntityKind;\r\n  onPageChange: (p: number) => void;\r\n  onMineChange?: (v: boolean) => void;\r\n  onRowClick?: (id: string) => void;\r\n  toolbarChildren?: React.ReactNode;\r\n  onDataChange?: (rows: TaskRow[]) => void;\r\n}\r\n\r\nexport default function TaskTable({\r\n  tasks,\r\n  users = {},\r\n  page,\r\n  pageCount,\r\n  mine = false,\r\n  entityKind = \"task\",\r\n  onPageChange,\r\n  onMineChange,\r\n  onRowClick,\r\n  toolbarChildren,\r\n  onDataChange,\r\n}: TaskTableProps) {\r\n  const { query, filters } = useTasks();\r\n  const columns = React.useMemo(\r\n    () => taskColumns(users, entityKind),\r\n    [users, entityKind],\r\n  );\r\n\r\n  React.useEffect(() => {\r\n    onDataChange?.(tasks);\r\n  }, [onDataChange, tasks]);\r\n\r\n  return (\r\n    <Suspense fallback={<div>Загрузка таблицы...</div>}>\r\n      <DataTable<TaskRow>\r\n        columns={columns}\r\n        data={tasks.filter((t) => {\r\n          if (query && !matchTaskQuery(t, query, users)) return false;\r\n          if (filters.status.length && !filters.status.includes(t.status))\r\n            return false;\r\n          if (\r\n            filters.priority.length &&\r\n            !filters.priority.includes(t.priority as string)\r\n          )\r\n            return false;\r\n          if (filters.taskTypes.length) {\r\n            const taskType =\r\n              typeof (t as Record<string, unknown>).task_type === \"string\"\r\n                ? ((t as Record<string, unknown>).task_type as string).trim()\r\n                : \"\";\r\n            if (!taskType || !filters.taskTypes.includes(taskType)) return false;\r\n          }\r\n          if (filters.assignees.length) {\r\n            const assigned = new Set<number>();\r\n            const collect = (value: unknown) => {\r\n              if (typeof value === \"number\" && Number.isFinite(value)) {\r\n                assigned.add(value);\r\n              } else if (typeof value === \"string\") {\r\n                const parsed = Number(value.trim());\r\n                if (Number.isFinite(parsed)) assigned.add(parsed);\r\n              }\r\n            };\r\n            if (Array.isArray((t as Record<string, unknown>).assignees)) {\r\n              ((t as Record<string, unknown>).assignees as unknown[]).forEach(collect);\r\n            }\r\n            collect((t as Record<string, unknown>).assigned_user_id);\r\n            if (\r\n              !filters.assignees.some((assignee) => assigned.has(Number(assignee)))\r\n            ) {\r\n              return false;\r\n            }\r\n          }\r\n          const created = t.createdAt ? new Date(t.createdAt) : null;\r\n          if (filters.from && created && created < new Date(filters.from))\r\n            return false;\r\n          if (filters.to && created && created > new Date(filters.to))\r\n            return false;\r\n          return true;\r\n        })}\r\n        pageIndex={page}\r\n        pageSize={25}\r\n        pageCount={pageCount}\r\n        onPageChange={onPageChange}\r\n        onRowClick={(row) => {\r\n          const original = row as TaskRow & Record<string, unknown>;\r\n          const normalizedId =\r\n            coerceTaskId(original._id) || coerceTaskId(original.id);\r\n          if (normalizedId) {\r\n            onRowClick?.(normalizedId);\r\n          }\r\n        }}\r\n        toolbarChildren={\r\n          <>\r\n            {typeof onMineChange === \"function\" && (\r\n              <label\r\n                className=\"flex items-center gap-1 text-sm\"\r\n                htmlFor=\"task-table-mine\"\r\n              >\r\n                <input\r\n                  id=\"task-table-mine\"\r\n                  name=\"mineTasks\"\r\n                  type=\"checkbox\"\r\n                  checked={mine}\r\n                  onChange={(e) => onMineChange(e.target.checked)}\r\n                />\r\n                Мои\r\n              </label>\r\n            )}\r\n            {toolbarChildren}\r\n          </>\r\n        }\r\n      />\r\n    </Suspense>\r\n  );\r\n}\r\n"],"file":"js/TaskTable-O66hOfPf.js"}