import{j as t}from"./index-DAGCYRZX.js";import{R as r,i as w}from"./vendor-DBLHOZWC.js";import{T as K}from"./TaskTable-O66hOfPf.js";import{u as N}from"./AuthenticatedApp-DKm_nmXg.js";import{a as E,i as $,j as z,k as F,h as L}from"./App-DjzPhsfn.js";import"./taskColumns-Ca4qs_dU.js";import"./EmployeeLink-BTtE5b3j.js";function Q(){var b;const[o,_]=r.useState(0),[x,f]=r.useState([]),[v,d]=r.useState(!0),[a,u]=w(),[n,C]=r.useState(a.get("mine")==="1"),{version:S,refresh:T,controller:m}=N(),{user:e,loading:g}=E(),q=(e==null?void 0:e.role)==="admin",M=(e==null?void 0:e.role)==="manager",h=q||M,l=r.useMemo(()=>{const s=e!=null&&e.telegram_id?String(e.telegram_id):"anon",i=n?"mine":"all";return"tasks:request:".concat(s,":").concat(i,":page=").concat(o+1)},[n,o,e==null?void 0:e.telegram_id]),p=$(l),A=z(l),k=r.useCallback(()=>{if(!(e!=null&&e.telegram_id)){m.setIndex(l,[],{kind:"request",mine:n,userId:void 0,pageSize:25,total:0,sort:"desc"}),d(!1);return}d(!0),F({page:o+1,limit:25,mine:n?1:void 0,kind:"request"},e.telegram_id,!0).then(s=>{const i=s.tasks,j=h?i:i.filter(c=>{const R=c.assignees||(c.assigned_user_id?[c.assigned_user_id]:[]),y=e.telegram_id;return R.includes(y)||c.created_by===y});m.setIndex(l,j,{kind:"request",mine:n,userId:e.telegram_id,pageSize:25,total:s.total||j.length,sort:"desc"});const P=Array.isArray(s.users)?s.users:Object.values(s.users||{});f(P)}).finally(()=>d(!1)),h&&L("/api/v1/users").then(s=>s.ok?s.json():[]).then(s=>f(Array.isArray(s)?s:Object.values(s||{}))).catch(()=>{})},[m,h,n,o,l,e]);r.useEffect(()=>{g||e!=null&&e.telegram_id&&k()},[g,e,k,S,o,n]);const I=r.useMemo(()=>{const s={};return x.forEach(i=>{s[i.telegram_id]=i}),s},[x]);return g?t.jsx("div",{children:"Загрузка..."}):t.jsxs("div",{className:"space-y-6",children:[t.jsx("h2",{className:"text-2xl font-semibold text-slate-900 dark:text-slate-100",children:"Панель заявок"}),v&&t.jsx("div",{children:"Загрузка..."}),t.jsx(K,{tasks:p,users:I,page:o,pageCount:Math.ceil(((b=A.total)!=null?b:p.length)/25),mine:n,entityKind:"request",onPageChange:_,onMineChange:s=>{C(s),s?a.set("mine","1"):a.delete("mine"),u(a)},onRowClick:s=>{a.set("task",s),u(a)},toolbarChildren:t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:T,className:"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700",children:"Обновить"}),t.jsx("button",{onClick:()=>{a.set("newRequest","1"),u(a)},className:"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700",children:"Новая заявка"})]})})]})}export{Q as default};
//# sourceMappingURL=RequestsPage-DBIznbo_.js.map
