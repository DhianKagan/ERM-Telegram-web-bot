#!/usr/bin/env node
// patch: 020-eslint-lpt-soften.cjs
// purpose: мягкий flat-конфиг для LPT, перенос .eslintignore -> ignores, послабления правил

const fs = require('fs');

// 1) собрать игнор-лист (перенос из apps/api/.eslintignore при наличии)
const apiIgnorePath = 'apps/api/.eslintignore';
let apiIgnores = [];
if (fs.existsSync(apiIgnorePath)) {
  apiIgnores = fs.readFileSync(apiIgnorePath, 'utf8')
    .split(/\r?\n/).map(s => s.trim()).filter(Boolean);
}

// Базовые игноры для всего репо (чтобы LPT был стабильным)
const baseIgnores = [
  'patch_cjs/**',
  'pnpm-lock.yaml',
  'package.json',
  'eslint.lpt.config.ts',
];

// 2) сформировать eslint.lpt.config.ts
const cfg = `// autogenerated by 020-eslint-lpt-soften.cjs
// Мягкая LPT-конфигурация ESLint (flat, v9)
// Цель: локальные проверки без «красных» остановок на неключевых местах
// В CI/PR можно использовать основной строгий конфиг.

import js from '@eslint/js';
import tseslint from 'typescript-eslint';
import globals from 'globals';

export default [
  {
    // Перенос игноров из .eslintignore + служебные/генерируемые файлы
    ignores: ${JSON.stringify([...new Set([...baseIgnores, ...apiIgnores])], null, 2)}
  },

  // Базовые рекомендации JS
  js.configs.recommended,

  // Блок для TypeScript/TSX (без type-check в LPT)
  ...tseslint.configs.recommended,

  {
    files: ['**/*.ts', '**/*.tsx'],
    languageOptions: {
      ecmaVersion: 2022,
      sourceType: 'module',
      globals: {
        ...globals.browser,
        ...globals.node,
        ...globals.es2021
      }
    },
    rules: {
      // Послабления под LPT (локальная проверка, не прод-качество)
      'no-undef': 'off',
      'no-redeclare': 'off',

      '@typescript-eslint/no-unused-vars': ['warn', { argsIgnorePattern: '^_', varsIgnorePattern: '^_' }],
      '@typescript-eslint/no-explicit-any': 'off',
      '@typescript-eslint/no-require-imports': 'off',
    }
  },

  // Тесты: ещё мягче
  {
    files: ['**/*.spec.ts', '**/*.spec.tsx', '**/*.test.ts', '**/*.test.tsx'],
    rules: {
      '@typescript-eslint/no-explicit-any': 'off',
      '@typescript-eslint/no-require-imports': 'off',
      '@typescript-eslint/no-unused-vars': ['warn', { argsIgnorePattern: '^_', varsIgnorePattern: '^_' }],
      'no-redeclare': 'off',
    }
  },

  // декларационные файлы
  {
    files: ['**/*.d.ts'],
    rules: {
      '@typescript-eslint/no-unused-vars': 'off',
      'no-undef': 'off',
    }
  },

  // vite / config-файлы
  {
    files: ['**/vite.config.ts', '**/*.config.ts'],
    rules: {
      'no-undef': 'off',
    }
  },
];
`;

// 3) записать конфиг
fs.writeFileSync('eslint.lpt.config.ts', cfg, 'utf8');

// 4) убрать apps/api/.eslintignore (устаревший механизм, ESLint 9 ругается)
if (fs.existsSync(apiIgnorePath)) {
  fs.rmSync(apiIgnorePath);
  console.log('[OK] перенёс игноры из apps/api/.eslintignore в flat-config и удалил файл');
} else {
  console.log('[OK] записан eslint.lpt.config.ts (игноры включены)');
}
