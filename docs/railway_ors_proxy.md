<!-- Назначение файла: инструкция по деплою прокси OpenRouteService на Railway. -->

# Деплой прокси OpenRouteService на Railway

Прокси-сервис из `tools/ors-proxy` защищает ключ OpenRouteService, кеширует ответы в Redis и отдаёт маршруты и матрицы через собственный токен авторизации. Ниже перечислены шаги для отдельного сервиса на Railway.

## Требования

- учётная запись Railway с доступом к проекту и подключённым репозиторием;
- рабочий ключ OpenRouteService (`ORS_API_KEY`);
- подключение Redis (плагин Railway или внешний хост) для кеша;
- выделенный токен для клиентов прокси (`PROXY_TOKEN`).

## Подготовка окружения

1. Создайте сервис **Redis** в проекте Railway или подключите существующий инстанс. Скопируйте строку подключения, она понадобится для переменной `REDIS_URL`.
2. Откройте проект и добавьте новый сервис из GitHub-репозитория. В настройках сервиса укажите корень `tools/ors-proxy` — Railway возьмёт `Dockerfile` из этого каталога. Путь нужно задавать **без ведущего слэша**: значение `/tools/ors-proxy` воспринимается как абсолютный путь в контейнере и приводит к ошибке поиска Dockerfile. Если указать корень нельзя, выберите окружение `ors-proxy`: файл `railway.json` настроит сборку через `tools/ors-proxy/Dockerfile` и будет отслеживать изменения только в каталоге прокси.
3. Убедитесь, что сервис слушает `PORT`, который предоставляет Railway; `Dockerfile` уже пробрасывает порт `5000`, дополнительно менять команду запуска не требуется.
4. Скопируйте файл `.env.example` из каталога `tools/ors-proxy` в `.env` и заполните значения перед деплоем. Это снизит риск опечаток в переменных окружения.

### Проверка настроек в Railway UI

- В разделе **Settings → Source** убедитесь, что параметр **Root Directory** выставлен в `tools/ors-proxy`, а в блоке **Build** выбран тип **Dockerfile** с путём `tools/ors-proxy/Dockerfile`. Используйте относительные пути, например `tools/ors-proxy/Dockerfile`; абсолютный `/tools/ors-proxy/Dockerfile` приведёт к сборке из корня и ошибке `dockerfile invalid: file with no instructions`.
- В разделе **Networking** включите **Private Networking**, чтобы URL вида `redis.railway.internal` был доступен из контейнера. Для внешних подключений используйте схему `rediss://` и порт, выдаваемый Railway, если включён TLS.
- После изменения настроек перезапустите деплой — новая сборка должна подняться без ошибок Redis.

## Настройка переменных окружения

Задайте переменные в разделе **Variables** сервиса прокси:

- `ORS_API_KEY` — ключ OpenRouteService.
- `REDIS_URL` — строка подключения Redis, например `redis://default:<пароль>@<хост>:6379` или `rediss://` при включённом TLS.
- `PROXY_TOKEN` — секретный токен, который клиенты передают в заголовке `X-Proxy-Token`.
- `CACHE_TTL_SEC` — время жизни кеша в секундах; по умолчанию 86400 (сутки).
- `ORS_BASE_URL` — при необходимости укажите альтернативный адрес OpenRouteService; по умолчанию используется `https://api.openrouteservice.org`.

Параметр `ORS_BASE_URL` указывает только домен OpenRouteService: прокси сам добавляет пути `/v2/directions/{profile}` и `/v2/matrix/{profile}` при обращении к API. Не нужно вписывать путь до конкретного метода, достаточно оставить хост (`https://api.openrouteservice.org`).

Ключ `ORS_API_KEY` прокси передаёт в заголовке `Authorization` при каждом запросе в OpenRouteService. Клиентам ключ знать не нужно: они работают с прокси по URL вида `https://<домен_railway>/route` или `/table` и передают только `X-Proxy-Token`. Если ответы приходят с `401`, убедитесь, что токен совпадает и переменные окружения прокси заполнены.

Если запросы отвечают кодом `401`, убедитесь, что клиенты отправляют заголовок `X-Proxy-Token` с тем же значением, что и в переменной `PROXY_TOKEN`, и что переменные действительно загрузились (видны в разделе **Variables** после деплоя).

После сохранения переменных запустите деплой вручную или дождитесь автосборки.

## Проверка после деплоя

1. Откройте логи сервиса и убедитесь, что контейнер стартовал без ошибок Redis и ключей ORS.
2. Выполните пробный запрос со своим токеном:

   ```bash
   curl -H "X-Proxy-Token: <PROXY_TOKEN>" "https://<домен_railway>/route?start=30.5,50.4&end=30.6,50.45&profile=driving-car"
   ```

   В ответ должен прийти JSON OpenRouteService. Аналогично проверьте `https://<домен>/table` через POST с телом `{ "locations": [[lon, lat], ...] }` или GET с параметром `locations=lon,lat|lon,lat`.

3. Добавьте `/health` в healthcheck Railway или проверьте вручную: `curl https://<домен_railway>/health`.

## Интеграция с основным приложением

- В переменных `ROUTING_URL` и `VITE_ROUTING_URL` основного проекта укажите `https://<домен_railway>/route`, чтобы бэкенд и клиент обращались к прокси вместо OSRM.
- Используйте тот же `PROXY_TOKEN` при вызове маршрутов из автоматизаций или внешних сервисов; передавайте его в `X-Proxy-Token`.
