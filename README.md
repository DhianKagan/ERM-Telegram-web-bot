# ERM Telegram Web Bot (v2.2)  ![Quality checks](https://img.shields.io/badge/Codex-Quality%20Gate-blue)

Этот монорепозиторий содержит модульную систему управления ресурсами предприятия, объединяющую телеграм-бота, REST API и веб-дашборд.

---

## Архитектура

Проект структурирован как рабочее пространство PNPM и состоит из нескольких пакетов:

- **`apps/api`** – API на базе Node.js/Express, написанное на TypeScript. Реализует REST-эндпоинты для задач, заявок, пользователей, ролей, логов, коллекций, журнала событий, аналитики, оптимизации маршрутов и пр. Взаимодействует с MongoDB (Mongoose). Фоновые воркеры (BullMQ) обрабатывают геокодинг, маршрутизацию и уведомления.
- **`apps/bot`** – Telegram-бот на базе Telegraf. Обрабатывает команды пользователей: создание задач/заявок, загрузку вложений, просмотр назначений, отправку уведомлений.
- **`apps/web`** – веб-приложение на React (Vite + Tailwind). Содержит интерфейсы: задачи, заявки, архив, журнал событий, менеджер файлов (Storage), коллекции, аналитика и настройки. Для таблиц используется TanStack React Table; встроены экспорт в CSV/XLSX/PDF.
- **`packages/shared`** – общие TypeScript-типы и утилиты, используемые в API, боте и вебе.
- **`packages/logging`**, **`packages/monitoring`** – middleware для логирования и метрик (Prometheus).

API модульное: для каждой области (auth, tasks, requests, users, roles, logs, events, analytics, storage, collections) есть контроллеры, DTO, сервисы и guards. Контроль доступа — RBAC с набором прав/масок (пример: `ACCESS_USER`, `ACCESS_MANAGER`, `ACCESS_ADMIN`). Безопасность: JWT в HTTP-only cookie, CSRF-токены, валидация DTO, rate limiting.

Файлы могут храниться на диске или в S3-совместимом хранилище; загрузки реализованы чанками и проверяются антивирусом (ClamAV и др.).

---

## Возможности

### Задачи и заявки (Tasks & Requests)

- Создание, редактирование и удаление задач и заявок. Поля: статус, приоритет, тип, исполнители, дедлайны, вложения.
- Фильтры и поиск: по статусу, приоритету, типу, исполнителям и диапазону дат; полнотекстовый поиск по заголовкам и описаниям. Для привилегированных пользователей — переключение «мои / все».
- Вложения: загрузка через drag-and-drop или селектор файлов; файловая проверка антивирусом.
- Предпросмотр и экспорт: отображение в таблицах/карточках; экспорт в CSV/XLSX/PDF через тулбар.
- Архив: архивирование выполненных сущностей и возможность полного удаления (при наличии права `TASK_DELETE`).
- Интеграция с Telegram: создание задач/заявок из чата, загрузка вложений, уведомления о назначениях.

### Коллекции и настройки (Collections & Settings)

Секция **Collections** для администраторов:

- Подразделения, отделы, должности.
- Объекты (локации), сотрудники, автопарк, основные средства.
- Пользователи и шаблоны задач.

CRUD, поиск, фильтры и импорт/экспорт; формы поддерживают вложенные связи (например, привязка сотрудника к отделу). В разделе настроек также находятся **Analytics**, **Archive**, **Logs**, **Storage**, **Health**.

### Менеджер файлов (Storage Manager)

- Загрузка и предпросмотр файлов: изображения, видео, PDF, текст.
- Фильтры и сортировка: поиск по имени, сортировка по размеру/дате, фильтр по типу файла и статусу привязки (все/связанные/несвязанные).
- Диагностика: анализ использования хранилища и обнаружение «осиротевших» файлов.
- Скачивание и удаление: возможность загрузки или окончательного удаления файлов; предпросмотр внутри интерфейса.

### Журнал событий (Event Log)

- Фиксация операций с активами: заправка, обслуживание, ремонт, перемещение и др. Для основных средств и автопарка.
- Создание и редактирование событий через модальное окно с валидацией и динамическими полями (выбор объекта из коллекций). Для перемещений запрашивается место отправления/назначения.
- Фильтры и экспорт: фильтрация по типу события, активу, локации и дате; экспорт через таблицу.

### Аналитика (Analytics)

- Встроенные панели отображают метрики по планам маршрутов и задачам. Страницы `/mg/analytics` и `/cp/analytics` показывают графики и таблицы для менеджеров и администраторов.
- Фильтрация аналитики по датам, объектам и исполнителям; агрегирование данных из задач и журнала событий.

### Оптимизация маршрутов (экспериментально)

- Опциональная интеграция решения VRP (Vehicle Routing Problem) c использованием **OR-Tools** и GraphHopper/OSRM. При включении (`ENABLE_VRP_SOLVER=true`) API принимает JSON-план (список задач с координатами, требованиями, временными окнами и т.д.) и возвращает оптимизированные маршруты.
- Конфигурация внешнего сервиса задаётся `GRAPH_HOPPER_API_KEY` и `GRAPH_HOPPER_BASE_URL`. Имеется прототип Python-скрипта для тестирования планирования маршрутов.

---

## Фоновые очереди и наблюдаемость

- Асинхронная обработка геокодинга и маршрутизации — BullMQ. Метрики (количество, длительности) экспортируются в Prometheus.
- Логирование операций с идентификаторами пользователей; упор на покрытие тестами и соблюдение RBAC/валидации DTO.
- CI: Danger/GitHub Actions — правила защиты веток, шаблоны сообщений коммитов и проверка покрытия.

---

## Быстрый старт

1. **Требования:** Node.js ≥ 18, PNPM (или Yarn), MongoDB, Redis. Для VRP: GraphHopper/OSRM при включении `ENABLE_VRP_SOLVER=true`.
2. **Установка зависимостей:**
   ```bash
   pnpm install

