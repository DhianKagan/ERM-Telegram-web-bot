{"version":3,"file":"ThemeProvider-legacy-DqvVv_Vc.js","sources":["../../../web/src/context/ThemeProvider.tsx"],"sourcesContent":["// Провайдер темы и токенов\r\n// Модули: React, next-themes, ThemeContext\r\nimport { useState, useEffect, useRef, type ReactNode } from \"react\";\r\nimport { ThemeProvider as NextThemesProvider } from \"next-themes\";\r\nimport { ThemeContext, type ThemeTokens } from \"./ThemeContext\";\r\nimport presets from \"../theme/presets.json\";\r\n\r\nfunction getCookie(name: string): string | null {\r\n  const match = document.cookie.match(new RegExp(`(?:^|; )${name}=([^;]*)`));\r\n  return match ? decodeURIComponent(match[1]) : null;\r\n}\r\n\r\nfunction setCookie(name: string, value: string) {\r\n  document.cookie = `${name}=${encodeURIComponent(value)};path=/;max-age=31536000`;\r\n}\r\n\r\nconst presetMap = presets as Record<string, ThemeTokens>;\r\nconst defaultTheme = \"light\";\r\n\r\nfunction sanitizeTokens(\r\n  source: unknown,\r\n  base: ThemeTokens,\r\n): Partial<ThemeTokens> | null {\r\n  if (!source || typeof source !== \"object\") return null;\r\n  const sanitized: Partial<ThemeTokens> = {};\r\n  for (const [key, value] of Object.entries(source as Record<string, unknown>)) {\r\n    if (typeof value === \"string\" && key in base) {\r\n      sanitized[key as keyof ThemeTokens] = value;\r\n    }\r\n  }\r\n  return Object.keys(sanitized).length ? sanitized : null;\r\n}\r\n\r\nfunction readThemeCookie(): string {\r\n  const cookieTheme = getCookie(\"theme\");\r\n  return cookieTheme && presetMap[cookieTheme] ? cookieTheme : defaultTheme;\r\n}\r\n\r\nfunction readTokensCookie(\r\n  theme: string,\r\n  base: ThemeTokens,\r\n): Partial<ThemeTokens> | null {\r\n  const raw = getCookie(\"theme-tokens\");\r\n  if (!raw) return null;\r\n  try {\r\n    const parsed = JSON.parse(raw) as unknown;\r\n    if (!parsed || typeof parsed !== \"object\") return null;\r\n    if (\"theme\" in parsed || \"tokens\" in parsed) {\r\n      const cookieTheme = (parsed as { theme?: unknown }).theme;\r\n      if (typeof cookieTheme === \"string\" && cookieTheme !== theme) {\r\n        return null;\r\n      }\r\n      const cookieTokens = sanitizeTokens(\r\n        (parsed as { tokens?: unknown }).tokens,\r\n        base,\r\n      );\r\n      return cookieTokens;\r\n    }\r\n    return sanitizeTokens(parsed, base);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction mergeWithPreset(\r\n  base: ThemeTokens,\r\n  extra: Partial<ThemeTokens> | null,\r\n): ThemeTokens {\r\n  if (!extra) return base;\r\n  return { ...extra, ...base } as ThemeTokens;\r\n}\r\n\r\nexport function ThemeProvider({ children }: { children: ReactNode }) {\r\n  const initialTheme = readThemeCookie();\r\n  const initialBase = presetMap[initialTheme] || presetMap[defaultTheme];\r\n  const [theme, setTheme] = useState(initialTheme);\r\n  const [tokens, setTokens] = useState<ThemeTokens>(() =>\r\n    mergeWithPreset(initialBase, readTokensCookie(initialTheme, initialBase)),\r\n  );\r\n\r\n  const appliedKeys = useRef<Set<string>>(new Set());\r\n\r\n  useEffect(() => {\r\n    if (!presetMap[theme]) {\r\n      setTheme(defaultTheme);\r\n      return;\r\n    }\r\n    const base = presetMap[theme] || presetMap[defaultTheme];\r\n    setTokens(mergeWithPreset(base, readTokensCookie(theme, base)));\r\n  }, [theme]);\r\n\r\n  useEffect(() => {\r\n    const root = document.documentElement;\r\n    const currentKeys = new Set<string>();\r\n    for (const [k, v] of Object.entries(tokens)) {\r\n      root.style.setProperty(`--${k}`, v);\r\n      currentKeys.add(k);\r\n    }\r\n    for (const key of appliedKeys.current) {\r\n      if (!currentKeys.has(key)) {\r\n        root.style.removeProperty(`--${key}`);\r\n      }\r\n    }\r\n    appliedKeys.current = currentKeys;\r\n    root.classList.toggle(\"dark\", theme === \"dark\");\r\n    setCookie(\"theme\", theme);\r\n    setCookie(\"theme-tokens\", JSON.stringify({ theme, tokens }));\r\n  }, [tokens, theme]);\r\n\r\n  return (\r\n    <NextThemesProvider\r\n      attribute=\"class\"\r\n      defaultTheme={theme}\r\n      enableSystem={false}\r\n    >\r\n      <ThemeContext.Provider value={{ theme, setTheme, tokens, setTokens }}>\r\n        {children}\r\n      </ThemeContext.Provider>\r\n    </NextThemesProvider>\r\n  );\r\n}\r\n"],"names":["_ref","children","initialTheme","cookieTheme","getCookie","presetMap","defaultTheme","initialBase","_reactExports$useStat2","_slicedToArray","useState","theme","setTheme","_reactExports$useStat4","mergeWithPreset","readTokensCookie","tokens","setTokens","appliedKeys","useRef","Set","useEffect","base","root","document","documentElement","currentKeys","_i2","_Object$entries2","Object","entries","length","_Object$entries2$_i","k","v","style","setProperty","concat","add","_step","_iterator","_createForOfIteratorHelper","current","s","n","done","key","value","has","removeProperty","err","e","f","classList","toggle","setCookie","JSON","stringify","jsx","NextThemesProvider","attribute","enableSystem","ThemeContext","Provider","name","match","cookie","RegExp","decodeURIComponent","encodeURIComponent","sanitizeTokens","source","_typeof","sanitized","_i","_Object$entries","_Object$entries$_i","keys","raw","parsed","parse","_unused","extra","_objectSpread"],"mappings":"0jFAwEO,SAASA,GAAqD,IAArCC,EAAAD,EAAAC,SACxBC,GAvCAC,EAAcC,EAAU,SACvBD,GAAeE,EAAUF,GAAeA,EAAcG,GAuCvDC,EAAcF,EAAUH,IAAiBG,EAAUC,GACVE,EAAAC,EAArBC,EAAAA,SAASR,GAAY,GAAxCS,EAAAH,EAAA,GAAOI,EAAQJ,EAAA,GAGtBK,EAAAJ,EAF4BC,EAAAA,SAAsB,WAAA,OAChDI,EAAgBP,EAAaQ,EAAiBb,EAAcK,GAAY,GAC1E,GAFOS,EAAAH,EAAA,GAAQI,EAASJ,EAAA,GAIlBK,EAAcC,EAAAA,OAAoB,IAAIC,KA/C9C,IACQjB,EA2EN,OA3BAkB,EAAAA,UAAU,WACR,GAAKhB,EAAUM,GAAf,CAIA,IAAMW,EAAOjB,EAAUM,IAAUN,EAAUC,GAC3CW,EAAUH,EAAgBQ,EAAMP,EAAiBJ,EAAOW,IAFxD,MAFEV,EAASN,EAKb,EAAG,CAACK,IAEJU,EAAAA,UAAU,WAGR,IAFA,IAAME,EAAOC,SAASC,gBAChBC,MAAkBN,IACxBO,EAAA,EAAAC,EAAqBC,OAAOC,QAAQd,GAAMW,EAAAC,EAAAG,OAAAJ,IAAG,CAA7C,IAAAK,EAAAvB,EAAAmB,EAAAD,GAAA,GAAYM,EAAAD,EAAA,GAAGE,EAACF,EAAA,GACdT,EAAKY,MAAMC,YAAA,KAAAC,OAAiBJ,GAAKC,GACjCR,EAAYY,IAAIL,EAClB,CAAA,IAC8BM,EAD9BC,koBAAAC,CACkBvB,EAAYwB,aAA9B,IAAAF,EAAAG,MAAAJ,EAAAC,EAAAI,KAAAC,MAAuC,CAAA,IAA5BC,EAAAP,EAAAQ,MACJrB,EAAYsB,IAAIF,IACnBvB,EAAKY,MAAMc,eAAA,KAAAZ,OAAoBS,GAEnC,CAAA,CAAA,MAAAI,GAAAV,EAAAW,EAAAD,EAAA,CAAA,QAAAV,EAAAY,GAAA,CACAlC,EAAYwB,QAAUhB,EACtBH,EAAK8B,UAAUC,OAAO,OAAkB,SAAV3C,GAC9B4C,EAAU,QAAS5C,GACnB4C,EAAU,eAAgBC,KAAKC,UAAU,CAAE9C,MAAAA,EAAOK,OAAAA,IACpD,EAAG,CAACA,EAAQL,IAGV+C,EAAAA,IAACC,EAAA,CACCC,UAAU,QACVtD,aAAcK,EACdkD,cAAc,EAEd5D,SAAAyD,EAAAA,IAACI,EAAaC,SAAb,CAAsBhB,MAAO,CAAEpC,MAAAA,EAAOC,SAAAA,EAAUI,OAAAA,EAAQC,UAAAA,GACtDhB,SAAAA,KAIT,GAjHA,SAASG,EAAU4D,GACjB,IAAMC,EAAQzC,SAAS0C,OAAOD,MAAM,IAAIE,OAAA,WAAA9B,OAAkB2B,EAAI,cAC9D,OAAOC,EAAQG,mBAAmBH,EAAM,IAAM,IAChD,CAEA,SAASV,EAAUS,EAAcjB,GAC/BvB,SAAS0C,iBAAYF,EAAI,KAAA3B,OAAIgC,mBAAmBtB,GAAM,2BACxD,CAEA,IAAM1C,2IACAC,EAAe,QAErB,SAASgE,EACPC,EACAjD,GAEA,IAAKiD,GAA4B,WAAlBC,EAAOD,GAAqB,YAE3C,IADA,IAAME,EAAkC,CAAA,EACxCC,EAAA,EAAAC,EAA2B9C,OAAOC,QAAQyC,GAAiCG,EAAAC,EAAA5C,OAAA2C,IAAG,CAA9E,IAAAE,EAAAnE,EAAAkE,EAAAD,GAAA,GAAY5B,EAAA8B,EAAA,GAAK7B,EAAK6B,EAAA,GACC,iBAAV7B,GAAsBD,KAAOxB,IACtCmD,EAAU3B,GAA4BC,EAE1C,CACA,OAAOlB,OAAOgD,KAAKJ,GAAW1C,OAAS0C,EAAY,IACrD,CAOA,SAAS1D,EACPJ,EACAW,GAEA,IAAMwD,EAAM1E,EAAU,gBACtB,IAAK0E,EAAK,OAAO,KACjB,IACE,IAAMC,EAASvB,KAAKwB,MAAMF,GAC1B,IAAKC,GAA4B,WAAlBP,EAAOO,GAAqB,OAAO,KAClD,GAAI,UAAWA,GAAU,WAAYA,EAAQ,CAC3C,IAAM5E,EAAe4E,EAA+BpE,MACpD,MAA2B,iBAAhBR,GAA4BA,IAAgBQ,EAC9C,KAEY2D,EAClBS,EAAgC/D,OACjCM,EAGJ,CACA,OAAOgD,EAAeS,EAAQzD,EAChC,CAAA,MAAA2D,GACE,OAAO,IACT,CACF,CAEA,SAASnE,EACPQ,EACA4D,GAEA,OAAKA,EACLC,EAAAA,EAAA,CAAA,EAAYD,GAAU5D,GADHA,CAErB"}