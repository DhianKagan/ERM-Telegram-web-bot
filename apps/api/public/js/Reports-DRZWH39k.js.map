{"version":3,"mappings":"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","names":["ReportFilterForm","onChange","from","setFrom","React","to","setTo","submit","e","jsxs","jsx","Button","KPIOverview","count","time","ReactApexChart","__vitePreload","n","buildQuery","filters","params","query","TasksChart","series","setSeries","useState","categories","setCategories","theme","useTheme","useEffect","cancelled","authFetch","r","data","labels","normalizedData","value","numeric","normalizedLabels","label","options","Reports","kpi","setKpi","setFilters","downloading","setDownloading","normalizePeriod","source","normalized","trimmed","period","extractFilename","header","fallback","match","handleDownload","kind","prev","endpoint","res","blob","disposition","filename","url","link","error","showToast","fetchSummary","load","next"],"ignoreList":[],"sources":["../../../web/src/components/ReportFilterForm.tsx","../../../web/src/components/KPIOverview.tsx","../../../web/src/components/TasksChart.tsx","../../../web/src/pages/Reports.tsx"],"sourcesContent":["// Форма фильтрации отчётов по диапазону дат\nimport React from 'react';\n\nimport { Button } from '@/components/ui/button';\n\ninterface ReportFilterFormProps {\n  onChange?: (period: { from: string; to: string }) => void;\n}\n\nexport default function ReportFilterForm({ onChange }: ReportFilterFormProps) {\n  const [from, setFrom] = React.useState('');\n  const [to, setTo] = React.useState('');\n  const submit = (e) => {\n    e.preventDefault();\n    onChange && onChange({ from, to });\n  };\n  return (\n    <form onSubmit={submit} className=\"flex flex-wrap items-end gap-2\">\n      <input\n        type=\"date\"\n        id=\"report-from\"\n        name=\"reportFrom\"\n        value={from}\n        onChange={(e) => setFrom(e.target.value)}\n        className=\"focus:border-accentPrimary focus:ring-brand-200 rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-800 focus:ring focus:outline-none\"\n      />\n      <input\n        type=\"date\"\n        id=\"report-to\"\n        name=\"reportTo\"\n        value={to}\n        onChange={(e) => setTo(e.target.value)}\n        className=\"focus:border-accentPrimary focus:ring-brand-200 rounded-lg border border-gray-300 bg-gray-100 px-3 py-2 text-sm text-gray-800 focus:ring focus:outline-none\"\n      />\n      <Button type=\"submit\">Применить</Button>\n    </form>\n  );\n}\n","// Блок KPI с общими метриками по задачам\nimport React from 'react';\n\ninterface KPIOverviewProps {\n  count: number;\n  time: number;\n}\n\nexport default function KPIOverview({ count, time }: KPIOverviewProps) {\n  return (\n    <div className=\"flex space-x-4\">\n      <div className=\"rounded border p-2\">Всего задач: {count}</div>\n      <div className=\"rounded border p-2\">Затрачено минут: {time}</div>\n    </div>\n  );\n}\n","// График количества задач за период\n// Модули: React, react-apexcharts, next-themes, authFetch\nimport React, { useEffect, useState } from 'react';\nimport { useTheme } from 'next-themes';\nimport authFetch from '../utils/authFetch';\nconst ReactApexChart = React.lazy(() => import('react-apexcharts'));\n\ninterface ChartState {\n  series: { data: number[] }[];\n  categories: string[];\n}\n\ninterface TasksChartProps {\n  filters?: {\n    from?: string;\n    to?: string;\n  };\n}\n\nconst buildQuery = (filters?: TasksChartProps['filters']) => {\n  const params = new URLSearchParams();\n  if (filters?.from) params.set('from', filters.from);\n  if (filters?.to) params.set('to', filters.to);\n  const query = params.toString();\n  return query ? `?${query}` : '';\n};\n\nexport default function TasksChart({ filters }: TasksChartProps) {\n  const [series, setSeries] = useState<ChartState['series']>([{ data: [] }]);\n  const [categories, setCategories] = useState<ChartState['categories']>([]);\n  const { theme } = useTheme();\n\n  useEffect(() => {\n    let cancelled = false;\n    authFetch(`/api/v1/tasks/report/chart${buildQuery(filters)}`)\n      .then((r) => (r.ok ? r.json() : { data: [], labels: [] }))\n      .then(({ data, labels }) => {\n        if (cancelled) return;\n        const normalizedData = Array.isArray(data)\n          ? data.map((value) => {\n              const numeric = Number(value);\n              return Number.isFinite(numeric) ? numeric : 0;\n            })\n          : [];\n        const normalizedLabels = Array.isArray(labels)\n          ? labels.map((label) => String(label))\n          : [];\n        setSeries([{ data: normalizedData }]);\n        setCategories(normalizedLabels);\n      })\n      .catch(() => {\n        if (cancelled) return;\n        setSeries([{ data: [] }]);\n        setCategories([]);\n      });\n    return () => {\n      cancelled = true;\n    };\n  }, [filters?.from, filters?.to]);\n\n  const options = {\n    chart: {\n      height: 200,\n      type: 'line',\n      fontFamily: 'Inter, sans-serif',\n      toolbar: { show: false },\n      background: theme === 'dark' ? '#24303F' : undefined,\n    },\n    colors: ['#2563EB'],\n    stroke: { width: 2, curve: 'smooth' },\n    xaxis: {\n      categories,\n      labels: { style: { colors: theme === 'dark' ? '#DEE4EE' : '#6B7280' } },\n    },\n    yaxis: {\n      labels: { style: { colors: theme === 'dark' ? '#DEE4EE' : '#6B7280' } },\n    },\n  };\n\n  return (\n    <React.Suspense fallback={<div>Загрузка...</div>}>\n      <ReactApexChart\n        series={series}\n        options={options}\n        type=\"line\"\n        height={200}\n      />\n    </React.Suspense>\n  );\n}\n","// Страница отчётов с фильтром по датам\nimport React from 'react';\nimport ReportFilterForm from '../components/ReportFilterForm';\nimport KPIOverview from '../components/KPIOverview';\nimport TasksChart from '../components/TasksChart';\nimport authFetch from '../utils/authFetch';\nimport { Button } from '../components/ui/button';\nimport { showToast } from '../utils/toast';\n\nexport default function Reports() {\n  const [kpi, setKpi] = React.useState({ count: 0, time: 0 });\n  const [filters, setFilters] = React.useState<{ from?: string; to?: string }>(\n    {},\n  );\n  const [downloading, setDownloading] = React.useState({\n    pdf: false,\n    xlsx: false,\n  });\n\n  const normalizePeriod = (source?: { from?: string; to?: string }) => {\n    const normalized: { from?: string; to?: string } = {};\n    if (source?.from) {\n      const trimmed = source.from.trim();\n      if (trimmed) normalized.from = trimmed;\n    }\n    if (source?.to) {\n      const trimmed = source.to.trim();\n      if (trimmed) normalized.to = trimmed;\n    }\n    return normalized;\n  };\n\n  const buildQuery = (period: { from?: string; to?: string }) => {\n    const params = new URLSearchParams();\n    if (period.from) params.set('from', period.from);\n    if (period.to) params.set('to', period.to);\n    const query = params.toString();\n    return query ? `?${query}` : '';\n  };\n\n  const extractFilename = (header: string | null, fallback: string) => {\n    if (!header) return fallback;\n    const match = header.match(/filename\\*?=(?:UTF-8'')?\"?([^\";]+)/i);\n    if (match && match[1]) {\n      try {\n        return decodeURIComponent(match[1]);\n      } catch {\n        return match[1];\n      }\n    }\n    return fallback;\n  };\n\n  const handleDownload = React.useCallback(\n    async (kind: 'pdf' | 'xlsx') => {\n      setDownloading((prev) => ({ ...prev, [kind]: true }));\n      try {\n        const query = buildQuery(filters);\n        const endpoint =\n          kind === 'pdf'\n            ? `/api/v1/tasks/report.pdf${query}`\n            : `/api/v1/tasks/report.xlsx${query}`;\n        const res = await authFetch(endpoint, { noRedirect: true });\n        if (!res.ok) {\n          throw new Error(`HTTP ${res.status}`);\n        }\n        const blob = await res.blob();\n        const disposition = res.headers.get('Content-Disposition');\n        const fallbackName =\n          kind === 'pdf' ? 'tasks-report.pdf' : 'tasks-report.xlsx';\n        const filename = extractFilename(disposition, fallbackName);\n        const url = window.URL.createObjectURL(blob);\n        const link = document.createElement('a');\n        link.href = url;\n        link.download = filename;\n        document.body.appendChild(link);\n        link.click();\n        link.remove();\n        window.URL.revokeObjectURL(url);\n      } catch (error) {\n        console.error('report download error', error);\n        showToast('Не удалось скачать отчёт', 'error');\n      } finally {\n        setDownloading((prev) => ({ ...prev, [kind]: false }));\n      }\n    },\n    [filters],\n  );\n\n  const fetchSummary = React.useCallback(\n    (period: { from?: string; to?: string }) => {\n      authFetch(`/api/v1/tasks/report/summary${buildQuery(period)}`)\n        .then((r) => (r.ok ? r.json() : { count: 0, time: 0 }))\n        .then(setKpi);\n    },\n    [],\n  );\n\n  const load = (next?: { from?: string; to?: string }) => {\n    const normalized = normalizePeriod(next);\n    setFilters(normalized);\n    fetchSummary(normalized);\n  };\n\n  React.useEffect(() => {\n    fetchSummary({});\n  }, [fetchSummary]);\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"space-y-4 rounded-lg bg-white p-4 shadow-sm\">\n        <h2 className=\"text-xl font-semibold\">Отчёты</h2>\n        <ReportFilterForm onChange={load} />\n        <KPIOverview count={kpi.count} time={kpi.time} />\n        <div className=\"flex flex-wrap gap-2\">\n          <Button\n            onClick={() => handleDownload('pdf')}\n            disabled={downloading.pdf}\n          >\n            {downloading.pdf ? 'Формируем PDF...' : 'Скачать PDF'}\n          </Button>\n          <Button\n            variant=\"outline\"\n            onClick={() => handleDownload('xlsx')}\n            disabled={downloading.xlsx}\n          >\n            {downloading.xlsx ? 'Формируем Excel...' : 'Скачать Excel'}\n          </Button>\n        </div>\n      </div>\n      <div className=\"space-y-4 rounded-lg bg-white p-4 shadow-sm\">\n        <h3 className=\"text-lg font-semibold\">Динамика задач</h3>\n        <TasksChart filters={filters} />\n      </div>\n    </div>\n  );\n}\n"],"file":"Reports-DRZWH39k.js"}