!function(){function e(e){return function(e){if(Array.isArray(e))return r(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||t(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var r,i,a,s,o=[],l=!0,u=!1;try{if(a=(t=t.call(e)).next,0===n){if(Object(t)!==t)return;l=!1}else for(;!(l=(r=a.call(t)).done)&&(o.push(r.value),o.length!==n);l=!0);}catch(e){u=!0,i=e}finally{try{if(!l&&null!=t.return&&(s=t.return(),Object(s)!==s))return}finally{if(u)throw i}}return o}}(e,n)||t(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function t(e,n){if(e){if("string"==typeof e)return r(e,n);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?r(e,n):void 0}}function r(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=Array(n);t<n;t++)r[t]=e[t];return r}System.register(["./index-legacy-CEOCQCnd.js","./vendor-legacy-B8gM1TaO.js","./TaskTable-legacy-CayimOH6.js","./AuthenticatedApp-legacy-Cp7fcK-C.js","./App-legacy-QJVPl7Ns.js","./taskColumns-legacy-DEYfZPSc.js","./EmployeeLink-legacy-ojmhKLCG.js"],function(t,r){"use strict";var i,a,s,o,l,u,c,d,f,m;return{setters:[function(e){i=e.j},function(e){a=e.R,s=e.i},function(e){o=e.T},function(e){l=e.u},function(e){u=e.a,c=e.i,d=e.j,f=e.k,m=e.h},null,null],execute:function(){t("default",function(){var t,r,g,v=n(a.useState(0),2),y=v[0],h=v[1],p=n(a.useState([]),2),b=p[0],j=p[1],k=n(a.useState(!0),2),x=k[0],A=k[1],S=n(s(),2),_=S[0],C=S[1],w=n(a.useState("1"===_.get("mine")),2),I=w[0],T=w[1],E=l(),M=E.version,N=E.refresh,O=E.controller,F=E.filters,R=E.setFilterUsers,U=u(),z=U.user,L=U.loading,P="admin"===(null==z?void 0:z.role),q="manager"===(null==z?void 0:z.role),D=null==z||null===(t=z.permissions)||void 0===t?void 0:t.includes("tasks"),$=Array.isArray(null==z?void 0:z.permissions)?null==z?void 0:z.permissions:null,B=(null!==(r=null==$?void 0:$.length)&&void 0!==r?r:0)>0,G=P||q,H=G||D||!B,J=!G||I,K=a.useMemo(function(){return[e(F.status).sort().join(","),e(F.priority).sort().join(","),e(F.taskTypes).sort().join(","),e(F.assignees).sort(function(e,n){return e-n}).join(","),F.from,F.to].join("|")},[F]),Q=a.useMemo(function(){var e=null!=z&&z.telegram_id?String(z.telegram_id):"anon",n=J?"mine":"all";return"tasks:task:".concat(e,":").concat(n,":page=").concat(y+1,":filters=").concat(K)},[J,K,y,null==z?void 0:z.telegram_id]),V=c(Q),W=d(Q),X=a.useCallback(function(e){var n=new Map;e.forEach(function(e){var t,r,i=Number(e.telegram_id);if(Number.isFinite(i)){var a=null!==(t="string"==typeof e.name&&e.name.trim().length>0?e.name.trim():e.username)&&void 0!==t?t:"ID ".concat(i);n.set(i,{id:i,name:a,username:null!==(r=e.username)&&void 0!==r?r:null})}}),R(Array.from(n.values()).sort(function(e,n){return e.name.localeCompare(n.name,"ru")}))},[R]),Y=a.useCallback(function(){if(null==z||!z.telegram_id)return O.setIndex(Q,[],{kind:"task",mine:J,userId:void 0,pageSize:25,total:0,sort:"desc"}),void A(!1);A(!0);var e={page:y+1,limit:25,mine:!G||I?1:void 0,kind:"task"};F.status.length&&(e.status=F.status.join(",")),F.taskTypes.length&&(e.taskType=F.taskTypes.join(",")),F.assignees.length&&(e.assignees=F.assignees.join(",")),f(e,z.telegram_id,!0).then(function(e){var n=e.tasks,t=G?n:n.filter(function(e){var n=e.assignees||(e.assigned_user_id?[e.assigned_user_id]:[]),t=z.telegram_id;return n.includes(t)||e.created_by===t});O.setIndex(Q,t,{kind:"task",mine:J,userId:z.telegram_id,pageSize:25,total:e.total||t.length,sort:"desc"});var r=Array.isArray(e.users)?e.users:Object.values(e.users||{});j(r),X(r)}).finally(function(){return A(!1)}),G&&m("/api/v1/users").then(function(e){return e.ok?e.json():[]}).then(function(e){var n=Array.isArray(e)?e:Object.values(e||{});j(n),X(n)}).catch(function(){})},[O,J,G,I,y,Q,z,F,X]);a.useEffect(function(){if(!L&&!G&&(I||T(!0),"1"!==_.get("mine"))){var e=new URLSearchParams(_);e.set("mine","1"),C(e,{replace:!0})}},[L,G,I,_,C]),a.useEffect(function(){L||H&&null!=z&&z.telegram_id&&Y()},[L,z,Y,M,y,I,H]);var Z=a.useMemo(function(){var e={};return b.forEach(function(n){e[n.telegram_id]=n}),e},[b]);return L?i.jsx("div",{children:"Загрузка..."}):H?i.jsxs("div",{className:"space-y-6",children:[i.jsx("h2",{className:"text-2xl font-semibold text-slate-900 dark:text-slate-100",children:"Панель управления задачами"}),x&&i.jsx("div",{children:"Загрузка..."}),i.jsx(o,{tasks:V,users:Z,page:y,pageCount:Math.ceil((null!==(g=W.total)&&void 0!==g?g:V.length)/25),mine:!G||I,onPageChange:h,onMineChange:G?function(e){T(e),e?_.set("mine","1"):_.delete("mine"),C(_)}:void 0,onRowClick:function(e){_.set("task",e),C(_)},toolbarChildren:i.jsxs(i.Fragment,{children:[i.jsx("button",{onClick:N,className:"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700",children:"Обновить"}),i.jsx("button",{onClick:function(){_.set("newTask","1"),C(_)},className:"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700",children:"Новая задача"})]})})]}):i.jsx("div",{className:"p-4",children:"У вас нет прав для просмотра задач"})})}}})}();
//# sourceMappingURL=TasksPage-legacy-Di0NxK_g.js.map
