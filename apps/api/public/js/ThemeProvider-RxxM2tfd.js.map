{"version":3,"file":"ThemeProvider-RxxM2tfd.js","sources":["../../../web/src/context/ThemeProvider.tsx"],"sourcesContent":["// Провайдер темы и токенов\r\n// Модули: React, next-themes, ThemeContext\r\nimport { useState, useEffect, useRef, type ReactNode } from \"react\";\r\nimport { ThemeProvider as NextThemesProvider } from \"next-themes\";\r\nimport { ThemeContext, type ThemeTokens } from \"./ThemeContext\";\r\nimport presets from \"../theme/presets.json\";\r\n\r\nfunction getCookie(name: string): string | null {\r\n  const match = document.cookie.match(new RegExp(`(?:^|; )${name}=([^;]*)`));\r\n  return match ? decodeURIComponent(match[1]) : null;\r\n}\r\n\r\nfunction setCookie(name: string, value: string) {\r\n  document.cookie = `${name}=${encodeURIComponent(value)};path=/;max-age=31536000`;\r\n}\r\n\r\nconst presetMap = presets as Record<string, ThemeTokens>;\r\nconst defaultTheme = \"light\";\r\n\r\nfunction sanitizeTokens(\r\n  source: unknown,\r\n  base: ThemeTokens,\r\n): Partial<ThemeTokens> | null {\r\n  if (!source || typeof source !== \"object\") return null;\r\n  const sanitized: Partial<ThemeTokens> = {};\r\n  for (const [key, value] of Object.entries(source as Record<string, unknown>)) {\r\n    if (typeof value === \"string\" && key in base) {\r\n      sanitized[key as keyof ThemeTokens] = value;\r\n    }\r\n  }\r\n  return Object.keys(sanitized).length ? sanitized : null;\r\n}\r\n\r\nfunction readThemeCookie(): string {\r\n  const cookieTheme = getCookie(\"theme\");\r\n  return cookieTheme && presetMap[cookieTheme] ? cookieTheme : defaultTheme;\r\n}\r\n\r\nfunction readTokensCookie(\r\n  theme: string,\r\n  base: ThemeTokens,\r\n): Partial<ThemeTokens> | null {\r\n  const raw = getCookie(\"theme-tokens\");\r\n  if (!raw) return null;\r\n  try {\r\n    const parsed = JSON.parse(raw) as unknown;\r\n    if (!parsed || typeof parsed !== \"object\") return null;\r\n    if (\"theme\" in parsed || \"tokens\" in parsed) {\r\n      const cookieTheme = (parsed as { theme?: unknown }).theme;\r\n      if (typeof cookieTheme === \"string\" && cookieTheme !== theme) {\r\n        return null;\r\n      }\r\n      const cookieTokens = sanitizeTokens(\r\n        (parsed as { tokens?: unknown }).tokens,\r\n        base,\r\n      );\r\n      return cookieTokens;\r\n    }\r\n    return sanitizeTokens(parsed, base);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction mergeWithPreset(\r\n  base: ThemeTokens,\r\n  extra: Partial<ThemeTokens> | null,\r\n): ThemeTokens {\r\n  if (!extra) return base;\r\n  return { ...extra, ...base } as ThemeTokens;\r\n}\r\n\r\nexport function ThemeProvider({ children }: { children: ReactNode }) {\r\n  const initialTheme = readThemeCookie();\r\n  const initialBase = presetMap[initialTheme] || presetMap[defaultTheme];\r\n  const [theme, setTheme] = useState(initialTheme);\r\n  const [tokens, setTokens] = useState<ThemeTokens>(() =>\r\n    mergeWithPreset(initialBase, readTokensCookie(initialTheme, initialBase)),\r\n  );\r\n\r\n  const appliedKeys = useRef<Set<string>>(new Set());\r\n\r\n  useEffect(() => {\r\n    if (!presetMap[theme]) {\r\n      setTheme(defaultTheme);\r\n      return;\r\n    }\r\n    const base = presetMap[theme] || presetMap[defaultTheme];\r\n    setTokens(mergeWithPreset(base, readTokensCookie(theme, base)));\r\n  }, [theme]);\r\n\r\n  useEffect(() => {\r\n    const root = document.documentElement;\r\n    const currentKeys = new Set<string>();\r\n    for (const [k, v] of Object.entries(tokens)) {\r\n      root.style.setProperty(`--${k}`, v);\r\n      currentKeys.add(k);\r\n    }\r\n    for (const key of appliedKeys.current) {\r\n      if (!currentKeys.has(key)) {\r\n        root.style.removeProperty(`--${key}`);\r\n      }\r\n    }\r\n    appliedKeys.current = currentKeys;\r\n    root.classList.toggle(\"dark\", theme === \"dark\");\r\n    setCookie(\"theme\", theme);\r\n    setCookie(\"theme-tokens\", JSON.stringify({ theme, tokens }));\r\n  }, [tokens, theme]);\r\n\r\n  return (\r\n    <NextThemesProvider\r\n      attribute=\"class\"\r\n      defaultTheme={theme}\r\n      enableSystem={false}\r\n    >\r\n      <ThemeContext.Provider value={{ theme, setTheme, tokens, setTokens }}>\r\n        {children}\r\n      </ThemeContext.Provider>\r\n    </NextThemesProvider>\r\n  );\r\n}\r\n"],"names":["getCookie","name","match","setCookie","value","presetMap","presets","defaultTheme","sanitizeTokens","source","base","sanitized","key","readThemeCookie","cookieTheme","readTokensCookie","theme","raw","parsed","mergeWithPreset","extra","ThemeProvider","children","initialTheme","initialBase","setTheme","useState","tokens","setTokens","appliedKeys","useRef","useEffect","root","currentKeys","k","v","jsx","NextThemesProvider","ThemeContext"],"mappings":"+VAOA,SAASA,EAAUC,EAA6B,CAC9C,MAAMC,EAAQ,SAAS,OAAO,MAAM,IAAI,OAAO,WAAW,OAAAD,EAAI,WAAU,CAAC,EACzE,OAAOC,EAAQ,mBAAmBA,EAAM,CAAC,CAAC,EAAI,IAChD,CAEA,SAASC,EAAUF,EAAcG,EAAe,CAC9C,SAAS,OAAS,GAAG,OAAAH,EAAI,KAAI,0BAAmBG,CAAK,EAAC,2BACxD,CAEA,MAAMC,EAAYC,EACZC,EAAe,QAErB,SAASC,EACPC,EACAC,EAC6B,CAC7B,GAAI,CAACD,GAAU,OAAOA,GAAW,SAAU,OAAO,KAClD,MAAME,EAAkC,CAAA,EACxC,SAAW,CAACC,EAAKR,CAAK,IAAK,OAAO,QAAQK,CAAiC,EACrE,OAAOL,GAAU,UAAYQ,KAAOF,IACtCC,EAAUC,CAAwB,EAAIR,GAG1C,OAAO,OAAO,KAAKO,CAAS,EAAE,OAASA,EAAY,IACrD,CAEA,SAASE,GAA0B,CACjC,MAAMC,EAAcd,EAAU,OAAO,EACrC,OAAOc,GAAeT,EAAUS,CAAW,EAAIA,EAAcP,CAC/D,CAEA,SAASQ,EACPC,EACAN,EAC6B,CAC7B,MAAMO,EAAMjB,EAAU,cAAc,EACpC,GAAI,CAACiB,EAAK,OAAO,KACjB,GAAI,CACF,MAAMC,EAAS,KAAK,MAAMD,CAAG,EAC7B,GAAI,CAACC,GAAU,OAAOA,GAAW,SAAU,OAAO,KAClD,GAAI,UAAWA,GAAU,WAAYA,EAAQ,CAC3C,MAAMJ,EAAeI,EAA+B,MACpD,OAAI,OAAOJ,GAAgB,UAAYA,IAAgBE,EAC9C,KAEYR,EAClBU,EAAgC,OACjCR,CAAA,CAGJ,CACA,OAAOF,EAAeU,EAAQR,CAAI,CACpC,OAAQ,GACN,OAAO,IACT,CACF,CAEA,SAASS,EACPT,EACAU,EACa,CACb,OAAKA,EACE,CAAE,GAAGA,EAAO,GAAGV,CAAA,EADHA,CAErB,CAEO,SAASW,EAAc,CAAE,SAAAC,GAAqC,CACnE,MAAMC,EAAeV,EAAA,EACfW,EAAcnB,EAAUkB,CAAY,GAAKlB,EAAUE,CAAY,EAC/D,CAACS,EAAOS,CAAQ,EAAIC,EAAAA,SAASH,CAAY,EACzC,CAACI,EAAQC,CAAS,EAAIF,EAAAA,SAAsB,IAChDP,EAAgBK,EAAaT,EAAiBQ,EAAcC,CAAW,CAAC,CAAA,EAGpEK,EAAcC,EAAAA,OAAoB,IAAI,GAAK,EAEjDC,OAAAA,EAAAA,UAAU,IAAM,CACd,GAAI,CAAC1B,EAAUW,CAAK,EAAG,CACrBS,EAASlB,CAAY,EACrB,MACF,CACA,MAAMG,EAAOL,EAAUW,CAAK,GAAKX,EAAUE,CAAY,EACvDqB,EAAUT,EAAgBT,EAAMK,EAAiBC,EAAON,CAAI,CAAC,CAAC,CAChE,EAAG,CAACM,CAAK,CAAC,EAEVe,EAAAA,UAAU,IAAM,CACd,MAAMC,EAAO,SAAS,gBAChBC,MAAkB,IACxB,SAAW,CAACC,EAAGC,CAAC,IAAK,OAAO,QAAQR,CAAM,EACxCK,EAAK,MAAM,YAAY,KAAK,OAAAE,GAAKC,CAAC,EAClCF,EAAY,IAAIC,CAAC,EAEnB,UAAWtB,KAAOiB,EAAY,QACvBI,EAAY,IAAIrB,CAAG,GACtBoB,EAAK,MAAM,eAAe,KAAK,OAAApB,EAAK,EAGxCiB,EAAY,QAAUI,EACtBD,EAAK,UAAU,OAAO,OAAQhB,IAAU,MAAM,EAC9Cb,EAAU,QAASa,CAAK,EACxBb,EAAU,eAAgB,KAAK,UAAU,CAAE,MAAAa,EAAO,OAAAW,CAAA,CAAQ,CAAC,CAC7D,EAAG,CAACA,EAAQX,CAAK,CAAC,EAGhBoB,EAAAA,IAACC,EAAA,CACC,UAAU,QACV,aAAcrB,EACd,aAAc,GAEd,SAAAoB,EAAAA,IAACE,EAAa,SAAb,CAAsB,MAAO,CAAE,MAAAtB,EAAO,SAAAS,EAAU,OAAAE,EAAQ,UAAAC,CAAA,EACtD,SAAAN,CAAA,CACH,CAAA,CAAA,CAGN"}