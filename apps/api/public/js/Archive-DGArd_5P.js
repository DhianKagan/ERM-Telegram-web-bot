import{j as a}from"./index-DAGCYRZX.js";import{R as n}from"./vendor-DBLHOZWC.js";import Q from"./DataTable-zTJOOpCK.js";import{h as O,a as X,B as N}from"./App-DjzPhsfn.js";import{I as Y}from"./input-D-Qc8kYd.js";import{u as ee}from"./useToast-BwdJaj6R.js";import{h as F,j as te,k as se}from"./AuthenticatedApp-DKm_nmXg.js";const ae=new Intl.DateTimeFormat("ru-RU",{dateStyle:"short",timeStyle:"short"});function re(e){if(!e)return"—";const s=new Date(e);return Number.isNaN(s.getTime())?e:ae.format(s)}function ne({enableSelection:e,selectedIds:s,onToggleRow:c,onToggleAll:g,visibleCount:l}){const o=[];return e&&o.push({id:"select",header:()=>{const r=l>0&&s.size>=l,u=s.size>0&&s.size<l;return a.jsx("input",{type:"checkbox","aria-label":"Выбрать все",checked:r,ref:h=>{h&&(h.indeterminate=u&&!r)},onChange:h=>g(h.target.checked)})},cell:({row:r})=>{const u=r.original.id;return u?a.jsx("input",{type:"checkbox","aria-label":"Выбрать задачу ".concat(r.original.task_number||u),checked:s.has(u),onChange:h=>c(u,h.target.checked)}):a.jsx("span",{className:"text-muted-foreground",children:"—"})},meta:{width:"3rem",minWidth:"3rem",maxWidth:"3rem"}}),o.push({header:"Номер",accessorKey:"task_number",meta:{width:"8rem",minWidth:"6rem",maxWidth:"8rem",cellClassName:"font-mono text-xs sm:text-sm"},cell:({row:r})=>r.original.task_number||r.original.id||"—"},{header:"Название",accessorKey:"title",meta:{width:"16rem",minWidth:"10rem",maxWidth:"22rem",cellClassName:"whitespace-normal"},cell:({row:r})=>{const u=r.original.title||"—";return a.jsx("span",{className:"line-clamp-2 break-words text-sm",children:u})}},{header:"Статус",accessorKey:"status",meta:{width:"8rem",minWidth:"6rem",maxWidth:"10rem"},cell:({row:r})=>r.original.status||"—"},{header:"Удалена",accessorKey:"archived_at",meta:{width:"10rem",minWidth:"8rem",maxWidth:"12rem"},cell:({row:r})=>re(r.original.archived_at)}),o}async function ie(e={}){const s=new URLSearchParams;e.page&&s.set("page",String(e.page)),e.limit&&s.set("limit",String(e.limit)),e.search&&s.set("search",e.search.trim());const c=s.toString(),g=c?"/api/v1/archives?".concat(c):"/api/v1/archives",l=await O(g);if(!l.ok){const r=await l.text().catch(()=>"");throw new Error(r||"Не удалось загрузить архив задач")}const o=await l.json();return{items:Array.isArray(o.items)?o.items:[],total:Number(o.total)||0,page:Number(o.page)||1,pages:Number(o.pages)||0}}async function oe(e){if(!Array.isArray(e)||e.length===0)return 0;const s=await O("/api/v1/archives/purge",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:e})});if(!s.ok){const g=await s.text().catch(()=>"");throw new Error(g||"Не удалось выполнить полное удаление")}const c=await s.json();return Number(c.removed)||0}const L=25,ce=e=>{if(!e)return"";if(typeof e=="string")return e;if(typeof e=="number")return String(e);if(typeof e=="object"&&e!==null&&"toString"in e)try{return e.toString()}catch(s){return""}return""},M=e=>{if(typeof e=="string")return e;if(e instanceof Date)return e.toISOString()};function pe(){const{addToast:e}=ee(),{user:s}=X(),[c,g]=n.useState([]),[l,o]=n.useState(0),[r,u]=n.useState(0),[h,$]=n.useState(0),[y,A]=n.useState(!1),[B,C]=n.useState(!1),[b,_]=n.useState(""),[w,E]=n.useState(""),[G,U]=n.useState(0),[p,x]=n.useState(new Set),T=typeof(s==null?void 0:s.access)=="number"?s.access:0,j=F(T,te),v=F(T,se),P=n.useMemo(()=>c.filter(t=>t.id).length,[c]);n.useEffect(()=>{let t=!1;return j&&(async()=>{A(!0);try{const m=await ie({page:l+1,limit:L,search:w||void 0});if(t)return;const f=m.items.map(k=>{var I,z,K;const i=k;return{id:ce((K=(z=(I=i._id)!=null?I:i.id)!=null?z:i.task_number)!=null?K:""),task_number:typeof i.task_number=="string"?i.task_number:void 0,title:typeof i.title=="string"?i.title:void 0,status:typeof i.status=="string"?i.status:void 0,archived_at:M(i.archived_at),createdAt:M(i.createdAt),archived_by:typeof i.archived_by=="number"&&Number.isFinite(i.archived_by)?i.archived_by:void 0}});g(f),$(m.total),u(m.pages),x(k=>{const i=new Set;return f.forEach(S=>{S.id&&k.has(S.id)&&i.add(S.id)}),i});const D=Math.max((m.pages||1)-1,0);l>D&&o(D)}catch(m){if(!t){const f=m instanceof Error?m.message:"Не удалось загрузить архив задач";e(f,"error")}}finally{t||A(!1)}})(),()=>{t=!0}},[l,w,G,j,e]);const V=n.useCallback(t=>{t.preventDefault(),E(b.trim()),o(0)},[b]),q=n.useCallback(()=>{_(""),E(""),o(0)},[]),R=n.useCallback((t,d)=>{x(m=>{const f=new Set(m);return d?f.add(t):f.delete(t),f})},[]),W=n.useCallback(t=>{if(t){const d=new Set;c.forEach(m=>{m.id&&d.add(m.id)}),x(d)}else x(new Set)},[c]),H=n.useCallback(async()=>{if(p.size){C(!0);try{const t=await oe(Array.from(p));t>0?e("Удалено ".concat(t," задач"),"success"):e("Задачи не были удалены","error"),x(new Set),U(d=>d+1)}catch(t){const d=t instanceof Error?t.message:"Не удалось выполнить полное удаление";e(d,"error")}finally{C(!1)}}},[p,e]),J=n.useMemo(()=>ne({enableSelection:v,selectedIds:p,onToggleRow:R,onToggleAll:W,visibleCount:P}),[v,p,R,W,P]);if(!j)return a.jsxs("div",{className:"space-y-4",children:[a.jsx("h1",{className:"text-2xl font-semibold",children:"Архив задач"}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"Недостаточно прав для просмотра архива."})]});const Z=(()=>{const t=h%10,d=h%100;return t===1&&d!==11?"задача":[2,3,4].includes(t)&&![12,13,14].includes(d)?"задачи":"задач"})();return a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-2xl font-semibold",children:"Архив задач"}),a.jsx("p",{className:"text-sm text-muted-foreground",children:"Здесь отображаются удалённые задачи только для чтения."})]}),v?a.jsx(N,{type:"button",variant:"destructive",disabled:!p.size||B||y,onClick:H,children:"Полное удаление"}):null]}),a.jsxs("form",{onSubmit:V,className:"flex flex-col gap-2 sm:flex-row sm:items-center",children:[a.jsx(Y,{value:b,onChange:t=>_(t.target.value),placeholder:"Поиск по номеру или названию","aria-label":"Поиск по архиву"}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx(N,{type:"submit",variant:"secondary",disabled:y,children:"Искать"}),a.jsx(N,{type:"button",variant:"ghost",disabled:y||!w&&!b,onClick:q,children:"Сбросить"})]})]}),y?a.jsx("div",{className:"text-sm text-muted-foreground",children:"Загрузка архива..."}):null,a.jsx(Q,{columns:J,data:c,pageIndex:l,pageSize:L,pageCount:r,onPageChange:o,showGlobalSearch:!1,showFilters:!1}),a.jsxs("div",{className:"text-sm text-muted-foreground",children:["Найдено ",h," ",Z]})]})}export{pe as default};
//# sourceMappingURL=Archive-DGArd_5P.js.map
