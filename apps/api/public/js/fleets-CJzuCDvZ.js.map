{"version":3,"file":"fleets-CJzuCDvZ.js","sources":["../../../web/src/services/fleets.ts"],"sourcesContent":["// Назначение: сервисные функции для работы с объектами автопарка\r\n// Основные модули: authFetch, shared/FleetVehicleDto\r\nimport authFetch from \"../utils/authFetch\";\r\nimport type { FleetVehicleDto } from \"shared\";\r\n\r\ntype PendingRequest = {\r\n  controller: AbortController;\r\n  promise: Promise<FleetVehicleResponse>;\r\n};\r\n\r\nconst pendingRequests = new Map<string, PendingRequest>();\r\n\r\nconst buildKey = (search: string, page: number, limit: number): string =>\r\n  `${search}::${page}::${limit}`;\r\n\r\nexport interface FleetVehiclePayload {\r\n  name: string;\r\n  registrationNumber: string;\r\n  odometerInitial: number;\r\n  odometerCurrent: number;\r\n  mileageTotal: number;\r\n  transportType: \"Легковой\" | \"Грузовой\";\r\n  fuelType: \"Бензин\" | \"Дизель\" | \"Газ\";\r\n  fuelRefilled: number;\r\n  fuelAverageConsumption: number;\r\n  fuelSpentTotal: number;\r\n  currentTasks: string[];\r\n}\r\n\r\nexport interface FleetVehicleResponse {\r\n  items: FleetVehicleDto[];\r\n  total: number;\r\n  page: number;\r\n  limit: number;\r\n}\r\n\r\nfunction parseResponse(res: Response, fallback: string) {\r\n  if (res.ok) return res.json();\r\n  return res.text().then((text) => {\r\n    throw new Error(text || fallback);\r\n  });\r\n}\r\n\r\nexport async function listFleetVehicles(\r\n  search = \"\",\r\n  page = 1,\r\n  limit = 10,\r\n): Promise<FleetVehicleResponse> {\r\n  const key = buildKey(search, page, limit);\r\n  const existing = pendingRequests.get(key);\r\n  if (existing) {\r\n    return existing.promise;\r\n  }\r\n\r\n  if (pendingRequests.size > 0) {\r\n    pendingRequests.forEach((entry, pendingKey) => {\r\n      if (pendingKey !== key) {\r\n        entry.controller.abort();\r\n        pendingRequests.delete(pendingKey);\r\n      }\r\n    });\r\n  }\r\n\r\n  const controller = new AbortController();\r\n  const params = new URLSearchParams();\r\n  params.set(\"page\", String(page));\r\n  params.set(\"limit\", String(limit));\r\n  if (search) params.set(\"search\", search);\r\n  const request = authFetch(`/api/v1/fleets?${params.toString()}`, {\r\n    signal: controller.signal,\r\n  })\r\n    .then((res) => parseResponse(res, \"Не удалось загрузить транспорт\"))\r\n    .finally(() => {\r\n      const entry = pendingRequests.get(key);\r\n      if (entry?.controller === controller) {\r\n        pendingRequests.delete(key);\r\n      }\r\n    });\r\n  pendingRequests.set(key, { controller, promise: request });\r\n  return request;\r\n}\r\n\r\nexport interface LegacyFleetVehiclesResponse {\r\n  fleet: { id: string; name: string };\r\n  vehicles: FleetVehicleDto[];\r\n}\r\n\r\nexport async function fetchFleetVehicles(\r\n  _fleetId?: string,\r\n): Promise<LegacyFleetVehiclesResponse> {\r\n  void _fleetId;\r\n  const data = await listFleetVehicles();\r\n  return {\r\n    fleet: { id: \"manual-fleet\", name: \"Автопарк\" },\r\n    vehicles: data.items,\r\n  };\r\n}\r\n\r\nexport async function createFleetVehicle(payload: FleetVehiclePayload): Promise<FleetVehicleDto> {\r\n  const res = await authFetch(\"/api/v1/fleets\", {\r\n    method: \"POST\",\r\n    confirmed: true,\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify(payload),\r\n  });\r\n  return parseResponse(res, \"Не удалось создать транспорт\");\r\n}\r\n\r\nexport async function updateFleetVehicle(\r\n  id: string,\r\n  payload: Partial<FleetVehiclePayload>,\r\n): Promise<FleetVehicleDto> {\r\n  const res = await authFetch(`/api/v1/fleets/${id}`, {\r\n    method: \"PUT\",\r\n    confirmed: true,\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify(payload),\r\n  });\r\n  return parseResponse(res, \"Не удалось обновить транспорт\");\r\n}\r\n\r\nexport async function deleteFleetVehicle(id: string): Promise<void> {\r\n  const res = await authFetch(`/api/v1/fleets/${id}`, {\r\n    method: \"DELETE\",\r\n    confirmed: true,\r\n  });\r\n  if (!res.ok) {\r\n    const text = await res.text().catch(() => \"\");\r\n    throw new Error(text || \"Не удалось удалить транспорт\");\r\n  }\r\n}\r\n"],"names":["pendingRequests","buildKey","search","page","limit","parseResponse","res","fallback","text","listFleetVehicles","key","existing","entry","pendingKey","controller","params","request","authFetch","createFleetVehicle","payload","updateFleetVehicle","id","deleteFleetVehicle"],"mappings":"sCAUA,MAAMA,MAAsB,IAEtBC,EAAW,CAACC,EAAgBC,EAAcC,IAC9C,GAAG,OAAAF,EAAM,MAAK,OAAAC,EAAI,MAAK,OAAAC,GAuBzB,SAASC,EAAcC,EAAeC,EAAkB,CACtD,OAAID,EAAI,GAAWA,EAAI,KAAA,EAChBA,EAAI,KAAA,EAAO,KAAME,GAAS,CAC/B,MAAM,IAAI,MAAMA,GAAQD,CAAQ,CAClC,CAAC,CACH,CAEA,eAAsBE,EACpBP,EAAS,GACTC,EAAO,EACPC,EAAQ,GACuB,CAC/B,MAAMM,EAAMT,EAASC,EAAQC,EAAMC,CAAK,EAClCO,EAAWX,EAAgB,IAAIU,CAAG,EACxC,GAAIC,EACF,OAAOA,EAAS,QAGdX,EAAgB,KAAO,GACzBA,EAAgB,QAAQ,CAACY,EAAOC,IAAe,CACzCA,IAAeH,IACjBE,EAAM,WAAW,MAAA,EACjBZ,EAAgB,OAAOa,CAAU,EAErC,CAAC,EAGH,MAAMC,EAAa,IAAI,gBACjBC,EAAS,IAAI,gBACnBA,EAAO,IAAI,OAAQ,OAAOZ,CAAI,CAAC,EAC/BY,EAAO,IAAI,QAAS,OAAOX,CAAK,CAAC,EAC7BF,GAAQa,EAAO,IAAI,SAAUb,CAAM,EACvC,MAAMc,EAAUC,EAAU,kBAAkB,OAAAF,EAAO,SAAA,GAAc,CAC/D,OAAQD,EAAW,MAAA,CACpB,EACE,KAAMR,GAAQD,EAAcC,EAAK,gCAAgC,CAAC,EAClE,QAAQ,IAAM,CACb,MAAMM,EAAQZ,EAAgB,IAAIU,CAAG,GACjCE,GAAA,YAAAA,EAAO,cAAeE,GACxBd,EAAgB,OAAOU,CAAG,CAE9B,CAAC,EACH,OAAAV,EAAgB,IAAIU,EAAK,CAAE,WAAAI,EAAY,QAASE,EAAS,EAClDA,CACT,CAkBA,eAAsBE,EAAmBC,EAAwD,CAC/F,MAAMb,EAAM,MAAMW,EAAU,iBAAkB,CAC5C,OAAQ,OACR,UAAW,GACX,QAAS,CAAE,eAAgB,kBAAA,EAC3B,KAAM,KAAK,UAAUE,CAAO,CAAA,CAC7B,EACD,OAAOd,EAAcC,EAAK,8BAA8B,CAC1D,CAEA,eAAsBc,EACpBC,EACAF,EAC0B,CAC1B,MAAMb,EAAM,MAAMW,EAAU,kBAAkB,OAAAI,GAAM,CAClD,OAAQ,MACR,UAAW,GACX,QAAS,CAAE,eAAgB,kBAAA,EAC3B,KAAM,KAAK,UAAUF,CAAO,CAAA,CAC7B,EACD,OAAOd,EAAcC,EAAK,+BAA+B,CAC3D,CAEA,eAAsBgB,EAAmBD,EAA2B,CAClE,MAAMf,EAAM,MAAMW,EAAU,kBAAkB,OAAAI,GAAM,CAClD,OAAQ,SACR,UAAW,EAAA,CACZ,EACD,GAAI,CAACf,EAAI,GAAI,CACX,MAAME,EAAO,MAAMF,EAAI,OAAO,MAAM,IAAM,EAAE,EAC5C,MAAM,IAAI,MAAME,GAAQ,8BAA8B,CACxD,CACF"}