# План унификации монорепозитория и shared-пакетов

## Цель

Перед настройкой отдельных сервисов проверить, что общие зависимости, правила сборки и shared-код максимально унифицированы и автоматизированы.


## Как пользоваться этим планом из чата

- Выполняйте задачи **строго по порядку**: сначала Вариант A, затем (опционально) Вариант B.
- Для каждой задачи ниже есть готовый формат запроса в чат: `Шаг A1`, `Шаг A2` и т.д.
- На каждом шаге делайте отдельный PR и переходите дальше только после зелёных проверок.

---

## Вариант A (минимальный, low-risk) — рекомендуемый старт

### Шаг A1. Аудит текущей структуры workspace

**Запрос в чат**

`Сделай Шаг A1 из docs/monorepo-unification-task-breakdown.md: аудит workspace и матрица пакетов`.


**Что сделать**

- Подтвердить состав workspace (`apps/*`, `packages/*`, `scripts`) и роли пакетов.
- Зафиксировать, какие пакеты уже используют `shared`.

- Добавить короткий отчёт в `docs/` (таблица: пакет → тип → зависимость от `shared`).

**Критерий готовности (DoD шага)**

- Есть матрица пакетов в репозитории.
- Не изменена бизнес-логика приложений.
- Все обязательные проверки из корня проходят.

### Шаг A2. Унификация скриптов CI в package.json пакетов

**Запрос в чат**

`Сделай Шаг A2 из docs/monorepo-unification-task-breakdown.md: выровняй scripts build/lint/typecheck/test`.


**Что сделать**

- Добавить/выровнять минимальный набор скриптов: `build`, `lint`, `typecheck`, `test` (где применимо).

- Убрать расхождения в именовании (единый слой `check`/`ci:fast` на верхнем уровне).
- Не ломать текущие команды root workflow.

**Критерий готовности (DoD шага)**

- Все пакеты проходят единый pipeline из корня без ручных исключений.
- Нет удаления полезных проверок ради «зелёного» CI.

### Шаг A3. Централизация общих devDependency-правил

**Запрос в чат**

`Сделай Шаг A3 из docs/monorepo-unification-task-breakdown.md: централизация devDependencies и pnpm.overrides`.


**Что сделать**

- Проверить, что версии TS/ESLint/Prettier/тестовых инструментов консистентны.
- Подтянуть дублирующиеся версии через root и `pnpm.overrides`, где это безопасно.

- Сохранить совместимость со всеми текущими пакетами.

**Критерий готовности (DoD шага)**

- Нет конфликтующих ключевых версий toolchain между пакетами.
- Установка и сборка не деградировали по стабильности.

### Шаг A4. Укрепление shared как единой точки общего кода

**Запрос в чат**

`Сделай Шаг A4 из docs/monorepo-unification-task-breakdown.md: вынеси очевидные дубли в packages/shared`.


**Что сделать**

- Явно описать публичные API `packages/shared` (экспорты, границы ответственности).

- Перенести только очевидные и безопасные дубли из `apps/*` в `packages/shared`.
- Избегать крупных архитектурных миграций в этом шаге.

**Критерий готовности (DoD шага)**

- Повторяющийся код сокращён.
- Импорты идут через `shared`, сборка стабильна.
- Добавлены/обновлены тесты для изменённой логики (если логика менялась).

### Шаг A5. Проверка качества и фиксация baseline

**Запрос в чат**

`Сделай Шаг A5 из docs/monorepo-unification-task-breakdown.md: прогони обязательные проверки и зафиксируй baseline`.


**Что сделать**

- Прогнать обязательный набор проверок (install/build/tsc/test/lint).

- Сохранить краткий baseline-отчёт в `docs/` (что проверено, сколько заняло, есть ли нестабильные места).

**Критерий готовности (DoD шага)**

- Все обязательные проверки проходят.
- Есть отчёт «до/после» (или «текущее состояние» для первой итерации).

---

## Вариант B (структурный, high-impact) — запускать только после полного A

### Шаг B1. Консолидация внутренних пакетов в `packages/*`

**Запрос в чат**

`Сделай Шаг B1 из docs/monorepo-unification-task-breakdown.md: консолидация внутренних пакетов в packages/*`.

**Что сделать**

- Оставить в `apps/*` только запускаемые сервисы (`api`, `web`, `worker`).

- Весь переиспользуемый код вынести в `packages/*` (`shared`, `config`, `types`, `utils`, и т.д.).

**Риск**

- Массовые изменения импортов и `tsconfig` paths.

### Шаг B2. Введение package boundaries и контрактов

**Запрос в чат**

`Сделай Шаг B2 из docs/monorepo-unification-task-breakdown.md: формализуй package boundaries и контракты`.


**Что сделать**

- Формализовать API каждого внутреннего пакета (exports map, semver-политика, правила зависимостей).
- Запретить «сквозные» импорты между приложениями.

**Риск**


- Понадобятся точечные рефакторинги в каждом приложении.

### Шаг B3. Единая оркестрация сборки/тестов через task runner

**Запрос в чат**

`Сделай Шаг B3 из docs/monorepo-unification-task-breakdown.md: оркестрация через Turborepo/Nx`.

**Что сделать**

- Подключить Turborepo/Nx (или эквивалент) для кэша, графа задач и инкрементальных проверок.
- Стандартизировать `ci:fast`/`ci:full` на уровне монорепо.

**Риск**

- Миграционные накладные расходы и необходимость обучения команды.

---

## Обязательный набор проверок для каждого шага

```bash
pnpm -w -s install
pnpm --filter shared build
pnpm -r --filter '!shared' build
pnpm --filter apps/api exec tsc -b
pnpm -w test
pnpm -w lint
```

## Рекомендованный порядок внедрения

1. Выполнить полностью Вариант A (A1 → A5).

2. После стабилизации оценить ROI Варианта B.
3. Переходить к B только при явной выгоде (скорость CI/масштаб команды/рост shared-кода).

## Почему не «все пакеты в одну папку» прямо сейчас

- В репозитории уже есть рабочее разделение `apps/*` и `packages/*`.
- Полный перенос «за один шаг» повышает риск регрессий и усложняет настройку сервисов.
- Практичнее сначала унифицировать процессы и контракты, а затем делать структурную миграцию при необходимости.
