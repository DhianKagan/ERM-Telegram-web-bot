{"version":3,"file":"map-legacy-DaUcrBc_.js","sources":["../../../web/src/utils/haversine.ts","../../../web/src/utils/mapLibrary.ts","../../../web/src/config/map.ts"],"sourcesContent":["// Назначение файла: расчёт геодезического расстояния между двумя координатами\r\n// Основные модули: отсутствуют\r\nimport type { LatLng } from \"./extractCoords\";\r\n\r\nconst EARTH_RADIUS_KM = 6371;\r\n\r\nexport default function haversine(a: LatLng, b: LatLng): number {\r\n  const toRadians = (value: number) => (value * Math.PI) / 180;\r\n  const dLat = toRadians(b.lat - a.lat);\r\n  const dLon = toRadians(b.lng - a.lng);\r\n  const lat1 = toRadians(a.lat);\r\n  const lat2 = toRadians(b.lat);\r\n  const sinLat = Math.sin(dLat / 2);\r\n  const sinLon = Math.sin(dLon / 2);\r\n  const h = sinLat * sinLat + Math.cos(lat1) * Math.cos(lat2) * sinLon * sinLon;\r\n  const c = 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));\r\n  return EARTH_RADIUS_KM * c;\r\n}\r\n","// Назначение: единая точка подключения MapLibre и поддержки протокола PMTiles\r\n// Основные модули: maplibre-gl, pmtiles\r\n\r\nimport maplibregl, {\r\n  type GeoJSONSource,\r\n  type LngLatBoundsLike,\r\n  type Map as MapInstance,\r\n  type MapLayerMouseEvent,\r\n  type MapMouseEvent,\r\n  type Marker as MapMarker,\r\n} from \"maplibre-gl\";\r\nimport { Protocol } from \"pmtiles\";\r\nimport \"maplibre-gl/dist/maplibre-gl.css\";\r\n\r\nlet pmtilesProtocolRegistered = false;\r\n\r\nconst registerPmtilesProtocol = () => {\r\n  if (pmtilesProtocolRegistered) {\r\n    return;\r\n  }\r\n  try {\r\n    const protocol = new Protocol();\r\n    maplibregl.addProtocol(\"pmtiles\", (request) => protocol.tile(request));\r\n    pmtilesProtocolRegistered = true;\r\n  } catch (error) {\r\n    console.error(\"Не удалось зарегистрировать протокол PMTiles\", error);\r\n  }\r\n};\r\n\r\nif (typeof window !== \"undefined\") {\r\n  registerPmtilesProtocol();\r\n}\r\n\r\nexport default maplibregl;\r\nexport { registerPmtilesProtocol };\r\nexport type {\r\n  GeoJSONSource,\r\n  LngLatBoundsLike,\r\n  MapInstance,\r\n  MapLayerMouseEvent,\r\n  MapMouseEvent,\r\n  MapMarker,\r\n};\r\n","// Назначение файла: общие настройки карт для веб-клиента на базе MapLibre\r\n// Основные модули: maplibre-gl\r\n\r\nimport type { StyleSpecification } from \"maplibre-gl\";\r\n\r\ndeclare const __ERM_MAP_STYLE_MODE__: string | undefined;\r\n\r\ntype MapStyleMode = \"pmtiles\" | \"raster\";\r\n\r\ntype EnvLookup = (key: string) => string | undefined;\r\n\r\nconst fromProcess: EnvLookup = (key) => {\r\n  if (typeof process === \"undefined\" || !process.env) {\r\n    return undefined;\r\n  }\r\n  const raw = process.env[key];\r\n  return raw && raw.trim() ? raw.trim() : undefined;\r\n};\r\n\r\nconst fromDefine: EnvLookup = (_key) => {\r\n  if (typeof __ERM_MAP_STYLE_MODE__ === \"string\") {\r\n    return __ERM_MAP_STYLE_MODE__;\r\n  }\r\n  return undefined;\r\n};\r\n\r\nconst sanitizeStyleMode = (value: string | undefined): MapStyleMode | undefined => {\r\n  if (!value) {\r\n    return undefined;\r\n  }\r\n  const normalized = value.trim().toLowerCase();\r\n  if ([\"pmtiles\", \"vector\", \"tiles\"].includes(normalized)) {\r\n    return \"pmtiles\";\r\n  }\r\n  if ([\"raster\", \"osm\", \"fallback\"].includes(normalized)) {\r\n    return \"raster\";\r\n  }\r\n  return undefined;\r\n};\r\n\r\nconst resolveStyleMode = (): MapStyleMode => {\r\n  const explicit =\r\n    sanitizeStyleMode(fromProcess(\"VITE_MAP_STYLE_MODE\")) ??\r\n    sanitizeStyleMode(fromDefine(\"VITE_MAP_STYLE_MODE\"));\r\n  if (explicit) {\r\n    return explicit;\r\n  }\r\n  const envHint = fromProcess(\"VITE_USE_PMTILES\");\r\n  if (envHint && envHint.trim()) {\r\n    return envHint === \"0\" || envHint.toLowerCase() === \"false\"\r\n      ? \"raster\"\r\n      : \"pmtiles\";\r\n  }\r\n  const nodeEnv = fromProcess(\"NODE_ENV\");\r\n  const isProduction = nodeEnv === \"production\" || nodeEnv === \"production-build\";\r\n  return isProduction ? \"pmtiles\" : \"raster\";\r\n};\r\n\r\nconst LOCAL_GLYPHS_TEMPLATE = \"/tiles/fonts/{fontstack}/{range}.pbf\";\r\nconst REMOTE_GLYPHS_TEMPLATE =\r\n  \"https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf\";\r\n\r\nconst sanitizeGlyphTemplate = (value: string | undefined): string | undefined => {\r\n  if (!value) {\r\n    return undefined;\r\n  }\r\n  const trimmed = value.trim();\r\n  if (!trimmed.includes(\"{fontstack}\") || !trimmed.includes(\"{range}\")) {\r\n    return undefined;\r\n  }\r\n  return trimmed;\r\n};\r\n\r\nconst resolveGlyphsTemplate = (styleMode: MapStyleMode): string => {\r\n  const envTemplate =\r\n    sanitizeGlyphTemplate(fromProcess(\"VITE_MAP_GLYPHS_URL\")) ??\r\n    sanitizeGlyphTemplate(fromProcess(\"VITE_MAP_GLYPHS_PATH\"));\r\n  if (envTemplate) {\r\n    return envTemplate;\r\n  }\r\n  if (styleMode === \"pmtiles\") {\r\n    return REMOTE_GLYPHS_TEMPLATE;\r\n  }\r\n  return LOCAL_GLYPHS_TEMPLATE;\r\n};\r\n\r\nexport const MAP_STYLE_MODE: MapStyleMode = resolveStyleMode();\r\n\r\nexport const MAP_ATTRIBUTION = \"© OpenStreetMap contributors, ODbL\";\r\nexport const MAP_VECTOR_SOURCE_ID = \"openmaptiles\";\r\nexport const MAP_ADDRESSES_SOURCE_ID = \"addresses\";\r\nexport const MAP_BASEMAP_PMTILES_URL = \"pmtiles://tiles/basemap.pmtiles\";\r\nexport const MAP_ADDRESSES_PMTILES_URL = \"pmtiles://tiles/addresses.pmtiles\";\r\nexport const MAP_GLYPHS_PATH = resolveGlyphsTemplate(MAP_STYLE_MODE);\r\n\r\nconst DEV_RASTER_STYLE: StyleSpecification = {\r\n  version: 8,\r\n  sources: {\r\n    osmRaster: {\r\n      type: \"raster\",\r\n      tiles: [\"https://tile.openstreetmap.org/{z}/{x}/{y}.png\"],\r\n      tileSize: 256,\r\n      attribution: MAP_ATTRIBUTION,\r\n    },\r\n  },\r\n  layers: [\r\n    {\r\n      id: \"osm-raster\",\r\n      type: \"raster\",\r\n      source: \"osmRaster\",\r\n    },\r\n  ],\r\n};\r\n\r\nconst labelFont = [\"Noto Sans Regular\", \"Open Sans Regular\", \"Arial Unicode MS Regular\"];\r\nconst labelHalo = {\r\n  \"text-color\": \"#1f2937\",\r\n  \"text-halo-color\": \"#f8fafc\",\r\n  \"text-halo-width\": 1.2,\r\n};\r\n\r\nconst createPmtilesStyle = (): StyleSpecification => ({\r\n  version: 8,\r\n  glyphs: MAP_GLYPHS_PATH,\r\n  sources: {\r\n    [MAP_VECTOR_SOURCE_ID]: {\r\n      type: \"vector\",\r\n      url: MAP_BASEMAP_PMTILES_URL,\r\n    },\r\n  },\r\n  layers: [\r\n    {\r\n      id: \"background\",\r\n      type: \"background\",\r\n      paint: {\r\n        \"background-color\": \"#f8fafc\",\r\n      },\r\n    },\r\n    {\r\n      id: \"water-fill\",\r\n      type: \"fill\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"water\",\r\n      paint: {\r\n        \"fill-color\": \"#bfdbfe\",\r\n      },\r\n    },\r\n    {\r\n      id: \"landcover\",\r\n      type: \"fill\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"landcover\",\r\n      paint: {\r\n        \"fill-color\": \"#e2e8f0\",\r\n        \"fill-opacity\": 0.4,\r\n      },\r\n    },\r\n    {\r\n      id: \"landuse\",\r\n      type: \"fill\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"landuse\",\r\n      paint: {\r\n        \"fill-color\": \"#f1f5f9\",\r\n        \"fill-opacity\": 0.35,\r\n      },\r\n    },\r\n    {\r\n      id: \"building\",\r\n      type: \"fill\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"building\",\r\n      paint: {\r\n        \"fill-color\": \"#cbd5f5\",\r\n        \"fill-outline-color\": \"#94a3b8\",\r\n      },\r\n    },\r\n    {\r\n      id: \"road\",\r\n      type: \"line\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"transportation\",\r\n      paint: {\r\n        \"line-color\": \"#94a3b8\",\r\n        \"line-width\": [\r\n          \"interpolate\",\r\n          [\"linear\"],\r\n          [\"zoom\"],\r\n          5,\r\n          0.2,\r\n          12,\r\n          1.2,\r\n          16,\r\n          2.6,\r\n        ],\r\n      },\r\n    },\r\n    {\r\n      id: \"road-major\",\r\n      type: \"line\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"transportation\",\r\n      filter: [\"==\", [\"get\", \"class\"], \"trunk\"],\r\n      paint: {\r\n        \"line-color\": \"#64748b\",\r\n        \"line-width\": [\r\n          \"interpolate\",\r\n          [\"linear\"],\r\n          [\"zoom\"],\r\n          6,\r\n          0.6,\r\n          12,\r\n          2.4,\r\n          16,\r\n          4,\r\n        ],\r\n      },\r\n    },\r\n    {\r\n      id: \"street-label\",\r\n      type: \"symbol\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"transportation_name\",\r\n      layout: {\r\n        \"text-field\": [\r\n          \"coalesce\",\r\n          [\"get\", \"name:uk\"],\r\n          [\"get\", \"name:ru\"],\r\n          [\"get\", \"name\"],\r\n        ],\r\n        \"text-font\": labelFont,\r\n        \"text-size\": [\r\n          \"interpolate\",\r\n          [\"linear\"],\r\n          [\"zoom\"],\r\n          13,\r\n          10,\r\n          18,\r\n          15,\r\n        ],\r\n        \"symbol-placement\": \"line\",\r\n      },\r\n      paint: labelHalo,\r\n    },\r\n    {\r\n      id: \"settlement-major-label\",\r\n      type: \"symbol\",\r\n      source: MAP_VECTOR_SOURCE_ID,\r\n      \"source-layer\": \"place\",\r\n      filter: [\r\n        \"any\",\r\n        [\"==\", [\"get\", \"class\"], \"city\"],\r\n        [\"==\", [\"get\", \"class\"], \"town\"],\r\n      ],\r\n      layout: {\r\n        \"text-field\": [\r\n          \"coalesce\",\r\n          [\"get\", \"name:uk\"],\r\n          [\"get\", \"name:ru\"],\r\n          [\"get\", \"name\"],\r\n        ],\r\n        \"text-font\": labelFont,\r\n        \"text-size\": [\r\n          \"interpolate\",\r\n          [\"linear\"],\r\n          [\"zoom\"],\r\n          6,\r\n          11,\r\n          14,\r\n          20,\r\n        ],\r\n      },\r\n      paint: labelHalo,\r\n    },\r\n  ],\r\n});\r\n\r\nexport const MAP_STYLE: StyleSpecification =\r\n  MAP_STYLE_MODE === \"pmtiles\" ? createPmtilesStyle() : DEV_RASTER_STYLE;\r\n\r\nexport const MAP_DEFAULT_CENTER: [number, number] = [48.3794, 31.1656];\r\nexport const MAP_DEFAULT_ZOOM = 6;\r\nexport const MAP_MAX_BOUNDS: [[number, number], [number, number]] = [\r\n  [22.1372, 44.3865],\r\n  [40.2286, 52.3796],\r\n];\r\n\r\nexport const MAP_ANIMATION_SPEED_KMH = 45;\r\n"],"names":["a","b","toRadians","value","Math","PI","dLat","lat","dLon","lng","lat1","lat2","sinLat","sin","sinLon","h","cos","c","atan2","sqrt","EARTH_RADIUS_KM","pmtilesProtocolRegistered","window","protocol","Protocol","maplibregl","addProtocol","request","tile","error","console","registerPmtilesProtocol","styleMode","_sanitizeGlyphTemplat","fromProcess","key","process","define_process_env_default","raw","trim","sanitizeStyleMode","normalized","toLowerCase","includes","sanitizeGlyphTemplate","trimmed","MAP_STYLE_MODE","_sanitizeStyleMode","explicit","envHint","nodeEnv","resolveStyleMode","MAP_ATTRIBUTION","exports","MAP_VECTOR_SOURCE_ID","MAP_GLYPHS_PATH","DEV_RASTER_STYLE","version","sources","osmRaster","type","tiles","tileSize","attribution","layers","id","source","labelFont","labelHalo","glyphs","_defineProperty","url","paint","filter","layout"],"mappings":"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"}