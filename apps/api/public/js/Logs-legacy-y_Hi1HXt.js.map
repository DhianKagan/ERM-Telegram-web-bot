{"version":3,"file":"Logs-legacy-y_Hi1HXt.js","sources":["../../../web/src/pages/Logs.tsx","../../../web/src/utils/parseAnsiLogEntry.ts","../../../web/src/hooks/useLogsQuery.ts","../../../web/src/components/FiltersPanel.tsx","../../../web/src/columns/logColumns.ts","../../../web/src/components/LogViewer.tsx"],"sourcesContent":["// Страница просмотра логов\nimport React from 'react';\nimport LogViewer from '../components/LogViewer';\n\nexport default function Logs() {\n  return (\n    <div className=\"space-y-6 p-4\">\n      <LogViewer />\n    </div>\n  );\n}\n","// Назначение файла: разбор ANSI-строк логов WG Log Engine\n// Модули: регулярные выражения\n\nexport interface ParsedLog {\n  level: string;\n  time?: string;\n  method?: string;\n  status?: number;\n  endpoint?: string;\n  csrf?: boolean;\n  message: string;\n}\n\nconst ESC = '\\u001b';\nconst ansiRegex = new RegExp(`${ESC}\\\\[[0-9;]*m`, 'g');\n\nexport default function parseAnsiLogEntry(line: string): ParsedLog {\n  const clean = line.replace(ansiRegex, '');\n  const match = clean.match(/^(\\w+)\\s+\\[(.+?)\\]\\s+(.*)$/);\n  const res: ParsedLog = {\n    level: match ? match[1].toLowerCase() : 'info',\n    time: match ? match[2] : undefined,\n    message: match ? match[3] : clean,\n  };\n  const msg = res.message;\n  let m;\n  if ((m = msg.match(/API запрос (\\w+) (\\S+) token:([^ ]+) csrf:([^ ]+)/))) {\n    res.method = m[1];\n    res.endpoint = m[2];\n    res.csrf = m[4] !== 'no-csrf';\n  } else if ((m = msg.match(/API запрос (\\w+) (\\S+) (\\w+) (\\w+)/))) {\n    res.method = m[1];\n    res.endpoint = m[2];\n    res.csrf = m[4] !== 'no-csrf';\n  } else if ((m = msg.match(/API ответ (\\w+) (\\S+) (\\d+)/))) {\n    res.method = m[1];\n    res.endpoint = m[2];\n    res.status = Number(m[3]);\n  }\n  return res;\n}\n","// Назначение файла: загрузка и фильтрация логов\n// Модули: React, authFetch, parseAnsiLogEntry\nimport { useEffect, useState } from 'react';\nimport authFetch from '../utils/authFetch';\nimport parseAnsiLogEntry, { ParsedLog } from '../utils/parseAnsiLogEntry';\n\nexport interface LogFilters {\n  level?: string;\n  message?: string;\n  from?: string;\n  to?: string;\n  method?: string;\n  status?: number;\n  endpoint?: string;\n  noCsrf?: boolean;\n}\n\nexport default function useLogsQuery(filters: LogFilters, page: number) {\n  const [logs, setLogs] = useState<ParsedLog[]>([]);\n\n  useEffect(() => {\n    const params = new URLSearchParams();\n    if (filters.level) params.set('level', filters.level);\n    if (filters.message) params.set('message', filters.message);\n    if (filters.from) params.set('from', filters.from);\n    if (filters.to) params.set('to', filters.to);\n    params.set('page', String(page));\n    params.set('limit', '50');\n    authFetch(`/api/v1/logs?${params.toString()}`)\n      .then((r) => (r.ok ? r.json() : []))\n      .then((data: { message: string; level: string }[]) => {\n        const parsed = data.map((l) =>\n          parseAnsiLogEntry(`${l.level} [${l.createdAt}] ${l.message}`),\n        );\n        setLogs(parsed);\n      });\n  }, [filters, page]);\n\n  return logs.filter((l) => {\n    if (filters.method && l.method !== filters.method) return false;\n    if (filters.status && l.status !== filters.status) return false;\n    if (filters.endpoint && !(l.endpoint || '').includes(filters.endpoint))\n      return false;\n    if (filters.noCsrf && l.csrf !== false) return false;\n    return true;\n  });\n}\n","// Панель фильтров логов\n// Модули: React\nimport React from 'react';\nimport { LogFilters } from '../hooks/useLogsQuery';\n\ninterface Props {\n  filters: LogFilters;\n  onChange: (f: LogFilters) => void;\n}\n\nexport default function FiltersPanel({ filters, onChange }: Props) {\n  const noCsrfId = React.useId();\n  return (\n    <div className=\"flex flex-wrap gap-2\">\n      <select\n        className=\"rounded border p-1\"\n        aria-label=\"Уровень\"\n        name=\"level\"\n        value={filters.level || ''}\n        onChange={(e) => onChange({ ...filters, level: e.target.value })}\n      >\n        <option value=\"\">Все уровни</option>\n        <option value=\"debug\">debug</option>\n        <option value=\"info\">info</option>\n        <option value=\"warn\">warn</option>\n        <option value=\"error\">error</option>\n        <option value=\"log\">log</option>\n      </select>\n      <input\n        className=\"rounded border p-1\"\n        placeholder=\"Метод\"\n        aria-label=\"Метод\"\n        name=\"method\"\n        value={filters.method || ''}\n        onChange={(e) => onChange({ ...filters, method: e.target.value })}\n      />\n      <input\n        className=\"rounded border p-1\"\n        placeholder=\"Endpoint\"\n        aria-label=\"Endpoint\"\n        name=\"endpoint\"\n        value={filters.endpoint || ''}\n        onChange={(e) => onChange({ ...filters, endpoint: e.target.value })}\n      />\n      <input\n        className=\"rounded border p-1\"\n        placeholder=\"Статус\"\n        aria-label=\"Статус\"\n        name=\"status\"\n        value={filters.status || ''}\n        onChange={(e) =>\n          onChange({ ...filters, status: Number(e.target.value) || undefined })\n        }\n      />\n      <input\n        className=\"rounded border p-1\"\n        placeholder=\"Содержит текст\"\n        aria-label=\"Содержит текст\"\n        name=\"message\"\n        value={filters.message || ''}\n        onChange={(e) => onChange({ ...filters, message: e.target.value })}\n      />\n      <input\n        type=\"date\"\n        className=\"rounded border p-1\"\n        aria-label=\"От\"\n        name=\"from\"\n        value={filters.from || ''}\n        onChange={(e) => onChange({ ...filters, from: e.target.value })}\n      />\n      <input\n        type=\"date\"\n        className=\"rounded border p-1\"\n        aria-label=\"До\"\n        name=\"to\"\n        value={filters.to || ''}\n        onChange={(e) => onChange({ ...filters, to: e.target.value })}\n      />\n      <div className=\"flex items-center gap-1 text-sm\">\n        <input\n          id={noCsrfId}\n          name=\"noCsrf\"\n          type=\"checkbox\"\n          checked={filters.noCsrf || false}\n          onChange={(e) => onChange({ ...filters, noCsrf: e.target.checked })}\n        />\n        <label htmlFor={noCsrfId}>no-csrf</label>\n      </div>\n    </div>\n  );\n}\n","// Конфигурация колонок логов для React Table\n// Модули: @tanstack/react-table\nimport type { ColumnDef } from '@tanstack/react-table';\n\nexport interface LogRow {\n  level: string;\n  time: string;\n  method: string;\n  status: number;\n  endpoint: string;\n  message: string;\n}\n\nconst logColumns: ColumnDef<LogRow>[] = [\n  { header: 'Уровень', accessorKey: 'level' },\n  { header: 'Время', accessorKey: 'time' },\n  { header: 'Метод', accessorKey: 'method' },\n  { header: 'Статус', accessorKey: 'status' },\n  { header: 'Endpoint', accessorKey: 'endpoint' },\n  { header: 'Сообщение', accessorKey: 'message' },\n];\n\nexport default logColumns;\n","// Компонент просмотра логов на React Table\n// Модули: React, useLogsQuery, FiltersPanel, DataTable (лениво), logColumns\nimport React, { lazy, Suspense } from 'react';\nimport useLogsQuery, { LogFilters } from '../hooks/useLogsQuery';\nimport FiltersPanel from './FiltersPanel';\nconst DataTable = lazy(() => import('./DataTable'));\nimport logColumns from '../columns/logColumns';\n\nexport default function LogViewer() {\n  const [filters, setFilters] = React.useState<LogFilters>({});\n  const [live, setLive] = React.useState(true);\n  const [page, setPage] = React.useState(0);\n  const logs = useLogsQuery(filters, page + 1);\n\n  React.useEffect(() => {\n    setPage(0);\n  }, [filters]);\n\n  React.useEffect(() => {\n    if (!live) return;\n    const id = setInterval(\n      () => setFilters((current) => ({ ...current })),\n      5000,\n    );\n    return () => clearInterval(id);\n  }, [live]);\n\n  return (\n    <div className=\"space-y-4 rounded-lg bg-white p-4 shadow-sm\">\n      <div className=\"flex items-center justify-between\">\n        <h2 className=\"text-xl font-semibold\">Логи</h2>\n        <label\n          className=\"flex items-center gap-1 text-sm\"\n          htmlFor=\"log-live-toggle\"\n        >\n          <input\n            id=\"log-live-toggle\"\n            name=\"liveUpdates\"\n            type=\"checkbox\"\n            checked={live}\n            onChange={(e) => setLive(e.target.checked)}\n          />\n          Live\n        </label>\n      </div>\n      <FiltersPanel filters={filters} onChange={setFilters} />\n      <Suspense fallback={<div>Загрузка таблицы...</div>}>\n        <DataTable\n          columns={logColumns}\n          data={logs}\n          pageIndex={page}\n          pageSize={50}\n          onPageChange={setPage}\n        />\n      </Suspense>\n    </div>\n  );\n}\n"],"names":["className","children","jsx","LogViewer","ansiRegex","RegExp","concat","useLogsQuery","filters","page","_reactExports$useStat2","_slicedToArray","useState","logs","setLogs","useEffect","params","URLSearchParams","level","set","message","from","to","String","authFetch","toString","then","r","ok","json","data","parsed","map","l","line","createdAt","clean","replace","match","res","toLowerCase","time","msg","m","method","endpoint","csrf","status","Number","filter","includes","noCsrf","FiltersPanel","_ref","onChange","noCsrfId","React","useId","jsxs","name","value","e","_objectSpread","target","placeholder","type","id","checked","htmlFor","logColumns","header","accessorKey","DataTable","lazy","__vitePreload","module","import","_React$useState2","setFilters","_React$useState4","live","setLive","_React$useState6","setPage","setInterval","current","clearInterval","Suspense","fallback","columns","pageIndex","pageSize","onPageChange"],"mappings":"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"}