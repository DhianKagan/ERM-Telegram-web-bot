#!/usr/bin/env node
// patch: 036-fix-web-maps-service.cjs
// purpose: восстановить сервис карт на фронтенде для разворачивания ссылок, поиска и реверс-геокодирования
const fs = require('fs');
const path = require('path');

const target = path.resolve('apps/web/src/services/maps.ts');

const lines = [
  '// Назначение: функции для работы с API карт (разворачивание ссылок и геокодирование)',
  '// Модули: authFetch, Map API (/api/v1/maps)',
  "import authFetch from '../utils/authFetch';",
  '',
  'export type AddressSuggestion = {',
  '  id: string;',
  '  label: string;',
  '  description?: string;',
  '  lat: number;',
  '  lng: number;',
  '  source?: string;',
  '};',
  '',
  'export type ExpandLinkResponse = {',
  '  url: string;',
  '  coords?: { lat: number; lng: number } | null;',
  '  short?: string;',
  '};',
  '',
  'type SearchOptions = {',
  '  signal?: AbortSignal;',
  '  limit?: number;',
  '  language?: string;',
  '};',
  '',
  'type ReverseOptions = {',
  '  signal?: AbortSignal;',
  '  language?: string;',
  '};',
  '',
  'const clampLimit = (value?: number): number | undefined => {',
  '  if (!Number.isFinite(value ?? Number.NaN)) {',
  '    return undefined;',
  '  }',
  '  const normalized = Math.trunc(value ?? 0);',
  '  return Math.min(Math.max(normalized, 1), 10);',
  '};',
  '',
  'const normalizeCoords = (value: unknown): { lat: number; lng: number } | null => {',
  "  if (!value || typeof value !== 'object') {",
  '    return null;',
  '  }',
  "  const latValue = (value as { lat?: unknown }).lat;",
  "  const lngValue = (value as { lng?: unknown; lon?: unknown }).lng ?? (value as { lon?: unknown }).lon;",
  "  const lat = typeof latValue === 'number' ? latValue : typeof latValue === 'string' ? Number.parseFloat(latValue) : Number.NaN;",
  "  const lng = typeof lngValue === 'number' ? lngValue : typeof lngValue === 'string' ? Number.parseFloat(lngValue) : Number.NaN;",
  '  if (!Number.isFinite(lat) || !Number.isFinite(lng)) {',
  '    return null;',
  '  }',
  '  return { lat, lng };',
  '};',
  '',
  'const normalizeSuggestion = (item: unknown): AddressSuggestion | null => {',
  "  if (!item || typeof item !== 'object') {",
  '    return null;',
  '  }',
  '  const record = item as Record<string, unknown>;',
  "  const idRaw = (record as { id?: unknown; place_id?: unknown }).id ?? (record as { place_id?: unknown }).place_id;",
  "  const id = typeof idRaw === 'string'",
  "    ? idRaw",
  "    : typeof idRaw === 'number'",
  "      ? String(idRaw)",
  '      : null;',
  "  const labelCandidate = (record as { label?: unknown }).label ?? (record as { display_name?: unknown }).display_name;",
  "  const label = typeof labelCandidate === 'string' ? labelCandidate.split(',')[0]?.trim() ?? '' : '';",
  "  const latValue = (record as { lat?: unknown }).lat;",
  "  const lngValue = (record as { lng?: unknown; lon?: unknown }).lng ?? (record as { lon?: unknown }).lon;",
  "  const lat = typeof latValue === 'number'",
  "    ? latValue",
  "    : typeof latValue === 'string'",
  "      ? Number.parseFloat(latValue)",
  '      : Number.NaN;',
  "  const lng = typeof lngValue === 'number'",
  "    ? lngValue",
  "    : typeof lngValue === 'string'",
  "      ? Number.parseFloat(lngValue)",
  '      : Number.NaN;',
  '  if (!id || !label || !Number.isFinite(lat) || !Number.isFinite(lng)) {',
  '    return null;',
  '  }',
  "  const description = typeof (record as { description?: unknown }).description === 'string'",
  "    ? (record as { description?: string }).description",
  "    : typeof (record as { display_name?: unknown }).display_name === 'string'",
  "      ? (record as { display_name: string }).display_name",
  "          .split(',')",
  '          .slice(1)',
  '          .map((part) => part.trim())',
  '          .filter(Boolean)',
  "          .join(', ')",
  '      : undefined;',
  "  const source = typeof (record as { source?: unknown }).source === 'string'",
  "    ? (record as { source: string }).source",
  '    : undefined;',
  '  return {',
  '    id,',
  '    label,',
  '    description,',
  '    lat,',
  '    lng,',
  '    ...(source ? { source } : {}),',
  '  };',
  '};',
  '',
  'export const expandLink = async (url: string): Promise<ExpandLinkResponse | null> => {',
  '  const trimmed = url.trim();',
  '  if (!trimmed) {',
  '    return null;',
  '  }',
  "  const response = await authFetch('/api/v1/maps/expand', {",
  "    method: 'POST',",
  "    headers: { 'Content-Type': 'application/json' },",
  '    body: JSON.stringify({ url: trimmed }),',
  '  });',
  '  if (!response.ok) {',
  '    return null;',
  '  }',
  '  try {',
  '    const data = (await response.json()) as Record<string, unknown>;',
  "    if (!data || typeof data.url !== 'string' || !data.url.trim()) {",
  '      return null;',
  '    }',
  '    const coords = normalizeCoords((data as { coords?: unknown }).coords);',
  "    const short = typeof (data as { short?: unknown }).short === 'string'",
  "      ? (data as { short: string }).short.trim()",
  '      : undefined;',
  '    return {',
  "      url: data.url.trim(),",
  '      coords: coords ?? null,',
  '      ...(short ? { short } : {}),',
  '    };',
  '  } catch {',
  '    return null;',
  '  }',
  '};',
  '',
  'export const searchAddress = async (',
  '  query: string,',
  '  options: SearchOptions = {},',
  '): Promise<AddressSuggestion[]> => {',
  '  const trimmed = query.trim();',
  '  if (!trimmed) {',
  '    return [];',
  '  }',
  '  const limit = clampLimit(options.limit);',
  '  const params = new URLSearchParams({ q: trimmed });',
  "  if (typeof limit === 'number') {",
  "    params.set('limit', String(limit));",
  '  }',
  '  const headers: Record<string, string> = {};',
  '  if (options.language) {',
  "    headers['Accept-Language'] = options.language;",
  '  }',
  "  const response = await authFetch(`/api/v1/maps/search?${params.toString()}`, {",
  "    method: 'GET',",
  '    signal: options.signal,',
  '    headers,',
  '  });',
  '  if (!response.ok) {',
  '    return [];',
  '  }',
  '  try {',
  '    const data = (await response.json()) as { items?: unknown };',
  '    const items = Array.isArray(data.items) ? data.items : [];',
  '    return items',
  '      .map((item) => normalizeSuggestion(item))',
  '      .filter((item): item is AddressSuggestion => Boolean(item));',
  '  } catch {',
  '    return [];',
  '  }',
  '};',
  '',
  'export const reverseGeocode = async (',
  '  coords: { lat: number; lng: number },',
  '  options: ReverseOptions = {},',
  '): Promise<AddressSuggestion | null> => {',
  '  if (!coords || !Number.isFinite(coords.lat) || !Number.isFinite(coords.lng)) {',
  '    return null;',
  '  }',
  '  const headers: Record<string, string> = {};',
  '  if (options.language) {',
  "    headers['Accept-Language'] = options.language;",
  '  }',
  '  const params = new URLSearchParams({',
  "    lat: coords.lat.toString(),",
  "    lng: coords.lng.toString(),",
  '  });',
  "  const response = await authFetch(`/api/v1/maps/reverse?${params.toString()}`, {",
  "    method: 'GET',",
  '    signal: options.signal,',
  '    headers,',
  '  });',
  '  if (!response.ok) {',
  '    return null;',
  '  }',
  '  try {',
  '    const data = (await response.json()) as { place?: unknown };',
  '    return normalizeSuggestion(data.place);',
  '  } catch {',
  '    return null;',
  '  }',
  '};',
  '',
  'const maps = { expandLink, searchAddress, reverseGeocode };',
  '',
  'export default maps;',
  '',
];

const content = lines.join(String.fromCharCode(10));
fs.writeFileSync(target, content, 'utf8');
console.log('rewritten ' + path.relative(process.cwd(), target));
