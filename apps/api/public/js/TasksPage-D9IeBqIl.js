import{j as c}from"./index-DgL4A3Hy.js";import{R as o,i as B}from"./vendor-bFQg9Mu4.js";import{T as G}from"./TaskTable-Bm5NCTXl.js";import{u as H}from"./AuthenticatedApp-m87IzzAI.js";import{a as J,i as Q,j as W,k as X,h as Y}from"./App-C5qf9m0C.js";import"./taskColumns-cbsood-k.js";import"./EmployeeLink-Cf0n-sug.js";function re(){var N,I,K;const[d,F]=o.useState(0),[_,M]=o.useState([]),[R,x]=o.useState(!0),[i,f]=B(),[u,C]=o.useState(i.get("mine")==="1"),{version:$,refresh:U,controller:j,filters:a,setFilterUsers:P}=H(),{user:e,loading:p}=J(),z=(e==null?void 0:e.role)==="admin",L=(e==null?void 0:e.role)==="manager",O=(N=e==null?void 0:e.permissions)==null?void 0:N.includes("tasks"),b=Array.isArray(e==null?void 0:e.permissions)?e==null?void 0:e.permissions:null,q=((I=b==null?void 0:b.length)!=null?I:0)>0,l=z||L,v=l||O||!q,h=l?u:!0,S=o.useMemo(()=>{const t=[...a.status].sort().join(","),s=[...a.priority].sort().join(","),n=[...a.taskTypes].sort().join(","),r=[...a.assignees].sort((g,m)=>g-m).join(",");return[t,s,n,r,a.from,a.to].join("|")},[a]),k=o.useMemo(()=>{const t=e!=null&&e.telegram_id?String(e.telegram_id):"anon",s=h?"mine":"all";return"tasks:task:".concat(t,":").concat(s,":page=").concat(d+1,":filters=").concat(S)},[h,S,d,e==null?void 0:e.telegram_id]),A=Q(k),D=W(k),T=o.useCallback(t=>{const s=new Map;t.forEach(n=>{var m,y;const r=Number(n.telegram_id);if(!Number.isFinite(r))return;const g=(m=typeof n.name=="string"&&n.name.trim().length>0?n.name.trim():n.username)!=null?m:"ID ".concat(r);s.set(r,{id:r,name:g,username:(y=n.username)!=null?y:null})}),P(Array.from(s.values()).sort((n,r)=>n.name.localeCompare(r.name,"ru")))},[P]),w=o.useCallback(()=>{if(!(e!=null&&e.telegram_id)){j.setIndex(k,[],{kind:"task",mine:h,userId:void 0,pageSize:25,total:0,sort:"desc"}),x(!1);return}x(!0);const t={page:d+1,limit:25,mine:!l||u?1:void 0,kind:"task"};a.status.length&&(t.status=a.status.join(",")),a.taskTypes.length&&(t.taskType=a.taskTypes.join(",")),a.assignees.length&&(t.assignees=a.assignees.join(",")),X(t,e.telegram_id,!0).then(s=>{const n=s.tasks,r=l?n:n.filter(m=>{const y=m.assignees||(m.assigned_user_id?[m.assigned_user_id]:[]),E=e.telegram_id;return y.includes(E)||m.created_by===E});j.setIndex(k,r,{kind:"task",mine:h,userId:e.telegram_id,pageSize:25,total:s.total||r.length,sort:"desc"});const g=Array.isArray(s.users)?s.users:Object.values(s.users||{});M(g),T(g)}).finally(()=>x(!1)),l&&Y("/api/v1/users").then(s=>s.ok?s.json():[]).then(s=>{const n=Array.isArray(s)?s:Object.values(s||{});M(n),T(n)}).catch(()=>{})},[j,h,l,u,d,k,e,a,T]);o.useEffect(()=>{if(!p&&!l&&(u||C(!0),i.get("mine")!=="1")){const t=new URLSearchParams(i);t.set("mine","1"),f(t,{replace:!0})}},[p,l,u,i,f]),o.useEffect(()=>{p||v&&e!=null&&e.telegram_id&&w()},[p,e,w,$,d,u,v]);const V=o.useMemo(()=>{const t={};return _.forEach(s=>{t[s.telegram_id]=s}),t},[_]);return p?c.jsx("div",{children:"Загрузка..."}):v?c.jsxs("div",{className:"space-y-6",children:[c.jsx("h2",{className:"text-2xl font-semibold text-slate-900 dark:text-slate-100",children:"Панель управления задачами"}),R&&c.jsx("div",{children:"Загрузка..."}),c.jsx(G,{tasks:A,users:V,page:d,pageCount:Math.ceil(((K=D.total)!=null?K:A.length)/25),mine:l?u:!0,onPageChange:F,onMineChange:l?t=>{C(t),t?i.set("mine","1"):i.delete("mine"),f(i)}:void 0,onRowClick:t=>{i.set("task",t),f(i)},toolbarChildren:c.jsxs(c.Fragment,{children:[c.jsx("button",{onClick:U,className:"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700",children:"Обновить"}),c.jsx("button",{onClick:()=>{i.set("newTask","1"),f(i)},className:"rounded bg-blue-600 px-2 py-1 text-sm text-white hover:bg-blue-700",children:"Новая задача"})]})})]}):c.jsx("div",{className:"p-4",children:"У вас нет прав для просмотра задач"})}export{re as default};
//# sourceMappingURL=TasksPage-D9IeBqIl.js.map
