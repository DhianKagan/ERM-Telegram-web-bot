<!-- Назначение файла: краткий план развития проекта. -->

# Дорожная карта проекта

- Добавлена команда `pnpm a11y` для проверки контрастности главной страницы.
- Базовые компоненты `Button` и `Input` унифицированы, формы стилизуются через `@tailwindcss/forms`, контраст контролируется автоматическими тестами.
- Документация собрана в одном файле technical_manual.md
- Добавлена современная форма задачи `TaskFormModern`.
- Поддержка произвольных полей задач через объект `custom`.
- Таблица задач получила фильтры по значениям и кнопку поиска.
- Инструмент `dataStorage` обеспечивает управление файлами через `/api/v1/storage` и страницу `/cp/storage`.
- Вложения задач сохраняются на локальном томе, путь задаётся `STORAGE_DIR`.
- История изменений задач и отдельные поля номера и даты создания.
- Форма задачи поддерживает загрузку файлов с предварительным просмотром
  и требует заполненного названия.
- Разделы API и карта запросов перенесены в него, отдельные файлы `api_reference.md` и `db_request_map.md` удалены
- Руководство по настройке Telegram-бота включено в него, файл `docs/telegram_bot_manual.md` удалён
- Документация по модулям объединена в docs/architecture.md
- Модули `db/connection.ts`, `db/model.ts` и `db/queries.ts` переведены на
  TypeScript
- Контроллеры маршрутов и оптимизации, модуль `config.ts`, модель `AuthUser`
  и кастомный бекенд админки переведены на TypeScript
- Для тестов типов добавлен отдельный `tsconfig.json` в каталоге `bot`
- Сервис задач использует типизированный репозиторий, фильтры задач экспортированы
  из `db/queries.ts`
- ESLint запрещает файлы `.js` вне конфигурации
- Разделена защита от CSRF: Mini App работает без cookie, Admin UI использует
  синхронизатор токенов и защищённые cookie
- Флаг Secure у cookie включён всегда; переменная `COOKIE_SECURE=false` разрешает HTTP только локально
- Внедрён единый middleware ошибок с форматом `application/problem+json`
- Добавлен корневой `package.json` с зависимостями `eslint`, `jiti` и `reflect-metadata` для запуска `npx eslint bot/src`
- Массовые действия над задачами позволяют выбирать все статусы и выделять все задачи.
- Оптимизированы запросы задач: добавлен скрипт `ensureIndexes` с индексами `{assigneeId,status,dueAt}` и `createdAt`.
- Ограничены запросы к `/api/v1/auth` и `/api/v1/route`, отдельные лимиты для Mini App и Admin, метрика `rate_limit_drops_total` доступна в Prometheus
- Ограничены запросы к `/api/v1/auth` и `/api/v1/route`, отдельные лимиты для Mini App и Admin, лимитер отправляет `X-RateLimit-*`, метрика `rate_limit_drops_total` имеет метки `name` и `key`, настроен алерт p95 и панель дашборда
- Добавлены гистограммы HTTP (method, route, status), метрики OSRM и поддержка traceparent.
- Таблицы админки переведены на AG Grid с сервисом `useGrid` и модульными колонками.
- Dependabot еженедельно обновляет npm-зависимости, CI запускает `audit-ci` с порогом `high`.
- Политика CSP разрешает подключение Google Fonts, источники стилей и шрифтов
  расширяются переменными `CSP_STYLE_SRC_ALLOWLIST` и `CSP_FONT_SRC_ALLOWLIST`.
- Стабилизированы запросы OSRM: алгоритм MLD по умолчанию, кеш с
  инвалидированием при изменении задач и ограничение размера и частоты матриц.
- Канбан-доска задач перенесена в раздел `cp` и доступна только администраторам.
- Реализован поиск задач с нечетким соответствием и сохранение пользовательских видов фильтрации.
- Страница «Мои задачи» удалена; обычные пользователи видят только свои задачи и меняют статус на «В работе» или «Выполнена» через специальные кнопки.

## Ближайшие задачи

- Полноценная типизация контроллеров и сервисов; `noImplicitAny` включён.
- Сервисы `LogsService` и `UsersService` уже используют интерфейсы репозитория без `any`.
- Исключить оставшиеся `any` и вернуть правило ESLint `no-explicit-any` (выполнено).
- Удалить дублирующий модуль `services/tasks.ts`, оставить `TasksService`.
- Переработать архитектуру DI, отказаться от service locator.
- Ввести интерфейсы для внешних сервисов и регистрировать их в контейнере.
- Применить паттерн Command для команд бота и Strategy для маршрутизации.
- Унифицировать обработку ошибок API и использовать собственные классы.
- Расширить тестовое покрытие и обновить документацию.

- Поддерживать регрессионный пакет тестов Playwright и Supertest для Auth/CRUD/CSRF.

1. Подготовка окружения: `.env` из `.env.example`, запуск Docker Compose
2. Развитие бота и мини‑приложения в каталоге `bot`
3. Исправлена сборка CSS для стабильного дизайна
4. Автоматические тесты через `./scripts/setup_and_test.sh` локально и в CI; при наличии Docker проверяется `docker compose config`, иначе выводится предупреждение
5. Аудит зависимостей командой `./scripts/audit_deps.sh`
6. Слабые уязвимости пропускаются флагом `--audit-level high`
7. Скрипт `install_bot_deps.sh` устанавливает корневые, серверные и клиентские зависимости и завершает установку,
   если остаются только нерешённые слабые уязвимости
8. Проверка MongoDB скриптом `check_mongo.ts` с понятной ошибкой при недоступности базы, использование healthcheck в Docker
9. Поддержка pm2 6.0.8 и повторных подключений к базе
10. Настройка fork-режима pm2 для предотвращения ошибок polling
11. Синхронизация команд и сообщений скриптами при деплое
12. Расширение API и интерфейса по мере необходимости
13. Интерфейс админки на `/cp` построен на TailAdmin
14. Исправлены ошибки TypeScript, мешавшие сборке Docker
15. Уточнены типы Express и сервисов, сборка Docker проходит
16. Сервисы переписаны на TypeScript с явными интерфейсами данных
17. Перевод серверных модулей на TypeScript: сервис, контроллер и роут карт, модуль auth
18. Доступ к админке открыт только пользователям с ролью администратора
19. Авторизация кодом из Telegram определяет роль пользователя автоматически
20. Маска доступа хранится в поле `access` и ускоряет проверку прав
21. В коллекции `roles` хранится список прав; страница `/cp/roles` позволяет их менять
22. Страница `/cp/logs` показывает логи через WG Log Engine
23. Цветные уровни и Telegram-уведомления о предупреждениях и ошибках
24. Пагинация списка задач для уменьшения нагрузки на клиент
25. Автоматическое формирование `slug` для человекочитаемого URL
26. Улучшение SEO и доступности (robots.txt, aria‑label, meta description)
27. Расширенная модель задачи с логистикой, закупками и работами
28. Поддержка enum-полей для типов транспорта, оплаты и статусов
29. CRUD-эндпойнты `/api/v1/tasks` с полной формой заявки
30. Учёт этих полей в веб-клиенте и контроллерах
31. Запрос `updateTask` фильтрует поля обновления, предотвращая инъекции
32. Значения enum задаются в `bot/src/shared/taskFields.ts`, страница справочников удалена
33. Улучшение интерфейса управления заявками
34. Расширение enum-значений: добавлены "Построить", "Починить" и "Без оплаты"
35. Уточнение документации о допустимых значениях `task_type`
36. Унификация формы создания и редактирования задач
37. Везде использовать идентификатор вида `ERM_000001` и добавлять его к названию
38. Исправлен маршрут `/api/v1/users`, убраны лишние аргументы
39. Форма задач: сначала дата начала и срок выполнения, затем статус и приоритет, контролёр допускает несколько значений
40. Кнопки "Карта" ведут на ссылку <https://maps.app.goo.gl/xsiC9fHdunCcifQF6> без iframe
41. Бот отвечает полной ссылкой и координатами на короткие URL Google Maps
42. Форма задач принимает короткие ссылки Google Maps и сохраняет полные
43. Исполнители и контролёр добавляются из выпадающего списка через кнопку «+»
44. Поле ввода ссылки на карту скрывается после вставки, показывается адрес
45. Координаты сохраняются в `startCoordinates` и `finishCoordinates`
46. В форме под ссылкой отображаются координаты
47. Пустые координаты не передаются в API
48. Добавить поле `start_date` для даты начала задачи
49. Форма выравнивается слева и растягивается на всю ширину
50. Выпадающие списки упоминаний удалены
51. Унифицирован префикс /api/v1 во всех запросах клиента
52. Интеграция React Quill и TelegramUI через @telegram-apps/sdk-react
53. Запуск мини-приложения в браузере по флагу `?browser=1`; кнопка «Браузер» ведёт на `https://agromarket.up.railway.app/?browser=1`
54. Клиент автоматически выбирает режим работы при отсутствии `Telegram.WebApp`
55. Удалить неиспользуемые состояния `roles` и `groups` в `TaskDialog`
56. Вынести React-контексты в отдельные файлы для поддержки hot reload
57. В логах разработки выводить только начало `BOT_TOKEN`
58. Указать рабочий email в SECURITY.md и владельца в CODEOWNERS
59. Обновить документацию: приоритет по умолчанию — «В течение дня»
60. Экспортировать провайдеры контекстов из файлов контекста для надёжного импорта
61. Открывать форму задачи поверх текущей страницы по параметрам URL
62. Добавить возможность скрывать сайдбар на всех устройствах
63. Уточнить стили формы для мобильных экранов
64. Шапка учитывает ширину сайдбара и растягивается при его скрытии
65. Форма задач заполняет область под шапкой и центрируется
66. Отправка формы авторизации клавишей Enter
67. Поле "Название" находится в начале формы задачи
68. Некоторые поля формы размещены на одной строке для уменьшения высоты
69. Все ответы бота собраны в `docs/bot_responses.md` и представлены на русском
70. Скрипт `scripts/db/seed.ts` использует приоритет «Срочно» для тестовой задачи
71. Списки значений загружаются из `bot/src/shared/taskFields.ts` без вызова API
72. Страница `/tasks` показывает даты начала и завершения,
    админ может менять статус и приоритет прямо в таблице,
    доступна сортировка по всем колонкам
73. Эндпойнт `/api/v1/route` возвращает координаты и длину маршрута
74. Инструкция по запуску OSRM на Railway в docs/osrm.md
75. Пример переменной `ROUTING_URL` использует сервис `https://osrm-production.up.railway.app/route`
76. Фронтенд использует переменную `VITE_ROUTING_URL` с тем же адресом
77. README содержит пример JSON с координатами
78. В мануале к боту описано разворачивание коротких ссылок Google Maps
79. Документ `docs/railway_full_setup.md` описывает развёртывание всего проекта на Railway
80. В задачи добавлено поле `route_distance_km` для расстояния маршрута
81. Ссылка маршрута сохраняется в поле `google_route_url`
82. Новый API `/api/v1/routes/all` и страница «Маршруты» с картой
83. Параметр `status` в этом API проверяется как строка и передаётся в запрос без операторов
84. Leaflet подключён локально, политика CSP разрешает тайлы OpenStreetMap
85. Статусы задач переведены на русский, время выполнения сохраняется в `completed_at`
86. Политика CSP разрешает подключение к сервису OSRM
    и домену `router.project-osrm.org`
87. Фильтры маршрутов отправляются только при заполнении
88. Страница `/tasks` автоматически обновляет список после создания задачи,
    добавлена кнопка «Обновить задачи»
89. Задачи на этой странице создаются через `/api/v1/tasks` с полями `title`
    и `task_description`
90. Страница маршрутов строит путь через OSRM,
    задачи задают порядок отображения маршрутов
91. Карта занимает верхнюю часть страницы, таблица задач закреплена снизу
92. Старт и финиш маршрута отмечены интерактивными иконками,
    фильтры статуса удалены, задачи выводятся таблицей,
    администратор может открывать их на редактирование
93. Форма задачи всегда поверх карты, есть кнопка сброса изменений и возможность развернуть окно,
    администратор может удалить задачу с подтверждением
94. При открытии задачи ввод блокируется, для изменений есть кнопка «Редактировать»
95. В Tailwind настроены палитры `success`, `error` и `warning` для оформления кнопок и уведомлений
96. Реализована оптимизация маршрутов для 1–3 машин, на странице «Маршруты» добавлена кнопка «Просчёт маршрута»
97. Возле неё появился выбор метода: angle или trip
98. Маршруты отображаются поверх карты разными цветами, есть кнопка «Сбросить»
99. Меню расчёта находится между картой и списком задач
100. Ссылки Google Maps показываются в меню и не открываются автоматически
101. Если выбрано несколько машин, задачи распределяются между всеми авто
102. Удалённые задачи переносятся в коллекцию `archives` с номером вида `ERM_xxx-DEL`
103. Страница `/tasks` позволяет скачать таблицу задач в CSV или JSON
104. Кнопки действий задачи закреплены внизу внутри формы, цвет «Принять» и «Выполнено» зависит от статуса
105. Команда `/task_form_app` отправляет ссылку на форму создания задачи
106. Функции работы с Google Maps вынесены в общий модуль `bot/src/shared/mapUtils.ts`
107. Все изменения задач фиксируются в коллекции логов
108. `authFetch` перенаправляет на `/login` при отсутствии токена или статусе 401/403
109. Срок действия JWT увеличен до семи дней
110. Подтверждение кода админа обновляет роль существующего пользователя на `admin`
111. Исправлена ошибка линтера в `TaskDialog`: состояние `selectedAction` подсвечивает выбранную кнопку
112. Сервис OSRM поддерживает `/table`, `/nearest`, `/match` и `/trip`
113. Координаты запросов к маршрутам проходят валидацию
114. Подключение к MongoDB повторяется до 10 раз,
     параметры задаются переменными `RETRY_ATTEMPTS` и `RETRY_DELAY_MS`
115. Меню задач выводит только кнопку «Мои задачи», действия обновляют сообщение, не закрывая его
116. Кнопки «Выполнено» и «Отменить» обновляют статус задачи без повторного выбора
117. Кнопка «Мои задачи» и команда `/list_tasks` показывают все связанные задачи с кнопками действий
118. Команда `/task_info` выводит компактную форму задачи в чате
119. Задача отображается в формате Markdown, снизу кнопка «Маршрут»
120. В сообщении указаны тип задачи, дата начала, исполнители и создатель
121. Все запросы к API и ответы фиксируются в журнале
122. Бот сравнивает текст перед редактированием сообщений
123. Поля описания задач и комментариев ограничены 4096 символами
124. Описание задачи видно в форме при закрытом редакторе
125. Функция `stripTags` полностью удаляет HTML-теги из комментариев
126. В Telegram выводится поле `task_description` вместо `comment`
127. Превью ссылок в сообщениях задач отключается
128. Зависимость `glob` закреплена на версии 7.2.3 для совместимости с CommonJS

129. Меню бота содержит только команды /start и /register
130. Маршрут `/cp/admin` объявлен как `/*splat` для Express 5
131. Комментарии API обновлены для нового синтаксиса маршрутов
132. Перед обновлением зависимостей выполняйте `npm outdated`, затем
     `./scripts/audit_deps.sh` и `./scripts/setup_and_test.sh`
133. Поле username в ответах API содержит Telegram ID
134. ID пользователей показываются в интерфейсе ссылкой с именем.
135. В задачах имена исполнителей и контролёров отображаются ссылками на профиль
136. `authFetch` перенаправляет на `/login` при отсутствии токена или статусе 401/403
137. Запросы `/api/v1/users` и `/api/v1/departments` выполняются только администратором
138. Исправлена ошибка инициализации переменной isAdmin в TasksPage
139. Панель управления доступна по пути `/cp`, кнопка «Админка» расположена в шапке.
140. В ответах API добавлено поле `telegram_username` для отображения имени.
141. Заглушка аватара заменена иконкой `UserCircleIcon`.
142. При вводе админского кода роль пользователя обновляется на `admin`.
143. Исправлены ошибки ESLint в контроллерах routes и tasks
144. Исправлена загрузка списка пользователей в TasksPage для обычных пользователей
145. Загрузка задач в канбане корректно парсит ответ сервера
146. Страница задач не падает при пустом ответе fetchTasks
147. Имена исполнителей и контролёров в форме отображаются после подгрузки пользователей
148. Добавлены тесты админских маршрутов
149. Исправлено обновление роли на страницах задач при смене токена
150. Покрыт тестами доступ к `/api/v1/users`
151. Скрипт create_admin_user.ts устанавливает roleId администратора
152. createUser проставляет name и roleId по умолчанию
153. Настроен Prettier и команда `npm run format`
154. В telegramApi.call реализован экспоненциальный бэкофф
155. Создан INCIDENT_RESPONSE.md для экстренной смены токена
156. Исправлена обработка кэша задач в tasks.js
157. Workflow CI закрепляет Node.js 20 и запускает тесты
158. Админка принимает токен через параметр `?token`,
     статические файлы отдаются без проверки
159. При ошибке 409 бот ждёт 3 секунды и перезапускается до пяти раз
160. Форма задачи остаётся открытой после сохранения, имена исполнителей сохраняются
161. Обновлены package-lock.json клиента для успешной сборки Docker
162. JWT теперь хранится в cookie HttpOnly
163. API использует lusca.csrf и express-session для защиты от CSRF
164. Сессия передаёт cookie только по HTTPS в продакшене, маршруты задач лимитированы
165. CSRF-токен находится в cookie XSRF-TOKEN и автоматически отправляется authFetch
166. Маршруты `/api/v1/auth/send_code` и `/api/v1/auth/verify_code` не требуют CSRF-токена
167. Сессии хранятся в MongoDB через библиотеку connect-mongo
168. Тесты используют secure cookie только в продакшене
169. Обновлена зависимость form-data до 4.0.4
170. Тест errorHandler использует secure cookie в зависимости от `NODE_ENV`
171. Добавлен маршрут `/api/v1/auth/verify_init` для проверки initData
172. В каталог `prometheus` помещены примеры конфигурации и оповещений
173. Создан файл `docs/stress_plan.md` с инструкцией по нагрузочному тестированию
174. Добавлен маршрут `/api/v1/csrf` для получения CSRF-токена и метрика `csrf_errors_total`
175. Клиент при инициализации запрашивает `/api/v1/csrf` для установки CSRF-токена
176. authFetch повторяет запрос при ответе 403 и пишет исключение в консоль
177. AuthProvider ждёт загрузки профиля, чтобы исключить лишние редиректы на `/login`
178. При отсутствии CSRF-токена authFetch получает его перед отправкой запроса
179. API слушает PORT на 0.0.0.0, Railway перенаправляет HTTP на HTTPS
180. Уровень логирования по умолчанию debug, переменные `LOG_LEVEL`,
     `LOG_TELEGRAM_TOKEN` и `LOG_TELEGRAM_CHAT` необязательны
181. Схема логов принимает уровни debug и log для обработки console.log
182. Маршрут `/api/v1/optimizer` исключён из CSRF-проверки
183. Workflow CI выполняет линт, тесты и сборку клиента
184. В `CHANGELOG.md` описан процесс релизов и семантического версионирования
185. `docs/stress_plan.md` дополнен чек-листом отказоустойчивости
186. Удалены устаревшие файлы `dashboard_tailadmin.md`, `tailadmin_figma_design.md` и `TailAdminDesign.fig`. Основной гайд по стилю — `docs/extended_tailadmin_guide.md`
187. Docker Compose собирает образ из корня проекта; Dockerfile включён в контекст
188. Маршрут `/api/v1/maps/expand` не требует CSRF-токена
189. Страница `/cp/logs` получила фильтр по уровню, тексту и дате и сортировку
190. Интерфейс логов показывает таблицу с методом, статусом и endpoint, режим live и экспорт в CSV/JSON
191. Фильтр уровня логов принимает только допустимые значения
192. Добавлен тест `loginFlow.test.ts` с полным сценарием логина и POST-запросом
193. Тест `loginFlow.test.ts` использует rate limit 100 запросов за 15 минут
194. Тест `loginRouteFlow.test.ts` проверяет CSRF-токен и вызов `/api/v1/route`
195. Cookie `token` использует SameSite=Lax и домен из APP_URL для сохранения сессии
196. Сессионная cookie хранится 7 дней, синхронно со сроком действия JWT
197. Cookie `XSRF-TOKEN` устанавливается с тем же доменом и SameSite=None
198. AuthProvider запрашивает `/api/v1/csrf` при фокусе страницы
199. authFetch записывает тело запроса в `localStorage` при ошибке CSRF
200. Лог запросов фиксирует наличие токена и заголовка CSRF
201. План внедрения рекомендаций из анализа описан в docs/apply_analysis_plan.md
202. Тест routeCsrf.test.ts использует самоподписанный сертификат и проверяет CSRF при расчёте маршрутов,
     а taskFields.test.ts контролирует поля формы
203. Добавлена маска `ACCESS_MANAGER`, тесты покрывают комбинированные маски
204. Тест `loginTasksFlow.test.ts` проверяет создание задачи после логина
205. seed.ts назначает администратору маску доступа 2
206. Контроллеры задач проверяют право пользователя на изменение задачи
207. Эндпойнт `/api/v1/logs` валидирует `page` и `limit` через query

- Инъекция зависимостей через tsyringe, контейнер src/di/index.ts

208. Валидация запросов перенесена на классы DTO и `class-validator`
209. Введён guard `rolesGuard` с декоратором `Roles` для проверки маски доступа
210. Код аутентификации вынесен в новые файлы `auth.controller.ts` и `auth.service.ts`,
     успешные логины пишутся в логи
211. Созданы UsersModule, RolesModule и LogsModule с отдельными сервисами и
     контроллерами
212. Добавлены middleware `pinoLogger.ts` и `metrics.ts`; Prometheus собирает
     `http_requests_total` и `http_request_duration_ms`
213. Покрыты тестами сервисы авторизации и задач, CI использует `setup_and_test.sh`
214. Workflow `release.yml` деплоит приложение на Railway через Railway CLI
215. README дополнен примером создания задачи через API и списком модулей
216. Исправлен импорт сервиса авторизации в контроллере
217. Указано расширение `.ts` в roles.guard.ts для корректной загрузки декоратора
218. Cookie `token` получает флаг `Secure` только в продакшене, verifyToken пишет причину отказа
219. Выполнять регулярную ротацию секретов и обновлять значения в `.env` и Railway
220. Улучшены сообщения об ошибках сохранения задач, введена метрика `api_errors_total` и детальный лог IP и User-Agent
221. Добавлена переменная `COOKIE_DOMAIN`, домен cookie задаётся только в продакшене
222. Middleware pinoLogger.ts выводит IP и User-Agent в логах
223. Middleware checkRole и checkTaskAccess фиксируют отказ доступа в логах
224. Значение COOKIE_DOMAIN может быть URL, hostname извлекается автоматически и проверяется
225. После установки cookie `token` в лог пишется домен
226. Документ `docs/railway_full_setup.md` дополнен разделом «Переменные окружения»
227. Middleware `verifyToken` продлевает cookie `token` при каждом запросе
228. CSRF-токен сохраняется в `localStorage` и отправляется в заголовке
229. При недоступности `localStorage` токен хранится в памяти, страница входа показывает ошибки
230. Проведена ревизия кода, удалена зависимость bcrypt
231. Функция `setTokenCookie` объединяет установку cookie `token`
232. Удалены из зависимостей bcrypt и mongodb-memory-server как неиспользуемые
233. Удалён контроллер tasks.js, проверка валидации вынесена в handleValidation
234. Убрана интеграция GatewayAPI и переменные `GATEWAY_API_KEY`, `GATEWAY_SENDER`
235. Убрана интеграция GatewayAPI и переменные `GATEWAY_API_KEY`, `GATEWAY_SENDER`
236. Удалён дублирующийся файл .husky/husky.sh
237. Удалён пакет @aws-sdk/client-s3
238. Повторяющийся код расчёта маршрута вынесен в функцию applyRouteInfo
239. Веб‑клиент импортирует mapUtils из `src/shared/mapUtils.ts`
240. authFetch поддерживает опцию noRedirect, предотвращая цикл входа
241. API использует middleware compression для сжатия
242. Фильтры логов получили атрибуты aria-label для улучшения доступности
243. Исполнители на странице задач выводятся по имени, если задан telegram_username
244. Запросы с заголовком `Authorization` обходят проверку CSRF, переменная `DISABLE_CSRF=1` отключает middleware и предупреждает в продакшене
245. Сервер компилируется TypeScript перед запуском, исходники в dist
246. updateUser использует sanitizeUpdate и $eq
247. tsconfig.json исключает каталог `bot/shared` и папку `dist`
248. Dockerfile запускает `npm run build` перед сборкой клиента
249. Dockerfile копирует `tsconfig.json`, чтобы сборка не падала
250. Dockerfile переносит `dist` в образ для запуска pm2
251. Исправлено подключение middleware логирования и метрик API
252. Исправлен импорт middleware `rolesGuard` в маршрутах `users`, `roles` и `logs`
253. Включён строгий режим TypeScript в сборке
254. Составлен план миграции JavaScript → TypeScript и запланированы проверки против возврата к `.js`
255. Переведены на TypeScript утилиты `userLink`, `formatTask`, `validate`, `haversine`, `verifyInitData`, `accessMask`, `formatUser`, `setTokenCookie` и `rateLimiter`
256. Утилита verifyInitData выбрасывает ошибку при отсутствии BOT_TOKEN
257. Исправлена типизация профиля пользователя для корректной сборки
258. Проверяется домен коротких ссылок Google Maps для защиты от SSRF
259. Проверяется протокол https, userinfo и порт коротких ссылок Google Maps
260. Уточнена типизация `username` в модуле авторизации для сборки Docker
261. API и middleware переписаны на TypeScript, исходные `.js` файлы удалены
262. Middleware `checkRole` и `taskAccess`, сервис `auth` веб-клиента и файл бота `bot` переписаны на TypeScript
263. В сервисе профиля веб-клиента `auth` используется локальный тип `FetchOptions` вместо `RequestInit`
264. Клиентские утилиты parseJwt, csrfToken и extractCoords переписаны на TypeScript
265. Текстовые ответы бота вынесены в `bot/src/messages.ts`
266. Утилита parseGoogleAddress переписана на TypeScript
267. Утилита authFetch и сервисы веб-клиента logs, maps, optimizer, roles, route, routes, tasks и osrm переписаны на TypeScript
268. Утилита authFetch использует локальный интерфейс FetchOptions вместо RequestInit
269. Скрипты меню Telegram и утилита chaos переведены на TypeScript

270. Тесты бота переписаны на TypeScript, Jest использует файлы `.test.ts`
271. Исключение `bot/src/api/*.js` удалено из tsconfig, план миграции обновлён
272. Общий тип RequestWithUser внедрён в контроллеры и middleware
273. Добавлены проверки типов через `tsd` и скрипт стресс-теста
274. Удалены неиспользуемые интерфейсы в роутерах authUser, logs и optimizer
275. Конфигурации ESLint, Prettier и Babel переведены на TypeScript, добавлена проверка отсутствия .js файлов
276. Реализован `tmaAuthGuard` и маршрут `/api/auth/tma-login` с проверкой `auth_date`
277. Логи HTTP и API включают `trace-id` каждого запроса
278. RequestWithUser использует `ParsedQs` в `query` для совместимости с Express 5
279. Добавлены заголовки безопасности Helmet и Content Security Policy
     с расширяемыми белыми списками через переменные окружения
280. Логирование ограничено ключевыми действиями; просмотр логов не записывается
281. Утилита verifyInitData использует @telegram-apps/init-data-node, guard tmaAuthGuard отдаёт распарсенные данные
282. Лимитер считает запросы по telegram_id и поддерживает капчу через `X-Captcha-Token`
283. Схема задач и формы содержат `formVersion`, сервер отвергает неизвестные версии
