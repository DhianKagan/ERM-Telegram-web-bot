<!-- Назначение файла: список основных изменений. -->

# История изменений

- Добавлены CRUD роуты для флотов, департаментов и сотрудников.
- Локализованы компоненты FileUploader и TaskDialog.
- Скрипт install_bot_deps.sh игнорирует неисправимые уязвимости, `audit-ci.json` разрешает пакет `debug`.
- В TaskDialog добавлено состояние отправки, кнопка блокируется и показывает индикатор загрузки.
- Срок задачи по умолчанию сдвигается на день вперёд от даты начала,
  дата окончания корректируется при изменении начала.
- В Tailwind подключены плагины daisyui и @tailwindcss/typography.
- Конфигурация Lighthouse CI запускает предпросмотр клиента через `pnpm --dir apps/web preview`, предотвращая сбои CI.
- Включены sourcemap в Vite, превью файлов используют `srcset`, артефакты сборки загружаются в CI.
- Добавлен скрипт `generate_hero_images.mjs`, meta‑теги `og:image` и шаг `prebuild`.
- Документация дополнена рекомендациями по предотвращению поломок фронтенда при деплое на Railway.
- Зависимость `react-router-dom` возвращена к версии шестой ветки для совместимости.
- Веб‑клиент автоматически работает в браузере без флага `?browser=1`, предупреждение о Telegram удалено.
- Реализован скрипт `start_api_with_memdb.sh` для запуска API с MongoDB в памяти, инструкция в README.
- Быстрый старт использует `./scripts/create_env_from_exports.sh`, добавлен `start_api_with_memdb.sh`.
- В корневые devDependencies добавлен `express-rate-limit`, исправлен сбой теста `tasks.upload.spec.ts`.
- Скрипт `pre_pr_check.sh` поднимает MongoDB в памяти, `check_mongo.mjs` пропускает проверку при `CI=true`, обновлена документация переменной `MONGO_DATABASE_URL`.
- `SESSION_SECRET` в `.env.example` пуст, добавлена команда генерации и предупреждение о коммите.
- Исправлен запуск клиента: инициализация откладывается до `DOMContentLoaded`,
  из-за чего при деплое исчезала ошибка `Cannot set properties of undefined`.
- Очищается таймер тостов при размонтировании компонента, предотвращая утечки.
- Удалён токен из `AuthContext`; клиент использует cookie и CSRF-токен.
- Добавлена зависимость react-jss для корректной сборки клиента.
- `.npmrc` задаёт npmjs.org для scope `@jsr`, устраняя ошибку установки зависимостей.
- Скрипт `install_bot_deps.sh` скачивает бинарный pnpm из GitHub при недоступности npm и corepack.
- Удалён пакет `react-jss` из lockfile, зафиксированы `react-is` 18.3.1 и
  `hoist-non-react-statics` 3.3.2, устраняя ошибку запуска клиента.
- Dockerfile копирует каталог `patches` перед `pnpm fetch`, устраняя ошибку отсутствующего патча.

- Зафиксированы версии `react-is` 18.3.1 и `hoist-non-react-statics` 3.3.2
  в `pnpm.overrides`, что устраняет зависимость старых пакетов и
  предотвращает сбой клиента.
- Исправлена ошибка разделения чанков: `use-callback-ref` включён в `react`,
  что устраняет сбой `useLayoutEffect`.
- Отключён таймаут PNPM для `pnpm run dev`, сервер работает без завершения.
- В Dockerfile ограничена параллельность `pnpm fetch`, чтобы избежать ошибок 429 при сборке.
- `install_bot_deps.sh` скачивает pnpm через curl при сбое corepack и npm.
- Скрипт `install_bot_deps.sh` корректно устанавливает pnpm через corepack с резервом на npm.
- Скрипт `pre_pr_check.sh` создаёт каталог `/tmp/apps` для логов запуска.
- Скрипт `pre_pr_check.sh` повторно собирает сервер после установки зависимостей.
- Добавлены проверка расширения и MIME, антивирусное сканирование и журналирование файлов; введены лимиты вложений на пользователя.
- Реализована загрузка нескольких файлов через drag-and-drop в TaskDialog и chunk-upload на сервере.
- Заменён AG Grid на DataTable (React Table) с серверной пагинацией, скрытием и перестановкой колонок, экспорт вынесен в общий тулбар (CSV/XLSX/PDF).
- Удалена зависимость `react-jss` из веб-клиента, снижая конфликт с `hoist-non-react-statics` в React 18.
- README сокращён: удалены устаревшие разделы, инструкции перенесены в docs/technical_manual.md.
- Добавлен контроль скриптов зависимостей через `pnpm approve-builds` и проверка в CI.
- Добавлен роут `/api/v1/files/:id` с проверкой прав и метрика `disk_free_bytes`.
- Удалён устаревший импорт `chonky/style/main.css`; сборка клиента снова проходит успешно.
- Добавлены `sharp` и `ffmpeg` для создания миниатюр вложений; проверяются MIME и размер файлов, ссылки сохраняются в `attachments` и коллекции `File`.
- Добавлена проверка типа параметра `type` в сервисе `dataStorage`, предотвращающая инъекции операторов MongoDB.
- Добавлена модель `File` в MongoDB и фильтрация файлов по `userId` и типу.
- Вложения задач сохраняются в подкаталоге пользователя и хранят метаданные: автор, дата, тип и размер.
- Procfile выполняет `pnpm build` перед запуском PM2, упрощён Dockerfile и добавлен раздел деплоя на Railway в README.
- Dockerfile кеширует зависимости через `pnpm fetch` и раздельно собирает пакеты `web` и `api`.
- Исправлен скрипт `test:api`: добавлено подключение `tests/setupEnv.ts` и поиск тестов в подпапках; документирована текущая lazy-загрузка в `docs/lazy_loading.md`.
- Сборка Vite очищает каталог вывода через `emptyOutDir`.
- Исправлен catch-all маршрут SPA: Express отдаёт `/login` и другие пути через `app.get('*')`.
- Лимит size-limit для `apps/api/public/assets/*.js` увеличен до 900 KB, чтобы предотвратить падение CI.
- Исправлен путь к `check:mongo.mjs`, lock-файл PNPM синхронизирован с `overrides`.
- Исправлен CI: `docker.yml` и шаблон PR используют команды `pnpm`, путь `bot/src` заменён на `apps/api/src`.
- Переведено на монорепозиторий pnpm: сервер в `apps/api`, клиент в `apps/web`, общие модули в `packages/shared`.
- Интерфейсы Task и User вынесены в пакет `shared`, добавлены константы и единая точка входа.
- Исправлен запуск тестов в `setup_and_test.sh`: удалён лишний `--`, из-за чего Jest не находил тесты.
- `pre_pr_check.sh` запускает `audit_deps.sh`; в CI добавлен job `audit-deps` и документирован обход ложных срабатываний `audit-ci`.
- `install_bot_deps.sh` использует pnpm и обеспечивает наличие pnpm в CI, `audit_deps.sh` проверяет все пакеты через `audit-ci`.
- Удалён скрипт `postinstall` из `bot/package.json`, добавлена команда `npm run prepare-client` и сборка клиента вынесена в CI.
- Обновлён шаг CI проверки контраста: используется `pnpm a11y`, удалён устаревший ключ `-p`.
- Исправлена проверка контраста в CI: `@axe-core/cli` анализирует локальный файл `bot/public/index.html` через ключ `-p`.
- Команда `pnpm a11y` запускает `vite preview` и проверяет `http://localhost:4173/index.html` через `@axe-core/cli`.
- Команда `pnpm a11y` переписана на Playwright и проверяет `bot/web/index.html` без установки Chrome.
- Добавлена команда `pnpm a11y` для проверки контраста `bot/public/index.html` через `@axe-core/cli`.
- Локальные шрифты и фавиконы, внешние URL исключены из расчёта SRI.
- Исправлен запуск `pnpm a11y`: путь к файлу задаётся через `file://` и `pwd`,
  что устраняет ошибку DNS `ERR_NAME_NOT_RESOLVED`.
- Подключён плагин `@tailwindcss/forms`, добавлены унифицированные компоненты `Button` и `Input` с 8‑pt ритмом и проверкой контраста в CI.
- Таблица задач получила фильтры со списками значений и поиск по кнопке.
- Добавлена обработка `multipart/form-data` при создании задач и переменная
  окружения `R2_ENDPOINT` для публичного URL R2.
- Вложения сохраняются в каталоге, задаваемом переменной `STORAGE_DIR`.
- Исправлена ошибка сервиса задач при обновлении без данных:
  расчёт маршрута выполняется только при наличии координат.
- Добавлена поддержка HashiCorp Vault и AWS Secrets Manager,
  пересоздание ключей по `KEY_ROTATION_CRON` и настройка CORS R2
  через переменную `R2_CORS_ORIGIN`.
- Канбан-доска перенесена в панель `cp` и закрыта для обычных пользователей; фильтрация "Моих задач" встроена в общий список задач с кнопками смены статусов «В работе» и «Выполнена» для пользователей.
- Добавлен инструмент `dataStorage` и раздел `Файлы` в `/cp/storage`.
- Удалён маршрут `/r2` и коллекция `uploads` для старого способа хранения файлов.
- Релизы создаются при пуше тега вида `vMAJOR.MINOR.PATCH`.
- Номер версии следует [семантическому версионированию](https://semver.org/lang/ru/).
- Файл `release.yml` собирает образ и выкладывает его на Railway.
- Диалог задачи занимает весь экран, содержимое прокручивается по высоте.
- Глобальный лимитер применяется только к `/api`; маршрут `/api/v1/csrf` и статика исключены, файлы кешируются на год.
- Лимитер отправляет заголовки `X-RateLimit-*`, метрика `rate_limit_drops_total` содержит метки `name` и `key`, добавлен алерт p95 и панель дашборда.
- Инструкции переведены на pnpm, описаны пакеты `bot`, `api` и `shared`, добавлен пример локального запуска.
- Добавлены инструкции по сборке образа и запуску двух процессов на Railway.
- CSP добавляет `upgrade-insecure-requests` в боевом режиме и поддерживает
  отчёты через переменную `CSP_REPORT_URI`; все сервисы переведены на HTTPS.
- Исправлено сохранение задач: `formVersion` отправляется при обновлении,
  добавлена кнопка «Загрузить» с миниатюрами файлов в форме задачи.
- Разрешена загрузка шрифтов Google через CSP, добавлена переменная `CSP_FONT_SRC_ALLOWLIST`.
- Убран `'strict-dynamic'` из CSP, добавлен `vite-plugin-sri`, `pre_pr_check.sh` проверяет наличие JS-бандла.
- По умолчанию сервис OSRM использует алгоритм MLD, запросы кешируются на 10
  минут и очищаются при изменении задач, матрица `/table` ограничена по
  размеру и частоте.
- Обновлена документация: исправлены инструкции клонирования и структура фронтенда.
- Дорожная карта и план внедрения обновлены; устаревшие документы `TSrecomendation.md` и `analys2025.md` удалены,
  содержание `ModuleCore.md` перенесено в `docs/architecture.md`.
- Добавлены зависимости `pino` и `pino-http`, middleware `pinoLogger.ts` генерирует reqId из traceparent и заменяет `logging.ts`.
- Добавлены гистограммы HTTP и OSRM, поддержка W3C Trace Context и метрики ошибок OSRM.
- Разделы API и карта запросов объединены в `docs/technical_manual.md`, файлы `docs/api_reference.md` и `docs/db_request_map.md` удалены.
- Добавлен сервис `useGrid` для AG Grid и вынесены конфигурации колонок.
- Добавлен единый middleware ошибок с ответами `application/problem+json` по [RFC 9457](https://www.rfc-editor.org/rfc/rfc9457).
- Настроен Dependabot для еженедельных npm-обновлений; CI выполняет `audit-ci` и падает при уязвимостях уровня high.
- Веб‑клиент поддерживает массовую смену статуса задач с выбором любого статуса и выделение всех задач.
- Реализована канбан-доска задач с перетаскиванием, переключателем таблица/доска и обновлением статуса через PATCH `/api/v1/tasks/:id/status`.
- Добавлены поиск задач с нечетким соответствием и сохранение видов фильтрации.
- Добавлен компонент `TaskFormModern` с компактной формой создания задач.
- В модель задачи добавлен объект `custom` для произвольных полей и поддержка их в формах.

- Руководство по настройке Telegram-бота перенесено в `docs/technical_manual.md`, файл `docs/telegram_bot_manual.md` удалён.

- Включён строгий режим TypeScript и добавлен план миграции из JavaScript (`docs/typescript_migration_plan.md`).
- Исправлена типизация порта, Request получил метод `csrfToken`, `jwt.verify` использует строгие типы.
- Включён флаг `noImplicitAny` и обновлены типы сервисов задач и пользователей.
- ESLint запрещает файлы `.js` вне конфигурации.
- Корневой `package.json` содержит зависимости `eslint` и `jiti`, поэтому `npx eslint bot/src` выполняется без ошибок.
- Добавлен композитный индекс `assigneeId,status,dueAt` и индекс `createdAt` для задач, внедрён скрипт `ensureIndexes` и тесты explain().
- Скрипт `install_bot_deps.sh` устанавливает корневые, серверные и клиентские зависимости,
  что обеспечивает работу `npx eslint bot/src` в Docker.
- Разделена защита от CSRF для Admin UI и Mini App: маршруты `/api/tma`
  исключены из проверки, ошибки возвращают тело `application/problem+json`.
- Cookie сессии и CSRF-токенов имеют флаги `HttpOnly`, `Secure`, `SameSite=None`.
- Флаг `Secure` у cookie включён всегда; переменная `COOKIE_SECURE=false` разрешает HTTP в разработке.
- Добавлена документация `docs/security/cookies_csrf.md`.
- Добавлен guard `tmaAuthGuard` с проверкой подписи и `auth_date`, маршрут `/api/auth/tma-login` выдаёт краткоживущий токен.
- Логи HTTP и API содержат `trace-id` для отслеживания запросов.
- Добавлены лимиты на `/api/v1/auth` и `/api/v1/route`, метрика `rate_limit_drops_total` отображает превышения.
- Переписаны на TypeScript утилиты `userLink`, `formatTask`, `validate`, `haversine` и `verifyInitData`.
- На TypeScript переписаны утилиты `accessMask`, `formatUser`, `setTokenCookie` и `rateLimiter`.
- На TypeScript переписаны утилиты `parseJwt`, `csrfToken` и `extractCoords`.
- На TypeScript переписана утилита `parseGoogleAddress`.
- На TypeScript переписан модуль `auth`.
- Утилита `authFetch` и сервисы веб-клиента `logs`, `maps`, `optimizer`, `roles`, `route`, `routes`, `tasks` и `osrm` переписаны на TypeScript.
- На TypeScript переведён модуль `messages`.
- Уточнены типы сервиса задач, фильтры задач экспортированы из `db/queries.ts`.
- Подключение, модели и запросы MongoDB (`connection.ts`, `model.ts`,
  `queries.ts`) переведены на TypeScript и снабжены типами схем.
- Добавлен локальный `tsconfig.json` в каталоге `bot` для проверки типов.
- Интерфейсы маршрутов экспортированы для корректной работы ESLint.
- Все сервисы переписаны на TypeScript, добавлены интерфейсы и тесты `getRouteDistance`.
- `verifyInitData` проверяет наличие переменной `BOT_TOKEN` и выбрасывает ошибку при её отсутствии.
- Конфигурации Vite, Tailwind и PostCSS переписаны на TypeScript,
  скрипт проверки MongoDB и тема интерфейса также написаны на TypeScript.
- Удалено исключение `bot/src/api/*.js` из `tsconfig.json`, план миграции обновлён.
- Добавлен лимитер запросов для входа через Telegram Mini App и исправлена типизация `traceId`.

- Уточнена типизация `username` в auth.service и auth.ts для корректной сборки Docker.

- Исправлено подключение middleware `logging` и `metrics` в API.
- Убраны лишние аргументы маршрута `/api/v1/users`, исключающего ошибку `argument handler must be a function`.
- Исправлен импорт middleware `rolesGuard` в маршрутах `users`, `roles` и `logs`.
- Удалены неиспользуемые интерфейсы в маршрутах задач и пользователей для прохождения ESLint.
- Исправлены ошибки TypeScript, из-за которых падала сборка Docker.
- Исправлена типизация профиля пользователя: `formatUser` принимает отсутствующий `telegram_id`.
- Модуль `shared/mapUtils` и утилиты веб-клиента переписаны на TypeScript.

- Документация сведена в `docs/technical_manual.md`, README сокращён
- Удалены устаревшие файлы `dashboard_tailadmin.md`, `tailadmin_figma_design.md` и `TailAdminDesign.fig`. Советы по стилю находятся в `extended_tailadmin_guide.md`
- Админка принимает токен в параметре `?token=` и статику можно загружать без
  заголовка Authorization
- Страница `/cp/logs` заменяет `/cp/admin` и показывает логи
- Система логирования переведена на WG Log Engine
- Общие функции Google Maps собраны в `packages/shared/src/mapUtils.ts`
- Развёртывание коротких ссылок Google Maps проверяет домен по белому списку
- Проверяется протокол https, отсутствие userinfo и нестандартного порта у коротких ссылок Google Maps
- Добавлена цветовая маркировка уровней и уведомления Telegram через движок
- Запрос `updateTask` фильтрует поля и игнорирует ключи с `$`, устранена ошибка CodeQL
- Система ролей дополнена числовыми масками доступа; middleware `checkRole` поддерживает проверку масок
- Удалены неиспользуемые функции assignTask, listAllTasks и команды загрузки файлов
- При обращении к пользователю Telegram ID приводится к числу,
  поиск задач экранирует спецсимволы регулярных выражений

- Уточнены типы `botToken` и `chatId`, middleware `checkRole` и `taskAccess`
  описаны собственными интерфейсами запроса для успешной Docker-сборки
- Функция `authFetch` перенаправляет на `/login` при отсутствии токена или статусе 401/403
- Исправлено обновление роли при подтверждении админского кода
- Срок действия JWT увеличен до семи дней
- Подтверждение кода администратора повышает существующего пользователя до роли `admin`
- Коды подтверждения содержат подпись типа пользователя
- Добавлена страница `/roles` для управления правами ролей
- Очередь сообщений ограничена 100 задачами и выводит ошибки
- Планировщик напоминаний использует lean и пакетное обновление
- Список задач кэшируется в localStorage и показывает индикатор загрузки
- Удалён AdminJS, админка `/admin` теперь использует кастомный бекенд
- Бекенд админки проверяет роль пользователя через JWT
- Меню бота упрощено: доступны только `/start` и `/register`
- Переработан расчёт маршрутов: используется сервис `OSRM-Odessa-Region` вместо GraphHopper erm-map
- Удалена страница «Справочники» и API `/api/v1/defaults` и `/api/v1/transports`; значения enum берутся из `taskFields.js`
- Уточнён владелец репозитория и email в SECURITY.md и CODEOWNERS
- В `setup_and_test.sh` тесты запускаются с флагом `--detectOpenHandles`
- Скрипт `setup_and_test.sh` проверяет `docker compose config` только при наличии команды `docker` и выводит предупреждение, если Docker не найден
- Функция `stripTags` рекурсивно удаляет HTML-теги в комментариях
- Добавлен скрипт `audit_deps.sh` и шаг CI для проверки зависимостей
- Низкоуровневые уязвимости игнорируются флагом `--audit-level high`
- Эндпойнты `/table`, `/nearest`, `/match` и `/trip` используют параметры `points` и `point`
- В README и документации указан новый репозиторий сервиса и переменная `OSRM_ALGORITHM`
- Кнопки статуса вынесены под форму и стали квадратными
- В верхней панели формы появилась кнопка «Сбросить»
- Кнопки действий внизу формы меняют цвет в зависимости от статуса
- Команда `/task_form_app` открывает форму новой задачи
- Зависимость `glob` зафиксирована на версии 7.2.3 для поддержки CommonJS
- Добавлена команда `/my_tasks` для вывода всех связанных задач
- Меню задач показывает только кнопку «Мои задачи»
- Исправлено отображение описания задачи в форме просмотра
- Действия «Принять», «Выполнено», «Изменить», «Отменить» обновляют задачу без закрытия сообщения
- Кнопка «Мои задачи» и команда `/list_tasks` выводят форму задачи с кнопками действий
- Все изменения задач пишутся в коллекцию логов
- Запросы к API и ответы сохраняются в журнал
- Бот безопасно редактирует сообщения, сравнивая текст
- Поля описания задач и комментариев ограничены 4096 символами
- Скрипт `install_bot_deps.sh` завершается успешно,
  если остаются только нерешённые слабые уязвимости
- Исправлена ошибка сборки CSS: неизвестный класс `bg-danger` приводил к пустому
  файлу стилей
- Фильтр `status` в `/api/v1/routes/all` защищён от инъекций
- Leaflet подключается локально, политика CSP разрешает тайлы OpenStreetMap
- Политика CSP разрешает подключение к сервису OSRM
  и `router.project-osrm.org`
- Удалённые задачи помещаются в коллекцию `archives` с суффиксом `-DEL`
- Страница `/tasks` получила экспорт таблицы в CSV и JSON
- На этой странице задачи создаются через `/api/v1/tasks` с полями
  `title` и `task_description`
- Пустые фильтры `/api/v1/routes/all` не отправляются
- Страница «Маршруты» строит путь через OSRM,
  порядок отображения зависит от сортировки задач
- Карта занимает верхнюю часть страницы, таблица закреплена снизу
- Старт и финиш маршрута отмечены интерактивными иконками
- Фильтры статуса убраны, задачи показаны таблицей с сортировкой,
  администратор может открыть их на редактирование
- Форма задачи фиксирована поверх карты, окно можно свернуть или развернуть,
  администратор может удалить задачу после подтверждения
- При открытии существующей задачи поля недоступны до нажатия «Редактировать»,
  исправлено самопроизвольное восстановление значений
- На странице «Маршруты» карта скрывается при открытии задачи
- В TaskDialog данные справочников загружаются один раз без перезапросов
- На форме входа можно отправить данные клавишей Enter
- В Tailwind добавлены палитры цветов `success`, `error` и `warning`
- Поле "Название" перемещено в начало формы задачи
- Некоторые поля формы объединены в строки по два, чтобы сократить высоту формы
- Справочники задач загружаются одним запросом для предотвращения ошибки 429
- Таблица ответов бота в `docs/bot_responses.md` полностью на русском
- В примерах `.env` и документации `ROUTING_URL` указывает на `https://osrm-production.up.railway.app/route`
- Добавлена переменная `VITE_ROUTING_URL` для веб-клиента
- Добавлена `docs/osrm.md` с инструкцией по запуску сервиса OSRM
- README обновлён ссылкой на документ `docs/osrm.md`
- Dockerfile корректно копирует каталог `bot`, сборка образа проходит без ошибок
- Добавлен `docs/railway_full_setup.md` с описанием полного развёртывания на Railway
- Клиент переведён на React 18 ради совместимости с TelegramUI
- Поддержан запуск в браузере через флаг `?browser=1`, telegram-apps-sdk не загружается
- Кнопка «Браузер» ведёт на `https://agromarket.up.railway.app/?browser=1`
- Клиент автоматически выбирает режим браузера при отсутствии `Telegram.WebApp`
- Завершение таймеров в `messageQueue` устранено
- Код бота и клиента объединён в каталоге `bot`
- Приоритет по умолчанию исправлен на форму «В течение дня»
- Добавлены скрипты `setup_and_test.sh`, `create_env_from_exports.sh`, `create_admin_user.js` и `check_bot_token.sh`
- MongoDB запускается с учётными данными `admin`/`admin` и healthcheck на `mongosh`
- Бот работает через polling, меню и сообщения синхронизируются скриптами
- Авторизация через одноразовый код; количество попыток ограничено
- Формы задач вынесены в общий модуль `taskFields.js`
- Добавлены глобальные обработчики ошибок и дополнительные тесты
- Команда `/whoami` показывает ID и статус пользователя
- Добавлена пагинация списка задач через параметры `page` и `limit`
- В модели задач появилось поле `slug`, генерируемое из названия
- Добавлены `robots.txt`, мета‑описание и aria‑метки для кнопок
- Модель задач расширена логистикой, закупками и работами
- Добавлены поля `transport_type`, `payment_method`, `priority`, `status`
- Веб-клиент получил редактор React Quill и поддержку TelegramUI
  через библиотеку @telegram-apps/sdk-react
- CRUD-маршруты `/api/v1/tasks` поддерживают полный набор полей
- Форма задач и контроллеры поддерживают поля `transport_type`,
  `payment_method` и выбор статуса
- Добавлены коллекции `DefaultValue` и `Transport` для справочников
- API `/api/v1/defaults/:name` и `/api/v1/transports` позволяет редактировать значения
- Для этих маршрутов добавлен rate limit и проверка входных данных
- Формы задач открываются поверх текущей страницы через параметры URL
- Сайдбар можно полностью скрыть и раскрыть
- При скрытом сайдбаре шапка растягивается, форма задач центрируется и занимает оставшееся пространство
- Макет формы адаптирован под мобильные устройства
- Интерфейс задач дополнен новой формой
- pm2 переведён в fork-режим, чтобы исключить конфликт polling
- Добавлены новые значения enum: "Построить", "Починить" для `task_type` и "Без оплаты" для `payment_method`
- Уточнён список допустимых `task_type` в документации
- Добавлена единая форма для создания и редактирования задач
- Название задачи теперь включает идентификатор вида `ERM_000001`
- API переведён на префикс `/api/v1`
- Изменён путь подключения к MongoDB на `ermdb`
- Добавлены переменные `RETRY_ATTEMPTS` и `RETRY_DELAY_MS`;
  по умолчанию выполняется 10 попыток подключения
- В формах задач отдельно выводятся номер задачи и дата создания, заголовок больше не добавляет `ERM_` к названию
- Добавлена история изменений задач с отображением в форме
- Поле "Ответственный" исключено, "Контролёр" поддерживает выбор нескольких
- Поля формы расположены в порядке: дата начала, срок выполнения, статус, приоритет и далее
- Кнопки "Карта" ведут на ссылку <https://maps.app.goo.gl/xsiC9fHdunCcifQF6> без iframe
- "Исполнител(и)ь" и "Контролёр" можно выбирать из списка по кнопке «+»
- Бот разворачивает короткие ссылки Google Maps и показывает координаты
- Форма задач также разворачивает короткие ссылки Google Maps
- В форме задачи при вставке ссылки поле скрывается, отображается адрес
- Добавлены поля `startCoordinates` и `finishCoordinates`
- Координаты точки теперь выводятся под ссылкой в форме
- Отправка null координат исключена, поля передаются только при наличии
- Появился эндпойнт `/api/v1/route` для расчёта расстояния
- В модель задач добавлено поле `route_distance_km`
- Добавлено поле `google_route_url` и автоматическая генерация ссылки маршрута
- Добавлен эндпойнт `/api/v1/routes/all` и страница «Маршруты»
- В форме появилось поле `start_date` для даты начала
- Автоподстановка финальной точки из стартовой отключена
- Выпадающие списки упоминаний удалены
- Скрипт `scripts/db/seed.ts` создаёт задачу с приоритетом «Срочно»
- В списке задач доступны даты начала и дедлайн,
  администратор может менять статус и приоритет, добавлена сортировка
- После создания задачи список на странице `/tasks` обновляется автоматически,
  появилась кнопка «Обновить задачи»
- Добавлена оптимизация маршрутов для 1–3 машин, кнопка «Просчёт маршрута»
- Добавлен выбор метода оптимизации: angle или trip
- Оптимизированные маршруты отображаются на карте разными цветами
- Добавлена кнопка «Сбросить" для очистки наложенных маршрутов
- Для каждого маршрута формируется ссылка Google Maps (до 10 точек)
- Меню расчёта расположено между картой и таблицей задач,
  ссылки выводятся в меню и не открываются автоматически
- При расчёте нескольких машин задачи распределяются между всеми авто
- README дополнен примером JSON со `startCoordinates` и `finishCoordinates`
- Разворачивание коротких ссылок Google Maps описано в `docs/technical_manual.md`
- Статус задач переведён на русский, добавлено поле `completed_at`
- Сервис OSRM поддерживает `/table`, `/nearest`, `/match` и `/trip`
- Координаты запросов к OSRM валидируются для защиты от SSRF

### Безопасность

- Сообщение о загрузке `BOT_TOKEN` не раскрывает даже начало значения
- Исправлены пути API в клиенте: добавлен префикс /api/v1
- Удалены неиспользуемые состояния `roles` и `groups` в компоненте `TaskDialog`
- Провайдер `ThemeProvider` корректно экспортируется из файла `ThemeContext.tsx`
- Провайдеры `SidebarProvider` и `ToastProvider` экспортируются из файлов контекста
- Исправлены зависимости `useEffect` в `TaskDialog`, предупреждения ESLint исчезли
- Исправлена ошибка линтера: состояние `selectedAction` используется для подсветки кнопок
- Кнопка \xC2\xABИзменить\xC2\xBB включает режим смены статуса
- Добавлен POST /api/v1/logs для произвольной записи
- Кнопки действий перемещены внутрь формы, теперь всегда находятся внизу окна
- Исправлен порядок обработчиков «Выполнено» и «Отменить», кнопки корректно меняют статус задачи
- Кнопка «Мои задачи» выводит все связанные задачи пользователя
- Команда `/task_info` показывает компактное описание задачи
- Вывод задачи в чате форматируется Markdown, добавлена кнопка маршрута
- Появились новые поля: тип задачи, дата начала, список исполнителей и создатель
- В чате отображается `task_description` вместо `comment`
- Превью ссылок в сообщениях задачи отключено
- Маршрут `/admin` объявлен как `/*splat` для Express 5, исправлен wildcard
- В комментариях API указан маршрут `/*splat` вместо устаревшего `/{*splat}`
- Перед обновлением зависимостей выполняется `npm outdated` и тестирование скриптами
- Авторизация проверяет роль пользователя, код отправляется только в Telegram
- Разделы «Роли» и «Логи» перенесены на `/admin`
- Страница `/admin` показывает заглушку для неадминов
- В API поле username теперь содержит Telegram ID
- Внутри `/admin` разделы переключаются вкладками «Роли» и «Логи»
- Имена пользователей отображаются ссылками на их Telegram ID
- В сообщениях задач исполнители, контролёры и создатель выводятся по имени
- Запросы `/api/v1/users` и `/api/v1/departments` выполняет только админ, обычные пользователи не перенаправляются на `/login`
- Исправлена ошибка инициализации переменной `isAdmin` в TasksPage, из-за которой падала авторизация
- Авторизация отправляет код входа в зависимости от роли пользователя
- Дашборд удалён, административные страницы перенесены на /cp
- На странице профиля теперь можно изменить ФИО и мобильный номер, добавлено поле mobNumber в схему пользователя. Путь /cp открывает панель управления, ссылка на неё доступна в меню админа.
- API пользователей теперь возвращает поле `telegram_username` с оригинальным username.
- Иконка меню профиля заменена на UserCircleIcon без заглушки.
- Меню профиля удалено, кнопка «Админка» находится в шапке.
- Исправлены ошибки ESLint в контроллерах routes и tasks
- Исправлена загрузка списка пользователей в TasksPage для неадминистраторов
- Исправлена загрузка задач в канбане при объектном ответе API
- Страница задач не падает, если fetchTasks вернул пустой массив
- Имена исполнителей и контролёров в форме подтягиваются из API и показывают имя
- Добавлены тесты админских маршрутов
- Исправлено определение роли в таблицах задач при смене токена
- Добавлены тесты доступа к маршруту `/api/v1/users`
- Скрипт create_admin_user.js также записывает roleId администратора
- Создание пользователя добавляет поле name и roleId по умолчанию
- Добавлен файл docs/architecture.md с описанием модулей
- Настроен Prettier и команда `npm run format`
- telegramApi.call повторяет запрос с экспоненциальной задержкой
- Добавлен INCIDENT_RESPONSE.md с инструкцией по смене токена
- Исправлена обработка кэша задач в tasks.js
- Workflow CI использует Node.js 20 для единообразия окружения
- При ошибке 409 бот повторяет запуск через 3 секунды и делает до 5 попыток
- Форма задачи остаётся открытой после сохранения, выбранные исполнители отображаются по имени
- Обновлены файлы package-lock.json клиента, docker build выполняется без ошибок
- JWT помещается в cookie HttpOnly
- API защищён от CSRF при помощи lusca.csrf, сессии хранятся через connect-mongo
- Сессия хранится в MongoDB, cookie передаётся только по HTTPS, маршруты задач ограничены rate limit
- CSRF-токен передается через cookie XSRF-TOKEN и добавляется в заголовок автоматической обёрткой fetch
- Маршруты `/api/v1/auth/send_code` и `/api/v1/auth/verify_code` не требуют CSRF-токена
- Тесты используют secure cookie только в продакшене
- Обновлена зависимость form-data до 4.0.4 для устранения критической уязвимости
- Обработчик ошибок учитывает статус ответа и возвращает 403 при ошибке CSRF
- Тест errorHandler использует флаг secure у cookie в зависимости от `NODE_ENV`
- Добавлен эндпойнт `/metrics` для Prometheus
- Введена проверка initData веб‑приложения и маршрут `/api/v1/auth/verify_init`
- Добавлены файлы конфигурации Prometheus и базовое правило оповещений
- Создан `docs/stress_plan.md` с планом нагрузочных тестов
- Добавлен маршрут `/api/v1/csrf` для получения CSRF-токена
- Ошибки CSRF учитываются метрикой `csrf_errors_total`
- Клиент мини‑приложения автоматически запрашивает `/api/v1/csrf`
- Исправлена обработка ошибки JSON при повторном запросе CSRF
- AuthProvider добавил состояние loading, страницы не перенаправляют на `/login` до загрузки профиля
- authFetch получает CSRF-токен при его отсутствии, избегая лишнего ответа 403
- API слушает порт на 0.0.0.0, добавлен тест проверки APP_URL
- Максимальный уровень логирования debug установлен по умолчанию,
  переменные `LOG_LEVEL`, `LOG_TELEGRAM_TOKEN` и `LOG_TELEGRAM_CHAT`
  можно не задавать
- Схема логов допускает уровни debug и log, чтобы перехватывать console.log
- Маршрут `/api/v1/optimizer` исключён из проверки CSRF
- Тесты устанавливают APP_URL для загрузки конфигурации
- Исправлена ошибка сборки `docker compose build`: Dockerfile берётся из корня,
  `.dockerignore` больше его не исключает
- Маршрут `/api/v1/maps/expand` исключён из проверки CSRF
- Страница логов получила фильтры по уровню, дате и тексту, а также сортировку
- Фильтр уровня логов проверяет значения по списку
- Интерфейс логов построен в виде таблицы с методом и статусом, включает экспорт в CSV/JSON и режим live
- Добавлен тест `loginFlow.test.js` с полным циклом логина и запросом к защищённому маршруту
- Тест `loginFlow.test.js` применяет rate limit к маршруту `/api/protected`
- Добавлен тест `loginRouteFlow.test.js`, проверяющий CSRF и вызов `/api/v1/route`
- Cookie `token` использует SameSite=Lax и домен из APP_URL, поэтому сессия не теряется при возврате с внешних сайтов
- Сессионная cookie получает срок жизни 7 дней, как и JWT
- AuthProvider обновляет CSRF-токен при фокусе страницы
- Cookie `XSRF-TOKEN` имеет SameSite=None и общий домен для совпадения с заголовком
- authFetch сохраняет тело запроса в `localStorage` при ошибке CSRF
- Логи запросов указывают наличие cookie и заголовка CSRF
- Добавлен файл docs/apply_analysis_plan.md с планом внедрения рекомендаций.
- Тест `routeCsrf.test.js` использует secure cookie и проверяет CSRF,
  `taskFields.test.js` контролирует форму задач
- В TLS-тесте используется самоподписанный сертификат вместо отключения проверки
- authFetch повторно запрашивает токен при любом ответе 403
- Добавлена маска `ACCESS_MANAGER` и тесты `accessMask.test.js`, `authRole.test.js` проверяют комбинированные права
- Добавлен тест loginTasksFlow.test.js для проверки CSRF после логина
- Скрипт `scripts/db/seed.ts` присваивает администратору маску доступа 2
- Контроллеры задач проверяют, что пользователь изменяет только собственные задачи
- Подробные логи CSRF включают значения заголовка и cookie
- В `/cp/logs` добавлена постраничная навигация
- В логи задач добавлен пользователь, выполнивший действие
- Повышение пользователя до администратора фиксируется в логах
- В Prometheus добавлено правило оповещения `CsrfErrors`
- Исправлена ошибка ESLint в API: параметр `query` не был импортирован
- Обновлён файл `docs/architecture.md`: описана модульная структура
- Добавлена библиотека tsyringe и контейнер src/di/index.ts для сервисов
- Введены классы DTO и middleware валидации на основе `class-validator`
- Добавлены `roles.guard.ts` и `roles.decorator.ts`, контроллеры задач и
  пользователей используют проверку маски доступа
- Код авторизации перенесён в `auth.controller.ts` и `auth.service.ts`
- Успешные логины записываются в базу логов
- Созданы UsersModule, RolesModule и LogsModule с роутами `/api/v1/users`,
  `/api/v1/roles`, `/api/v1/logs`
- Добавлены middleware `logging.ts` и `metrics.ts`; Prometheus собирает
  `http_requests_total` и `http_request_duration_ms`, конфигурация обновлена
- Добавлены тесты `authService.test.js` и `tasksService.test.js`,
  workflow CI выполняет `setup_and_test.sh` и проверку зависимостей
- Добавлены примеры API с DTO в README
- Workflow `release.yml` разворачивает проект на Railway через Railway CLI

- Исправлена ошибка импорта auth.service
- Указано расширение `.ts` в roles.guard.ts для корректного импорта
- Cookie `token` получает флаг `Secure` только в продакшене
- verifyToken логирует причину отказа при отсутствии или ошибке токена
- verifyToken выводит первые символы токена при ошибке
- requestLogger выводит начало заголовка Authorization для сравнения с cookie
- Выполнена ротация `BOT_TOKEN` и других секретов, изменения отражены в `.env.example` и `INCIDENT_RESPONSE.md`
- Добавлены подробные сообщения об ошибках при сохранении задач
- Введена метрика `api_errors_total` и расширен формат логов (IP, User-Agent)
- Добавлена переменная `COOKIE_DOMAIN` для указания домена cookie в продакшене
  и отключения его в режиме разработки
- Middleware logging.ts выводит IP и User-Agent в логах
- Middleware checkRole и checkTaskAccess фиксируют отказ доступа в логах
- Логирование превышения лимитов запросов через rateLimiter.ts
- Значение COOKIE_DOMAIN приводится к hostname, неподдерживаемые форматы вызывают ошибку.
- Установка cookie `token` сопровождается логом с доменом
- В railway_full_setup.md уточнён список переменных окружения с ссылкой на защиту от CSRF
- verifyToken обновляет cookie `token` при каждом запросе для silent refresh
- CSRF-токен сохраняется в `localStorage` и передаётся в заголовке `X-XSRF-TOKEN`
- При недоступности `localStorage` токен хранится в памяти, добавлен раздел в technical_manual.md
- Страница входа показывает уведомления об ошибках авторизации
- Удалена неиспользуемая зависимость bcrypt
- Удалена неиспользуемая страница AdminPlaceholder и скрипт backup_mongo_r2.sh
- Функция `setTokenCookie` избавляет от дублирования кода установки cookie
- Удалены неиспользуемые зависимости bcrypt и mongodb-memory-server
- Удалён устаревший контроллер tasks.js, общая проверка перенесена в handleValidation
- Июль 2025: устранено дублирование логики расчёта маршрутов в tasks.service.ts и tasks.js
- Удалён модуль `services/gateway.js`; поддержка SMS через GatewayAPI исключена
  вместе с переменными `GATEWAY_API_KEY` и `GATEWAY_SENDER`
- Удалён дублирующийся скрипт `.husky/husky.sh`, используется `.husky/_/husky.sh`
- Удалён неиспользуемый пакет @aws-sdk/client-s3
- Исправлены импорты mapUtils в веб‑клиенте, используется default объект
- authFetch принимает опцию `noRedirect`, AuthProvider использует её при загрузке профиля
- Добавлено сжатие ответов через `compression`
- Фильтры логов снабжены атрибутами `aria-label` для Lighthouse
- Исполнители на странице задач отображаются по имени (учитывается telegram_username)
- Запросы с заголовком `Authorization` обходят проверку CSRF, переменная `DISABLE_CSRF=1` отключает middleware и выводит предупреждение
- Запуск сервера переведён на сборку TypeScript через tsc
- Обновление профиля пользователя защищено от NoSQL-инъекций
- Файл `tsconfig.json` исключает `bot/shared` и `dist`
- Dockerfile собирает сервер командой `npm run build`
- Dockerfile копирует `tsconfig.json`, исправлена ошибка `Cannot find tsconfig.json`
- Dockerfile переносит каталог `dist` в образ для корректной работы pm2
- Переведены на TypeScript сервис, контроллер и роут карт
- Расширена проверка коротких ссылок Google Maps: DNS-разрешение и фильтрация приватных IP защищают от SSRF
- API, middleware и swagger переписаны на TypeScript, исходные `.js` удалены
- Middleware `checkRole`, `taskAccess`, сервис `auth` веб-клиента и файл бота `bot` переписаны на TypeScript
- Типизация сервиса `auth` веб-клиента исправлена: вместо `RequestInit` используется локальный интерфейс `FetchOptions`
- Переписаны на TypeScript контроллеры маршрутов и оптимизации, модель
  пользователя, кастомный админ-бекенд и модуль `config`; удалены
  дублирующие JS‑роуты
- ESLint проверяет серверные файлы TypeScript, правила `no-explicit-any` и `ban-ts-comment` отключены
- Модуль `taskFields` переименован в `taskFields.js`, исправлены типы оптимизатора и модели пользователя для успешной Docker-сборки
- Файл `taskFields.js` перемещён в `packages/shared/src` для корректной Docker-сборки
- `taskFields.ts` заменил `taskFields.js`, поля типизированы интерфейсом
- Скрипт `create_admin_user.ts` переписан на TypeScript
- Устранена ошибка ESLint: `authFetch` использует локальный интерфейс `FetchOptions` вместо `RequestInit`
- Скрипты `get_menu_button_url`, `set_menu_button_url`, `set_attachment_menu_url` и `chaos` переписаны на TypeScript
- Автотесты переведены на TypeScript, конфигурация Jest обновлена.
- Проверка MongoDB в workflow Docker запускает TypeScript-скрипт через `pnpm --dir bot check:mongo`.
- Скрипт `check_mongo` корректно сообщает об отсутствии базы данных вместо ошибки `db`.
- Восстановлен файл `ecosystem.config.cjs` для запуска через pm2.
- Введён общий тип `RequestWithUser`, все контроллеры и middleware используют его вместо `any`.
- Добавлен скрипт `test:types` с проверками `tsd` и стресс-тест `stress_test.sh`.
- Исправлены ошибки TypeScript, обновлены конфигурация и зависимости для успешной сборки.

- Поле `query` в `RequestWithUser` теперь `ParsedQs`, что устраняет ошибку Docker-сборки.

- Удалены неиспользуемые интерфейсы в роутерах `authUser`, `logs` и `optimizer` для прохождения ESLint
- Сервисы `LogsService` и `UsersService` получили интерфейсы репозитория, контроллеры типизированы без `any`
- Удалены остаточные CommonJS-экспорты и явные `any`, `asyncHandler` допускает обработчики без `next`
- Исправлена типизация контроллеров и сервисов для успешной Docker-сборки
- Уточнены типы запросов к MongoDB и движка логов,
  правило `@typescript-eslint/no-explicit-any` включено для серверного кода
- Конфигурационные файлы переведены на TypeScript, добавлен скрипт проверки отсутствия JavaScript
- История изменений вынесена из AGENTS.md; файл содержит только инструкции.
- Подключены заголовки безопасности Helmet и Content Security Policy
  с белыми списками через переменные окружения.
- В корневой `package.json` добавлена зависимость `reflect-metadata` для корректного разрешения модулей.
- Добавлены регрессионные тесты Playwright и Supertest для Auth/CRUD/CSRF.
- Ограничено логирование: записываются только ключевые действия, просмотр логов не фиксируется.
- Исправлен импорт `matchSorter` в веб‑клиенте: используется пакет `match-sorter`, сборка Docker проходит.
- Заголовок CORP переведён в режим cross-origin; `applySecurity` вызывается до трассировки и логирования.
- Добавлена зависимость `@telegram-apps/init-data-node`, утилита `verifyInitData` использует её и возвращает объект, обновлён `tmaAuth.guard`.

- Исправлена конфигурация Tailwind: расширено поле content и PostCSS явно подключает Tailwind.
- Удалён инлайновый скрипт из веб-клиента, CSP использует nonce и 'strict-dynamic'; useGrid форматирует объектные значения.
- Добавлены глобальные форматтеры для `object` в AG Grid и повторная загрузка маршрутов при навигации.
- Исправлена конфигурация `useGrid`: тип `object` включает `baseDataType`, форма задач открывается без ошибки.
- Лимитер использует ключ пользователя и отправляет заголовок `Retry-After`.
- Добавлен модуль `form` со схемой задач и генерацией формы на клиенте и серверной валидацией.
- Схема задач и payload включают `formVersion`; сервер отклоняет неизвестные версии.
- Лимитер считает запросы по `telegram_id` и допускает обход через заголовок `X-Captcha-Token`.
- Обновлены документы по безопасности cookie/CSRF и стресс-план.
- Канбан‑доска получила панель действий сверху и горизонтальную прокрутку колонок.
- Удалена кнопка «Загрузить»; файлы прикрепляются кнопкой,
  поддерживается множественный выбор, миниатюры и открытие в новом окне.
  Плейсхолдер выбора пользователей переведён на русский.
- `<ErrorBoundary>` оборачивает `React.StrictMode` в `apps/web/src/main.tsx`, проверен вывод запасного UI.
- Активирован `build.minify` и `treeshake` в Vite, зависимости `jspdf` загружаются динамически, патч удалён.
